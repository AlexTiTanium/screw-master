import{T as mr,S as Wc,b as mn,l as en,c as sn,R as Yc,d as X,f as jc,g as $n,h as Jc,s as Gc,e as wa,C as Ct,i as Kc,j as Ki,E as Xc,G as ba,k as ae,m as Hn,_ as ur}from"./pixi-CUtm4PMh.js";import{g as we}from"./vendor-DDlvirwQ.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();function Qc(i,t){const e=Math.pow(10,t);return Math.round(i*e)/e}class Bs{constructor(t,e){this.x=t||0,this.y=e||0}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}setScalar(t){return this.x=t,this.y=t,this}set(t,e){return this.x=t,this.y=e,this}clone(){return new Bs(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return Un.set(t,t),Wn.set(e,e),this.clamp(Un,Wn)}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Math.max(t,Math.min(e,s)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){let t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.subVectors(e,t).multiplyScalar(s).add(t)}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this}toArray(t,e){return t===void 0&&(t=[]),e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t}rotateAround(t,e){const s=Math.cos(e),r=Math.sin(e),n=this.x-t.x,o=this.y-t.y;return this.x=n*s-o*r+t.x,this.y=n*r+o*s+t.y,this}}const Un=new Bs,Wn=new Bs,ns=new Map;function Aa(i,t=100,e){if(!ns.has(i)){let s=null;const r=(...n)=>{if(ns.get(i).args=n,s)return;const o=()=>{s=null;const a=ns.get(i).args;e?i.call(e,...a):i(...a)};t===0?o():s=setTimeout(o,t)};ns.set(i,{throttledFunction:r,args:null})}return ns.get(i).throttledFunction}class Zc{constructor(){this._locked=!1}get locked(){return this._locked}lock(){return this._locked?!1:(this._locked=!0,!0)}unlock(){this._locked=!1}}class Ba extends Promise{constructor(t){let e,s;super((r,n)=>{e=r,s=n,t?.(r,n)}),this.resolve=e,this.reject=s}}class tl{constructor(t){this._params=this._getParams(t??location.search)}get(t,e){const s=typeof e;return s==="number"?this.getNumber(t,e):s==="boolean"?this.getBoolean(t,e):this.getString(t,e)}getString(t,e){return this._params.paramsString.has(t)?this._params.paramsString.get(t):e}getNumber(t,e){return this._params.paramsNumber.has(t)?this._params.paramsNumber.get(t):e}getBoolean(t,e){return this._params.paramsBoolean.has(t)?this._params.paramsBoolean.get(t):e}getAll(){return this._params.paramsString}_getParams(t){const e=t.slice(t.indexOf("?")+1).split("&"),s=new Map,r=new Map,n=new Map;for(const o of e){const a=o.split("="),l=a[0],p=a[1]??"true";s.set(l,p),r.set(l,Number(p)),n.set(l,p.toLowerCase()!=="false")}return{paramsString:s,paramsNumber:r,paramsBoolean:n}}}function Sa(i=60){mr.shared.maxFPS=i,mr.system.maxFPS=i,we.ticker.fps(i)}function Ca(i){return{name:i._name,items:i.items}}class Ta{constructor(t,e,s){this._priorities=[],this._result={priority:"after",runner:"start",plugin1:null,plugin2:null},this._runners=t,this._getRunner=e,this._getItem=s||(r=>r)}get prioritise(){return this._runnerChain||this._buildChain(),this._runnerChain}applyPrioritise(){this._priorities.forEach(t=>{this._prioritise(t)})}_buildChain(){this._actionChain={before:(e,s)=>{this._result.priority="before",this._result.plugin2={item:e,data:s},this._priorities.push({...this._result})},after:(e,s)=>{this._result.priority="after",this._result.plugin2={item:e,data:s},this._priorities.push({...this._result})},first:()=>{this._result.priority="first",this._priorities.push({...this._result})},last:()=>{this._result.priority="last",this._priorities.push({...this._result})}};const t=this._runners;this._runnerChain=this._runnerChain??t.reduce((e,s)=>{const r=this._getRunner(s).name;return e[r]=(n,o)=>(this._result.plugin1={item:n,data:o},this._result.runner=r,this._actionChain),e},{})}_prioritise(t){const e=this._runners.find(o=>this._getRunner(o).name===t.runner);if(!e)return;const s=this._getItem(t.plugin1.item,t.plugin1.data),r=this._getRunner(e).items,n=r.indexOf(s);if(n!==-1)if(r.splice(n,1),t.priority==="first")r.unshift(s);else if(t.priority==="last")r.push(s);else{const o=this._getItem(t.plugin2.item,t.plugin2.data),a=r.indexOf(o);if(a===-1)return;t.priority==="before"?r.splice(a,0,s):t.priority==="after"&&r.splice(a+1,0,s)}}}async function ar(i){const{items:t,name:e}=i;for(const s of t)await s[e]()}async function Ma(i){const t=[],{items:e,name:s}=i;for(const r of e)t.push(r[s]());await Promise.all(t)}class el{constructor(){this.blockingAssetsTrackingState={state:"blockingAssets",size:0,startTime:performance.now(),endTime:0,count:0},this.gameAssetsTrackingState={state:"gameAssets",size:0,count:0},this.currentAssetState="blockingAssets"}start(){this.blockingAssetsTrackingState.startTime=performance.now()}getState(){return{blockingAssetsCount:this.blockingAssetsTrackingState.count,blockingAssetsSize:this.blockingAssetsTrackingState.size,blockingAssetsTime:this.blockingAssetsTrackingState.endTime&&this.blockingAssetsTrackingState.startTime?this.blockingAssetsTrackingState.endTime-this.blockingAssetsTrackingState.startTime:0,gameAssetsCount:this.gameAssetsTrackingState.count,gameAssetsSize:this.gameAssetsTrackingState.size,allAssetsSize:this.blockingAssetsTrackingState.size+this.gameAssetsTrackingState.size,allAssetsCount:this.blockingAssetsTrackingState.count+this.gameAssetsTrackingState.count}}trackAsset(t){this.currentAssetState==="blockingAssets"?(this.blockingAssetsTrackingState.count+=t.length,this.blockingAssetsTrackingState.size+=t.reduce((e,s)=>e+s,0)):(this.gameAssetsTrackingState.count+=t.length,this.gameAssetsTrackingState.size+=t.reduce((e,s)=>e+s,0))}switchAssetState(t){this.currentAssetState==="blockingAssets"&&t==="gameAssets"&&(this.blockingAssetsTrackingState.endTime=performance.now(),this.gameAssetsTrackingState.startTime=this.blockingAssetsTrackingState.endTime),this.currentAssetState=t}}class il{constructor(t,e=!0){this._TAIL_WINDOW_SECONDS=3,this._SESSION_FPS_SAMPLE_MAX=5e3,this._SEGMENT_FPS_SAMPLE_MAX=1e3,this._realtime={stdDevCount:0,stdDevMean:0,stdDevSquared:0,ticks:0,fpsTime:0},this.id=t,this.startTime=performance.now(),this.perf={stdDevCount:0,stdDevMean:0,stdDevSquared:0,ticks:0,fpsTime:0},this.fpsSamples=[],this.fpsSampleCount=0,this.worstWindowFPS=1/0,this.trackTail=e,e&&(this.frameWindow=[])}update(t,e){const s=Math.min(1e3/t,60);this.id==="session"&&(this._updateVariance(t,this._realtime),this._updateFPS(t,this._realtime)),this._updateVariance(t,this.perf),this._updateFPS(t,this.perf),this.addFPSSample(this,s),this.trackTail&&this.frameWindow&&this.updateRollingWindow(e,this)}getStats(t,e=performance.now()){const s=this._getFPS(this.perf),r=this._getVariance(this.perf),n=this._getVarianceSample(this.perf),{fpsPercentile1:o,fpsPercentile5:a,fpsPercentile95:l,fpsPercentile99:p}=this._computePercentiles(this.fpsSamples);return{id:this.id,startTime:this.startTime,endTime:t?e:void 0,durationMs:e-this.startTime,frames:this.perf.ticks,fps:s,choppiness:r,choppinessSample:n,fpsPercentile1:o,fpsPercentile5:a,fpsPercentile95:l,fpsPercentile99:p,tailFPS:this.trackTail&&isFinite(this.worstWindowFPS)?this.worstWindowFPS:void 0,active:!t}}resetRealTimeStats(){this._realtime.fpsTime=0,this._realtime.stdDevCount=0,this._realtime.stdDevMean=0,this._realtime.stdDevSquared=0,this._realtime.ticks=0}get fps(){return this._getFPS(this.perf)}get realtimeFPS(){return this._getFPS(this._realtime)}get choppiness(){return this._getVariance(this.perf)}get choppinessSample(){return this._getVarianceSample(this.perf)}get realtimeChoppiness(){return this._getVariance(this._realtime)}get realtimeChoppinessSample(){return this._getVarianceSample(this._realtime)}get tailFPS(){return isFinite(this.worstWindowFPS)?this.worstWindowFPS:void 0}get tailWindowSeconds(){return this._TAIL_WINDOW_SECONDS}_updateVariance(t,e){e.stdDevCount++;const s=t-e.stdDevMean;e.stdDevMean+=s/e.stdDevCount;const r=t-e.stdDevMean;e.stdDevSquared+=s*r}_getVariance(t){return t.stdDevCount===0?0:t.stdDevSquared/t.stdDevCount}_getVarianceSample(t){return t.stdDevCount===0?0:t.stdDevSquared/(t.stdDevCount-1)}_updateFPS(t,e){e.fpsTime+=t,e.ticks++}_getFPS(t){if(t.ticks===0)return 0;const e=1e3/(t.fpsTime/t.ticks);return Math.min(e,60)}addFPSSample(t,e){t.fpsSampleCount++;const s=t.fpsSampleCount,r=t.id==="session"?this._SESSION_FPS_SAMPLE_MAX:this._SEGMENT_FPS_SAMPLE_MAX;if(t.fpsSamples.length<r)t.fpsSamples.push(e);else{const n=Math.floor(Math.random()*s);n<r&&(t.fpsSamples[n]=e)}}updateRollingWindow(t,e){const s=this._TAIL_WINDOW_SECONDS*1e3,r=e.frameWindow;for(r.push({t});r.length&&t-r[0].t>s;)r.shift();if(r.length>1){const n=t-r[0].t;if(n>0){const o=Math.min((r.length-1)/(n/1e3),60);o<e.worstWindowFPS&&(e.worstWindowFPS=o)}}}_computePercentiles(t){if(!t.length)return{fpsPercentile1:0,fpsPercentile5:0,fpsPercentile95:0,fpsPercentile99:0};const e=[...t].sort((r,n)=>r-n),s=r=>{const n=Math.min(e.length,Math.max(1,Math.ceil(r/100*e.length)));return e[n-1]};return{fpsPercentile1:s(1),fpsPercentile5:s(5),fpsPercentile95:s(95),fpsPercentile99:s(99)}}}const Yn={r8unorm:1,r8snorm:1,r8uint:1,r8sint:1,r16uint:2,r16sint:2,r16float:2,rg8unorm:2,rg8snorm:2,rg8uint:2,rg8sint:2,r32float:4,r32uint:4,r32sint:4,rg16uint:4,rg16sint:4,rg16float:4,rgba8unorm:4,"rgba8unorm-srgb":4,rgba8snorm:4,rgba8uint:4,rgba8sint:4,bgra8unorm:4,"bgra8unorm-srgb":4,rgb10a2unorm:4,rg11b10ufloat:4,rgb9e5ufloat:4,rg32float:8,rg32uint:8,rg32sint:8,rgba16uint:8,rgba16sint:8,rgba16float:8,rgba32float:16,rgba32uint:16,rgba32sint:16,depth16unorm:2,depth24plus:3,"depth24plus-stencil8":4,depth32float:4,stencil8:1,"depth32float-stencil8":5},jn={6408:4,6407:3,33319:2,6403:1,36249:4,36248:3,33320:2,36244:1,6406:1,6409:1,6410:2,6402:1,34041:2};class sl{constructor(){this._gpuTextureSize=new Map}start(t){this._renderer=t}update(){if(!this._renderer)return{textureCount:0,sizeInMb:0};const t=this._get();let e=0,s=0;for(const n of t)!n.destroyed&&n.isLoaded&&(e++,s+=n.gpuSize);const r=Qc(s/1024/1024,1);return{textureCount:e,sizeInMb:r}}_get(){const t=this._renderer.texture.managedTextures,e=this._getWebTextures(),s=[];return t.forEach(r=>{if(r?.resource){if(!this._gpuTextureSize.has(r.uid)){const n=this._getMemorySize(r,e[r.uid]);n&&this._gpuTextureSize.set(r.uid,n)}s.push({gpuSize:this._gpuTextureSize.get(r.uid)||0,destroyed:r.destroyed,isLoaded:!!e[r.uid]})}}),s}_getWebTextures(){const t=this._renderer;let e={};const s=t.texture;return"_glTextures"in s||"_gpuSources"in s?e="_glTextures"in s?s._glTextures:s._gpuSources:e=s.managedTextures.reduce((n,o)=>{if(!o)return n;const a=o._gpuData[this._renderer.uid];return a&&(n[o.uid]="gpuTexture"in a?a.gpuTexture:a),n},{}),e}_getMemorySize(t,e){return e?Array.isArray(t.resource)&&t.resource[0]instanceof Uint8Array?t.resource.reduce((s,r)=>s+r.byteLength,0):typeof e.format=="string"&&Yn[e.format]?e.width*e.height*Yn[e.format]:typeof e.format=="number"&&jn[e.format]?e.width*e.height*jn[e.format]:null:null}}const rl=60*1e3,nl=2*1e3,ol=20*1e3;class al{constructor(){this.assetMonitor=new el,this._paused=!1,this._isFirstEvent=!0,this._lastTickTime=0,this._systemThrottled=!1,this._peakSizeInMb=0,this._deviceScreenRefresh=0,this._LIKELY_HZ=[15,30,60,90,120],this._rafSamplingStarted=!1,this._timeTo={},this._gpuMonitor=new sl,this._segments=new Map,this._warningLastEmit=Object.create(null),this._GPU_WARNING_THRESHOLD_MB=200*.9}init(t,e=!0,s){this._trackFunction=t,this._warningFunction=s,this.startSegment("session",{trackTail:!0}),setInterval(()=>this._trackAnalytics(),rl),this._startDisplayHzSampling(),e&&mr.shared.add(this.update,this)}startSegment(t,e){if(this._segments.has(t))return;const s=e?.trackTail??!0;this._segments.set(t,new il(t,s))}endSegment(t){const e=this._segments.get(t);if(!e)return;const s=this._buildSegmentData(e,!0);return this._segments.delete(t),s}getActiveSegments(){return Array.from(this._segments.keys())}get jsHeapSizeUsed(){var t;return(t=performance?.memory)==null?void 0:t.usedJSHeapSize}get jsHeapSizeTotal(){var t;return(t=performance?.memory)==null?void 0:t.totalJSHeapSize}get jsHeapSizeLimit(){var t;return(t=performance?.memory)==null?void 0:t.jsHeapSizeLimit}get fps(){var t;return((t=this._segments.get("session"))==null?void 0:t.fps)??0}get realtimeFPS(){var t;return((t=this._segments.get("session"))==null?void 0:t.realtimeFPS)??0}get choppiness(){var t;return((t=this._segments.get("session"))==null?void 0:t.choppiness)??0}get choppinessSample(){var t;return((t=this._segments.get("session"))==null?void 0:t.choppinessSample)??0}get realtimeChoppiness(){var t;return((t=this._segments.get("session"))==null?void 0:t.realtimeChoppiness)??0}get realtimeChoppinessSample(){var t;return((t=this._segments.get("session"))==null?void 0:t.realtimeChoppinessSample)??0}get tailFPS(){var t;return((t=this._segments.get("session"))==null?void 0:t.tailFPS)??0}get tailWindowSeconds(){var t;return((t=this._segments.get("session"))==null?void 0:t.tailWindowSeconds)??0}get deviceScreenRefresh(){return this._deviceScreenRefresh||void 0}get peakSizeInMb(){return this._peakSizeInMb}get vramPeakExceeded(){return this._peakSizeInMb>=200}get systemThrottled(){return this._systemThrottled}startGPUMonitoring(t){this._gpuMonitor.start(t)}update(){if(this._paused)return;const t=performance.now(),e=t-this._lastTickTime;if(this._lastTickTime!==0&&e<nl&&t>ol){const s=this._capDeltaFor60(e);if(this._segments.size)for(const r of this._segments.values())r.update(s,t)}this._lastTickTime=t}pause(){this._paused=!0}resume(){this._paused=!1}reset(){return this.assetMonitor.blockingAssetsTrackingState={state:"blockingAssets",size:0,startTime:performance.now(),endTime:0,count:0},this.assetMonitor.gameAssetsTrackingState={state:"gameAssets",size:0,count:0},this.assetMonitor.currentAssetState="blockingAssets",this._paused=!1,this._isFirstEvent=!0,this._lastTickTime=0,this._systemThrottled=!1,this._peakSizeInMb=0,this._deviceScreenRefresh=0,this._rafSamplingStarted=!1,this._timeTo={},this._segments.clear(),this._warningLastEmit=Object.create(null),this.startSegment("session",{trackTail:!0}),this._startDisplayHzSampling(),this}trackTimeTo(t){const e=`timeTo${t.charAt(0).toUpperCase()+t.slice(1)}`;this._timeTo[e]=Math.round(window.performance.now())/1e3}_trackAnalytics(){if(this._paused)return;const t=this._gpuMonitor.update();t.sizeInMb>this._peakSizeInMb&&(this._peakSizeInMb=t.sizeInMb),this._checkGpuWarning(t.sizeInMb),this._checkSystemMemoryWarning();const e=[],s=performance.now();let r;if(this._segments.size)for(const a of this._segments.values()){const l=this._buildSegmentData(a,!1,s);a.id==="session"?r=l:e.push(l)}const n=this._segments.get("session"),o={...r,isFirst:this._isFirstEvent,realtimeFPS:n.realtimeFPS,realtimeChoppiness:n.realtimeChoppiness,realtimeChoppinessSample:n.realtimeChoppinessSample,jsHeapSizeLimit:this.jsHeapSizeLimit,jsHeapSizeTotal:this.jsHeapSizeTotal,jsHeapSizeUsed:this.jsHeapSizeUsed,tailWindowSeconds:n.tailWindowSeconds,textureCount:t.textureCount,sizeInMb:t.sizeInMb,peakSizeInMb:this._peakSizeInMb,vramPeakExceeded:this.vramPeakExceeded,deviceScreenRefresh:this.deviceScreenRefresh,...this.assetMonitor.getState(),...this._timeTo};this._trackFunction(o,e),n.resetRealTimeStats(),this._isFirstEvent=!1}_capDeltaFor60(t){const e=16.666666666666668;return t<e?e:t}_startDisplayHzSampling(){var t;if(this._deviceScreenRefresh||this._rafSamplingStarted)return;const e=typeof window<"u"?window:void 0,s=(t=e?.requestAnimationFrame)==null?void 0:t.bind(e);if(!s)return;this._rafSamplingStarted=!0;let r=0;const n=performance.now(),o=1e3,a=2500,l=_=>{if(this._deviceScreenRefresh)return;const y=Math.max(1,_-n),h=r/(y/1e3);this._deviceScreenRefresh=this._snapHz(h),this._deviceScreenRefresh<=30&&(this._systemThrottled=!0)},p=_=>{if(this._deviceScreenRefresh)return;if(r++,_-n>=o||r>=300){l(_);return}s(p)};s(p),setTimeout(()=>{this._deviceScreenRefresh||l(performance.now())},a)}_snapHz(t){let e=t,s=1/0;for(const r of this._LIKELY_HZ){const n=Math.abs(r-t);n<s&&(s=n,e=r)}return Math.abs(e-t)/t>.15?Math.round(t):Math.round(e)}_buildSegmentData(t,e,s=performance.now()){return{...t.getStats(e,s),systemThrottled:this._systemThrottled}}emitWarning(t,e,s=120*1e3){if(!this._warningFunction)return!1;const r=performance.now(),n=this._warningLastEmit[t];return n!==void 0&&r-n<s?!1:(this._warningLastEmit[t]=r,this._warningFunction({type:t,data:e,at:r}),!0)}_checkGpuWarning(t){t>=this._GPU_WARNING_THRESHOLD_MB&&this.emitWarning("gpuMemoryHigh",{sizeInMb:t,peakSizeInMb:this._peakSizeInMb,thresholdMb:this._GPU_WARNING_THRESHOLD_MB})}_checkSystemMemoryWarning(){const t=this.jsHeapSizeUsed,e=this.jsHeapSizeLimit;if(!t||!e||e<=0)return;const s=t/e;s>=.9&&this.emitWarning("systemMemoryHigh",{jsHeapSizeUsed:t,jsHeapSizeLimit:e,ratio:s})}}const un=new al;class Pa{constructor(t={}){this._defaultPluginName="default",this.runners=[],this.setupRunner=this.addRunner("setup"),this.initRunner=this.addRunner("init"),this.prepareRunner=this.addRunner("prepare"),this.startRunner=this.addRunner("start"),this.updateRunner=this.addRunner("update"),this.config=t,this.verbose=this.config.verbose??!1,this.plugins=new Map,this.pluginDefaults=new Map,this.config.limitFPS=this.config.limitFPS??60,this.config.limitFPS&&Sa(this.config.limitFPS),this._prioritiser=new Ta(this.runners,Ca,(e,s)=>this.get(e,s))}add(t,e){e=e||{};const s=e.name,r=s??this._defaultPluginName;e=Object.assign(e,this.config[s]||{});const n=new t(this,e),o=this.plugins.get(t)||{};if(o[r])throw new Error(`app plugin ${r} already exists`);return o[r]=n,this.pluginDefaults.get(t)||this.pluginDefaults.set(t,r),this.runners.forEach(a=>{a.add(n)}),this.plugins.set(t,o),n}get(t,e){const s=e??this.pluginDefaults.get(t);return this.plugins.get(t)[s]}async init(){this._prioritiser.applyPrioritise(),await Ma(this.setupRunner),await ar(this.initRunner),mr.system.add(this.update,this),await ar(this.prepareRunner),await ar(this.startRunner),un.assetMonitor.switchAssetState("gameAssets")}update(t){this.updateRunner.emit(t.deltaTime)}addRunner(t){const e=new Wc(t);return this.runners.push(e),e}get prioritise(){return this._prioritiser.prioritise}}class Qi{constructor(t,e){this.app=t,this.options=e||{},this.verbose=e?.verbose??t.verbose??!1}}function Ia(i){var t,e;for(const s of i){const r=(t=s.data)==null?void 0:t.tags,n=(e=s.asset)==null?void 0:e.source;n&&r&&(r.REPEAT&&(n.style.addressMode="repeat"),r.NEAREST&&(n.style.scaleMode="nearest"))}}const Ea={...en,extension:mn.LoadParser,async load(i,t,e){var s,r;const n=await((r=(s=en).load)==null?void 0:r.call(s,i,t,e));return t&&Ia([{asset:n,data:t.data}]),n}},Va={...sn,extension:mn.LoadParser,async load(i,t){var e;const s=["normal","bold","100","200","300","400","500","600","700","800","900"];let r=[];const n=((e=t?.data)==null?void 0:e.tags)||{};return n.w&&(Array.isArray(n.w)?r.push(...n.w.map(o=>o.toString())):n.w==="all"?r=s:r.push(n.w.toString())),r.length===0&&(r=["normal"]),r.every(o=>s.includes(o))||console.warn(`[loadWebFont] A font weight provided for ${i} is invalid`),n.w&&(t.data.weights=r),n.family&&(t.data.family=n.family),sn.load(i,t)}},ka={extension:{type:mn.ResolveParser,name:"resolveSpineAtlas"},test:i=>{const e=i.split("?")[0].split("."),s=e.pop(),r=e.pop();return s==="atlas"&&["png","webp","avif"].includes(r)},parse:i=>{var t;const e=i.split(".");return{resolution:parseFloat(((t=Yc.RETINA_PREFIX.exec(i))==null?void 0:t[1])??"1"),format:e[e.length-2],src:i}}},Jn={};let Gn=!0;const cl=X.load,ll=X.backgroundLoad,Kn=i=>{if(Gn){const s=X.resolver._manifest;s&&(s.bundles.forEach(r=>{r.assets.forEach(o=>{o.data.tags.tps&&o.data.frameNames&&o.data.frameNames.forEach(a=>{Jn[a]=o})})}),Gn=!1)}const t={},e=Jc(i,s=>{const r=Jn[s];return r?(t[s]=r,r):s});return{urlToSpritesheetMap:t,res:e}};function hl(){X.load=async(i,t)=>{const{res:e,urlToSpritesheetMap:s}=Kn(i),r=await cl.bind(X)(e.length===1?e[0]:e,t);let n;Object.entries(s).forEach(([p,_])=>{if(!r[p]&&!(r instanceof jc)){r[p]=$n.get(p);return}n=$n.get(p)});const a=(Array.isArray(i)?i:[i]).map(p=>typeof p=="string"?p:p.alias[0]),l=Object.values(X.resolver.resolve(a)).map(p=>p.progressSize??1);return un.assetMonitor.trackAsset(l),n??r},X.backgroundLoad=async i=>{const{res:t}=Kn(i),e=t.map(s=>typeof s=="string"?s:s.alias[0]);await ll.bind(X)(e)}}const Xn={};function La(i,t,e=3){if(Xn[t])return;let s=new Error().stack;typeof s>"u"?console.warn("Astro Deprecation Warning: ",`${t}
Deprecated since v${i}`):(s=s.split(`
`).splice(e).join(`
`),console.groupCollapsed?(console.groupCollapsed("%cAstro Deprecation Warning: %c%s","color:#614108;background:#fffbe6","font-weight:normal;color:#614108;background:#fffbe6",`${t}
Deprecated since v${i}`),console.warn(s),console.groupEnd()):(console.warn("Astro Deprecation Warning: ",`${t}
Deprecated since v${i}`),console.warn(s))),Xn[t]=!0}var ys={exports:{}},ml=ys.exports,Qn;function ul(){return Qn||(Qn=1,(function(i,t){(function(e,s){var r="1.0.41",n="",o="?",a="function",l="undefined",p="object",_="string",y="major",h="model",m="name",u="type",d="vendor",f="version",v="architecture",w="console",g="mobile",b="tablet",S="smarttv",C="wearable",T="embedded",P=500,E="Amazon",z="Apple",H="ASUS",Y="BlackBerry",W="Browser",j="Chrome",dt="Edge",ot="Firefox",At="Google",lt="Honor",rt="Huawei",oi="Lenovo",Pt="LG",Qt="Microsoft",he="Motorola",ke="Nvidia",Le="OnePlus",ze="Opera",Ii="OPPO",je="Samsung",es="Sharp",Je="Sony",me="Xiaomi",Tr="Zebra",Ln="Facebook",zn="Chromium OS",Fn="Mac OS",Dn=" Browser",$c=function(G,Z){var U={};for(var at in G)Z[at]&&Z[at].length%2===0?U[at]=Z[at].concat(G[at]):U[at]=G[at];return U},Ps=function(G){for(var Z={},U=0;U<G.length;U++)Z[G[U].toUpperCase()]=G[U];return Z},Rn=function(G,Z){return typeof G===_?is(Z).indexOf(is(G))!==-1:!1},is=function(G){return G.toLowerCase()},Hc=function(G){return typeof G===_?G.replace(/[^\d\.]/g,n).split(".")[0]:s},Mr=function(G,Z){if(typeof G===_)return G=G.replace(/^\s\s*/,n),typeof Z===l?G:G.substring(0,P)},ss=function(G,Z){for(var U=0,at,Fe,be,et,q,Ae;U<Z.length&&!q;){var Pr=Z[U],On=Z[U+1];for(at=Fe=0;at<Pr.length&&!q&&Pr[at];)if(q=Pr[at++].exec(G),q)for(be=0;be<On.length;be++)Ae=q[++Fe],et=On[be],typeof et===p&&et.length>0?et.length===2?typeof et[1]==a?this[et[0]]=et[1].call(this,Ae):this[et[0]]=et[1]:et.length===3?typeof et[1]===a&&!(et[1].exec&&et[1].test)?this[et[0]]=Ae?et[1].call(this,Ae,et[2]):s:this[et[0]]=Ae?Ae.replace(et[1],et[2]):s:et.length===4&&(this[et[0]]=Ae?et[3].call(this,Ae.replace(et[1],et[2])):s):this[et]=Ae||s;U+=2}},rs=function(G,Z){for(var U in Z)if(typeof Z[U]===p&&Z[U].length>0){for(var at=0;at<Z[U].length;at++)if(Rn(Z[U][at],G))return U===o?s:U}else if(Rn(Z[U],G))return U===o?s:U;return Z.hasOwnProperty("*")?Z["*"]:G},Uc={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},qn={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Nn={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[f,[m,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[f,[m,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[m,f],[/opios[\/ ]+([\w\.]+)/i],[f,[m,ze+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[f,[m,ze+" GX"]],[/\bopr\/([\w\.]+)/i],[f,[m,ze]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[f,[m,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[f,[m,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[m,f],[/quark(?:pc)?\/([-\w\.]+)/i],[f,[m,"Quark"]],[/\bddg\/([\w\.]+)/i],[f,[m,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[f,[m,"UC"+W]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[f,[m,"WeChat"]],[/konqueror\/([\w\.]+)/i],[f,[m,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[f,[m,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[f,[m,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[f,[m,"Smart Lenovo "+W]],[/(avast|avg)\/([\w\.]+)/i],[[m,/(.+)/,"$1 Secure "+W],f],[/\bfocus\/([\w\.]+)/i],[f,[m,ot+" Focus"]],[/\bopt\/([\w\.]+)/i],[f,[m,ze+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[f,[m,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[f,[m,"Dolphin"]],[/coast\/([\w\.]+)/i],[f,[m,ze+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[f,[m,"MIUI"+Dn]],[/fxios\/([\w\.-]+)/i],[f,[m,ot]],[/\bqihoobrowser\/?([\w\.]*)/i],[f,[m,"360"]],[/\b(qq)\/([\w\.]+)/i],[[m,/(.+)/,"$1Browser"],f],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[m,/(.+)/,"$1"+Dn],f],[/samsungbrowser\/([\w\.]+)/i],[f,[m,je+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[f,[m,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[m,"Sogou Mobile"],f],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[m,f],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[m],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[f,m],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[m,Ln],f],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[m,f],[/\bgsa\/([\w\.]+) .*safari\//i],[f,[m,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[f,[m,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[f,[m,j+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[m,j+" WebView"],f],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[f,[m,"Android "+W]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[m,f],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[f,[m,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[f,m],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[m,[f,rs,Uc]],[/(webkit|khtml)\/([\w\.]+)/i],[m,f],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[m,"Netscape"],f],[/(wolvic|librewolf)\/([\w\.]+)/i],[m,f],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[f,[m,ot+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[m,[f,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[m,[f,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[v,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[v,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[v,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[v,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[v,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[v,/ower/,n,is]],[/ sun4\w[;\)]/i],[[v,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[v,is]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[h,[d,je],[u,b]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[h,[d,je],[u,g]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[h,[d,z],[u,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[h,[d,z],[u,b]],[/(macintosh);/i],[h,[d,z]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[h,[d,es],[u,g]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[h,[d,lt],[u,b]],[/honor([-\w ]+)[;\)]/i],[h,[d,lt],[u,g]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[h,[d,rt],[u,b]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[h,[d,rt],[u,g]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[h,/_/g," "],[d,me],[u,b]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[h,/_/g," "],[d,me],[u,g]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[h,[d,Ii],[u,g]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[h,[d,rs,{OnePlus:["304","403","203"],"*":Ii}],[u,b]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[h,[d,"Vivo"],[u,g]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[h,[d,"Realme"],[u,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[h,[d,he],[u,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[h,[d,he],[u,b]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[h,[d,Pt],[u,b]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[h,[d,Pt],[u,g]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[h,[d,oi],[u,b]],[/(nokia) (t[12][01])/i],[d,h,[u,b]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[h,/_/g," "],[u,g],[d,"Nokia"]],[/(pixel (c|tablet))\b/i],[h,[d,At],[u,b]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[h,[d,At],[u,g]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[h,[d,Je],[u,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[h,"Xperia Tablet"],[d,Je],[u,b]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[h,[d,Le],[u,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[h,[d,E],[u,b]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[h,/(.+)/g,"Fire Phone $1"],[d,E],[u,g]],[/(playbook);[-\w\),; ]+(rim)/i],[h,d,[u,b]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[h,[d,Y],[u,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[h,[d,H],[u,b]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[h,[d,H],[u,g]],[/(nexus 9)/i],[h,[d,"HTC"],[u,b]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[d,[h,/_/g," "],[u,g]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[h,[d,"TCL"],[u,b]],[/(itel) ((\w+))/i],[[d,is],h,[u,rs,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[h,[d,"Acer"],[u,b]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[h,[d,"Meizu"],[u,g]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[h,[d,"Ulefone"],[u,g]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[h,[d,"Energizer"],[u,g]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[h,[d,"Cat"],[u,g]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[h,[d,"Smartfren"],[u,g]],[/droid.+; (a(?:015|06[35]|142p?))/i],[h,[d,"Nothing"],[u,g]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[h,[d,"Archos"],[u,b]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[h,[d,"Archos"],[u,g]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[d,h,[u,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[d,h,[u,g]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[d,h,[u,b]],[/(surface duo)/i],[h,[d,Qt],[u,b]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[h,[d,"Fairphone"],[u,g]],[/(u304aa)/i],[h,[d,"AT&T"],[u,g]],[/\bsie-(\w*)/i],[h,[d,"Siemens"],[u,g]],[/\b(rct\w+) b/i],[h,[d,"RCA"],[u,b]],[/\b(venue[\d ]{2,7}) b/i],[h,[d,"Dell"],[u,b]],[/\b(q(?:mv|ta)\w+) b/i],[h,[d,"Verizon"],[u,b]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[h,[d,"Barnes & Noble"],[u,b]],[/\b(tm\d{3}\w+) b/i],[h,[d,"NuVision"],[u,b]],[/\b(k88) b/i],[h,[d,"ZTE"],[u,b]],[/\b(nx\d{3}j) b/i],[h,[d,"ZTE"],[u,g]],[/\b(gen\d{3}) b.+49h/i],[h,[d,"Swiss"],[u,g]],[/\b(zur\d{3}) b/i],[h,[d,"Swiss"],[u,b]],[/\b((zeki)?tb.*\b) b/i],[h,[d,"Zeki"],[u,b]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[d,"Dragon Touch"],h,[u,b]],[/\b(ns-?\w{0,9}) b/i],[h,[d,"Insignia"],[u,b]],[/\b((nxa|next)-?\w{0,9}) b/i],[h,[d,"NextBook"],[u,b]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[d,"Voice"],h,[u,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[d,"LvTel"],h,[u,g]],[/\b(ph-1) /i],[h,[d,"Essential"],[u,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[h,[d,"Envizen"],[u,b]],[/\b(trio[-\w\. ]+) b/i],[h,[d,"MachSpeed"],[u,b]],[/\btu_(1491) b/i],[h,[d,"Rotor"],[u,b]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[h,[d,ke],[u,b]],[/(sprint) (\w+)/i],[d,h,[u,g]],[/(kin\.[onetw]{3})/i],[[h,/\./g," "],[d,Qt],[u,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[h,[d,Tr],[u,b]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[h,[d,Tr],[u,g]],[/smart-tv.+(samsung)/i],[d,[u,S]],[/hbbtv.+maple;(\d+)/i],[[h,/^/,"SmartTV"],[d,je],[u,S]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[d,Pt],[u,S]],[/(apple) ?tv/i],[d,[h,z+" TV"],[u,S]],[/crkey/i],[[h,j+"cast"],[d,At],[u,S]],[/droid.+aft(\w+)( bui|\))/i],[h,[d,E],[u,S]],[/(shield \w+ tv)/i],[h,[d,ke],[u,S]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[h,[d,es],[u,S]],[/(bravia[\w ]+)( bui|\))/i],[h,[d,Je],[u,S]],[/(mi(tv|box)-?\w+) bui/i],[h,[d,me],[u,S]],[/Hbbtv.*(technisat) (.*);/i],[d,h,[u,S]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[d,Mr],[h,Mr],[u,S]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[h,[u,S]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,S]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[d,h,[u,w]],[/droid.+; (shield)( bui|\))/i],[h,[d,ke],[u,w]],[/(playstation \w+)/i],[h,[d,Je],[u,w]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[h,[d,Qt],[u,w]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[h,[d,je],[u,C]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[d,h,[u,C]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[h,[d,Ii],[u,C]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[h,[d,z],[u,C]],[/(opwwe\d{3})/i],[h,[d,Le],[u,C]],[/(moto 360)/i],[h,[d,he],[u,C]],[/(smartwatch 3)/i],[h,[d,Je],[u,C]],[/(g watch r)/i],[h,[d,Pt],[u,C]],[/droid.+; (wt63?0{2,3})\)/i],[h,[d,Tr],[u,C]],[/droid.+; (glass) \d/i],[h,[d,At],[u,C]],[/(pico) (4|neo3(?: link|pro)?)/i],[d,h,[u,C]],[/; (quest( \d| pro)?)/i],[h,[d,Ln],[u,C]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[d,[u,T]],[/(aeobc)\b/i],[h,[d,E],[u,T]],[/(homepod).+mac os/i],[h,[d,z],[u,T]],[/windows iot/i],[[u,T]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[h,[u,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[h,[u,b]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,b]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,g]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[h,[d,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[f,[m,dt+"HTML"]],[/(arkweb)\/([\w\.]+)/i],[m,f],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[f,[m,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[m,f],[/ladybird\//i],[[m,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[f,m]],os:[[/microsoft (windows) (vista|xp)/i],[m,f],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[m,[f,rs,qn]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,rs,qn],[m,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[f,/_/g,"."],[m,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[m,Fn],[f,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[f,m],[/(ubuntu) ([\w\.]+) like android/i],[[m,/(.+)/,"$1 Touch"],f],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[m,f],[/\(bb(10);/i],[f,[m,Y]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[f,[m,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[f,[m,ot+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[f,[m,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[f,[m,"watchOS"]],[/crkey\/([\d\.]+)/i],[f,[m,j+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[m,zn],f],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[m,f],[/(sunos) ?([\w\.\d]*)/i],[[m,"Solaris"],f],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[m,f]]},ue=function(G,Z){if(typeof G===p&&(Z=G,G=s),!(this instanceof ue))return new ue(G,Z).getResult();var U=typeof e!==l&&e.navigator?e.navigator:s,at=G||(U&&U.userAgent?U.userAgent:n),Fe=U&&U.userAgentData?U.userAgentData:s,be=Z?$c(Nn,Z):Nn,et=U&&U.userAgent==at;return this.getBrowser=function(){var q={};return q[m]=s,q[f]=s,ss.call(q,at,be.browser),q[y]=Hc(q[f]),et&&U&&U.brave&&typeof U.brave.isBrave==a&&(q[m]="Brave"),q},this.getCPU=function(){var q={};return q[v]=s,ss.call(q,at,be.cpu),q},this.getDevice=function(){var q={};return q[d]=s,q[h]=s,q[u]=s,ss.call(q,at,be.device),et&&!q[u]&&Fe&&Fe.mobile&&(q[u]=g),et&&q[h]=="Macintosh"&&U&&typeof U.standalone!==l&&U.maxTouchPoints&&U.maxTouchPoints>2&&(q[h]="iPad",q[u]=b),q},this.getEngine=function(){var q={};return q[m]=s,q[f]=s,ss.call(q,at,be.engine),q},this.getOS=function(){var q={};return q[m]=s,q[f]=s,ss.call(q,at,be.os),et&&!q[m]&&Fe&&Fe.platform&&Fe.platform!="Unknown"&&(q[m]=Fe.platform.replace(/chrome os/i,zn).replace(/macos/i,Fn)),q},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return at},this.setUA=function(q){return at=typeof q===_&&q.length>P?Mr(q,P):q,this},this.setUA(at),this};ue.VERSION=r,ue.BROWSER=Ps([m,f,y]),ue.CPU=Ps([v]),ue.DEVICE=Ps([h,d,u,w,g,S,b,C,T]),ue.ENGINE=ue.OS=Ps([m,f]),i.exports&&(t=i.exports=ue),t.UAParser=ue;var Ei=typeof e!==l&&(e.jQuery||e.Zepto);if(Ei&&!Ei.ua){var Is=new ue;Ei.ua=Is.getResult(),Ei.ua.get=function(){return Is.getUA()},Ei.ua.set=function(G){Is.setUA(G);var Z=Is.getResult();for(var U in Z)Ei.ua[U]=Z[U]}}})(typeof window=="object"?window:ml)})(ys,ys.exports)),ys.exports}var _l=ul(),_r=(i=>(i.LOCAL="local",i.SESSION="session",i))(_r||{});function rn(i){let t;try{t=i==="local"?window.localStorage:window.sessionStorage;const e="__storage_test__";return t.setItem(e,e),t.removeItem(e),!0}catch(e){return e instanceof DOMException&&(e.code===22||e.code===1014||e.name==="QuotaExceededError"||e.name==="NS_ERROR_DOM_QUOTA_REACHED")&&t&&t.length!==0}}function za(i){return i.type==="device"&&i.value==="iPhone6"?!!(le.ios&&window.outerHeight===667&&window.outerWidth===375&&window.devicePixelRatio===3):!1}function Fa(i){return i.type==="device"&&i.value==="s5"?!!(le.android&&window.outerHeight===560&&window.outerWidth===360&&window.devicePixelRatio===3):!1}function Da(i){if(!(i.type==="device"&&i.value==="kindle"))return!1;const t=navigator.userAgent;return/Kindle|Silk|KFAPW|KFARWI|KFASWI|KFFOWI|KFJW|KFMEWI|KFOT|KFSAW|KFSOWI|KFTBW|KFTHW|KFTT|WFFOWI/i.test(t)}function Ra(i){var t,e;if(!(i.type==="browser"&&i.value==="safari-18.4"))return!1;const s=le.uaData,r=(t=s?.browser)==null?void 0:t.version;if(((e=s?.browser)==null?void 0:e.name)==="Mobile Safari"){if(!r)return!1;const[o,a]=r.split(".").map(Number);if(o===18&&a===4)return!0}return!1}function qa(i){var t,e;if(!(i.type==="browser"&&i.value==="safari-18"))return!1;const s=le.uaData,r=(t=s?.browser)==null?void 0:t.version;if(((e=s?.browser)==null?void 0:e.name)==="Mobile Safari"){if(!r)return!1;const[o]=r.split(".").map(Number);if(o===18)return!0}return!1}class Na{constructor(){this.allowGPUData=!0,this.customQueries=[],this.caches={query:{},browser:{},os:{},device:{},custom:{}},this.uaData=new _l.UAParser().getResult(),this.isLocalStorageAllowed=rn(_r.LOCAL),this.isSessionStorageAllowed=rn(_r.SESSION),this._checkIPadPro()}get supportedFileFormats(){return console.warn("[Device] File format detection is no longer supported. Returning default values of false"),{webp:!1,avif:!1}}get desktop(){return!(this.uaData.device.type==="tablet"||this.uaData.device.type==="mobile")}get mobile(){return this.isDevice("mobile")}get phone(){return this.isDevice("phone")}get tablet(){return this.isDevice("tablet")}get android(){return this.uaData.os.name==="Android"}get ios(){return this.uaData.os.name==="iOS"||this.uaData.os.name==="Mac OS"&&this.uaData.device.type==="tablet"}get kindle(){return this.isDevice("kindle")}get ie(){return this.uaData.browser.name==="IE"}get gpu(){return console.warn("[Device] GPU data is no longer supported. Returning default value of 2"),2}async init(){this.gpuData||(this.gpuData={tier:2,type:null})}addQuery(...t){this.customQueries.push(...t)}query(t){const e=this.checkCache(t,"query");if(e!==null)return e;const s=this.parseQuery(t);let r=!0;for(const n of s){const o=n;switch(o.type){case"browser":r=this.isBrowser(o.value);break;case"os":r=this.isOS(o.value);break;case"device":r=this.isDevice(o.value);break;case"gpu":console.warn("[Device] GPU data is no longer supported. Returning default value of 2"),r=this.isGPU(o.value);break;default:r=this.checkCustom(o);break}if(!r)break}return this.addToCache(t,r,"query"),r}isBrowser(t){const e=this.checkCache(t,"browser");if(e!==null)return e;const s=[()=>this.checkCustom({type:"browser",value:t}),()=>{const r=t.split(":");return r.length>1?this.uaData.browser.version.split(".")[0]===r[1]:!1},()=>this.uaData.browser.name.toLowerCase().replace(" ","-")===t];return this.checkTests(s,t,"browser")}isOS(t){const e=this.checkCache(t,"os");if(e!==null)return e;const s=[()=>this.checkCustom({type:"os",value:t}),()=>{const r=t.split(":");return r.length>1?this.uaData.os.version.split(".")[0]===r[1]:!1},()=>t==="mobile"||t==="desktop"?t==="mobile"?!this.desktop:this.desktop:!1,()=>this.uaData.os.name.toLowerCase().replace(" ","-")===t];return this.checkTests(s,t,"os")}isDevice(t){const e=this.checkCache(t,"device");if(e!==null)return e;const s=[()=>this.checkCustom({type:"device",value:t}),()=>t==="tablet"?this.uaData.device.type==="tablet":!1,()=>t==="mobile"?this.uaData.device.type==="tablet"||this.uaData.device.type==="mobile":!1,()=>t==="phone"?this.uaData.device.type==="mobile":!1,()=>this.uaData.device.model===t];return this.checkTests(s,t,"device")}isGPU(t){return this.gpu===Number(t)}parseQuery(t){return t.split("--").map(e=>{const s=e.split(":").filter(r=>r!==":");return{type:s.shift(),value:s.join(":")}})}checkCustom(t){const e=this.checkCache(JSON.stringify(t),"custom");if(e!==null)return e;for(const s of this.customQueries)if(s(t))return this.addToCache(JSON.stringify(t),!0,"custom"),!0;return this.addToCache(JSON.stringify(t),!1,"custom"),!1}checkCache(t,e){return this.caches[e][t]?this.caches[e][t]:null}checkTests(t,e,s){let r=!1;for(const n of t)if(r=n(),r)break;return this.addToCache(e,r,s),r}addToCache(t,e,s){this.caches[s][t]=e}_checkIPadPro(){const t=this.uaData.ua,e=t.includes("Mac OS")&&!t.includes("like Mac OS"),s="ontouchstart"in window;e&&s&&(this.uaData.device.type="tablet",this.uaData.device.vendor="apple",this.uaData.device.model="ipad-pro",console.warn("[Device]: OS cannot be determined on this device"))}}const le=new Na;le.addQuery(za,Fa,Da,Ra,qa);hl();class Oa extends Qi{constructor(){super(...arguments),this.initialised=new Ba}async setup(){le.isBrowser("safari-18")&&(Gc.ogg=!1,console.warn("iOS 18 has a bug with ogg support. Ogg files have been disabled.")),await X.init(this.options),this.initialised.resolve()}async load(t){return La("8.4.0","Please use PixiJS Assets instead of ResourcePlugin. e.g Assets.load()"),typeof t=="string"?X.load(t):t.map(e=>X.load(e))}}wa.remove(sn,en);wa.add(Va,Ea,ka);const pl={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",space:" "};class nn{constructor(){this.map={}}add(t){Object.entries(pl).forEach(([s,r])=>{s===t.key&&(t.key=r)});const e=this.map[t.key]||[];e.push(t),this.map[t.key]=e}remove(t){const e=this.map[t.key];if(!e)return;const s=e.indexOf(t);s<0||e.splice(s,1)}bindingsByKey(t){return this.map[t]||[]}}class $a extends Qi{constructor(t,e){super(t,e),this.enabled=!0,this._onKeyDown=s=>{if(!this.enabled||s.repeat)return;const r=s.key,n=this._keyDownBindings.bindingsByKey(r);for(const o of n)o.action&&o.action(),o.isDown=!0},this._onBlur=()=>{if(!this.enabled)return;const s=this._keyDownBindings.map;for(const r in s){const n=s[r];for(const o of n)o.isDown&&this._keyUpBindings.bindingsByKey(o.key).forEach(a=>{var l;(l=a.action)==null||l.call(a)}),o.isDown=!1}},this._onKeyUp=s=>{if(!this.enabled||s.repeat)return;const r=s.key;let n=this._keyUpBindings.bindingsByKey(r);for(const o of n)o.action&&o.action(),o.isDown=!1;n=this._keyDownBindings.bindingsByKey(r);for(const o of n)o.isDown=!1},this._keyDownBindings=new nn,this._keyUpBindings=new nn,window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),window.addEventListener("blur",this._onBlur)}dispose(){this._keyDownBindings.map={},this._keyUpBindings.map={},window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),window.removeEventListener("blur",this._onBlur)}bindKeyDown(t,e,s){return typeof t=="string"?this._bindKeyDown(t,e,s):t.map(r=>this._bindKeyDown(r,e,s))}_bindKeyDown(t,e,s){const r=s?.allowHold||!1,n=s?.holdTime||.1,o={key:t,action:e,allowHold:r,currentHoldTime:n,holdTime:n};return this._keyDownBindings.add(o),o}bindKeyUp(t,e){return typeof t=="string"?this._bindKeyUp(t,e):t.map(s=>this.bindKeyUp(s,e))}_bindKeyUp(t,e){const s={key:t,action:e};return this._keyUpBindings.add(s),s}unbind(t){this._keyDownBindings.remove(t),this._keyUpBindings.remove(t)}update(t){const e=this._keyDownBindings.map;for(const s in e){const r=e[s];for(const n of r){const o=n;o.allowHold&&o.isDown&&(o.currentHoldTime>=0?o.currentHoldTime-=t/60:(o.currentHoldTime=o.holdTime,o.action&&o.action()))}}}getBindings(t){return this._keyDownBindings.bindingsByKey(t)}isKeyDown(t){if(typeof t=="string")return this._isKeyDown(t);const e=t.map(s=>this._isKeyDown(s));for(const s of e)if(s===!0)return!0;return!1}_isKeyDown(t){let e=!1;const s=this.getBindings(t);if(!s)return!1;for(const r in s)if(s[r].isDown){e=!0;break}return e}}class _n{constructor(t){this._enabled=!0,this._bubble=!0,this._down=!1,this._tapLock=new Zc,this._source=t,t?.on("pointertap",e=>{this._onTap(e)}).on("pointerdown",e=>{this._onDown(e)}).on("pointerup",e=>{this._onUp(e)}).on("pointerupoutside",e=>{this._onUp(e)}).on("pointerout",e=>{var s;(s=this.onOut)==null||s.call(this,this._convertEvent(e))}).on("pointermove",e=>{var s;(s=this.onMove)==null||s.call(this,this._convertEvent(e))}),this._updateEnabled()}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._updateEnabled()}get bubble(){return this._bubble}set bubble(t){this._bubble=t}async triggerTap(){this._down=!0,await this._onTap({pointerId:0,global:{x:0,y:0}})}_updateEnabled(){const t=this._source;t.interactive=this.enabled,t.cursor=this.enabled?"pointer":"default"}async _onTap(t){var e;this._bubble||t?.stopImmediatePropagation(),this._down&&this._tapLock.lock()&&(await((e=this.onTap)==null?void 0:e.call(this,this._convertEvent(t))),this._tapLock.unlock()),this._down=!1}_onDown(t){var e;this._bubble||t?.stopImmediatePropagation(),this._down=!0,(e=this.onDown)==null||e.call(this,this._convertEvent(t))}_onUp(t){var e;(e=this.onUp)!=null&&e.call(this,this._convertEvent(t))&&(this._down=!1)}_convertEvent(t){return{id:t.pointerId,position:new Bs(t.global.x,t.global.y)}}}function Ha(){return Math.min(window.devicePixelRatio,2)}function Ua(){return le.desktop}function Wa(){const i=document.createElement("canvas");let t,e,s,r=!1;try{t=i.getContext("webgl"),e=t.getExtension("WEBGL_debug_renderer_info"),s=t.getParameter(e.UNMASKED_RENDERER_WEBGL);const n=s.substring(0,8);(n==="Mali-400"||n==="Mali-450")&&(r=!0)}catch{console.warn("WebGL or renderer info not supported!")}return r}le.android||le.ios;class Ee extends Qi{constructor(t,e){super(t,e),e.resolution=e.resolution??Ha(),e.antialias=e.antialias??Ua(),e.powerPreference=e.powerPreference??"high-performance",e.backgroundAlpha=e.backgroundAlpha??Wa()?0:1,this.canvas=e.canvas=e.canvas||this._setupCanvas(),this.wrapper=document.createElement("div"),this.wrapper.style.transformOrigin="0 0",this.wrapper.appendChild(e.canvas),(e.autoAddToDocument??!0)&&document.body.appendChild(this.wrapper),this.stage=new Ct,this.mainContainer=new Ct,this.overlayContainer=new Ct,this.stage.addChild(this.mainContainer),this.stage.addChild(this.overlayContainer),this.useHalfFPS=e.useHalfFPS??!1,this._halfTick=0,this.rendererPromise=Kc({canvas:this.canvas,...this.options})}async init(){this.renderer=await this.rendererPromise,this.renderer.accessibility&&(this.renderer.accessibility.debug=this.options.accessibilityDebug??!1,(this.options.alwaysOnAccessibility??!1)&&(this.renderer.accessibility._isMobileAccessibility=!0,this.renderer.accessibility._activate(),this.renderer.accessibility._destroyTouchHook()))}_setupCanvas(){const t=document.createElement("canvas");return t.id="pixi-canvas",t.style.position="absolute",t.style.left="0px",t.style.right="0px",t.style.top="0px",t.style.bottom="0px",t.style.width="100%",t.style.height="100%",t.style.overflow="visible",t.style.display="block",t.style.margin="0 auto",t}start(){this.app.updateRunner.remove(this.update),this.app.updateRunner.add(this.update)}update(t){(!le.ios||t>.8)&&(this._halfTick++,(!this.useHalfFPS||this._halfTick%2)&&this.renderer.render(this.stage))}get view(){return this.renderer.canvas}get element(){return this.renderer.canvas}set interactive(t){this.stage.interactive=t,this.stage.interactiveChildren=t}get interactive(){return this.stage.interactive}}function Ya(i,t){return{rendererWidth:i,rendererHeight:t,canvasWidth:i,canvasHeight:t}}class pn extends Qi{constructor(t,e){var s;super(t,e),this.onResize=new Ki.Signal,this._w=0,this._h=0,this._canvasWidth=0,this._canvasHeight=0,this.autoResize=e.autoResize??!0,this.resizeFunction=e?.resizeFunction||Ya,this.fitToCanvasParent=e.fitToCanvasParent,this.orientationLock=e.orientationLock??"none",((s=screen?.orientation)==null?void 0:s.type)===void 0&&(this.orientationLock="none")}prepare(){var t,e;if(this.orientationLock!=="none"&&this._overrideMapPositionToPoint(),this.autoResize){const s=(e=(t=this.app.get(Ee))==null?void 0:t.view)==null?void 0:e.parentElement,r=this.fitToCanvasParent?s:null;window.addEventListener("resize",()=>{const{width:a,height:l}=this._getMeasurements(r);Aa(this.resize,le.desktop?0:100,this)(a,l)});const{width:n,height:o}=this._getMeasurements(r);this.resize(n,o)}}_getMeasurements(t){if(!t||!this.fitToCanvasParent)return{width:t?.clientWidth??window.innerWidth,height:t?.clientHeight??window.innerHeight};const e=this.app.get(Ee),s=e?.canvas;if(!s?.style)return{width:t.clientWidth,height:t.clientHeight};const r=s.style.display,n=r!=="none";try{n&&(s.style.display="none");const o=t.clientWidth,a=t.clientHeight;return{width:o,height:a}}finally{n&&(s.style.display=r)}}_overrideMapPositionToPoint(){Xc.prototype.mapPositionToPoint=(t,e,s)=>{const r=1/this.resolution,o=this.app.get(Ee).canvas,a=o.width,l=o.height,p=parseFloat(o.style.width),_=parseFloat(o.style.height),y=this.orientationLock==="portrait",h={x:e,y:s};switch(screen.orientation.type){case"portrait-primary":y||(h.x=s,h.y=_-e);break;case"landscape-primary":y&&(h.x=p-s,h.y=e);break;case"landscape-secondary":y&&(h.x=s,h.y=_-e);break;case"portrait-secondary":y||(h.y=p-s);break}t.x=h.x*(a/p)*r,t.y=h.y*(l/_)*r}}set resolution(t){const e=this.app.get(Ee).renderer;e.resolution=t,this.resize(this._w,this._h,!0)}get resolution(){return this.app.get(Ee).renderer.resolution}resize(t,e,s=!1){var r;const n=this.app.get(Ee),o=n.renderer,a=((r=screen?.orientation)==null?void 0:r.type)??"unknown",l=this.orientationLock==="none"||a.includes(this.orientationLock),{canvasWidth:p,canvasHeight:_,rendererWidth:y,rendererHeight:h}=l?this.resizeFunction(t,e):this.resizeFunction(e,t);if(s||this._w!==y||this._h!==h||this._canvasWidth!==p||this._canvasHeight!==_||this.currentOrientation!==a){this._w=y,this._h=h,this._canvasWidth=p,this._canvasHeight=_,this.currentOrientation=a;const m=n.canvas;if(m.style.width=`${p}px`,m.style.height=`${_}px`,this.orientationLock!=="none"&&this.currentOrientation!=="unknown"){const u=this.orientationLock==="portrait";switch(a){case"portrait-primary":n.wrapper.style.transform=u?"":`rotate(90deg) translate(0, -${_}px)`;break;case"landscape-primary":n.wrapper.style.transform=u?`rotate(-90deg) translate(-${p}px, 0)`:"";break;case"landscape-secondary":n.wrapper.style.transform=u?`rotate(90deg) translate(0, -${_}px)`:"";break;case"portrait-secondary":n.wrapper.style.transform=u?"":`rotate(-90deg) translate(-${p}px, 0)`;break}}window.scrollTo(0,0),o.resize(this.w,this.h),this.onResize.emit(this.w,this.h)}}get w(){return this._w}get h(){return this._h}get width(){return this._w}get height(){return this._h}get canvasWidth(){return this._canvasWidth}get canvasHeight(){return this._canvasHeight}get isCorrectOrientation(){return this.orientationLock==="none"||this.currentOrientation.includes(this.orientationLock)}}class on{constructor(t){this.app=t,this.view=new Ct}async init(){}async show(){}shown(){}async hide(){}async hidden(){}resize(t,e){}}class ja{constructor(){this.history=[],this.currentIndex=-1}navigate(t,e){this.history=this.history.slice(0,this.currentIndex+1),this.history.push({id:t,data:e}),this.currentIndex++}back(){return this.canGoBack()?(this.currentIndex--,this.currentScreen()):null}forward(){return this.canGoForward()?(this.currentIndex++,this.currentScreen()):null}canGoBack(){return this.currentIndex>0}canGoForward(){return this.currentIndex<this.history.length-1}currentScreen(){return this.history[this.currentIndex]}}class Ja extends Ct{constructor(t={}){super(),this.barWidth=t.width??100;const e=this.getPixiObject(t.bg,this.barWidth),s=this.getPixiObject(t.frame,this.barWidth),r=this.getPixiObject(t.bar??16711680,this.barWidth);t.frameTint!==void 0&&(s.tint=4144959),this._easing=t.easing??1,this._easeRatio=0,this._ratio=0,e&&(this.bg=e,this.addChild(e)),r&&(this.addChild(r),this.bar=r),s&&(s.width>r.width&&(s.x=-(s.width-r.width)/2),s.height>r.height&&(s.y=-(s.height-r.height)/2),this.addChild(s));const n=this.getPixiObject(t.mask,this.barWidth);n&&(this._barMask=n,this.addChild(this._barMask),this.bar.mask=this._barMask,this._barMask.x-=this.bar.width),this.onRender=this._updateTransform}_updateTransform(){this._easeRatio+=(this._ratio-this._easeRatio)*this._easing,this.bar&&!this._barMask?this.bar.scale.x=this._easeRatio:this._barMask&&(this._barMask.x=-this._barMask.width+this._barMask.width/100*(this._easeRatio*100))}getPixiObject(t,e){let s=null;return typeof t=="number"?(s=new ba,s.context.fill({color:t}).rect(0,0,e,40)):typeof t=="string"?s=ae.from(t):s=t,s}set ratio(t){this._ratio=Math.max(Math.min(t,1),0)}get ratio(){return this._ratio}}class Ga{constructor(){this.view=new Ct,this.bar=new Ja({bg:0,bar:16711680,width:300}),this.view.addChild(this.bar)}updateProgress(t){this.bar.ratio=t}show(){this.view.alpha=0,we.to(this.view,.4,{alpha:1})}hide(){return new Promise(t=>{we.to(this.view,.4,{alpha:0,onComplete:t})})}resize(t,e){this.bar.x=t/2-this.bar.barWidth/2,this.bar.y=e/2}}class Ka{constructor(){this._transitionMap={}}get default(){return this._transitionMap.all?this._transitionMap.all.all:null}set default(t){"transition"in t?this.register(t):this.register({transition:t})}register(t){const e={from:"all",to:"all",both:!1},s=Object.fromEntries(Object.entries(t).filter(([_,y])=>y!=null)),{from:r,to:n,both:o,transition:a,...l}={...e,...s};let p=this._transitionMap[r];p||(p=this._transitionMap[r]={}),p[n]={transition:a,...l},o&&this.register({transition:a,from:n,to:r,...l})}get(t,e){const s=(r,n)=>this._transitionMap[r]?this._transitionMap[r][n]||this._transitionMap[r].all:null;return s(t,e)||s("all",e)||this.default}}class Xa{constructor(t={}){this.autoManageContainers=!0,this.duration=.4,this.prepare(t)}prepare(t){this.duration=t.duration||this.duration}hide(t,e){return new Promise(s=>{we.to(e.view,{duration:this.duration,alpha:0,onComplete:()=>{e.view.alpha=1,s()}})})}show(t,e,s){return new Promise(r=>{s.view.alpha=0,we.to(s.view,{duration:this.duration,alpha:1,onComplete:()=>{r()}})})}}class an{constructor(t,e){this.onChange=new Ki.Signal,this.onShown=new Ki.Signal,this.w=0,this.h=0,this.history=new ja,this._loaderActive=!1,this._applyLoaderAsOverlay=!1,this._loadingScreenDelay=1e3,this.options=e,this.app=t,this.view=e?.view||new Ct,this.transitionManager=new Ka,e?.defaultTransitionClass?this.transitionManager.default=new e.defaultTransitionClass(e.defaultTransitionOptions):this.transitionManager.default=new Xa(e?.defaultTransitionOptions),this.screens={},this.add(on,{},"empty",!0),this.currentScreenId="empty",this.visibleScreens=[],this._applyLoaderAsOverlay=e?.applyLoaderAsOverlay??!1,this._loadingScreenDelay=e?.loadingScreenDelay??1e3}getVisibleScreens(){return this.visibleScreens.map(t=>t.instance)}get(t){var e;return(e=this.screens[t])==null?void 0:e.instance}getScreen(t){return this.get(t)}add(t,e,s,r=!1){if(this.screens[s])throw new Error(`Screen id ${s} has already been assigned`);const n={instance:null,class:t,options:e,id:s};r&&(n.instance=new t(this.app,n.options)),this.screens[s]=n}async back(){const t=this.history.back();t&&await this.show(t.id,{force:!0,data:t.data},!0)}async forward(){const t=this.history.forward();t&&await this.show(t.id,{force:!0,data:t.data},!0)}async show(t,e={},s=!1){if(!(this.currentScreenId===t&&!e.force)){if(!this.screens[t])throw new Error(`Screen id ${t} does not exist`);if(this.nextScreenId=t,this.nextData=e,this.transitionPromise){if(this.nextScreenId===t)return;await this.transitionPromise;return}else if(this.currentScreenId===t&&!e.force)return;this.onChange.emit(t,e),this.transitionPromise=this.createTransitionPromise(this.nextData.data,s,this.nextData.transitionOptions),await this.transitionPromise,this.transitionPromise=null,this.onShown.emit(t,e)}}async goto(t,e={}){return this.show(t,e)}async hide(){return this.show("empty")}async preloadScreen(t,e){var s,r;const n=this.screens[t];if(!n)throw new Error(`Screen id ${t} does not exist`);const o=n.instance;n.instance||(n.instance=new n.class(this.app,n.options)),await this._loadScreen(n,e?.data),o||await((r=(s=n.instance).init)==null?void 0:r.call(s,n.options))}createTransitionPromise(t,e=!1,s){return new Promise(async r=>{var n,o,a,l,p,_,y,h,m,u,d,f;this.view.interactiveChildren=!1;const{transition:v,loadingScreenDelay:w,applyLoaderAsOverlay:g,loaderOptions:b,loaderScreenClass:S,loadBeforeTransition:C}=s??this.transitionManager.get(this.currentScreenId,this.nextScreenId),T=v.autoManageContainers,P=this.screens[this.currentScreenId],E=this.screens[this.nextScreenId],z=!E.instance,H=this.currentScreenId==="empty"||P?.instance instanceof on,Y=g??this._applyLoaderAsOverlay;z&&(E.instance=new E.class(this.app,E.options));let W=Promise.resolve(),j=!1,dt=this.loader;const ot=C??this.options.loadBeforeTransition;W=this._loadScreen(E,t).then(()=>{var lt;j=!0,(lt=dt?.complete)==null||lt.call(dt)}),ot&&(dt=this._initLoader(S,b),await this._awaitLoad(W,w??this._loadingScreenDelay,j,async()=>{})),await((n=v.prepare)==null?void 0:n.call(v,s?.data||{})),(o=v.resize)==null||o.call(v,this.w,this.h),P&&(await((l=(a=P.instance).hide)==null?void 0:l.call(a)),(!H||H&&v.forceHideOnEmptyScreen)&&await v.hide(this.view,P.instance,E.instance),Y||this._hideScreen(P,T)),ot?z&&await((_=(p=E.instance).init)==null?void 0:_.call(p,E.options)):(dt=this._initLoader(),await this._awaitLoad(W,w??this._loadingScreenDelay,j,async()=>{var lt,rt;z&&await((rt=(lt=E.instance).init)==null?void 0:rt.call(lt,E.options))})),this.currentScreenId=E.id,e||this.history.navigate(this.currentScreenId,t),Y&&this._hideScreen(P,T),await((h=(y=E.instance).prepare)==null?void 0:h.call(y,t)),E.instance.resize(this.w,this.h),await((u=(m=E.instance).show)==null?void 0:u.call(m)),this.view.interactiveChildren=!0,this.visibleScreens.push(E),T&&this.view.addChild(E.instance.view),await v.show(this.view,P?.instance,E.instance),(f=(d=E.instance).shown)==null||f.call(d);const At=this.visibleScreens.indexOf(P);At!==-1&&this.visibleScreens.splice(At,1),this.currentScreenId!==this.nextScreenId&&await this.createTransitionPromise(this.nextData.data,void 0,this.nextData.transitionOptions),r()})}resize(t,e){this.w=t,this.h=e,this.screens[this.currentScreenId]&&this.screens[this.currentScreenId].instance.resize(t,e),this.loader&&this.loader.resize(t,e)}update(t){var e,s;const r=this.visibleScreens;for(const n of r)n.instance.update&&n.instance.update(t);this._loaderActive&&((s=(e=this.loader).update)==null||s.call(e,t))}_initLoader(t,e){var s,r,n,o,a;if(this.loader)(a=(o=this.loader).prepare)==null||a.call(o,e??this.options.loaderOptions??{}),this.loader.resize(this.w,this.h);else{const l=t??(((s=this.options)==null?void 0:s.loaderScreenClass)||Ga);this.loader=new l(this.app),(n=(r=this.loader).prepare)==null||n.call(r,e??this.options.loaderOptions??{}),this.loader.resize(this.w,this.h)}return this.loader}async _awaitLoad(t,e,s,r){const n=setTimeout(()=>{var o,a;s||(this.view.addChild(this.loader.view),this.loader.show(),(a=(o=this.loader).start)==null||a.call(o),this._loaderActive=!0)},e);await t,await r(),this._loaderActive?(await this.loader.hide(),this._loaderActive=!1,this.view.removeChild(this.loader.view)):clearTimeout(n)}_loadScreen(t,e){return new Promise(async s=>{const r=t.instance,n=[],o=[],a=[];let l=0,p=0,_=0,y=0;if(r.preload&&r.preload){const h=await r.preload(e);h&&(n.push(...h.manifests??[]),o.push(...h.assets??[]),a.push(...h.promises??[]))}(r.manifests||r.assets)&&(r.manifests&&n.push(...r.manifests),r.assets&&o.push(...r.assets)),n.length&&++y,o.length&&++y,a.length&&++y,await Promise.all([X.loadBundle(n,h=>{var m,u;l=h,(u=(m=this.loader)==null?void 0:m.updateProgress)==null||u.call(m,(l+p+_)/y)}),X.load(o,h=>{var m,u;p=h,(u=(m=this.loader)==null?void 0:m.updateProgress)==null||u.call(m,(l+p+_)/y)}),...a.map(async h=>{var m,u;await h,_+=1/a.length,(u=(m=this.loader)==null?void 0:m.updateProgress)==null||u.call(m,(l+p+_)/y)})]),s()})}_hideScreen(t,e){e&&this.view.removeChild(t?.instance.view),t?.instance.hidden&&t.instance.hidden()}}class dn extends Qi{constructor(t,e){super(t,e),this.w=0,this.h=0,this.stack=[],this.view=new Ct;const s={},r=e?.config?Object.entries(e.config):[];if(r.find(([n])=>n==="main")||r.unshift(["main",{options:e.main}]),!r.find(([n])=>n==="overlay")){const n=r.findIndex(([o])=>o==="main");r.splice(n+1,0,["overlay",{options:e.overlay}])}r.forEach(([n,o])=>{var a;const l=new an(this.app,o.options);this.view.addChild(l.view),s[n]=l,this.stack.push(l);for(const p in o.screens){const _=o.screens[p],y=typeof _=="function",h=y?_:_.screen,m=y?{}:_.options,u=y?!1:_.async;l.add(h,m,p,u),!y&&((a=_.transitions)==null||a.forEach(d=>{l.transitionManager.register({...d,from:d.from??p})}))}}),this.layers=s}get main(){return this.layers.main}get overlay(){return this.layers.overlay}prepare(){const t=this.app.get(pn),e=this.app.get(Ee);t&&(t.onResize.connect(this.resize.bind(this)),this.resize(t.w,t.h)),e.mainContainer.addChild(this.view)}add(t,e,s,r=!1){this.addToLayer("main",t,e,s,r)}addToLayer(t,e,s,r,n=!1){const o=this.layers[t];if(!o)throw new Error(`Layer ${t} does not exist`);o.add(e,s,r,n)}addScreens(t){t.forEach(e=>{var s;const r=this.layers[e.layer];r.add(e.screen,e.options,e.id,e.async),(s=e.transitions)==null||s.forEach(n=>{r.transitionManager.register({...n,from:n.from??e.id})})})}async goto(t,e={}){return this.main.goto(t,e)}getLayer(t){return this.layers[t]}gotoLayer(t,e,s={}){const r=this.layers[t];if(!r)throw new Error(`Layer '${t}' does not exist`);return r.goto(e,s)}addLayer(t,e){this.addLayerAt(t,e,this.stack.length)}removeLayer(t){const e=this.layers[t];if(!e)throw new Error(`Layer '${t}' does not exist`);this.view.removeChild(e.view),delete this.layers[t],this.stack.splice(this.stack.indexOf(e),1)}addLayerAt(t,e,s){if(s>this.stack.length||s<0)throw new Error(`Layer index ${s}, is out of bound`);if(this.layers[t])throw new Error(`Layer '${t}' already exists`);const r=new an(this.app,e);this.view.addChildAt(r.view,s),this.layers[t]=r,this.stack.splice(s,0,r)}setLayerIndex(t,e){if(e>=this.stack.length)throw new Error(`Layer index ${e}, is out of bound`);const s=this.layers[t];if(!s)throw new Error(`Layer '${t}' does not exist`);this.view.setChildIndex(s.view,e),this.stack.splice(this.stack.indexOf(s),1),this.stack.splice(e,0,s)}resize(t,e){this.w=t,this.h=e,this.stack.forEach(s=>{s.resize(t,e)})}update(t){this.stack.forEach(e=>{e.update(t)})}}function Qa(i,t,e=!1){const s=i/t;return(r,n)=>{let o=r,a=n;e&&(a=n,o=Math.min(r,i,a*s));const l=o<i?i/o:1,p=a<t?t/a:1,_=l>p?l:p,y=Math.floor(o*_),h=Math.floor(a*_);return{rendererWidth:y,rendererHeight:h,canvasWidth:o,canvasHeight:a}}}new tl;const Za=Object.freeze(Object.defineProperty({__proto__:null,AlphaTransition:Xa,Application:Pa,Bar:Ja,Device:le,DeviceClass:Na,EmptyScreen:on,History:ja,KeyBindingCollection:nn,KeyboardPlugin:$a,LoaderScreen:Ga,NakedPromise:Ba,PerformanceTracker:un,Plugin:Qi,Prioritiser:Ta,ResizePlugin:pn,ResourcePlugin:Oa,ScreenGroup:an,ScreensPlugin:dn,StagePlugin:Ee,StorageType:_r,TouchInput:_n,TransitionManager:Ka,aspectResize:Qa,atlasResolver:ka,autoDetectAntialias:Ua,autoDetectResolution:Ha,autoDetectStorage:rn,autoDetectTransparency:Wa,deprecation:La,formatTextures:Ia,getPixiRunnerData:Ca,isGalaxyS5:Fa,isIPhone6:za,isKindle:Da,isSafari18:qa,isSafari18Dot4:Ra,limitFPS:Sa,loadTexturesWrapper:Ea,loadWebFontWrapper:Va,promiseAllRunner:Ma,promiseRunner:ar,resizeDefault:Ya,throttle:Aa},Symbol.toStringTag,{value:"Module"}));class dl{app;view;constructor(t,e){this.app=t,this.view=new Ct}onPrepare(){}onShow(){}onUpdate(t){}onHide(){}onHidden(){}onPause(){}onResume(){}onResize(t,e){}async prepare(){await this.onPrepare()}async show(){await this.onShow()}update(t){this.onUpdate(t)}async hide(){await this.onHide()}async hidden(){await this.onHidden()}pause(){this.onPause()}resume(){this.onResume()}resize(t,e){this.onResize(t,e)}}const tc=class cr{constructor(t,e=0){this.items=[],this._name=t,this.running=!1,this.dispatch=cr._generateRun(t,e),this.run=this.dispatch,this.emit=this.dispatch,this._dummy={},this._dummy[t]=()=>{}}static _generateRun(t,e){const s=`${t}|${e}`;let r=cr._hash[s];if(!r){if(e>0){let n="arg0";for(let a=1;a<e;a++)n+=`,arg${a}`;const o=`this.running = true;
                            var items = this.items;
                            for(var i=0;i<items.length;i++)
                            { items[i].${t}(${n});}
                            this.running = false;
                            if( this.needsTidy) this.tidy()`;r=new Function(n,o)}else r=new Function(`this.running = true;
                                    var items = this.items;
                                    for(var i=0;i<items.length;i++)
                                    { items[i].${t}(); }
                                    this.running = false;
                                    if( this.needsTidy) this.tidy() `);cr._hash[s]=r}return r}add(t){return t[this._name]&&(this.remove(t),this.items.push(t),this._toRemove=[],this.needsTidy=!1),this}remove(t){const e=this.items.indexOf(t);return this.running?(this.needsTidy=!0,this._toRemove.push(e),this.items[e]=this._dummy):e!==-1&&this.items.splice(e,1),this}contains(t){return this.items.indexOf(t)!==-1}removeAll(){this.items.length=0}destroy(){this.removeAll(),this.items=null}tidy(){for(let t=this._toRemove.length-1;t>=0;t--){const e=this._toRemove[t];e!==-1&&this.items.splice(e,1)}}get empty(){return this.items.length===0}};tc._hash={};let Gt=tc;class Gi{constructor(){this.id=new Int32Array(4)}setIndex(t){const e=t/31|0;this.id[e]=this.id[e]|1<<t%31}unsetIndex(t){const e=t/31|0;this.id[e]=this.id[e]&~(1<<t%31)}matchIndex(t){const e=this.id[0],s=this.id[1],r=this.id[2],n=this.id[3],o=t.id;return(o[0]&e^e)+(o[1]&s^s)+(o[2]&r^r)+(o[3]&n^n)===0}matchAnyIndex(t){const e=this.id[0],s=this.id[1],r=this.id[2],n=this.id[3],o=t.id;return(o[0]&e)+(o[1]&s)+(o[2]&r)+(o[3]&n)>0}}const pr={_ENTITY:0,_COMPONENT:0,_ENTITY_CLASS:0},ec=class{constructor(){this.c={},this.UID=pr._ENTITY++,this.componentBitHash=new Gi,this.queries=[],this.name=`item${this.UID}`,this.runners={init:new Gt("init",1),reset:new Gt("reset")},this._gc=!1,this._released=!1,this._pooled=!1,this._initialised=!1,this._staticComponents=this._staticComponents||new Set,this._addStaticComponents()}init(t){var e;if(this._initialised)return;this._addStaticComponents();const s=this.runners.init.items;for(let r=0;r<s.length;r++){const n=s[r];(e=n.init)==null||e.call(n,t?.[n.name]||{})}this._initialised=!0}reset(){this._gc=!1,this.runners.reset.run();for(const t in this.c){const e=this.c[t];if(e.signals){const s=e.signals;for(const r in s)s[r].disconnectAll()}e.dynamic&&this._removeComponent(e.name,e.id)}this._initialised=!1}addComponent(t,e,s=!1){var r;if(!t.NAME)throw new Error("[Entity] cannot add component that does not have a name");if(this.c[t.NAME])return this.c[t.NAME];t.ID===void 0&&(t.ID=pr._COMPONENT++);const n=new t;n.name=t.NAME,n.id=t.ID,n.entity=this,this.c[t.NAME]=n;for(const o in this.runners)this.runners[o].add(n);return this.componentBitHash.setIndex(t.ID),this._initialised&&((r=n.init)==null||r.call(n,e||{})),this.scene&&this.scene.queryManager.onEntityComponentAdded(this),s&&!this._staticComponents.has(t)&&this._staticComponents.add(t),this._staticComponents.has(t)||(n.dynamic=!0),n}removeComponent(t){return this._removeComponent(t.NAME,t.ID),this}removeAllComponents(){for(const t in this.c){const e=this.c[t];this._removeComponent(e.name,e.id)}return this}getComponent(t){return this.c[t.NAME]}setModified(t,e){for(let s=0;s<this.queries.length;s++)this.queries[s].modifiedQuery(this,t,e)}_addStaticComponents(){for(const t of this._staticComponents)this.addComponent(t,void 0,!0);return this}_removeComponent(t,e){var s;const r=this.c[t];if(r){for(const n in this.runners)this.runners[n].remove(r);this.componentBitHash.unsetIndex(e),this.scene&&this.scene.queryManager.onEntityComponentRemoved(this),(s=r.reset)==null||s.call(r),delete this.c[t]}}};ec.POOL=!0;let yl=ec,fl=class{constructor(t,e){this._pool=[],this._count=0,this._debug=!1,this._classType=t,e&&this.prepopulate(e)}prepopulate(t){for(let e=0;e<t;e++)this._pool.push(new this._classType);this._count+=t}get(){this._pool.length<=0&&this.prepopulate(Math.round(this._count*.2)+1);let t=this._pool.pop();return t||(t=new this._classType),t}return(t){if(this._pool.indexOf(t)!==-1){this._debug&&console.warn("Object already in pool",t);return}this._pool.push(t)}get totalSize(){return this._count}get totalFree(){return this._pool.length}get totalUsed(){return this._count-this._pool.length}};class vl{constructor(){this._poolsByClass=new Map}prepopulate(t,e){this.getPool(t).prepopulate(e)}get(t,e){var s;const n=this.getPool(t).get();return n._pooled=!0,(s=n.init)==null||s.call(n,e),n}return(t){var e;(e=t.reset)==null||e.call(t),t._pooled=!1,this._returnToPool(t)}getPool(t){return this._poolsByClass.has(t)||this._poolsByClass.set(t,new fl(t)),this._poolsByClass.get(t)}stats(){const t={};return this._poolsByClass.forEach(e=>{const s=t[e._classType.name]?e._classType.name+e._classType.ID:e._classType.name;t[s]={free:e.totalFree,used:e.totalUsed,size:e.totalSize}}),t}_returnToPool(t){this.getPool(t.constructor).return(t)}}const ic=new vl,Zn=new Map;function Zi(i,...t){const e=Zn.get(i.ID)??new Set,s=class extends i{},r=new Set([...e,...t]);return s.ID=pr._ENTITY_CLASS++,Zn.set(s.ID,r),Object.defineProperty(s.prototype,"_staticComponents",{value:r,writable:!0}),s}function Ss(i,t){if(!i.POOL){const e=new i;return e.init(t),e}return ic.get(i,t)}const sc=class{init(t={}){this.layer=t.layer||"default",this.view=t.view||new Ct}};sc.NAME="view2d";let yn=sc;class Cs extends Zi(yl,yn){get view(){return this.c.view2d.view}get transform(){return this.c.view2d.view.transform}get position(){return this.view.position}get scale(){return this.view.scale}get rotation(){return this.view.rotation}get x(){return this.view.position.x}set x(t){this.view.position.x=t}get y(){return this.view.position.y}set y(t){this.view.position.y=t}get scaleX(){return this.view.scale.x}set scaleX(t){this.view.scale.x=t}get scaleY(){return this.view.scale.y}set scaleY(t){this.view.scale.y=t}}class gl{constructor(){this.signals={}}register(...t){for(let e=0;e<t.length;e++){const s=t[e];this.signals[s]||(this.signals[s]=new Ki.Signal)}}resetSignals(){for(const t in this.signals)this.signals[t].disconnectAll()}}class rc{constructor(t={}){this.timeScale=1,this.maxDeltaTime=1e3/20,this._fps=60,this._deltaTime=0,this._frameTime=0,this.timeScale=t.timeScale??1,this._lastTime=performance.now(),this.fps=t.fps??60}nextUpdate(){const t=performance.now();this._deltaTime=Math.min(t-this._lastTime,this.maxDeltaTime),this._frameTime=this._deltaTime/this._frameDuration,this._lastTime=t}get deltaTime(){return this._deltaTime*this.timeScale}get unscaledDeltaTime(){return this._deltaTime}get frameTime(){return this._frameTime*this.timeScale}get unscaledFrameTime(){return this._frameTime}get fps(){return this._fps}set fps(t){this._fps=t,this._frameDuration=1e3/this._fps}}class xl extends rc{constructor(t={}){super(t),this.smooth=t.smooth??.2}nextUpdate(){const t=performance.now(),e=Math.min(t-this._lastTime,this.maxDeltaTime);this.smooth>0&&this.smooth<1?this._deltaTime-=(this._deltaTime-e)*this.smooth:this._deltaTime=e,this._frameTime=this._deltaTime/this._frameDuration,this._lastTime=t}}class wl{constructor(t=[]){this.onAdded=new Ki.Signal,this.onRemoved=new Ki.Signal,this.children=t}add(t){this.children.indexOf(t)===-1&&(this.children.push(t),this.onAdded.emit(t))}remove(t){const e=this.children.indexOf(t);return e===-1?!1:(this.children.splice(e,1),this.onRemoved.emit(t),!0)}contains(t){return this.children.indexOf(t)!==-1}getIndex(t){return this.children.indexOf(t)}getItem(t){return this.children[t]}run(t,e){let s;if(e)for(s=0;s<this.children.length;s++)t.call(e,this.children[s]);else for(s=0;s<this.children.length;s++)t(this.children[s])}empty(){this.children.length=0,this.onAdded.disconnectAll(),this.onRemoved.disconnectAll()}get length(){return this.children.length}}function bl(i,t){if(i.Queries)for(const e in i.Queries){const s=i.Queries[e],r=s.components;if(!r||r.length===0)throw new Error("'components' attribute can't be empty in a query");const n=t.scene.queryManager.getQuery(r,e);t.queries||(t.queries={}),t.queries[e]=n,s.modified&&(n.reactive=!0,n.runners.modified.add(t)),s.added&&(n.reactive=!0,n.runners.added.add(t)),s.removed&&(n.reactive=!0,n.runners.removed.add(t))}}class Al{constructor(t,e,s){this.reactive=!1,this.runners={added:new Gt("addedToQuery",2),removed:new Gt("removedFromQuery",2),modified:new Gt("modifiedQuery",5)},this.componentID=new Gi,this.notComponentID=new Gi,this.orComponentIDs=[],this.entities=[],this.key=e.name,this.componentID=e.componentID,this.notComponentID=e.notComponentID,this.orComponentIDs=e.orComponentIDs,this.name=s;for(let r=0;r<t.allEntities.children.length;r++){const n=t.allEntities.children[r];this.match(n.componentBitHash)&&this.entities.push(n)}}get first(){return this.entities[0]}forEach(t){for(let e=this.entities.length-1;e>=0;--e){const s=this.entities[e];t(s,e,this.entities)}}addEntity(t){~this.entities.indexOf(t)||(t.queries.push(this),this.entities.push(t),this.runners.added.run(t,this))}removeEntity(t){let e=this.entities.indexOf(t);~e&&(this.entities.splice(e,1),e=t.queries.indexOf(this),t.queries.splice(e,1),this.runners.removed.run(t,this))}modifiedQuery(t,e,s){this.runners.modified.run(t,t.c[e.NAME],s,this,e)}hasEntity(t){return!!~this.entities.indexOf(t)}match(t){const e=this.componentID.matchIndex(t),s=this.notComponentID.matchAnyIndex(t);let r=!0;return this.orComponentIDs.length>0&&(r=this.orComponentIDs.every(n=>n.matchAnyIndex(t))),e&&!s&&r}}class Bl{constructor(t){this._scene=t,this._queries={}}onEntityComponentAdded(t){for(const e in this._queries){const s=this._queries[e];s.match(t.componentBitHash)?s.addEntity(t):s.removeEntity(t)}}onEntityComponentRemoved(t){for(const e in this._queries){const s=this._queries[e];s.match(t.componentBitHash)?s.addEntity(t):s.removeEntity(t)}}onEntityAdded(t){this.onEntityComponentAdded(t)}onEntityRemoved(t){for(const e in this._queries)this._queries[e].removeEntity(t)}getQuery(t,e){if(t.length===0)throw Error("[QueryManager] cannot create empty query");const s=this.generateQueryKey(t);let r=this._queries[s.name];return r||(this._queries[s.name]=r=new Al(this._scene,s,e)),r}generateQueryKey(t){const e=new Gi,s=new Gi,r=[];let n="";const o=a=>{a.ID===void 0&&(a.ID=pr._COMPONENT++)};return t.forEach(a=>{if(typeof a=="object")if(a.operator==="not")a=a.component,o(a),s.setIndex(a.ID);else{const l=new Gi;a.components.forEach(p=>{o(p),l.setIndex(p.ID)}),r.push(l),n+=`${l.id.toString()}||`}else o(a),e.setIndex(a.ID)}),{name:`${e.id.toString()}!${s.id.toString()}||${n}`,componentID:e,notComponentID:s,orComponentIDs:r}}}class Sl extends gl{constructor(t={}){super(),this.allSystems=new Map,this.allEntities=new wl,this.queryManager=new Bl(this),this.paused=!1,this.runners={resize:new Gt("resize",2),preupdate:new Gt("preupdate",1),update:new Gt("update",1),postupdate:new Gt("postupdate",1),prerender:new Gt("prerender",1),render:new Gt("render",1),postrender:new Gt("postrender",1),reset:new Gt("reset",1)},this._enabled=!1,this._width=100,this._height=100,this._entitiesToRemove=[],this._systemsToStart=[],this.time=t.smoothTime?new xl({smooth:t.smoothTime}):new rc,this._updateAndRender=t.updateAndRender??!0,t.autoStart=t.autoStart??!1,t.autoStart&&this.start()}start(){this._enabled||(this.allSystems.forEach(t=>{var e;(e=t.awake)==null||e.call(t)}),this._enabled=!0)}addSystem(t,e){var s,r;const n=t.NAME;if(!n)throw new Error("[SystemManager]: cannot add System without name");if(this.allSystems.has(n))return this.allSystems.get(n);const o=new t;o.scene=this,o.queries={},bl(t,o),(s=o.init)==null||s.call(o,e),this._enabled&&((r=o.awake)==null||r.call(o));const{runners:a}=this;for(const l in a)a[l].add(o);return this._systemsToStart.push(o),this.allSystems.set(t.NAME,o),o}getSystem(t){return this.allSystems.get(t.NAME)}addToScene(t){if(t._gc){const e=this._entitiesToRemove.indexOf(t);this._entitiesToRemove.splice(e,1),t._gc=!1}if(t.scene){if(t.scene===this)return;this._removeEntity(t)}t.scene=this,this.allEntities.add(t),this.queryManager.onEntityAdded(t)}removeFromScene(t){t._gc||!t.scene||(t._gc=!0,this._entitiesToRemove.push(t))}renderStart(){this._updateAndRender&&this.update(),this.runners.prerender.run(this.time),this.runners.render.run(this.time)}renderFinish(){this.runners.postrender.run(this.time)}update(){this.paused||!this._enabled||(this.time.nextUpdate(),this._startSystems(),this._removeEntities(),this.runners.preupdate.run(this.time),this._removeEntities(),this.runners.update.run(this.time),this._removeEntities(),this.runners.postupdate.run(this.time))}restart(){this.reset(),this.start()}reset(){this._removeEntities(),this.runners.reset.run();for(let t=this.allEntities.children.length-1;t>=0;--t){const e=this.allEntities.children[t];e._released=!0,this._removeEntity(e)}this.allEntities.empty();for(const t in this.runners)this.runners[t].removeAll();this._entitiesToRemove.length=0,this.allSystems.forEach(t=>{for(const e in this.runners)this.runners[e].add(t);this._systemsToStart.push(t)}),this._enabled=!1}resize(t,e){this._width=t,this._height=e,this.runners.resize.run(t,e)}_removeEntities(){const t=this._entitiesToRemove;if(t.length){for(let e=0;e<t.length;e++){const s=t[e];this._removeEntity(s)}t.length=0}}_removeEntity(t){var e;t._released&&(t._pooled?ic.return(t):(e=t.reset)==null||e.call(t)),this.queryManager.onEntityRemoved(t),this.allEntities.remove(t),t._gc=!1,t.scene=null,t._released=!1}_startSystems(){var t;for(let e=0;e<this._systemsToStart.length;e++){const s=this._systemsToStart[e];(t=s.start)==null||t.call(s)}this._systemsToStart.length=0}get width(){return this._width}get height(){return this._height}}const fn=class{constructor(){this.w=-1,this.h=-1,this.camera={x:0,y:0,zoom:1,offset:{x:0,y:0}},this._activeItemsContainer=new Ct,this._layers={},this._innerContainer=new Ct}init(t={}){this.stage=t.stage||new Ct;const e=new Hn({render:()=>{this.scene.renderStart()}}),s=new Hn({render:()=>{this.scene.renderFinish()}});this.stage.isRenderGroup=!0,this.stage.addChild(e),this.stage.addChild(this._innerContainer),this._innerContainer.addChild(this._activeItemsContainer),this.stage.addChild(s),this.addLayer("back"),this.addLayer("default"),this.addLayer("front"),this.resize(1,1)}setCamera(t){this.camera=t,this.resize(this.w,this.h)}render(){const t=this.camera.zoom,e=this.stage;e.scale.set(t),e.position.x=this.w/2-this.w/2*t+this.camera.offset.x*2,e.position.y=this.h/2-this.h/2*t+this.camera.offset.y;const s=this._innerContainer.scale.x,r=this._innerContainer.scale.y;this._innerContainer.x=-this.camera.x*s+this.w/2,this._innerContainer.y=-this.camera.y*r+this.h/2}addedToQuery(t){const e=t,s=e.c.view2d.view;this._layers[e.c.view2d.layer].addChild(s)}removedFromQuery(t){const e=t,s=e.c.view2d.view;this._layers[e.c.view2d.layer].removeChild(s)}reset(){}addLayer(t,e=-1){this._layers[t]=new Ct,e===-1&&(e=this._activeItemsContainer.children.length),this._activeItemsContainer.addChildAt(this._layers[t],e)}setEntityLayer(t,e,s=-1){if(!this._layers[e])throw new Error(`Layer doesn't exist: ${e}`);const r=t.getComponent(yn);if(r){const n=r.view,o=this._layers[r.layer];o.children.indexOf(n)!==-1&&o.removeChild(n),s===-1&&(s=this._layers[e].children.length),this._layers[e].addChildAt(n,s),r.layer=e}}setLayerAt(t,e){const s=this.layers[t];s&&this.activeItemsContainer.addChildAt(s,e)}resize(t,e){this.w===t&&this.h===e||(this.w=t,this.h=e)}get layers(){return this._layers}get activeItemsContainer(){return this._activeItemsContainer}get innerContainer(){return this._innerContainer}};fn.NAME="view2d";fn.Queries={view2d:{components:[yn],added:!0,removed:!0}};let Cl=fn;class Tl extends Sl{constructor(t){super(t),this.register("onGameover"),this.register("onGameComplete"),this.view2d=this.addSystem(Cl,{stage:t.stage})}addChild(...t){if(t.length>1)for(let e=0;e<t.length;e++)this.addToScene(t[e]);else this.addToScene(t[0])}removeChild(...t){if(t.length>1)for(let e=0;e<t.length;e++)this.removeFromScene(t[e]);else this.removeFromScene(t[0])}}var cn=function(i,t){return cn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,s){e.__proto__=s}||function(e,s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])},cn(i,t)};function zt(i,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");cn(i,t);function e(){this.constructor=i}i.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var Lt=function(){return Lt=Object.assign||function(t){for(var e,s=1,r=arguments.length;s<r;s++){e=arguments[s];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},Lt.apply(this,arguments)},Xt=function(i,t){(i===null||typeof i>"u")&&(i={});var e=Lt({},i);for(var s in t)t.hasOwnProperty(s)&&typeof i[s]>"u"&&(e[s]=t[s]);if(typeof Object.getOwnPropertySymbols=="function")for(var r=Object.getOwnPropertySymbols(t),n=0;n<r.length;n++){var o=r[n];t.propertyIsEnumerable(o)&&typeof i[o]>"u"&&(e[o]=t[o])}return e},Ml=Math.random,qt=1e-9,Pl=Number.isFinite;function Il(i){return i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i+1}function El(i){return i>0&&(i&i-1)===0}function nc(i,t,e){return typeof t>"u"?(e=1,t=0):typeof e>"u"&&(e=t,t=0),e>t?(i=(i-t)%(e-t),i+(i<0?e:t)):(i=(i-e)%(t-e),i+(i<=0?t:e))}function Mt(i,t,e){return i<t?t:i>e?e:i}function Vl(i,t){return typeof i>"u"?(t=1,i=0):typeof t>"u"&&(t=i,i=0),i===t?i:Ml()*(t-i)+i}var Si=Object.create(Math);Si.EPSILON=qt;Si.isFinite=Pl;Si.nextPowerOfTwo=Il;Si.isPowerOfTwo=El;Si.mod=nc;Si.clamp=Mt;Si.random=Vl;var to=Math.abs,Ir=Math.sqrt,eo=Math.max,io=Math.min,c=(function(){function i(t,e){if(!(this instanceof i))return new i(t,e);typeof t>"u"?(this.x=0,this.y=0):typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}return i.prototype._serialize=function(){return{x:this.x,y:this.y}},i._deserialize=function(t){var e=Object.create(i.prototype);return e.x=t.x,e.y=t.y,e},i.zero=function(){var t=Object.create(i.prototype);return t.x=0,t.y=0,t},i.neo=function(t,e){var s=Object.create(i.prototype);return s.x=t,s.y=e,s},i.clone=function(t){return i.neo(t.x,t.y)},i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.x)&&Number.isFinite(t.y)},i.assert=function(t){},i.prototype.clone=function(){return i.clone(this)},i.prototype.setZero=function(){return this.x=0,this.y=0,this},i.prototype.set=function(t,e){return typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),this},i.prototype.setNum=function(t,e){return this.x=t,this.y=e,this},i.prototype.setVec2=function(t){return this.x=t.x,this.y=t.y,this},i.prototype.wSet=function(t,e,s,r){return typeof s<"u"||typeof r<"u"?this.setCombine(t,e,s,r):this.setMul(t,e)},i.prototype.setCombine=function(t,e,s,r){var n=t*e.x+s*r.x,o=t*e.y+s*r.y;return this.x=n,this.y=o,this},i.prototype.setMul=function(t,e){var s=t*e.x,r=t*e.y;return this.x=s,this.y=r,this},i.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},i.prototype.wAdd=function(t,e,s,r){return typeof s<"u"||typeof r<"u"?this.addCombine(t,e,s,r):this.addMul(t,e)},i.prototype.addCombine=function(t,e,s,r){var n=t*e.x+s*r.x,o=t*e.y+s*r.y;return this.x+=n,this.y+=o,this},i.prototype.addMul=function(t,e){var s=t*e.x,r=t*e.y;return this.x+=s,this.y+=r,this},i.prototype.wSub=function(t,e,s,r){return typeof s<"u"||typeof r<"u"?this.subCombine(t,e,s,r):this.subMul(t,e)},i.prototype.subCombine=function(t,e,s,r){var n=t*e.x+s*r.x,o=t*e.y+s*r.y;return this.x-=n,this.y-=o,this},i.prototype.subMul=function(t,e){var s=t*e.x,r=t*e.y;return this.x-=s,this.y-=r,this},i.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},i.prototype.mul=function(t){return this.x*=t,this.y*=t,this},i.prototype.length=function(){return i.lengthOf(this)},i.prototype.lengthSquared=function(){return i.lengthSquared(this)},i.prototype.normalize=function(){var t=this.length();if(t<qt)return 0;var e=1/t;return this.x*=e,this.y*=e,t},i.normalize=function(t){var e=i.lengthOf(t);if(e<qt)return i.zero();var s=1/e;return i.neo(t.x*s,t.y*s)},i.lengthOf=function(t){return Ir(t.x*t.x+t.y*t.y)},i.lengthSquared=function(t){return t.x*t.x+t.y*t.y},i.distance=function(t,e){var s=t.x-e.x,r=t.y-e.y;return Ir(s*s+r*r)},i.distanceSquared=function(t,e){var s=t.x-e.x,r=t.y-e.y;return s*s+r*r},i.areEqual=function(t,e){return t===e||typeof e=="object"&&e!==null&&t.x===e.x&&t.y===e.y},i.skew=function(t){return i.neo(-t.y,t.x)},i.dot=function(t,e){return t.x*e.x+t.y*e.y},i.cross=function(t,e){return typeof e=="number"?i.neo(e*t.y,-e*t.x):typeof t=="number"?i.neo(-t*e.y,t*e.x):t.x*e.y-t.y*e.x},i.crossVec2Vec2=function(t,e){return t.x*e.y-t.y*e.x},i.crossVec2Num=function(t,e){return i.neo(e*t.y,-e*t.x)},i.crossNumVec2=function(t,e){return i.neo(-t*e.y,t*e.x)},i.addCross=function(t,e,s){if(typeof s=="number")return i.neo(s*e.y+t.x,-s*e.x+t.y);if(typeof e=="number")return i.neo(-e*s.y+t.x,e*s.x+t.y)},i.addCrossVec2Num=function(t,e,s){return i.neo(s*e.y+t.x,-s*e.x+t.y)},i.addCrossNumVec2=function(t,e,s){return i.neo(-e*s.y+t.x,e*s.x+t.y)},i.add=function(t,e){return i.neo(t.x+e.x,t.y+e.y)},i.wAdd=function(t,e,s,r){return typeof s<"u"||typeof r<"u"?i.combine(t,e,s,r):i.mulNumVec2(t,e)},i.combine=function(t,e,s,r){return i.zero().setCombine(t,e,s,r)},i.sub=function(t,e){return i.neo(t.x-e.x,t.y-e.y)},i.mul=function(t,e){if(typeof t=="object")return i.neo(t.x*e,t.y*e);if(typeof e=="object")return i.neo(t*e.x,t*e.y)},i.mulVec2Num=function(t,e){return i.neo(t.x*e,t.y*e)},i.mulNumVec2=function(t,e){return i.neo(t*e.x,t*e.y)},i.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this},i.neg=function(t){return i.neo(-t.x,-t.y)},i.abs=function(t){return i.neo(to(t.x),to(t.y))},i.mid=function(t,e){return i.neo((t.x+e.x)*.5,(t.y+e.y)*.5)},i.upper=function(t,e){return i.neo(eo(t.x,e.x),eo(t.y,e.y))},i.lower=function(t,e){return i.neo(io(t.x,e.x),io(t.y,e.y))},i.prototype.clamp=function(t){var e=this.x*this.x+this.y*this.y;if(e>t*t){var s=t/Ir(e);this.x*=s,this.y*=s}return this},i.clamp=function(t,e){var s=i.neo(t.x,t.y);return s.clamp(e),s},i.clampVec2=function(t,e,s){return{x:Mt(t.x,e?.x,s?.x),y:Mt(t.y,e?.y,s?.y)}},i.scaleFn=function(t,e){return function(s){return i.neo(s.x*t,s.y*e)}},i.translateFn=function(t,e){return function(s){return i.neo(s.x+t,s.y+e)}},i})(),Zt=Math.max,te=Math.min,Et=(function(){function i(t,e){if(!(this instanceof i))return new i(t,e);this.lowerBound=c.zero(),this.upperBound=c.zero(),typeof t=="object"&&this.lowerBound.setVec2(t),typeof e=="object"?this.upperBound.setVec2(e):typeof t=="object"&&this.upperBound.setVec2(t)}return i.prototype.isValid=function(){return i.isValid(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:c.isValid(t.lowerBound)&&c.isValid(t.upperBound)&&c.sub(t.upperBound,t.lowerBound).lengthSquared()>=0},i.assert=function(t){},i.prototype.getCenter=function(){return c.neo((this.lowerBound.x+this.upperBound.x)*.5,(this.lowerBound.y+this.upperBound.y)*.5)},i.prototype.getExtents=function(){return c.neo((this.upperBound.x-this.lowerBound.x)*.5,(this.upperBound.y-this.lowerBound.y)*.5)},i.prototype.getPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+this.upperBound.y-this.lowerBound.y)},i.prototype.combine=function(t,e){e=e||this;var s=t.lowerBound,r=t.upperBound,n=e.lowerBound,o=e.upperBound,a=te(s.x,n.x),l=te(s.y,n.y),p=Zt(o.x,r.x),_=Zt(o.y,r.y);this.lowerBound.setNum(a,l),this.upperBound.setNum(p,_)},i.prototype.combinePoints=function(t,e){this.lowerBound.setNum(te(t.x,e.x),te(t.y,e.y)),this.upperBound.setNum(Zt(t.x,e.x),Zt(t.y,e.y))},i.prototype.set=function(t){this.lowerBound.setNum(t.lowerBound.x,t.lowerBound.y),this.upperBound.setNum(t.upperBound.x,t.upperBound.y)},i.prototype.contains=function(t){var e=!0;return e=e&&this.lowerBound.x<=t.lowerBound.x,e=e&&this.lowerBound.y<=t.lowerBound.y,e=e&&t.upperBound.x<=this.upperBound.x,e=e&&t.upperBound.y<=this.upperBound.y,e},i.prototype.extend=function(t){return i.extend(this,t),this},i.extend=function(t,e){return t.lowerBound.x-=e,t.lowerBound.y-=e,t.upperBound.x+=e,t.upperBound.y+=e,t},i.testOverlap=function(t,e){var s=e.lowerBound.x-t.upperBound.x,r=t.lowerBound.x-e.upperBound.x,n=e.lowerBound.y-t.upperBound.y,o=t.lowerBound.y-e.upperBound.y;return!(s>0||n>0||r>0||o>0)},i.areEqual=function(t,e){return c.areEqual(t.lowerBound,e.lowerBound)&&c.areEqual(t.upperBound,e.upperBound)},i.diff=function(t,e){var s=Zt(0,te(t.upperBound.x,e.upperBound.x)-Zt(e.lowerBound.x,t.lowerBound.x)),r=Zt(0,te(t.upperBound.y,e.upperBound.y)-Zt(e.lowerBound.y,t.lowerBound.y)),n=t.upperBound.x-t.lowerBound.x,o=t.upperBound.y-t.lowerBound.y,a=e.upperBound.x-e.lowerBound.x,l=e.upperBound.y-e.lowerBound.y;return n*o+a*l-s*r},i.prototype.rayCast=function(t,e){var s=-1/0,r=1/0,n=e.p1,o=c.sub(e.p2,e.p1),a=c.abs(o),l=c.zero();if(a.x<qt){if(n.x<this.lowerBound.x||this.upperBound.x<n.x)return!1}else{var p=1/o.x,_=(this.lowerBound.x-n.x)*p,y=(this.upperBound.x-n.x)*p,h=-1;if(_>y){var m=_;_=y,y=m,h=1}if(_>s&&(l.setZero(),l.x=h,s=_),r=te(r,y),s>r)return!1}if(a.y<qt){if(n.y<this.lowerBound.y||this.upperBound.y<n.y)return!1}else{var p=1/o.y,_=(this.lowerBound.y-n.y)*p,y=(this.upperBound.y-n.y)*p,h=-1;if(_>y){var m=_;_=y,y=m,h=1}if(_>s&&(l.setZero(),l.y=h,s=_),r=te(r,y),s>r)return!1}return s<0||e.maxFraction<s?!1:(t.fraction=s,t.normal=l,!0)},i.prototype.toString=function(){return JSON.stringify(this)},i.combinePoints=function(t,e,s){return t.lowerBound.x=te(e.x,s.x),t.lowerBound.y=te(e.y,s.y),t.upperBound.x=Zt(e.x,s.x),t.upperBound.y=Zt(e.y,s.y),t},i.combinedPerimeter=function(t,e){var s=te(t.lowerBound.x,e.lowerBound.x),r=te(t.lowerBound.y,e.lowerBound.y),n=Zt(t.upperBound.x,e.upperBound.x),o=Zt(t.upperBound.y,e.upperBound.y);return 2*(n-s+o-r)},i})(),Es=Math.PI,O=(function(){function i(){}return Object.defineProperty(i,"polygonRadius",{get:function(){return 2*i.linearSlop},enumerable:!1,configurable:!0}),i.lengthUnitsPerMeter=1,i.maxManifoldPoints=2,i.maxPolygonVertices=12,i.aabbExtension=.1,i.aabbMultiplier=2,i.linearSlop=.005,i.angularSlop=2/180*Es,i.maxSubSteps=8,i.maxTOIContacts=32,i.maxTOIIterations=20,i.maxDistanceIterations=20,i.velocityThreshold=1,i.maxLinearCorrection=.2,i.maxAngularCorrection=8/180*Es,i.maxTranslation=2,i.maxRotation=.5*Es,i.baumgarte=.2,i.toiBaugarte=.75,i.timeToSleep=.5,i.linearSleepTolerance=.01,i.angularSleepTolerance=2/180*Es,i})(),I=(function(){function i(){}return Object.defineProperty(i,"maxManifoldPoints",{get:function(){return O.maxManifoldPoints},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxPolygonVertices",{get:function(){return O.maxPolygonVertices},enumerable:!1,configurable:!0}),Object.defineProperty(i,"aabbExtension",{get:function(){return O.aabbExtension*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"aabbMultiplier",{get:function(){return O.aabbMultiplier},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSlop",{get:function(){return O.linearSlop*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSlopSquared",{get:function(){return O.linearSlop*O.lengthUnitsPerMeter*O.linearSlop*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"angularSlop",{get:function(){return O.angularSlop},enumerable:!1,configurable:!0}),Object.defineProperty(i,"polygonRadius",{get:function(){return 2*O.linearSlop},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxSubSteps",{get:function(){return O.maxSubSteps},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTOIContacts",{get:function(){return O.maxTOIContacts},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTOIIterations",{get:function(){return O.maxTOIIterations},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxDistanceIterations",{get:function(){return O.maxDistanceIterations},enumerable:!1,configurable:!0}),Object.defineProperty(i,"velocityThreshold",{get:function(){return O.velocityThreshold*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxLinearCorrection",{get:function(){return O.maxLinearCorrection*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxAngularCorrection",{get:function(){return O.maxAngularCorrection},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTranslation",{get:function(){return O.maxTranslation*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTranslationSquared",{get:function(){return O.maxTranslation*O.lengthUnitsPerMeter*O.maxTranslation*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxRotation",{get:function(){return O.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxRotationSquared",{get:function(){return O.maxRotation*O.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(i,"baumgarte",{get:function(){return O.baumgarte},enumerable:!1,configurable:!0}),Object.defineProperty(i,"toiBaugarte",{get:function(){return O.toiBaugarte},enumerable:!1,configurable:!0}),Object.defineProperty(i,"timeToSleep",{get:function(){return O.timeToSleep},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSleepTolerance",{get:function(){return O.linearSleepTolerance*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSleepToleranceSqr",{get:function(){return O.linearSleepTolerance*O.lengthUnitsPerMeter*O.linearSleepTolerance*O.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"angularSleepTolerance",{get:function(){return O.angularSleepTolerance},enumerable:!1,configurable:!0}),Object.defineProperty(i,"angularSleepToleranceSqr",{get:function(){return O.angularSleepTolerance*O.angularSleepTolerance},enumerable:!1,configurable:!0}),i})(),xs=(function(){function i(t){this._list=[],this._max=1/0,this._hasCreateFn=!1,this._createCount=0,this._hasAllocateFn=!1,this._allocateCount=0,this._hasReleaseFn=!1,this._releaseCount=0,this._hasDisposeFn=!1,this._disposeCount=0,this._list=[],this._max=t.max||this._max,this._createFn=t.create,this._hasCreateFn=typeof this._createFn=="function",this._allocateFn=t.allocate,this._hasAllocateFn=typeof this._allocateFn=="function",this._releaseFn=t.release,this._hasReleaseFn=typeof this._releaseFn=="function",this._disposeFn=t.dispose,this._hasDisposeFn=typeof this._disposeFn=="function"}return i.prototype.max=function(t){return typeof t=="number"?(this._max=t,this):this._max},i.prototype.size=function(){return this._list.length},i.prototype.allocate=function(){var t;return this._list.length>0?t=this._list.shift():(this._createCount++,this._hasCreateFn?t=this._createFn():t={}),this._allocateCount++,this._hasAllocateFn&&this._allocateFn(t),t},i.prototype.release=function(t){this._list.length<this._max?(this._releaseCount++,this._hasReleaseFn&&this._releaseFn(t),this._list.push(t)):(this._disposeCount++,this._hasDisposeFn&&(t=this._disposeFn(t)))},i.prototype.toString=function(){return" +"+this._createCount+" >"+this._allocateCount+" <"+this._releaseCount+" -"+this._disposeCount+" ="+this._list.length+"/"+this._max},i})(),so=Math.abs,Wt=Math.max,kl=(function(){function i(t){this.aabb=new Et,this.userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=-1,this.id=t}return i.prototype.toString=function(){return this.id+": "+this.userData},i.prototype.isLeaf=function(){return this.child1==null},i})(),ro=new xs({create:function(){return new kl},release:function(i){i.userData=null,i.parent=null,i.child1=null,i.child2=null,i.height=-1,i.id=void 0}}),Ll=(function(){function i(){this.inputPool=new xs({create:function(){return{}},release:function(t){}}),this.stackPool=new xs({create:function(){return[]},release:function(t){t.length=0}}),this.iteratorPool=new xs({create:function(){return new zl},release:function(t){t.close()}}),this.m_root=null,this.m_nodes={},this.m_lastProxyId=0}return i.prototype.getUserData=function(t){var e=this.m_nodes[t];return e.userData},i.prototype.getFatAABB=function(t){var e=this.m_nodes[t];return e.aabb},i.prototype.allocateNode=function(){var t=ro.allocate();return t.id=++this.m_lastProxyId,this.m_nodes[t.id]=t,t},i.prototype.freeNode=function(t){delete this.m_nodes[t.id],ro.release(t)},i.prototype.createProxy=function(t,e){var s=this.allocateNode();return s.aabb.set(t),Et.extend(s.aabb,I.aabbExtension),s.userData=e,s.height=0,this.insertLeaf(s),s.id},i.prototype.destroyProxy=function(t){var e=this.m_nodes[t];this.removeLeaf(e),this.freeNode(e)},i.prototype.moveProxy=function(t,e,s){var r=this.m_nodes[t];return r.aabb.contains(e)?!1:(this.removeLeaf(r),r.aabb.set(e),e=r.aabb,Et.extend(e,I.aabbExtension),s.x<0?e.lowerBound.x+=s.x*I.aabbMultiplier:e.upperBound.x+=s.x*I.aabbMultiplier,s.y<0?e.lowerBound.y+=s.y*I.aabbMultiplier:e.upperBound.y+=s.y*I.aabbMultiplier,this.insertLeaf(r),!0)},i.prototype.insertLeaf=function(t){if(this.m_root==null){this.m_root=t,this.m_root.parent=null;return}for(var e=t.aabb,s=this.m_root;!s.isLeaf();){var r=s.child1,n=s.child2,o=s.aabb.getPerimeter(),a=Et.combinedPerimeter(s.aabb,e),l=2*a,p=2*(a-o),_=Et.combinedPerimeter(e,r.aabb),y=_+p;if(!r.isLeaf()){var h=r.aabb.getPerimeter();y-=h}var m=Et.combinedPerimeter(e,n.aabb),u=m+p;if(!n.isLeaf()){var h=n.aabb.getPerimeter();u-=h}if(l<y&&l<u)break;y<u?s=r:s=n}var d=s,f=d.parent,v=this.allocateNode();for(v.parent=f,v.userData=null,v.aabb.combine(e,d.aabb),v.height=d.height+1,f!=null?(f.child1===d?f.child1=v:f.child2=v,v.child1=d,v.child2=t,d.parent=v,t.parent=v):(v.child1=d,v.child2=t,d.parent=v,t.parent=v,this.m_root=v),s=t.parent;s!=null;){s=this.balance(s);var r=s.child1,n=s.child2;s.height=1+Wt(r.height,n.height),s.aabb.combine(r.aabb,n.aabb),s=s.parent}},i.prototype.removeLeaf=function(t){if(t===this.m_root){this.m_root=null;return}var e=t.parent,s=e.parent,r;if(e.child1===t?r=e.child2:r=e.child1,s!=null){s.child1===e?s.child1=r:s.child2=r,r.parent=s,this.freeNode(e);for(var n=s;n!=null;){n=this.balance(n);var o=n.child1,a=n.child2;n.aabb.combine(o.aabb,a.aabb),n.height=1+Wt(o.height,a.height),n=n.parent}}else this.m_root=r,r.parent=null,this.freeNode(e)},i.prototype.balance=function(t){var e=t;if(e.isLeaf()||e.height<2)return t;var s=e.child1,r=e.child2,n=r.height-s.height;if(n>1){var o=r.child1,a=r.child2;return r.child1=e,r.parent=e.parent,e.parent=r,r.parent!=null?r.parent.child1===t?r.parent.child1=r:r.parent.child2=r:this.m_root=r,o.height>a.height?(r.child2=o,e.child2=a,a.parent=e,e.aabb.combine(s.aabb,a.aabb),r.aabb.combine(e.aabb,o.aabb),e.height=1+Wt(s.height,a.height),r.height=1+Wt(e.height,o.height)):(r.child2=a,e.child2=o,o.parent=e,e.aabb.combine(s.aabb,o.aabb),r.aabb.combine(e.aabb,a.aabb),e.height=1+Wt(s.height,o.height),r.height=1+Wt(e.height,a.height)),r}if(n<-1){var l=s.child1,p=s.child2;return s.child1=e,s.parent=e.parent,e.parent=s,s.parent!=null?s.parent.child1===e?s.parent.child1=s:s.parent.child2=s:this.m_root=s,l.height>p.height?(s.child2=l,e.child1=p,p.parent=e,e.aabb.combine(r.aabb,p.aabb),s.aabb.combine(e.aabb,l.aabb),e.height=1+Wt(r.height,p.height),s.height=1+Wt(e.height,l.height)):(s.child2=p,e.child1=l,l.parent=e,e.aabb.combine(r.aabb,l.aabb),s.aabb.combine(e.aabb,p.aabb),e.height=1+Wt(r.height,l.height),s.height=1+Wt(e.height,p.height)),s}return e},i.prototype.getHeight=function(){return this.m_root==null?0:this.m_root.height},i.prototype.getAreaRatio=function(){if(this.m_root==null)return 0;for(var t=this.m_root,e=t.aabb.getPerimeter(),s=0,r,n=this.iteratorPool.allocate().preorder(this.m_root);r=n.next();)r.height<0||(s+=r.aabb.getPerimeter());return this.iteratorPool.release(n),s/e},i.prototype.computeHeight=function(t){var e;if(typeof t<"u"?e=this.m_nodes[t]:e=this.m_root,e.isLeaf())return 0;var s=this.computeHeight(e.child1.id),r=this.computeHeight(e.child2.id);return 1+Wt(s,r)},i.prototype.validateStructure=function(t){if(t!=null){this.m_root;var e=t.child1,s=t.child2;t.isLeaf()||(this.validateStructure(e),this.validateStructure(s))}},i.prototype.validateMetrics=function(t){if(t!=null){var e=t.child1,s=t.child2;t.isLeaf()||(this.validateMetrics(e),this.validateMetrics(s))}},i.prototype.validate=function(){},i.prototype.getMaxBalance=function(){for(var t=0,e,s=this.iteratorPool.allocate().preorder(this.m_root);e=s.next();)if(!(e.height<=1)){var r=so(e.child2.height-e.child1.height);t=Wt(t,r)}return this.iteratorPool.release(s),t},i.prototype.rebuildBottomUp=function(){for(var t=[],e=0,s,r=this.iteratorPool.allocate().preorder(this.m_root);s=r.next();)s.height<0||(s.isLeaf()?(s.parent=null,t[e]=s,++e):this.freeNode(s));for(this.iteratorPool.release(r);e>1;){for(var n=1/0,o=-1,a=-1,l=0;l<e;++l)for(var p=t[l].aabb,_=l+1;_<e;++_){var y=t[_].aabb,h=Et.combinedPerimeter(p,y);h<n&&(o=l,a=_,n=h)}var m=t[o],u=t[a],d=this.allocateNode();d.child1=m,d.child2=u,d.height=1+Wt(m.height,u.height),d.aabb.combine(m.aabb,u.aabb),d.parent=null,m.parent=d,u.parent=d,t[a]=t[e-1],t[o]=d,--e}this.m_root=t[0]},i.prototype.shiftOrigin=function(t){for(var e,s=this.iteratorPool.allocate().preorder(this.m_root);e=s.next();){var r=e.aabb;r.lowerBound.x-=t.x,r.lowerBound.y-=t.y,r.upperBound.x-=t.x,r.upperBound.y-=t.y}this.iteratorPool.release(s)},i.prototype.query=function(t,e){var s=this.stackPool.allocate();for(s.push(this.m_root);s.length>0;){var r=s.pop();if(r!=null&&Et.testOverlap(r.aabb,t))if(r.isLeaf()){var n=e(r.id);if(n===!1)return}else s.push(r.child1),s.push(r.child2)}this.stackPool.release(s)},i.prototype.rayCast=function(t,e){var s=t.p1,r=t.p2,n=c.sub(r,s);n.normalize();var o=c.crossNumVec2(1,n),a=c.abs(o),l=t.maxFraction,p=new Et,_=c.combine(1-l,s,l,r);p.combinePoints(s,_);var y=this.stackPool.allocate(),h=this.inputPool.allocate();for(y.push(this.m_root);y.length>0;){var m=y.pop();if(m!=null&&Et.testOverlap(m.aabb,p)!==!1){var u=m.aabb.getCenter(),d=m.aabb.getExtents(),f=so(c.dot(o,c.sub(s,u)))-c.dot(a,d);if(!(f>0))if(m.isLeaf()){h.p1=c.clone(t.p1),h.p2=c.clone(t.p2),h.maxFraction=l;var v=e(h,m.id);if(v===0)break;v>0&&(l=v,_=c.combine(1-l,s,l,r),p.combinePoints(s,_))}else y.push(m.child1),y.push(m.child2)}}this.stackPool.release(y),this.inputPool.release(h)},i})(),zl=(function(){function i(){this.parents=[],this.states=[]}return i.prototype.preorder=function(t){return this.parents.length=0,this.parents.push(t),this.states.length=0,this.states.push(0),this},i.prototype.next=function(){for(;this.parents.length>0;){var t=this.parents.length-1,e=this.parents[t];if(this.states[t]===0)return this.states[t]=1,e;if(this.states[t]===1&&(this.states[t]=2,e.child1))return this.parents.push(e.child1),this.states.push(1),e.child1;if(this.states[t]===2&&(this.states[t]=3,e.child2))return this.parents.push(e.child2),this.states.push(1),e.child2;this.parents.pop(),this.states.pop()}},i.prototype.close=function(){this.parents.length=0},i})(),Fl=Math.max,Dl=Math.min,Rl=(function(){function i(){var t=this;this.m_tree=new Ll,this.m_moveBuffer=[],this.query=function(e,s){t.m_tree.query(e,s)},this.queryCallback=function(e){if(e===t.m_queryProxyId)return!0;var s=Dl(e,t.m_queryProxyId),r=Fl(e,t.m_queryProxyId),n=t.m_tree.getUserData(s),o=t.m_tree.getUserData(r);return t.m_callback(n,o),!0}}return i.prototype.getUserData=function(t){return this.m_tree.getUserData(t)},i.prototype.testOverlap=function(t,e){var s=this.m_tree.getFatAABB(t),r=this.m_tree.getFatAABB(e);return Et.testOverlap(s,r)},i.prototype.getFatAABB=function(t){return this.m_tree.getFatAABB(t)},i.prototype.getProxyCount=function(){return this.m_moveBuffer.length},i.prototype.getTreeHeight=function(){return this.m_tree.getHeight()},i.prototype.getTreeBalance=function(){return this.m_tree.getMaxBalance()},i.prototype.getTreeQuality=function(){return this.m_tree.getAreaRatio()},i.prototype.rayCast=function(t,e){this.m_tree.rayCast(t,e)},i.prototype.shiftOrigin=function(t){this.m_tree.shiftOrigin(t)},i.prototype.createProxy=function(t,e){var s=this.m_tree.createProxy(t,e);return this.bufferMove(s),s},i.prototype.destroyProxy=function(t){this.unbufferMove(t),this.m_tree.destroyProxy(t)},i.prototype.moveProxy=function(t,e,s){var r=this.m_tree.moveProxy(t,e,s);r&&this.bufferMove(t)},i.prototype.touchProxy=function(t){this.bufferMove(t)},i.prototype.bufferMove=function(t){this.m_moveBuffer.push(t)},i.prototype.unbufferMove=function(t){for(var e=0;e<this.m_moveBuffer.length;++e)this.m_moveBuffer[e]===t&&(this.m_moveBuffer[e]=null)},i.prototype.updatePairs=function(t){for(this.m_callback=t;this.m_moveBuffer.length>0;)if(this.m_queryProxyId=this.m_moveBuffer.pop(),this.m_queryProxyId!==null){var e=this.m_tree.getFatAABB(this.m_queryProxyId);this.m_tree.query(e,this.queryCallback)}},i})(),oc=Math.sin,ac=Math.cos,vn=Math.sqrt;function A(i,t){return{x:i,y:t}}function ql(i){return{s:oc(i),c:ac(i)}}function Tt(i,t,e){return i.x=t,i.y=e,i}function x(i,t){return i.x=t.x,i.y=t.y,i}function k(i){return i.x=0,i.y=0,i}function bs(i){return i.x=-i.x,i.y=-i.y,i}function ne(i,t){return i.x+=t.x,i.y+=t.y,i}function Nl(i,t,e){return i.x=t.x+e.x,i.y=t.x+e.y,i}function Ue(i,t){return i.x-=t.x,i.y-=t.y,i}function R(i,t,e){return i.x=t.x-e.x,i.y=t.y-e.y,i}function no(i,t){return i.x*=t,i.y*=t,i}function L(i,t,e){return i.x=t*e.x,i.y=t*e.y,i}function fe(i,t,e){return i.x+=t*e.x,i.y+=t*e.y,i}function fs(i,t,e){return i.x-=t*e.x,i.y-=t*e.y,i}function ct(i,t,e,s,r){return i.x=t*e.x+s*r.x,i.y=t*e.y+s*r.y,i}function Pe(i,t,e,s,r,n,o){return i.x=t*e.x+s*r.x+n*o.x,i.y=t*e.y+s*r.y+n*o.y,i}function Ol(i){var t=vn(i.x*i.x+i.y*i.y);if(t!==0){var e=1/t;i.x*=e,i.y*=e}return t}function ve(i){var t=vn(i.x*i.x+i.y*i.y);if(t>0){var e=1/t;i.x*=e,i.y*=e}return i}function xi(i,t,e){var s=e*t.y,r=-e*t.x;return i.x=s,i.y=r,i}function Jt(i,t,e){var s=-t*e.y,r=t*e.x;return i.x=s,i.y=r,i}function $(i,t){return i.x*t.y-i.y*t.x}function M(i,t){return i.x*t.x+i.y*t.y}function wi(i){return i.x*i.x+i.y*i.y}function cc(i,t){var e=i.x-t.x,s=i.y-t.y;return vn(e*e+s*s)}function bi(i,t){var e=i.x-t.x,s=i.y-t.y;return e*e+s*s}function $l(i,t){return i.c=ac(t),i.s=oc(t),i}function ce(i,t,e){return i.x=t.c*e.x-t.s*e.y,i.y=t.s*e.x+t.c*e.y,i}function ji(i,t,e){var s=t.c*e.x+t.s*e.y,r=-t.s*e.x+t.c*e.y;return i.x=s,i.y=r,i}function Hl(i,t,e,s){var r=t.c*s.x+t.s*s.y,n=-t.s*s.x+t.c*s.y,o=e.c*r-e.s*n,a=e.s*r+e.c*n;return i.x=o,i.y=a,i}function Ci(i,t,e){return{p:A(i,t),q:ql(e)}}function dr(i,t){return i.p.x=t.p.x,i.p.y=t.p.y,i.q.s=t.q.s,i.q.c=t.q.c,i}function D(i,t,e){var s=t.q.c*e.x-t.q.s*e.y+t.p.x,r=t.q.s*e.x+t.q.c*e.y+t.p.y;return i.x=s,i.y=r,i}function gn(i,t,e){var s=e.x-t.p.x,r=e.y-t.p.y,n=t.q.c*s+t.q.s*r,o=-t.q.s*s+t.q.c*r;return i.x=n,i.y=o,i}function lc(i,t,e,s){var r=t.q.c*s.x-t.q.s*s.y+t.p.x,n=t.q.s*s.x+t.q.c*s.y+t.p.y,o=r-e.p.x,a=n-e.p.y,l=e.q.c*o+e.q.s*a,p=-e.q.s*o+e.q.c*a;return i.x=l,i.y=p,i}function hc(i,t,e){var s=t.q.c*e.q.c+t.q.s*e.q.s,r=t.q.c*e.q.s-t.q.s*e.q.c,n=t.q.c*(e.p.x-t.p.x)+t.q.s*(e.p.y-t.p.y),o=-t.q.s*(e.p.x-t.p.x)+t.q.c*(e.p.y-t.p.y);return i.q.c=s,i.q.s=r,i.p.x=n,i.p.y=o,i}var oo=Math.sin,ao=Math.cos,Ul=Math.atan2,B=(function(){function i(t){if(!(this instanceof i))return new i(t);typeof t=="number"?this.setAngle(t):typeof t=="object"?this.setRot(t):this.setIdentity()}return i.neo=function(t){var e=Object.create(i.prototype);return e.setAngle(t),e},i.clone=function(t){var e=Object.create(i.prototype);return e.s=t.s,e.c=t.c,e},i.identity=function(){var t=Object.create(i.prototype);return t.s=0,t.c=1,t},i.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.s)&&Number.isFinite(t.c)},i.assert=function(t){},i.prototype.setIdentity=function(){this.s=0,this.c=1},i.prototype.set=function(t){typeof t=="object"?(this.s=t.s,this.c=t.c):(this.s=oo(t),this.c=ao(t))},i.prototype.setRot=function(t){this.s=t.s,this.c=t.c},i.prototype.setAngle=function(t){this.s=oo(t),this.c=ao(t)},i.prototype.getAngle=function(){return Ul(this.s,this.c)},i.prototype.getXAxis=function(){return c.neo(this.c,this.s)},i.prototype.getYAxis=function(){return c.neo(-this.s,this.c)},i.mul=function(t,e){if("c"in e&&"s"in e){var s=i.identity();return s.s=t.s*e.c+t.c*e.s,s.c=t.c*e.c-t.s*e.s,s}else if("x"in e&&"y"in e)return c.neo(t.c*e.x-t.s*e.y,t.s*e.x+t.c*e.y)},i.mulRot=function(t,e){var s=i.identity();return s.s=t.s*e.c+t.c*e.s,s.c=t.c*e.c-t.s*e.s,s},i.mulVec2=function(t,e){return c.neo(t.c*e.x-t.s*e.y,t.s*e.x+t.c*e.y)},i.mulSub=function(t,e,s){var r=t.c*(e.x-s.x)-t.s*(e.y-s.y),n=t.s*(e.x-s.x)+t.c*(e.y-s.y);return c.neo(r,n)},i.mulT=function(t,e){if("c"in e&&"s"in e){var s=i.identity();return s.s=t.c*e.s-t.s*e.c,s.c=t.c*e.c+t.s*e.s,s}else if("x"in e&&"y"in e)return c.neo(t.c*e.x+t.s*e.y,-t.s*e.x+t.c*e.y)},i.mulTRot=function(t,e){var s=i.identity();return s.s=t.c*e.s-t.s*e.c,s.c=t.c*e.c+t.s*e.s,s},i.mulTVec2=function(t,e){return c.neo(t.c*e.x+t.s*e.y,-t.s*e.x+t.c*e.y)},i})(),Wl=Math.atan2,co=Math.PI,ai=A(0,0),Xi=(function(){function i(){this.localCenter=c.zero(),this.c=c.zero(),this.a=0,this.alpha0=0,this.c0=c.zero(),this.a0=0}return i.prototype.recycle=function(){k(this.localCenter),k(this.c),this.a=0,this.alpha0=0,k(this.c0),this.a0=0},i.prototype.setTransform=function(t){D(ai,t,this.localCenter),x(this.c,ai),x(this.c0,ai),this.a=this.a0=Wl(t.q.s,t.q.c)},i.prototype.setLocalCenter=function(t,e){x(this.localCenter,t),D(ai,e,this.localCenter),x(this.c,ai),x(this.c0,ai)},i.prototype.getTransform=function(t,e){e===void 0&&(e=0),$l(t.q,(1-e)*this.a0+e*this.a),ct(t.p,1-e,this.c0,e,this.c),Ue(t.p,ce(ai,t.q,this.localCenter))},i.prototype.advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0);ct(this.c0,e,this.c,1-e,this.c0),this.a0=e*this.a+(1-e)*this.a0,this.alpha0=t},i.prototype.forward=function(){this.a0=this.a,x(this.c0,this.c)},i.prototype.normalize=function(){var t=nc(this.a0,-co,+co);this.a-=this.a0-t,this.a0=t},i.prototype.set=function(t){x(this.localCenter,t.localCenter),x(this.c,t.c),this.a=t.a,this.alpha0=t.alpha0,x(this.c0,t.c0),this.a0=t.a0},i})(),ge=(function(){function i(t,e){if(!(this instanceof i))return new i(t,e);this.p=c.zero(),this.q=B.identity(),typeof t<"u"&&this.p.setVec2(t),typeof e<"u"&&this.q.setAngle(e)}return i.clone=function(t){var e=Object.create(i.prototype);return e.p=c.clone(t.p),e.q=B.clone(t.q),e},i.neo=function(t,e){var s=Object.create(i.prototype);return s.p=c.clone(t),s.q=B.clone(e),s},i.identity=function(){var t=Object.create(i.prototype);return t.p=c.zero(),t.q=B.identity(),t},i.prototype.setIdentity=function(){this.p.setZero(),this.q.setIdentity()},i.prototype.set=function(t,e){typeof e>"u"?(this.p.set(t.p),this.q.set(t.q)):(this.p.set(t),this.q.set(e))},i.prototype.setNum=function(t,e){this.p.setVec2(t),this.q.setAngle(e)},i.prototype.setTransform=function(t){this.p.setVec2(t.p),this.q.setRot(t.q)},i.isValid=function(t){return t===null||typeof t>"u"?!1:c.isValid(t.p)&&B.isValid(t.q)},i.assert=function(t){},i.mul=function(t,e){if(Array.isArray(e)){for(var s=[],r=0;r<e.length;r++)s[r]=i.mul(t,e[r]);return s}else{if("x"in e&&"y"in e)return i.mulVec2(t,e);if("p"in e&&"q"in e)return i.mulXf(t,e)}},i.mulAll=function(t,e){for(var s=[],r=0;r<e.length;r++)s[r]=i.mul(t,e[r]);return s},i.mulFn=function(t){return function(e){return i.mul(t,e)}},i.mulVec2=function(t,e){var s=t.q.c*e.x-t.q.s*e.y+t.p.x,r=t.q.s*e.x+t.q.c*e.y+t.p.y;return c.neo(s,r)},i.mulXf=function(t,e){var s=i.identity();return s.q=B.mulRot(t.q,e.q),s.p=c.add(B.mulVec2(t.q,e.p),t.p),s},i.mulT=function(t,e){if("x"in e&&"y"in e)return i.mulTVec2(t,e);if("p"in e&&"q"in e)return i.mulTXf(t,e)},i.mulTVec2=function(t,e){var s=e.x-t.p.x,r=e.y-t.p.y,n=t.q.c*s+t.q.s*r,o=-t.q.s*s+t.q.c*r;return c.neo(n,o)},i.mulTXf=function(t,e){var s=i.identity();return s.q.setRot(B.mulTRot(t.q,e.q)),s.p.setVec2(B.mulTVec2(t.q,c.sub(e.p,t.p))),s},i})(),Yl=(function(){function i(){this.v=c.zero(),this.w=0}return i})(),mc=Math.sin,uc=Math.cos,jl=(function(){function i(){this.c=c.zero(),this.a=0}return i.prototype.getTransform=function(t,e){return t.q.c=uc(this.a),t.q.s=mc(this.a),t.p.x=this.c.x-(t.q.c*e.x-t.q.s*e.y),t.p.y=this.c.y-(t.q.s*e.x+t.q.c*e.y),t},i})();function Vs(i,t,e,s){return i.q.c=uc(s),i.q.s=mc(s),i.p.x=e.x-(i.q.c*t.x-i.q.s*t.y),i.p.y=e.y-(i.q.s*t.x+i.q.c*t.y),i}var Ti=(function(){function i(){this.style={},this.appData={}}return i.isValid=function(t){return t===null||typeof t>"u"?!1:typeof t.m_type=="string"&&typeof t.m_radius=="number"},i})(),lo=new Et,ho=new Et,mo=A(0,0),Jl={userData:null,friction:.2,restitution:0,density:0,isSensor:!1,filterGroupIndex:0,filterCategoryBits:1,filterMaskBits:65535},uo=(function(){function i(t,e){this.aabb=new Et,this.fixture=t,this.childIndex=e}return i})(),yr=(function(){function i(t,e,s){this.style={},this.appData={},e.shape?(s=e,e=e.shape):typeof s=="number"&&(s={density:s}),s=Xt(s,Jl),this.m_body=t,this.m_friction=s.friction,this.m_restitution=s.restitution,this.m_density=s.density,this.m_isSensor=s.isSensor,this.m_filterGroupIndex=s.filterGroupIndex,this.m_filterCategoryBits=s.filterCategoryBits,this.m_filterMaskBits=s.filterMaskBits,this.m_shape=e,this.m_next=null,this.m_proxies=[],this.m_proxyCount=0;for(var r=this.m_shape.getChildCount(),n=0;n<r;++n)this.m_proxies[n]=new uo(this,n);this.m_userData=s.userData,typeof s.style=="object"&&s.style!==null&&(this.style=s.style)}return i.prototype._reset=function(){var t=this.getBody(),e=t.m_world.m_broadPhase;this.destroyProxies(e),this.m_shape._reset&&this.m_shape._reset();for(var s=this.m_shape.getChildCount(),r=0;r<s;++r)this.m_proxies[r]=new uo(this,r);this.createProxies(e,t.m_xf),t.resetMassData()},i.prototype._serialize=function(){return{friction:this.m_friction,restitution:this.m_restitution,density:this.m_density,isSensor:this.m_isSensor,filterGroupIndex:this.m_filterGroupIndex,filterCategoryBits:this.m_filterCategoryBits,filterMaskBits:this.m_filterMaskBits,shape:this.m_shape}},i._deserialize=function(t,e,s){var r=s(Ti,t.shape),n=r&&new i(e,r,t);return n},i.prototype.getType=function(){return this.m_shape.m_type},i.prototype.getShape=function(){return this.m_shape},i.prototype.isSensor=function(){return this.m_isSensor},i.prototype.setSensor=function(t){t!=this.m_isSensor&&(this.m_body.setAwake(!0),this.m_isSensor=t)},i.prototype.getUserData=function(){return this.m_userData},i.prototype.setUserData=function(t){this.m_userData=t},i.prototype.getBody=function(){return this.m_body},i.prototype.getNext=function(){return this.m_next},i.prototype.getDensity=function(){return this.m_density},i.prototype.setDensity=function(t){this.m_density=t},i.prototype.getFriction=function(){return this.m_friction},i.prototype.setFriction=function(t){this.m_friction=t},i.prototype.getRestitution=function(){return this.m_restitution},i.prototype.setRestitution=function(t){this.m_restitution=t},i.prototype.testPoint=function(t){return this.m_shape.testPoint(this.m_body.getTransform(),t)},i.prototype.rayCast=function(t,e,s){return this.m_shape.rayCast(t,e,this.m_body.getTransform(),s)},i.prototype.getMassData=function(t){this.m_shape.computeMass(t,this.m_density)},i.prototype.getAABB=function(t){return this.m_proxies[t].aabb},i.prototype.createProxies=function(t,e){this.m_proxyCount=this.m_shape.getChildCount();for(var s=0;s<this.m_proxyCount;++s){var r=this.m_proxies[s];this.m_shape.computeAABB(r.aabb,e,s),r.proxyId=t.createProxy(r.aabb,r)}},i.prototype.destroyProxies=function(t){for(var e=0;e<this.m_proxyCount;++e){var s=this.m_proxies[e];t.destroyProxy(s.proxyId),s.proxyId=null}this.m_proxyCount=0},i.prototype.synchronize=function(t,e,s){for(var r=0;r<this.m_proxyCount;++r){var n=this.m_proxies[r];this.m_shape.computeAABB(lo,e,n.childIndex),this.m_shape.computeAABB(ho,s,n.childIndex),n.aabb.combine(lo,ho),R(mo,s.p,e.p),t.moveProxy(n.proxyId,n.aabb,mo)}},i.prototype.setFilterData=function(t){this.m_filterGroupIndex=t.groupIndex,this.m_filterCategoryBits=t.categoryBits,this.m_filterMaskBits=t.maskBits,this.refilter()},i.prototype.getFilterGroupIndex=function(){return this.m_filterGroupIndex},i.prototype.setFilterGroupIndex=function(t){this.m_filterGroupIndex=t,this.refilter()},i.prototype.getFilterCategoryBits=function(){return this.m_filterCategoryBits},i.prototype.setFilterCategoryBits=function(t){this.m_filterCategoryBits=t,this.refilter()},i.prototype.getFilterMaskBits=function(){return this.m_filterMaskBits},i.prototype.setFilterMaskBits=function(t){this.m_filterMaskBits=t,this.refilter()},i.prototype.refilter=function(){if(this.m_body!=null){for(var t=this.m_body.getContactList();t;){var e=t.contact,s=e.getFixtureA(),r=e.getFixtureB();(s==this||r==this)&&e.flagForFiltering(),t=t.next}var n=this.m_body.getWorld();if(n!=null)for(var o=n.m_broadPhase,a=0;a<this.m_proxyCount;++a)o.touchProxy(this.m_proxies[a].proxyId)}},i.prototype.shouldCollide=function(t){if(t.m_filterGroupIndex===this.m_filterGroupIndex&&t.m_filterGroupIndex!==0)return t.m_filterGroupIndex>0;var e=(t.m_filterMaskBits&this.m_filterCategoryBits)!==0,s=(t.m_filterCategoryBits&this.m_filterMaskBits)!==0,r=e&&s;return r},i})(),Yi="static",_o="kinematic",_e="dynamic",ks=A(0,0),ci=A(0,0),Ls=A(0,0),zs=A(0,0),po=Ci(0,0,0),Gl={type:Yi,position:c.zero(),angle:0,linearVelocity:c.zero(),angularVelocity:0,linearDamping:0,angularDamping:0,fixedRotation:!1,bullet:!1,gravityScale:1,allowSleep:!0,awake:!0,active:!0,userData:null},Q=(function(){function i(t,e){this.style={},this.appData={},e=Xt(e,Gl),this.m_world=t,this.m_awakeFlag=e.awake,this.m_autoSleepFlag=e.allowSleep,this.m_bulletFlag=e.bullet,this.m_fixedRotationFlag=e.fixedRotation,this.m_activeFlag=e.active,this.m_islandFlag=!1,this.m_toiFlag=!1,this.m_userData=e.userData,this.m_type=e.type,this.m_type==_e?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_xf=ge.identity(),this.m_xf.p.setVec2(e.position),this.m_xf.q.setAngle(e.angle),this.m_sweep=new Xi,this.m_sweep.setTransform(this.m_xf),this.c_velocity=new Yl,this.c_position=new jl,this.m_force=c.zero(),this.m_torque=0,this.m_linearVelocity=c.clone(e.linearVelocity),this.m_angularVelocity=e.angularVelocity,this.m_linearDamping=e.linearDamping,this.m_angularDamping=e.angularDamping,this.m_gravityScale=e.gravityScale,this.m_sleepTime=0,this.m_jointList=null,this.m_contactList=null,this.m_fixtureList=null,this.m_prev=null,this.m_next=null,this.m_destroyed=!1,typeof e.style=="object"&&e.style!==null&&(this.style=e.style)}return i.prototype._serialize=function(){for(var t=[],e=this.m_fixtureList;e;e=e.m_next)t.push(e);return{type:this.m_type,bullet:this.m_bulletFlag,position:this.m_xf.p,angle:this.m_xf.q.getAngle(),linearVelocity:this.m_linearVelocity,angularVelocity:this.m_angularVelocity,fixtures:t}},i._deserialize=function(t,e,s){var r=new i(e,t);if(t.fixtures)for(var n=t.fixtures.length-1;n>=0;n--){var o=s(yr,t.fixtures[n],r);r._addFixture(o)}return r},i.prototype.isWorldLocked=function(){return!!(this.m_world&&this.m_world.isLocked())},i.prototype.getWorld=function(){return this.m_world},i.prototype.getNext=function(){return this.m_next},i.prototype.setUserData=function(t){this.m_userData=t},i.prototype.getUserData=function(){return this.m_userData},i.prototype.getFixtureList=function(){return this.m_fixtureList},i.prototype.getJointList=function(){return this.m_jointList},i.prototype.getContactList=function(){return this.m_contactList},i.prototype.isStatic=function(){return this.m_type==Yi},i.prototype.isDynamic=function(){return this.m_type==_e},i.prototype.isKinematic=function(){return this.m_type==_o},i.prototype.setStatic=function(){return this.setType(Yi),this},i.prototype.setDynamic=function(){return this.setType(_e),this},i.prototype.setKinematic=function(){return this.setType(_o),this},i.prototype.getType=function(){return this.m_type},i.prototype.setType=function(t){if(this.isWorldLocked()!=!0&&this.m_type!=t){this.m_type=t,this.resetMassData(),this.m_type==Yi&&(this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_sweep.forward(),this.synchronizeFixtures()),this.setAwake(!0),this.m_force.setZero(),this.m_torque=0;for(var e=this.m_contactList;e;){var s=e;e=e.next,this.m_world.destroyContact(s.contact)}this.m_contactList=null;for(var r=this.m_world.m_broadPhase,n=this.m_fixtureList;n;n=n.m_next)for(var o=0;o<n.m_proxyCount;++o)r.touchProxy(n.m_proxies[o].proxyId)}},i.prototype.isBullet=function(){return this.m_bulletFlag},i.prototype.setBullet=function(t){this.m_bulletFlag=!!t},i.prototype.isSleepingAllowed=function(){return this.m_autoSleepFlag},i.prototype.setSleepingAllowed=function(t){this.m_autoSleepFlag=!!t,this.m_autoSleepFlag==!1&&this.setAwake(!0)},i.prototype.isAwake=function(){return this.m_awakeFlag},i.prototype.setAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_force.setZero(),this.m_torque=0)},i.prototype.isActive=function(){return this.m_activeFlag},i.prototype.setActive=function(t){if(t!=this.m_activeFlag)if(this.m_activeFlag=!!t,this.m_activeFlag){for(var e=this.m_world.m_broadPhase,s=this.m_fixtureList;s;s=s.m_next)s.createProxies(e,this.m_xf);this.m_world.m_newFixture=!0}else{for(var e=this.m_world.m_broadPhase,s=this.m_fixtureList;s;s=s.m_next)s.destroyProxies(e);for(var r=this.m_contactList;r;){var n=r;r=r.next,this.m_world.destroyContact(n.contact)}this.m_contactList=null}},i.prototype.isFixedRotation=function(){return this.m_fixedRotationFlag},i.prototype.setFixedRotation=function(t){this.m_fixedRotationFlag!=t&&(this.m_fixedRotationFlag=!!t,this.m_angularVelocity=0,this.resetMassData())},i.prototype.getTransform=function(){return this.m_xf},i.prototype.setTransform=function(t,e){if(this.isWorldLocked()!=!0){typeof e=="number"?this.m_xf.setNum(t,e):this.m_xf.setTransform(t),this.m_sweep.setTransform(this.m_xf);for(var s=this.m_world.m_broadPhase,r=this.m_fixtureList;r;r=r.m_next)r.synchronize(s,this.m_xf,this.m_xf);this.setAwake(!0)}},i.prototype.synchronizeTransform=function(){this.m_sweep.getTransform(this.m_xf,1)},i.prototype.synchronizeFixtures=function(){this.m_sweep.getTransform(po,0);for(var t=this.m_world.m_broadPhase,e=this.m_fixtureList;e;e=e.m_next)e.synchronize(t,po,this.m_xf)},i.prototype.advance=function(t){this.m_sweep.advance(t),x(this.m_sweep.c,this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_sweep.getTransform(this.m_xf,1)},i.prototype.getPosition=function(){return this.m_xf.p},i.prototype.setPosition=function(t){this.setTransform(t,this.m_sweep.a)},i.prototype.getAngle=function(){return this.m_sweep.a},i.prototype.setAngle=function(t){this.setTransform(this.m_xf.p,t)},i.prototype.getWorldCenter=function(){return this.m_sweep.c},i.prototype.getLocalCenter=function(){return this.m_sweep.localCenter},i.prototype.getLinearVelocity=function(){return this.m_linearVelocity},i.prototype.getLinearVelocityFromWorldPoint=function(t){var e=c.sub(t,this.m_sweep.c);return c.add(this.m_linearVelocity,c.crossNumVec2(this.m_angularVelocity,e))},i.prototype.getLinearVelocityFromLocalPoint=function(t){return this.getLinearVelocityFromWorldPoint(this.getWorldPoint(t))},i.prototype.setLinearVelocity=function(t){this.m_type!=Yi&&(c.dot(t,t)>0&&this.setAwake(!0),this.m_linearVelocity.setVec2(t))},i.prototype.getAngularVelocity=function(){return this.m_angularVelocity},i.prototype.setAngularVelocity=function(t){this.m_type!=Yi&&(t*t>0&&this.setAwake(!0),this.m_angularVelocity=t)},i.prototype.getLinearDamping=function(){return this.m_linearDamping},i.prototype.setLinearDamping=function(t){this.m_linearDamping=t},i.prototype.getAngularDamping=function(){return this.m_angularDamping},i.prototype.setAngularDamping=function(t){this.m_angularDamping=t},i.prototype.getGravityScale=function(){return this.m_gravityScale},i.prototype.setGravityScale=function(t){this.m_gravityScale=t},i.prototype.getMass=function(){return this.m_mass},i.prototype.getInertia=function(){return this.m_I+this.m_mass*c.dot(this.m_sweep.localCenter,this.m_sweep.localCenter)},i.prototype.getMassData=function(t){t.mass=this.m_mass,t.I=this.getInertia(),x(t.center,this.m_sweep.localCenter)},i.prototype.resetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,k(this.m_sweep.localCenter),this.isStatic()||this.isKinematic()){x(this.m_sweep.c0,this.m_xf.p),x(this.m_sweep.c,this.m_xf.p),this.m_sweep.a0=this.m_sweep.a;return}k(ci);for(var t=this.m_fixtureList;t;t=t.m_next)if(t.m_density!=0){var e={mass:0,center:A(0,0),I:0};t.getMassData(e),this.m_mass+=e.mass,fe(ci,e.mass,e.center),this.m_I+=e.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,L(ci,this.m_invMass,ci)):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&this.m_fixedRotationFlag==!1?(this.m_I-=this.m_mass*M(ci,ci),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0),x(ks,this.m_sweep.c),this.m_sweep.setLocalCenter(ci,this.m_xf),R(Ls,this.m_sweep.c,ks),Jt(zs,this.m_angularVelocity,Ls),ne(this.m_linearVelocity,zs)},i.prototype.setMassData=function(t){this.isWorldLocked()!=!0&&this.m_type==_e&&(this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&this.m_fixedRotationFlag==!1&&(this.m_I=t.I-this.m_mass*M(t.center,t.center),this.m_invI=1/this.m_I),x(ks,this.m_sweep.c),this.m_sweep.setLocalCenter(t.center,this.m_xf),R(Ls,this.m_sweep.c,ks),Jt(zs,this.m_angularVelocity,Ls),ne(this.m_linearVelocity,zs))},i.prototype.applyForce=function(t,e,s){s===void 0&&(s=!0),this.m_type==_e&&(s&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_force.add(t),this.m_torque+=c.crossVec2Vec2(c.sub(e,this.m_sweep.c),t)))},i.prototype.applyForceToCenter=function(t,e){e===void 0&&(e=!0),this.m_type==_e&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&this.m_force.add(t))},i.prototype.applyTorque=function(t,e){e===void 0&&(e=!0),this.m_type==_e&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))},i.prototype.applyLinearImpulse=function(t,e,s){s===void 0&&(s=!0),this.m_type==_e&&(s&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.addMul(this.m_invMass,t),this.m_angularVelocity+=this.m_invI*c.crossVec2Vec2(c.sub(e,this.m_sweep.c),t)))},i.prototype.applyAngularImpulse=function(t,e){e===void 0&&(e=!0),this.m_type==_e&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))},i.prototype.shouldCollide=function(t){if(this.m_type!=_e&&t.m_type!=_e)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&e.joint.m_collideConnected==!1)return!1;return!0},i.prototype._addFixture=function(t){if(this.isWorldLocked()==!0)return null;if(this.m_activeFlag){var e=this.m_world.m_broadPhase;t.createProxies(e,this.m_xf)}return t.m_next=this.m_fixtureList,this.m_fixtureList=t,t.m_density>0&&this.resetMassData(),this.m_world.m_newFixture=!0,t},i.prototype.createFixture=function(t,e){if(this.isWorldLocked()==!0)return null;var s=new yr(this,t,e);return this._addFixture(s),s},i.prototype.destroyFixture=function(t){if(this.isWorldLocked()!=!0){if(this.m_fixtureList===t)this.m_fixtureList=t.m_next;else for(var e=this.m_fixtureList;e!=null;){if(e.m_next===t){e.m_next=t.m_next;break}e=e.m_next}for(var s=this.m_contactList;s;){var r=s.contact;s=s.next;var n=r.getFixtureA(),o=r.getFixtureB();(t==n||t==o)&&this.m_world.destroyContact(r)}if(this.m_activeFlag){var a=this.m_world.m_broadPhase;t.destroyProxies(a)}t.m_body=null,t.m_next=null,this.m_world.publish("remove-fixture",t),this.resetMassData()}},i.prototype.getWorldPoint=function(t){return ge.mulVec2(this.m_xf,t)},i.prototype.getWorldVector=function(t){return B.mulVec2(this.m_xf.q,t)},i.prototype.getLocalPoint=function(t){return ge.mulTVec2(this.m_xf,t)},i.prototype.getLocalVector=function(t){return B.mulTVec2(this.m_xf.q,t)},i.STATIC="static",i.KINEMATIC="kinematic",i.DYNAMIC="dynamic",i})(),yo=(function(){function i(){this.other=null,this.joint=null,this.prev=null,this.next=null}return i})(),kt=(function(){function i(t,e,s){this.m_type="unknown-joint",this.m_prev=null,this.m_next=null,this.m_edgeA=new yo,this.m_edgeB=new yo,this.m_islandFlag=!1,this.style={},this.appData={},e="bodyA"in t?t.bodyA:e,s="bodyB"in t?t.bodyB:s,this.m_bodyA=e,this.m_bodyB=s,this.m_collideConnected=!!t.collideConnected,this.m_userData=t.userData,typeof t.style=="object"&&t.style!==null&&(this.style=t.style)}return i.prototype.isActive=function(){return this.m_bodyA.isActive()&&this.m_bodyB.isActive()},i.prototype.getType=function(){return this.m_type},i.prototype.getBodyA=function(){return this.m_bodyA},i.prototype.getBodyB=function(){return this.m_bodyB},i.prototype.getNext=function(){return this.m_next},i.prototype.getUserData=function(){return this.m_userData},i.prototype.setUserData=function(t){this.m_userData=t},i.prototype.getCollideConnected=function(){return this.m_collideConnected},i.prototype.shiftOrigin=function(t){},i.prototype._resetAnchors=function(t){return this._reset(t)},i})(),ht={gjkCalls:0,gjkIters:0,gjkMaxIters:0,toiTime:0,toiMaxTime:0,toiCalls:0,toiIters:0,toiMaxIters:0,toiRootIters:0,toiMaxRootIters:0},Kl=function(){return Date.now()},Xl=function(i){return Date.now()-i};const fo={now:Kl,diff:Xl};var Ql=Math.max,Fs=A(0,0),Ds=A(0,0),Yt=A(0,0),Rs=A(0,0),Er=A(0,0),Zl=A(0,0),th=A(0,0);ht.gjkCalls=0;ht.gjkIters=0;ht.gjkMaxIters=0;var xn=(function(){function i(){this.proxyA=new Ai,this.proxyB=new Ai,this.transformA=ge.identity(),this.transformB=ge.identity(),this.useRadii=!1}return i.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),this.useRadii=!1},i})(),wn=(function(){function i(){this.pointA=A(0,0),this.pointB=A(0,0),this.distance=0,this.iterations=0}return i.prototype.recycle=function(){k(this.pointA),k(this.pointB),this.distance=0,this.iterations=0},i})(),bn=(function(){function i(){this.metric=0,this.indexA=[],this.indexB=[],this.count=0}return i.prototype.recycle=function(){this.metric=0,this.indexA.length=0,this.indexB.length=0,this.count=0},i})(),Mi=function(i,t,e){++ht.gjkCalls;var s=e.proxyA,r=e.proxyB,n=e.transformA,o=e.transformB;pe.recycle(),pe.readCache(t,s,n,r,o);for(var a=pe.m_v,l=I.maxDistanceIterations,p=[],_=[],y=0,h=0;h<l;){y=pe.m_count;for(var m=0;m<y;++m)p[m]=a[m].indexA,_[m]=a[m].indexB;if(pe.solve(),pe.m_count===3)break;var u=pe.getSearchDirection();if(wi(u)<qt*qt)break;var d=a[pe.m_count];d.indexA=s.getSupport(ji(Fs,n.q,L(Fs,-1,u))),D(d.wA,n,s.getVertex(d.indexA)),d.indexB=r.getSupport(ji(Fs,o.q,u)),D(d.wB,o,r.getVertex(d.indexB)),R(d.w,d.wB,d.wA),++h,++ht.gjkIters;for(var f=!1,m=0;m<y;++m)if(d.indexA===p[m]&&d.indexB===_[m]){f=!0;break}if(f)break;++pe.m_count}if(ht.gjkMaxIters=Ql(ht.gjkMaxIters,h),pe.getWitnessPoints(i.pointA,i.pointB),i.distance=cc(i.pointA,i.pointB),i.iterations=h,pe.writeCache(t),e.useRadii){var v=s.m_radius,w=r.m_radius;if(i.distance>v+w&&i.distance>qt)i.distance-=v+w,R(Ds,i.pointB,i.pointA),ve(Ds),fe(i.pointA,v,Ds),fs(i.pointB,w,Ds);else{var g=R(Fs,i.pointA,i.pointB);x(i.pointA,g),x(i.pointB,g),i.distance=0}}},Ai=(function(){function i(){this.m_vertices=[],this.m_count=0,this.m_radius=0}return i.prototype.recycle=function(){this.m_vertices.length=0,this.m_count=0,this.m_radius=0},i.prototype.getVertexCount=function(){return this.m_count},i.prototype.getVertex=function(t){return this.m_vertices[t]},i.prototype.getSupport=function(t){for(var e=-1,s=-1/0,r=0;r<this.m_count;++r){var n=M(this.m_vertices[r],t);n>s&&(e=r,s=n)}return e},i.prototype.getSupportVertex=function(t){return this.m_vertices[this.getSupport(t)]},i.prototype.set=function(t,e){t.computeDistanceProxy(this,e)},i.prototype.setVertices=function(t,e,s){this.m_vertices=t,this.m_count=e,this.m_radius=s},i})(),Vr=(function(){function i(){this.wA=A(0,0),this.indexA=0,this.wB=A(0,0),this.indexB=0,this.w=A(0,0),this.a=0}return i.prototype.recycle=function(){this.indexA=0,this.indexB=0,k(this.wA),k(this.wB),k(this.w),this.a=0},i.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,x(this.wA,t.wA),x(this.wB,t.wB),x(this.w,t.w),this.a=t.a},i})(),qs=A(0,0),os=A(0,0),eh=(function(){function i(){this.m_v1=new Vr,this.m_v2=new Vr,this.m_v3=new Vr,this.m_v=[this.m_v1,this.m_v2,this.m_v3]}return i.prototype.recycle=function(){this.m_v1.recycle(),this.m_v2.recycle(),this.m_v3.recycle(),this.m_count=0},i.prototype.toString=function(){return this.m_count===3?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y,this.m_v3.a,this.m_v3.wA.x,this.m_v3.wA.y,this.m_v3.wB.x,this.m_v3.wB.y].toString():this.m_count===2?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y].toString():this.m_count===1?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y].toString():"+"+this.m_count},i.prototype.readCache=function(t,e,s,r,n){this.m_count=t.count;for(var o=0;o<this.m_count;++o){var a=this.m_v[o];a.indexA=t.indexA[o],a.indexB=t.indexB[o];var l=e.getVertex(a.indexA),p=r.getVertex(a.indexB);D(a.wA,s,l),D(a.wB,n,p),R(a.w,a.wB,a.wA),a.a=0}if(this.m_count>1){var _=t.metric,y=this.getMetric();(y<.5*_||2*_<y||y<qt)&&(this.m_count=0)}if(this.m_count===0){var a=this.m_v[0];a.indexA=0,a.indexB=0;var l=e.getVertex(0),p=r.getVertex(0);D(a.wA,s,l),D(a.wB,n,p),R(a.w,a.wB,a.wA),a.a=1,this.m_count=1}},i.prototype.writeCache=function(t){t.metric=this.getMetric(),t.count=this.m_count;for(var e=0;e<this.m_count;++e)t.indexA[e]=this.m_v[e].indexA,t.indexB[e]=this.m_v[e].indexB},i.prototype.getSearchDirection=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_count){case 1:return Tt(qs,-t.w.x,-t.w.y);case 2:{R(Yt,e.w,t.w);var s=-$(Yt,t.w);return s>0?Tt(qs,-Yt.y,Yt.x):Tt(qs,Yt.y,-Yt.x)}default:return k(qs)}},i.prototype.getClosestPoint=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_count){case 0:return k(os);case 1:return x(os,t.w);case 2:return ct(os,t.a,t.w,e.a,e.w);case 3:return k(os);default:return k(os)}},i.prototype.getWitnessPoints=function(t,e){var s=this.m_v1,r=this.m_v2,n=this.m_v3;switch(this.m_count){case 0:break;case 1:x(t,s.wA),x(e,s.wB);break;case 2:ct(t,s.a,s.wA,r.a,r.wA),ct(e,s.a,s.wB,r.a,r.wB);break;case 3:Pe(t,s.a,s.wA,r.a,r.wA,n.a,n.wA),x(e,t);break}},i.prototype.getMetric=function(){switch(this.m_count){case 0:return 0;case 1:return 0;case 2:return cc(this.m_v1.w,this.m_v2.w);case 3:return $(R(Zl,this.m_v2.w,this.m_v1.w),R(th,this.m_v3.w,this.m_v1.w));default:return 0}},i.prototype.solve=function(){switch(this.m_count){case 1:break;case 2:this.solve2();break;case 3:this.solve3();break}},i.prototype.solve2=function(){var t=this.m_v1.w,e=this.m_v2.w;R(Yt,e,t);var s=-M(t,Yt);if(s<=0){this.m_v1.a=1,this.m_count=1;return}var r=M(e,Yt);if(r<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.set(this.m_v2);return}var n=1/(r+s);this.m_v1.a=r*n,this.m_v2.a=s*n,this.m_count=2},i.prototype.solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,s=this.m_v3.w;R(Yt,e,t);var r=M(t,Yt),n=M(e,Yt),o=n,a=-r;R(Rs,s,t);var l=M(t,Rs),p=M(s,Rs),_=p,y=-l;R(Er,s,e);var h=M(e,Er),m=M(s,Er),u=m,d=-h,f=$(Yt,Rs),v=f*$(e,s),w=f*$(s,t),g=f*$(t,e);if(a<=0&&y<=0){this.m_v1.a=1,this.m_count=1;return}if(o>0&&a>0&&g<=0){var b=1/(o+a);this.m_v1.a=o*b,this.m_v2.a=a*b,this.m_count=2;return}if(_>0&&y>0&&w<=0){var S=1/(_+y);this.m_v1.a=_*S,this.m_v3.a=y*S,this.m_count=2,this.m_v2.set(this.m_v3);return}if(o<=0&&d<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.set(this.m_v2);return}if(_<=0&&u<=0){this.m_v3.a=1,this.m_count=1,this.m_v1.set(this.m_v3);return}if(u>0&&d>0&&v<=0){var C=1/(u+d);this.m_v2.a=u*C,this.m_v3.a=d*C,this.m_count=2,this.m_v1.set(this.m_v3);return}var T=1/(v+w+g);this.m_v1.a=v*T,this.m_v2.a=w*T,this.m_v3.a=g*T,this.m_count=3},i})(),pe=new eh,li=new xn,vo=new bn,kr=new wn,_c=function(i,t,e,s,r,n){return li.recycle(),li.proxyA.set(i,t),li.proxyB.set(e,s),dr(li.transformA,r),dr(li.transformB,n),li.useRadii=!0,kr.recycle(),vo.recycle(),Mi(kr,vo,li),kr.distance<10*qt};Mi.testOverlap=_c;Mi.Input=xn;Mi.Output=wn;Mi.Proxy=Ai;Mi.Cache=bn;(function(){function i(){this.proxyA=new Ai,this.proxyB=new Ai,this.transformA=ge.identity(),this.transformB=ge.identity(),this.translationB=c.zero()}return i.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),k(this.translationB)},i})();var ih=Math.abs,Ns=Math.max,pc=(function(){function i(){this.proxyA=new Ai,this.proxyB=new Ai,this.sweepA=new Xi,this.sweepB=new Xi}return i.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.sweepA.recycle(),this.sweepB.recycle(),this.tMax=-1},i})(),oe;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_unknown=0]="e_unknown",i[i.e_failed=1]="e_failed",i[i.e_overlapped=2]="e_overlapped",i[i.e_touching=3]="e_touching",i[i.e_separated=4]="e_separated"})(oe||(oe={}));var dc=(function(){function i(){this.state=oe.e_unset,this.t=-1}return i.prototype.recycle=function(){this.state=oe.e_unset,this.t=-1},i})();ht.toiTime=0;ht.toiMaxTime=0;ht.toiCalls=0;ht.toiIters=0;ht.toiMaxIters=0;ht.toiRootIters=0;ht.toiMaxRootIters=0;var Vi=new xn,Lr=new wn,zr=new bn,Ot=Ci(0,0,0),$t=Ci(0,0,0),as=A(0,0),Be=A(0,0),ee=A(0,0),Nt=A(0,0),Os=A(0,0),$s=A(0,0),Hs=A(0,0),Us=A(0,0),An=function(i,t){var e=fo.now();++ht.toiCalls,i.state=oe.e_unknown,i.t=t.tMax;var s=t.proxyA,r=t.proxyB,n=t.sweepA,o=t.sweepB;n.normalize(),o.normalize();var a=t.tMax,l=s.m_radius+r.m_radius,p=Ns(I.linearSlop,l-3*I.linearSlop),_=.25*I.linearSlop,y=0,h=I.maxTOIIterations,m=0;for(zr.recycle(),Vi.proxyA.setVertices(s.m_vertices,s.m_count,s.m_radius),Vi.proxyB.setVertices(r.m_vertices,r.m_count,r.m_radius),Vi.useRadii=!1;;){if(n.getTransform(Ot,y),o.getTransform($t,y),dr(Vi.transformA,Ot),dr(Vi.transformB,$t),Mi(Lr,zr,Vi),Lr.distance<=0){i.state=oe.e_overlapped,i.t=0;break}if(Lr.distance<p+_){i.state=oe.e_touching,i.t=y;break}cs.initialize(zr,s,n,r,o,y);for(var u=!1,d=a,f=0;;){var v=cs.findMinSeparation(d);if(v>p+_){i.state=oe.e_separated,i.t=a,u=!0;break}if(v>p-_){y=d;break}var w=cs.evaluate(y);if(w<p-_){i.state=oe.e_failed,i.t=y,u=!0;break}if(w<=p+_){i.state=oe.e_touching,i.t=y,u=!0;break}for(var g=0,b=y,S=d;;){var C=void 0;g&1?C=b+(p-w)*(S-b)/(v-w):C=.5*(b+S),++g,++ht.toiRootIters;var T=cs.evaluate(C);if(ih(T-p)<_){d=C;break}if(T>p?(b=C,w=T):(S=C,v=T),g===50)break}if(ht.toiMaxRootIters=Ns(ht.toiMaxRootIters,g),++f,f===I.maxPolygonVertices)break}if(++m,++ht.toiIters,u)break;if(m===h){i.state=oe.e_failed,i.t=y;break}}ht.toiMaxIters=Ns(ht.toiMaxIters,m);var P=fo.diff(e);ht.toiMaxTime=Ns(ht.toiMaxTime,P),ht.toiTime+=P,cs.recycle()},Ie;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_points=1]="e_points",i[i.e_faceA=2]="e_faceA",i[i.e_faceB=3]="e_faceB"})(Ie||(Ie={}));var sh=(function(){function i(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=Ie.e_unset,this.m_localPoint=A(0,0),this.m_axis=A(0,0),this.indexA=-1,this.indexB=-1}return i.prototype.recycle=function(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=Ie.e_unset,k(this.m_localPoint),k(this.m_axis),this.indexA=-1,this.indexB=-1},i.prototype.initialize=function(t,e,s,r,n,o){var a=t.count;if(this.m_proxyA=e,this.m_proxyB=r,this.m_sweepA=s,this.m_sweepB=n,this.m_sweepA.getTransform(Ot,o),this.m_sweepB.getTransform($t,o),a===1){this.m_type=Ie.e_points;var l=this.m_proxyA.getVertex(t.indexA[0]),p=this.m_proxyB.getVertex(t.indexB[0]);D(Be,Ot,l),D(ee,$t,p),R(this.m_axis,ee,Be);var _=Ol(this.m_axis);return _}else if(t.indexA[0]===t.indexA[1]){this.m_type=Ie.e_faceB;var y=r.getVertex(t.indexB[0]),h=r.getVertex(t.indexB[1]);xi(this.m_axis,R(as,h,y),1),ve(this.m_axis),ce(Nt,$t.q,this.m_axis),ct(this.m_localPoint,.5,y,.5,h),D(ee,$t,this.m_localPoint);var m=e.getVertex(t.indexA[0]),u=ge.mulVec2(Ot,m),_=M(u,Nt)-M(ee,Nt);return _<0&&(bs(this.m_axis),_=-_),_}else{this.m_type=Ie.e_faceA;var d=this.m_proxyA.getVertex(t.indexA[0]),f=this.m_proxyA.getVertex(t.indexA[1]);xi(this.m_axis,R(as,f,d),1),ve(this.m_axis),ce(Nt,Ot.q,this.m_axis),ct(this.m_localPoint,.5,d,.5,f),D(Be,Ot,this.m_localPoint);var v=this.m_proxyB.getVertex(t.indexB[0]);D(ee,$t,v);var _=M(ee,Nt)-M(Be,Nt);return _<0&&(bs(this.m_axis),_=-_),_}},i.prototype.compute=function(t,e){switch(this.m_sweepA.getTransform(Ot,e),this.m_sweepB.getTransform($t,e),this.m_type){case Ie.e_points:{t&&(ji(Os,Ot.q,this.m_axis),ji($s,$t.q,L(as,-1,this.m_axis)),this.indexA=this.m_proxyA.getSupport(Os),this.indexB=this.m_proxyB.getSupport($s)),x(Hs,this.m_proxyA.getVertex(this.indexA)),x(Us,this.m_proxyB.getVertex(this.indexB)),D(Be,Ot,Hs),D(ee,$t,Us);var s=M(ee,this.m_axis)-M(Be,this.m_axis);return s}case Ie.e_faceA:{ce(Nt,Ot.q,this.m_axis),D(Be,Ot,this.m_localPoint),t&&(ji($s,$t.q,L(as,-1,Nt)),this.indexA=-1,this.indexB=this.m_proxyB.getSupport($s)),x(Us,this.m_proxyB.getVertex(this.indexB)),D(ee,$t,Us);var s=M(ee,Nt)-M(Be,Nt);return s}case Ie.e_faceB:{ce(Nt,$t.q,this.m_axis),D(ee,$t,this.m_localPoint),t&&(ji(Os,Ot.q,L(as,-1,Nt)),this.indexB=-1,this.indexA=this.m_proxyA.getSupport(Os)),x(Hs,this.m_proxyA.getVertex(this.indexA)),D(Be,Ot,Hs);var s=M(Be,Nt)-M(ee,Nt);return s}default:return t&&(this.indexA=-1,this.indexB=-1),0}},i.prototype.findMinSeparation=function(t){return this.compute(!0,t)},i.prototype.evaluate=function(t){return this.compute(!1,t)},i})(),cs=new sh;An.Input=pc;An.Output=dc;var go=Math.abs,xo=Math.sqrt,Ws=Math.min,Bn=(function(){function i(){this.dt=0,this.inv_dt=0,this.velocityIterations=0,this.positionIterations=0,this.warmStarting=!1,this.blockSolve=!0,this.inv_dt0=0,this.dtRatio=1}return i.prototype.reset=function(t){this.dt>0&&(this.inv_dt0=this.inv_dt),this.dt=t,this.inv_dt=t==0?0:1/t,this.dtRatio=t*this.inv_dt0},i})(),ki=new Bn,De=A(0,0),It=A(0,0),Ys=A(0,0),Li=new pc,Fr=new dc,wo=new Xi,bo=new Xi,Ao=new Xi,rh=(function(){function i(t){this.contact=t,this.normals=[],this.tangents=[]}return i.prototype.recycle=function(){this.normals.length=0,this.tangents.length=0},Object.defineProperty(i.prototype,"normalImpulses",{get:function(){var t=this.contact,e=this.normals;e.length=0;for(var s=0;s<t.v_points.length;++s)e.push(t.v_points[s].normalImpulse);return e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"tangentImpulses",{get:function(){var t=this.contact,e=this.tangents;e.length=0;for(var s=0;s<t.v_points.length;++s)e.push(t.v_points[s].tangentImpulse);return e},enumerable:!1,configurable:!0}),i})(),yc=(function(){function i(t){this.m_world=t,this.m_stack=[],this.m_bodies=[],this.m_contacts=[],this.m_joints=[]}return i.prototype.clear=function(){this.m_stack.length=0,this.m_bodies.length=0,this.m_contacts.length=0,this.m_joints.length=0},i.prototype.addBody=function(t){this.m_bodies.push(t)},i.prototype.addContact=function(t){this.m_contacts.push(t)},i.prototype.addJoint=function(t){this.m_joints.push(t)},i.prototype.solveWorld=function(t){for(var e=this.m_world,s=e.m_bodyList;s;s=s.m_next)s.m_islandFlag=!1;for(var r=e.m_contactList;r;r=r.m_next)r.m_islandFlag=!1;for(var n=e.m_jointList;n;n=n.m_next)n.m_islandFlag=!1;for(var o=this.m_stack,a=e.m_bodyList;a;a=a.m_next)if(!a.m_islandFlag&&!(a.isAwake()==!1||a.isActive()==!1)&&!a.isStatic()){for(this.clear(),o.push(a),a.m_islandFlag=!0;o.length>0;){var s=o.pop();if(this.addBody(s),s.m_awakeFlag=!0,!s.isStatic()){for(var l=s.m_contactList;l;l=l.next){var p=l.contact;if(!p.m_islandFlag&&!(p.isEnabled()==!1||p.isTouching()==!1)){var _=p.m_fixtureA.m_isSensor,y=p.m_fixtureB.m_isSensor;if(!(_||y)){this.addContact(p),p.m_islandFlag=!0;var h=l.other;h.m_islandFlag||(o.push(h),h.m_islandFlag=!0)}}}for(var m=s.m_jointList;m;m=m.next)if(m.joint.m_islandFlag!=!0){var h=m.other;h.isActive()!=!1&&(this.addJoint(m.joint),m.joint.m_islandFlag=!0,!h.m_islandFlag&&(o.push(h),h.m_islandFlag=!0))}}}this.solveIsland(t);for(var u=0;u<this.m_bodies.length;++u){var s=this.m_bodies[u];s.isStatic()&&(s.m_islandFlag=!1)}}},i.prototype.solveIsland=function(t){for(var e=this.m_world,s=e.m_gravity,r=e.m_allowSleep,n=t.dt,o=0;o<this.m_bodies.length;++o){var a=this.m_bodies[o];x(De,a.m_sweep.c);var l=a.m_sweep.a;x(It,a.m_linearVelocity);var p=a.m_angularVelocity;x(a.m_sweep.c0,a.m_sweep.c),a.m_sweep.a0=a.m_sweep.a,a.isDynamic()&&(fe(It,n*a.m_gravityScale,s),fe(It,n*a.m_invMass,a.m_force),p+=n*a.m_invI*a.m_torque,L(It,1/(1+n*a.m_linearDamping),It),p*=1/(1+n*a.m_angularDamping)),x(a.c_position.c,De),a.c_position.a=l,x(a.c_velocity.v,It),a.c_velocity.w=p}for(var o=0;o<this.m_contacts.length;++o){var _=this.m_contacts[o];_.initConstraint(t)}for(var o=0;o<this.m_contacts.length;++o){var _=this.m_contacts[o];_.initVelocityConstraint(t)}if(t.warmStarting)for(var o=0;o<this.m_contacts.length;++o){var _=this.m_contacts[o];_.warmStartConstraint(t)}for(var o=0;o<this.m_joints.length;++o){var y=this.m_joints[o];y.initVelocityConstraints(t)}for(var o=0;o<t.velocityIterations;++o){for(var h=0;h<this.m_joints.length;++h){var y=this.m_joints[h];y.solveVelocityConstraints(t)}for(var h=0;h<this.m_contacts.length;++h){var _=this.m_contacts[h];_.solveVelocityConstraint(t)}}for(var o=0;o<this.m_contacts.length;++o){var _=this.m_contacts[o];_.storeConstraintImpulses(t)}for(var o=0;o<this.m_bodies.length;++o){var a=this.m_bodies[o];x(De,a.c_position.c);var l=a.c_position.a;x(It,a.c_velocity.v);var p=a.c_velocity.w;L(Ys,n,It);var m=wi(Ys);if(m>I.maxTranslationSquared){var u=I.maxTranslation/xo(m);no(It,u)}var d=n*p;if(d*d>I.maxRotationSquared){var u=I.maxRotation/go(d);p*=u}fe(De,n,It),l+=n*p,x(a.c_position.c,De),a.c_position.a=l,x(a.c_velocity.v,It),a.c_velocity.w=p}for(var f=!1,o=0;o<t.positionIterations;++o){for(var v=0,h=0;h<this.m_contacts.length;++h){var _=this.m_contacts[h],w=_.solvePositionConstraint(t);v=Ws(v,w)}for(var g=v>=-3*I.linearSlop,b=!0,h=0;h<this.m_joints.length;++h){var y=this.m_joints[h],S=y.solvePositionConstraints(t);b=b&&S}if(g&&b){f=!0;break}}for(var o=0;o<this.m_bodies.length;++o){var a=this.m_bodies[o];x(a.m_sweep.c,a.c_position.c),a.m_sweep.a=a.c_position.a,x(a.m_linearVelocity,a.c_velocity.v),a.m_angularVelocity=a.c_velocity.w,a.synchronizeTransform()}if(this.postSolveIsland(),r){for(var C=1/0,T=I.linearSleepToleranceSqr,P=I.angularSleepToleranceSqr,o=0;o<this.m_bodies.length;++o){var a=this.m_bodies[o];a.isStatic()||(a.m_autoSleepFlag==!1||a.m_angularVelocity*a.m_angularVelocity>P||wi(a.m_linearVelocity)>T?(a.m_sleepTime=0,C=0):(a.m_sleepTime+=n,C=Ws(C,a.m_sleepTime)))}if(C>=I.timeToSleep&&f)for(var o=0;o<this.m_bodies.length;++o){var a=this.m_bodies[o];a.setAwake(!1)}}},i.prototype.solveWorldTOI=function(t){var e=this.m_world;if(e.m_stepComplete){for(var s=e.m_bodyList;s;s=s.m_next)s.m_islandFlag=!1,s.m_sweep.alpha0=0;for(var r=e.m_contactList;r;r=r.m_next)r.m_toiFlag=!1,r.m_islandFlag=!1,r.m_toiCount=0,r.m_toi=1}for(;;){for(var n=null,o=1,a=e.m_contactList;a;a=a.m_next)if(a.isEnabled()!=!1&&!(a.m_toiCount>I.maxSubSteps)){var l=1;if(a.m_toiFlag)l=a.m_toi;else{var p=a.getFixtureA(),_=a.getFixtureB();if(p.isSensor()||_.isSensor())continue;var y=p.getBody(),h=_.getBody(),m=y.isAwake()&&!y.isStatic(),u=h.isAwake()&&!h.isStatic();if(m==!1&&u==!1)continue;var d=y.isBullet()||!y.isDynamic(),f=h.isBullet()||!h.isDynamic();if(d==!1&&f==!1)continue;var v=y.m_sweep.alpha0;y.m_sweep.alpha0<h.m_sweep.alpha0?(v=h.m_sweep.alpha0,y.m_sweep.advance(v)):h.m_sweep.alpha0<y.m_sweep.alpha0&&(v=y.m_sweep.alpha0,h.m_sweep.advance(v));var w=a.getChildIndexA(),g=a.getChildIndexB();Li.proxyA.set(p.getShape(),w),Li.proxyB.set(_.getShape(),g),Li.sweepA.set(y.m_sweep),Li.sweepB.set(h.m_sweep),Li.tMax=1,An(Fr,Li);var b=Fr.t;Fr.state==oe.e_touching?l=Ws(v+(1-v)*b,1):l=1,a.m_toi=l,a.m_toiFlag=!0}l<o&&(n=a,o=l)}if(n==null||1-10*qt<o){e.m_stepComplete=!0;break}var S=n.getFixtureA(),C=n.getFixtureB(),T=S.getBody(),P=C.getBody();if(bo.set(T.m_sweep),Ao.set(P.m_sweep),T.advance(o),P.advance(o),n.update(e),n.m_toiFlag=!1,++n.m_toiCount,n.isEnabled()==!1||n.isTouching()==!1){n.setEnabled(!1),T.m_sweep.set(bo),P.m_sweep.set(Ao),T.synchronizeTransform(),P.synchronizeTransform();continue}T.setAwake(!0),P.setAwake(!0),this.clear(),this.addBody(T),this.addBody(P),this.addContact(n),T.m_islandFlag=!0,P.m_islandFlag=!0,n.m_islandFlag=!0;for(var E=[T,P],z=0;z<E.length;++z){var H=E[z];if(H.isDynamic())for(var Y=H.m_contactList;Y;Y=Y.next){var W=Y.contact;if(!W.m_islandFlag){var j=Y.other;if(!(j.isDynamic()&&!H.isBullet()&&!j.isBullet())){var dt=W.m_fixtureA.m_isSensor,ot=W.m_fixtureB.m_isSensor;if(!(dt||ot)){if(wo.set(j.m_sweep),j.m_islandFlag==!1&&j.advance(o),W.update(e),W.isEnabled()==!1||W.isTouching()==!1){j.m_sweep.set(wo),j.synchronizeTransform();continue}W.m_islandFlag=!0,this.addContact(W),!j.m_islandFlag&&(j.m_islandFlag=!0,j.isStatic()||j.setAwake(!0),this.addBody(j))}}}}}ki.reset((1-o)*t.dt),ki.dtRatio=1,ki.positionIterations=20,ki.velocityIterations=t.velocityIterations,ki.warmStarting=!1,this.solveIslandTOI(ki,T,P);for(var z=0;z<this.m_bodies.length;++z){var H=this.m_bodies[z];if(H.m_islandFlag=!1,!!H.isDynamic()){H.synchronizeFixtures();for(var Y=H.m_contactList;Y;Y=Y.next)Y.contact.m_toiFlag=!1,Y.contact.m_islandFlag=!1}}if(e.findNewContacts(),e.m_subStepping){e.m_stepComplete=!1;break}}},i.prototype.solveIslandTOI=function(t,e,s){for(var _=0;_<this.m_bodies.length;++_){var r=this.m_bodies[_];x(r.c_position.c,r.m_sweep.c),r.c_position.a=r.m_sweep.a,x(r.c_velocity.v,r.m_linearVelocity),r.c_velocity.w=r.m_angularVelocity}for(var _=0;_<this.m_contacts.length;++_){var n=this.m_contacts[_];n.initConstraint(t)}for(var _=0;_<t.positionIterations;++_){for(var o=0,a=0;a<this.m_contacts.length;++a){var n=this.m_contacts[a],l=n.solvePositionConstraintTOI(t,e,s);o=Ws(o,l)}var p=o>=-1.5*I.linearSlop;if(p)break}var _;x(e.m_sweep.c0,e.c_position.c),e.m_sweep.a0=e.c_position.a,x(s.m_sweep.c0,s.c_position.c),s.m_sweep.a0=s.c_position.a;for(var _=0;_<this.m_contacts.length;++_){var n=this.m_contacts[_];n.initVelocityConstraint(t)}for(var _=0;_<t.velocityIterations;++_)for(var a=0;a<this.m_contacts.length;++a){var n=this.m_contacts[a];n.solveVelocityConstraint(t)}for(var y=t.dt,_=0;_<this.m_bodies.length;++_){var r=this.m_bodies[_];x(De,r.c_position.c);var h=r.c_position.a;x(It,r.c_velocity.v);var m=r.c_velocity.w;L(Ys,y,It);var u=wi(Ys);if(u>I.maxTranslationSquared){var d=I.maxTranslation/xo(u);no(It,d)}var f=y*m;if(f*f>I.maxRotationSquared){var d=I.maxRotation/go(f);m*=d}fe(De,y,It),h+=y*m,x(r.c_position.c,De),r.c_position.a=h,x(r.c_velocity.v,It),r.c_velocity.w=m,x(r.m_sweep.c,De),r.m_sweep.a=h,x(r.m_linearVelocity,It),r.m_angularVelocity=m,r.synchronizeTransform()}this.postSolveIsland()},i.prototype.postSolveIsland=function(){for(var t=0;t<this.m_contacts.length;++t){var e=this.m_contacts[t];this.m_world.postSolve(e,e.m_impulse)}},i})();yc.TimeStep=Bn;var xe=(function(){function i(t,e,s,r){typeof t=="object"&&t!==null?(this.ex=c.clone(t),this.ey=c.clone(e)):typeof t=="number"?(this.ex=c.neo(t,s),this.ey=c.neo(e,r)):(this.ex=c.zero(),this.ey=c.zero())}return i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:c.isValid(t.ex)&&c.isValid(t.ey)},i.assert=function(t){},i.prototype.set=function(t,e,s,r){typeof t=="number"&&typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(this.ex.setNum(t,s),this.ey.setNum(e,r)):typeof t=="object"&&typeof e=="object"?(this.ex.setVec2(t),this.ey.setVec2(e)):typeof t=="object"&&(this.ex.setVec2(t.ex),this.ey.setVec2(t.ey))},i.prototype.setIdentity=function(){this.ex.x=1,this.ey.x=0,this.ex.y=0,this.ey.y=1},i.prototype.setZero=function(){this.ex.x=0,this.ey.x=0,this.ex.y=0,this.ey.y=0},i.prototype.getInverse=function(){var t=this.ex.x,e=this.ey.x,s=this.ex.y,r=this.ey.y,n=t*r-e*s;n!==0&&(n=1/n);var o=new i;return o.ex.x=n*r,o.ey.x=-n*e,o.ex.y=-n*s,o.ey.y=n*t,o},i.prototype.solve=function(t){var e=this.ex.x,s=this.ey.x,r=this.ex.y,n=this.ey.y,o=e*n-s*r;o!==0&&(o=1/o);var a=c.zero();return a.x=o*(n*t.x-s*t.y),a.y=o*(e*t.y-r*t.x),a},i.mul=function(t,e){if(e&&"x"in e&&"y"in e){var s=t.ex.x*e.x+t.ey.x*e.y,r=t.ex.y*e.x+t.ey.y*e.y;return c.neo(s,r)}else if(e&&"ex"in e&&"ey"in e){var n=t.ex.x*e.ex.x+t.ey.x*e.ex.y,o=t.ex.x*e.ey.x+t.ey.x*e.ey.y,a=t.ex.y*e.ex.x+t.ey.y*e.ex.y,l=t.ex.y*e.ey.x+t.ey.y*e.ey.y;return new i(n,o,a,l)}},i.mulVec2=function(t,e){var s=t.ex.x*e.x+t.ey.x*e.y,r=t.ex.y*e.x+t.ey.y*e.y;return c.neo(s,r)},i.mulMat22=function(t,e){var s=t.ex.x*e.ex.x+t.ey.x*e.ex.y,r=t.ex.x*e.ey.x+t.ey.x*e.ey.y,n=t.ex.y*e.ex.x+t.ey.y*e.ex.y,o=t.ex.y*e.ey.x+t.ey.y*e.ey.y;return new i(s,r,n,o)},i.mulT=function(t,e){if(e&&"x"in e&&"y"in e)return c.neo(c.dot(e,t.ex),c.dot(e,t.ey));if(e&&"ex"in e&&"ey"in e){var s=c.neo(c.dot(t.ex,e.ex),c.dot(t.ey,e.ex)),r=c.neo(c.dot(t.ex,e.ey),c.dot(t.ey,e.ey));return new i(s,r)}},i.mulTVec2=function(t,e){return c.neo(c.dot(e,t.ex),c.dot(e,t.ey))},i.mulTMat22=function(t,e){var s=c.neo(c.dot(t.ex,e.ex),c.dot(t.ey,e.ex)),r=c.neo(c.dot(t.ex,e.ey),c.dot(t.ey,e.ey));return new i(s,r)},i.abs=function(t){return new i(c.abs(t.ex),c.abs(t.ey))},i.add=function(t,e){return new i(c.add(t.ex,e.ex),c.add(t.ey,e.ey))},i})(),nh=Math.sqrt,Dr=A(0,0),Rr=A(0,0),ls=A(0,0),Re=A(0,0),qe=A(0,0),qr=A(0,0),js=A(0,0),Ge=A(0,0),mt;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_circles=0]="e_circles",i[i.e_faceA=1]="e_faceA",i[i.e_faceB=2]="e_faceB"})(mt||(mt={}));var J;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_vertex=0]="e_vertex",i[i.e_face=1]="e_face"})(J||(J={}));var gi;(function(i){i[i.nullState=0]="nullState",i[i.addState=1]="addState",i[i.persistState=2]="persistState",i[i.removeState=3]="removeState"})(gi||(gi={}));var Kt=(function(){function i(){this.v=A(0,0),this.id=new vc}return i.prototype.set=function(t){x(this.v,t.v),this.id.set(t.id)},i.prototype.recycle=function(){k(this.v),this.id.recycle()},i})(),fc=(function(){function i(){this.localNormal=A(0,0),this.localPoint=A(0,0),this.points=[new Bo,new Bo],this.pointCount=0}return i.prototype.set=function(t){this.type=t.type,x(this.localNormal,t.localNormal),x(this.localPoint,t.localPoint),this.pointCount=t.pointCount,this.points[0].set(t.points[0]),this.points[1].set(t.points[1])},i.prototype.recycle=function(){this.type=mt.e_unset,k(this.localNormal),k(this.localPoint),this.pointCount=0,this.points[0].recycle(),this.points[1].recycle()},i.prototype.getWorldManifold=function(t,e,s,r,n){if(this.pointCount==0)return t;t=t||new gc,t.pointCount=this.pointCount;var o=t.normal,a=t.points,l=t.separations;switch(this.type){case mt.e_circles:{Tt(o,1,0);var p=this.points[0];D(Dr,e,this.localPoint),D(Rr,r,p.localPoint),R(qr,Rr,Dr);var _=wi(qr);if(_>qt*qt){var y=nh(_);L(o,1/y,qr)}ct(Re,1,Dr,s,o),ct(qe,1,Rr,-n,o),ct(a[0],.5,Re,.5,qe),l[0]=M(R(ls,qe,Re),o);break}case mt.e_faceA:{ce(o,e.q,this.localNormal),D(js,e,this.localPoint);for(var h=0;h<this.pointCount;++h){var p=this.points[h];D(Ge,r,p.localPoint),ct(Re,1,Ge,s-M(R(ls,Ge,js),o),o),ct(qe,1,Ge,-n,o),ct(a[h],.5,Re,.5,qe),l[h]=M(R(ls,qe,Re),o)}break}case mt.e_faceB:{ce(o,r.q,this.localNormal),D(js,r,this.localPoint);for(var h=0;h<this.pointCount;++h){var p=this.points[h];D(Ge,e,p.localPoint),ct(qe,1,Ge,n-M(R(ls,Ge,js),o),o),ct(Re,1,Ge,-s,o),ct(a[h],.5,Re,.5,qe),l[h]=M(R(ls,Re,qe),o)}bs(o);break}}return t},i.clipSegmentToLine=As,i.ClipVertex=Kt,i.getPointStates=oh,i.PointState=gi,i})(),Bo=(function(){function i(){this.localPoint=A(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.id=new vc}return i.prototype.set=function(t){x(this.localPoint,t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.set(t.id)},i.prototype.recycle=function(){k(this.localPoint),this.normalImpulse=0,this.tangentImpulse=0,this.id.recycle()},i})(),vc=(function(){function i(){this.key=-1,this.indexA=-1,this.indexB=-1,this.typeA=J.e_unset,this.typeB=J.e_unset}return i.prototype.setFeatures=function(t,e,s,r){this.indexA=t,this.indexB=s,this.typeA=e,this.typeB=r,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},i.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,this.typeA=t.typeA,this.typeB=t.typeB,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},i.prototype.swapFeatures=function(){var t=this.indexA,e=this.indexB,s=this.typeA,r=this.typeB;this.indexA=e,this.indexB=t,this.typeA=r,this.typeB=s,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},i.prototype.recycle=function(){this.indexA=0,this.indexB=0,this.typeA=J.e_unset,this.typeB=J.e_unset,this.key=-1},i})(),gc=(function(){function i(){this.normal=A(0,0),this.points=[A(0,0),A(0,0)],this.separations=[0,0],this.pointCount=0}return i.prototype.recycle=function(){k(this.normal),k(this.points[0]),k(this.points[1]),this.separations[0]=0,this.separations[1]=0,this.pointCount=0},i})();function oh(i,t,e,s){for(var r=0;r<e.pointCount;++r){var n=e.points[r].id;i[r]=gi.removeState;for(var o=0;o<s.pointCount;++o)if(s.points[o].id.key===n.key){i[r]=gi.persistState;break}}for(var r=0;r<s.pointCount;++r){var n=s.points[r].id;t[r]=gi.addState;for(var o=0;o<e.pointCount;++o)if(e.points[o].id.key===n.key){t[r]=gi.persistState;break}}}function As(i,t,e,s,r){var n=0,o=M(e,t[0].v)-s,a=M(e,t[1].v)-s;if(o<=0&&i[n++].set(t[0]),a<=0&&i[n++].set(t[1]),o*a<0){var l=o/(o-a);ct(i[n].v,1-l,t[0].v,l,t[1].v),i[n].id.setFeatures(r,J.e_vertex,t[0].id.indexB,J.e_face),++n}return n}var ah=Math.sqrt,ch=Math.max,lh=Math.min,So=new xs({create:function(){return new Ve},release:function(i){i.recycle()}}),zi=new fc,Js=new gc,Co=(function(){function i(t){this.prev=null,this.next=null,this.other=null,this.contact=t}return i.prototype.recycle=function(){this.prev=null,this.next=null,this.other=null},i})();function To(i,t){return ah(i*t)}function Mo(i,t){return i>t?i:t}var hi=[],Po=(function(){function i(){this.rA=A(0,0),this.rB=A(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return i.prototype.recycle=function(){k(this.rA),k(this.rB),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0},i})(),Ne=A(0,0),_t=A(0,0),Oe=A(0,0),pt=A(0,0),Ke=A(0,0),mi=Ci(0,0,0),ui=Ci(0,0,0),Gs=A(0,0),Ks=A(0,0),Fi=A(0,0),Xs=A(0,0),Nr=A(0,0),Or=A(0,0),ft=A(0,0),tt=A(0,0),hs=A(0,0),ie=A(0,0),Di=A(0,0),Ri=A(0,0),jt=A(0,0),$e=A(0,0),nt=A(0,0),se=A(0,0),vt=A(0,0),gt=A(0,0),Se=A(0,0),Ve=(function(){function i(){this.m_nodeA=new Co(this),this.m_nodeB=new Co(this),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold=new fc,this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse=new rh(this),this.v_points=[new Po,new Po],this.v_normal=A(0,0),this.v_normalMass=new xe,this.v_K=new xe,this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0,this.p_localPoints=[A(0,0),A(0,0)],this.p_localNormal=A(0,0),this.p_localPoint=A(0,0),this.p_localCenterA=A(0,0),this.p_localCenterB=A(0,0),this.p_type=mt.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0}return i.prototype.initialize=function(t,e,s,r,n){this.m_fixtureA=t,this.m_fixtureB=s,this.m_indexA=e,this.m_indexB=r,this.m_evaluateFcn=n,this.m_friction=To(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Mo(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},i.prototype.recycle=function(){this.m_nodeA.recycle(),this.m_nodeB.recycle(),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold.recycle(),this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse.recycle();for(var t=0,e=this.v_points;t<e.length;t++){var s=e[t];s.recycle()}k(this.v_normal),this.v_normalMass.setZero(),this.v_K.setZero(),this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0;for(var r=0,n=this.p_localPoints;r<n.length;r++){var o=n[r];k(o)}k(this.p_localNormal),k(this.p_localPoint),k(this.p_localCenterA),k(this.p_localCenterB),this.p_type=mt.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0},i.prototype.initConstraint=function(t){var e=this.m_fixtureA,s=this.m_fixtureB;if(!(e===null||s===null)){var r=e.m_body,n=s.m_body;if(!(r===null||n===null)){var o=e.m_shape,a=s.m_shape;if(!(o===null||a===null)){var l=this.m_manifold,p=l.pointCount;this.v_invMassA=r.m_invMass,this.v_invMassB=n.m_invMass,this.v_invIA=r.m_invI,this.v_invIB=n.m_invI,this.v_friction=this.m_friction,this.v_restitution=this.m_restitution,this.v_tangentSpeed=this.m_tangentSpeed,this.v_pointCount=p,this.v_K.setZero(),this.v_normalMass.setZero(),this.p_invMassA=r.m_invMass,this.p_invMassB=n.m_invMass,this.p_invIA=r.m_invI,this.p_invIB=n.m_invI,x(this.p_localCenterA,r.m_sweep.localCenter),x(this.p_localCenterB,n.m_sweep.localCenter),this.p_radiusA=o.m_radius,this.p_radiusB=a.m_radius,this.p_type=l.type,x(this.p_localNormal,l.localNormal),x(this.p_localPoint,l.localPoint),this.p_pointCount=p;for(var _=0;_<I.maxManifoldPoints;++_)this.v_points[_].recycle(),k(this.p_localPoints[_]);for(var _=0;_<p;++_){var y=l.points[_],h=this.v_points[_];t.warmStarting&&(h.normalImpulse=t.dtRatio*y.normalImpulse,h.tangentImpulse=t.dtRatio*y.tangentImpulse),x(this.p_localPoints[_],y.localPoint)}}}}},i.prototype.getManifold=function(){return this.m_manifold},i.prototype.getWorldManifold=function(t){var e=this.m_fixtureA,s=this.m_fixtureB;if(!(e===null||s===null)){var r=e.m_body,n=s.m_body;if(!(r===null||n===null)){var o=e.m_shape,a=s.m_shape;if(!(o===null||a===null))return this.m_manifold.getWorldManifold(t,r.getTransform(),o.m_radius,n.getTransform(),a.m_radius)}}},i.prototype.setEnabled=function(t){this.m_enabledFlag=!!t},i.prototype.isEnabled=function(){return this.m_enabledFlag},i.prototype.isTouching=function(){return this.m_touchingFlag},i.prototype.getNext=function(){return this.m_next},i.prototype.getFixtureA=function(){return this.m_fixtureA},i.prototype.getFixtureB=function(){return this.m_fixtureB},i.prototype.getChildIndexA=function(){return this.m_indexA},i.prototype.getChildIndexB=function(){return this.m_indexB},i.prototype.flagForFiltering=function(){this.m_filterFlag=!0},i.prototype.setFriction=function(t){this.m_friction=t},i.prototype.getFriction=function(){return this.m_friction},i.prototype.resetFriction=function(){var t=this.m_fixtureA,e=this.m_fixtureB;t===null||e===null||(this.m_friction=To(t.m_friction,e.m_friction))},i.prototype.setRestitution=function(t){this.m_restitution=t},i.prototype.getRestitution=function(){return this.m_restitution},i.prototype.resetRestitution=function(){var t=this.m_fixtureA,e=this.m_fixtureB;t===null||e===null||(this.m_restitution=Mo(t.m_restitution,e.m_restitution))},i.prototype.setTangentSpeed=function(t){this.m_tangentSpeed=t},i.prototype.getTangentSpeed=function(){return this.m_tangentSpeed},i.prototype.evaluate=function(t,e,s){var r=this.m_fixtureA,n=this.m_fixtureB;r===null||n===null||this.m_evaluateFcn(t,e,r,this.m_indexA,s,n,this.m_indexB)},i.prototype.update=function(t){var e=this.m_fixtureA,s=this.m_fixtureB;if(!(e===null||s===null)){var r=e.m_body,n=s.m_body;if(!(r===null||n===null)){var o=e.m_shape,a=s.m_shape;if(!(o===null||a===null)){this.m_enabledFlag=!0;var l=!1,p=this.m_touchingFlag,_=e.m_isSensor,y=s.m_isSensor,h=_||y,m=r.m_xf,u=n.m_xf;if(h)l=_c(o,this.m_indexA,a,this.m_indexB,m,u),this.m_manifold.pointCount=0;else{zi.recycle(),zi.set(this.m_manifold),this.m_manifold.recycle(),this.evaluate(this.m_manifold,m,u),l=this.m_manifold.pointCount>0;for(var d=0;d<this.m_manifold.pointCount;++d){var f=this.m_manifold.points[d];f.normalImpulse=0,f.tangentImpulse=0;for(var v=0;v<zi.pointCount;++v){var w=zi.points[v];if(w.id.key===f.id.key){f.normalImpulse=w.normalImpulse,f.tangentImpulse=w.tangentImpulse;break}}}l!==p&&(r.setAwake(!0),n.setAwake(!0))}this.m_touchingFlag=l;var g=typeof t=="object"&&t!==null;!p&&l&&g&&t.beginContact(this),p&&!l&&g&&t.endContact(this),!h&&l&&g&&zi&&t.preSolve(this,zi)}}}},i.prototype.solvePositionConstraint=function(t){return this._solvePositionConstraint(t,null,null)},i.prototype.solvePositionConstraintTOI=function(t,e,s){return this._solvePositionConstraint(t,e,s)},i.prototype._solvePositionConstraint=function(t,e,s){var r=e!==null&&s!==null,n=0,o=this.m_fixtureA,a=this.m_fixtureB;if(o===null||a===null)return n;var l=o.m_body,p=a.m_body;if(l===null||p===null)return n;var _=l.c_position,y=p.c_position,h=this.p_localCenterA,m=this.p_localCenterB,u=0,d=0;(!r||l===e||l===s)&&(u=this.p_invMassA,d=this.p_invIA);var f=0,v=0;(!r||p===e||p===s)&&(f=this.p_invMassB,v=this.p_invIB),x(Ne,_.c);var w=_.a;x(Oe,y.c);for(var g=y.a,b=0;b<this.p_pointCount;++b){Vs(mi,h,Ne,w),Vs(ui,m,Oe,g);var S=void 0;switch(this.p_type){case mt.e_circles:{D(Gs,mi,this.p_localPoint),D(Ks,ui,this.p_localPoints[0]),R(tt,Ks,Gs),ve(tt),ct(hs,.5,Gs,.5,Ks),S=M(Ks,tt)-M(Gs,tt)-this.p_radiusA-this.p_radiusB;break}case mt.e_faceA:{ce(tt,mi.q,this.p_localNormal),D(Xs,mi,this.p_localPoint),D(Fi,ui,this.p_localPoints[b]),S=M(Fi,tt)-M(Xs,tt)-this.p_radiusA-this.p_radiusB,x(hs,Fi);break}case mt.e_faceB:{ce(tt,ui.q,this.p_localNormal),D(Xs,ui,this.p_localPoint),D(Fi,mi,this.p_localPoints[b]),S=M(Fi,tt)-M(Xs,tt)-this.p_radiusA-this.p_radiusB,x(hs,Fi),bs(tt);break}default:return n}R(Nr,hs,Ne),R(Or,hs,Oe),n=lh(n,S);var C=r?I.toiBaugarte:I.baumgarte,T=I.linearSlop,P=I.maxLinearCorrection,E=Mt(C*(S+T),-P,0),z=$(Nr,tt),H=$(Or,tt),Y=u+f+d*z*z+v*H*H,W=Y>0?-E/Y:0;L(ft,W,tt),fs(Ne,u,ft),w-=d*$(Nr,ft),fe(Oe,f,ft),g+=v*$(Or,ft)}return x(_.c,Ne),_.a=w,x(y.c,Oe),y.a=g,n},i.prototype.initVelocityConstraint=function(t){var e=this.m_fixtureA,s=this.m_fixtureB;if(!(e===null||s===null)){var r=e.m_body,n=s.m_body;if(!(r===null||n===null)){var o=r.c_velocity,a=n.c_velocity,l=r.c_position,p=n.c_position,_=this.p_radiusA,y=this.p_radiusB,h=this.m_manifold,m=this.v_invMassA,u=this.v_invMassB,d=this.v_invIA,f=this.v_invIB,v=this.p_localCenterA,w=this.p_localCenterB;x(Ne,l.c);var g=l.a;x(_t,o.v);var b=o.w;x(Oe,p.c);var S=p.a;x(pt,a.v);var C=a.w;Vs(mi,v,Ne,g),Vs(ui,w,Oe,S),Js.recycle(),h.getWorldManifold(Js,mi,_,ui,y),x(this.v_normal,Js.normal);for(var T=0;T<this.v_pointCount;++T){var P=this.v_points[T],E=Js.points[T];R(P.rA,E,Ne),R(P.rB,E,Oe);var z=$(P.rA,this.v_normal),H=$(P.rB,this.v_normal),Y=m+u+d*z*z+f*H*H;P.normalMass=Y>0?1/Y:0,xi(Ke,this.v_normal,1);var W=$(P.rA,Ke),j=$(P.rB,Ke),dt=m+u+d*W*W+f*j*j;P.tangentMass=dt>0?1/dt:0,P.velocityBias=0;var ot=0;ot+=M(this.v_normal,pt),ot+=M(this.v_normal,Jt(Se,C,P.rB)),ot-=M(this.v_normal,_t),ot-=M(this.v_normal,Jt(Se,b,P.rA)),ot<-I.velocityThreshold&&(P.velocityBias=-this.v_restitution*ot)}if(this.v_pointCount==2&&t.blockSolve){var At=this.v_points[0],lt=this.v_points[1],rt=$(At.rA,this.v_normal),oi=$(At.rB,this.v_normal),Pt=$(lt.rA,this.v_normal),Qt=$(lt.rB,this.v_normal),he=m+u+d*rt*rt+f*oi*oi,ke=m+u+d*Pt*Pt+f*Qt*Qt,Le=m+u+d*rt*Pt+f*oi*Qt,ze=1e3;if(he*he<ze*(he*ke-Le*Le)){this.v_K.ex.setNum(he,Le),this.v_K.ey.setNum(Le,ke);var Ii=this.v_K.ex.x,je=this.v_K.ey.x,es=this.v_K.ex.y,Je=this.v_K.ey.y,me=Ii*Je-je*es;me!==0&&(me=1/me),this.v_normalMass.ex.x=me*Je,this.v_normalMass.ey.x=-me*je,this.v_normalMass.ex.y=-me*es,this.v_normalMass.ey.y=me*Ii}else this.v_pointCount=1}x(l.c,Ne),l.a=g,x(o.v,_t),o.w=b,x(p.c,Oe),p.a=S,x(a.v,pt),a.w=C}}},i.prototype.warmStartConstraint=function(t){var e=this.m_fixtureA,s=this.m_fixtureB;if(!(e===null||s===null)){var r=e.m_body,n=s.m_body;if(!(r===null||n===null)){var o=r.c_velocity,a=n.c_velocity,l=this.v_invMassA,p=this.v_invIA,_=this.v_invMassB,y=this.v_invIB;x(_t,o.v);var h=o.w;x(pt,a.v);var m=a.w;x(tt,this.v_normal),xi(Ke,tt,1);for(var u=0;u<this.v_pointCount;++u){var d=this.v_points[u];ct(ft,d.normalImpulse,tt,d.tangentImpulse,Ke),h-=p*$(d.rA,ft),fs(_t,l,ft),m+=y*$(d.rB,ft),fe(pt,_,ft)}x(o.v,_t),o.w=h,x(a.v,pt),a.w=m}}},i.prototype.storeConstraintImpulses=function(t){for(var e=this.m_manifold,s=0;s<this.v_pointCount;++s)e.points[s].normalImpulse=this.v_points[s].normalImpulse,e.points[s].tangentImpulse=this.v_points[s].tangentImpulse},i.prototype.solveVelocityConstraint=function(t){var e=this.m_fixtureA,s=this.m_fixtureB;if(!(e===null||s===null)){var r=e.m_body,n=s.m_body;if(!(r===null||n===null)){var o=r.c_velocity,a=n.c_velocity,l=this.v_invMassA,p=this.v_invIA,_=this.v_invMassB,y=this.v_invIB;x(_t,o.v);var h=o.w;x(pt,a.v);var m=a.w;x(tt,this.v_normal),xi(Ke,tt,1);for(var u=this.v_friction,d=0;d<this.v_pointCount;++d){var f=this.v_points[d];k(ie),ne(ie,pt),ne(ie,Jt(Se,m,f.rB)),Ue(ie,_t),Ue(ie,Jt(Se,h,f.rA));var v=M(ie,Ke)-this.v_tangentSpeed,w=f.tangentMass*-v,g=u*f.normalImpulse,b=Mt(f.tangentImpulse+w,-g,g);w=b-f.tangentImpulse,f.tangentImpulse=b,L(ft,w,Ke),fs(_t,l,ft),h-=p*$(f.rA,ft),fe(pt,_,ft),m+=y*$(f.rB,ft)}if(this.v_pointCount==1||t.blockSolve==!1)for(var S=0;S<this.v_pointCount;++S){var f=this.v_points[S];k(ie),ne(ie,pt),ne(ie,Jt(Se,m,f.rB)),Ue(ie,_t),Ue(ie,Jt(Se,h,f.rA));var C=M(ie,tt),w=-f.normalMass*(C-f.velocityBias),b=ch(f.normalImpulse+w,0);w=b-f.normalImpulse,f.normalImpulse=b,L(ft,w,tt),fs(_t,l,ft),h-=p*$(f.rA,ft),fe(pt,_,ft),m+=y*$(f.rB,ft)}else{var T=this.v_points[0],P=this.v_points[1];Tt($e,T.normalImpulse,P.normalImpulse),k(Di),ne(Di,pt),ne(Di,Jt(Se,m,T.rB)),Ue(Di,_t),Ue(Di,Jt(Se,h,T.rA)),k(Ri),ne(Ri,pt),ne(Ri,Jt(Se,m,P.rB)),Ue(Ri,_t),Ue(Ri,Jt(Se,h,P.rA));var E=M(Di,tt),z=M(Ri,tt);for(Tt(jt,E-T.velocityBias,z-P.velocityBias),jt.x-=this.v_K.ex.x*$e.x+this.v_K.ey.x*$e.y,jt.y-=this.v_K.ex.y*$e.x+this.v_K.ey.y*$e.y;;){if(k(nt),nt.x=-(this.v_normalMass.ex.x*jt.x+this.v_normalMass.ey.x*jt.y),nt.y=-(this.v_normalMass.ex.y*jt.x+this.v_normalMass.ey.y*jt.y),nt.x>=0&&nt.y>=0){R(se,nt,$e),L(vt,se.x,tt),L(gt,se.y,tt),Pe(_t,-l,vt,-l,gt,1,_t),h-=p*($(T.rA,vt)+$(P.rA,gt)),Pe(pt,_,vt,_,gt,1,pt),m+=y*($(T.rB,vt)+$(P.rB,gt)),T.normalImpulse=nt.x,P.normalImpulse=nt.y;break}if(nt.x=-T.normalMass*jt.x,nt.y=0,E=0,z=this.v_K.ex.y*nt.x+jt.y,nt.x>=0&&z>=0){R(se,nt,$e),L(vt,se.x,tt),L(gt,se.y,tt),Pe(_t,-l,vt,-l,gt,1,_t),h-=p*($(T.rA,vt)+$(P.rA,gt)),Pe(pt,_,vt,_,gt,1,pt),m+=y*($(T.rB,vt)+$(P.rB,gt)),T.normalImpulse=nt.x,P.normalImpulse=nt.y;break}if(nt.x=0,nt.y=-P.normalMass*jt.y,E=this.v_K.ey.x*nt.y+jt.x,z=0,nt.y>=0&&E>=0){R(se,nt,$e),L(vt,se.x,tt),L(gt,se.y,tt),Pe(_t,-l,vt,-l,gt,1,_t),h-=p*($(T.rA,vt)+$(P.rA,gt)),Pe(pt,_,vt,_,gt,1,pt),m+=y*($(T.rB,vt)+$(P.rB,gt)),T.normalImpulse=nt.x,P.normalImpulse=nt.y;break}if(nt.x=0,nt.y=0,E=jt.x,z=jt.y,E>=0&&z>=0){R(se,nt,$e),L(vt,se.x,tt),L(gt,se.y,tt),Pe(_t,-l,vt,-l,gt,1,_t),h-=p*($(T.rA,vt)+$(P.rA,gt)),Pe(pt,_,vt,_,gt,1,pt),m+=y*($(T.rB,vt)+$(P.rB,gt)),T.normalImpulse=nt.x,P.normalImpulse=nt.y;break}break}}x(o.v,_t),o.w=h,x(a.v,pt),a.w=m}}},i.addType=function(t,e,s){hi[t]=hi[t]||{},hi[t][e]=s},i.create=function(t,e,s,r){var n=t.m_shape.m_type,o=s.m_shape.m_type,a=So.allocate(),l;if(l=hi[n]&&hi[n][o])a.initialize(t,e,s,r,l);else if(l=hi[o]&&hi[o][n])a.initialize(s,r,t,e,l);else return null;t=a.m_fixtureA,s=a.m_fixtureB,e=a.getChildIndexA(),r=a.getChildIndexB();var p=t.m_body,_=s.m_body;return a.m_nodeA.contact=a,a.m_nodeA.other=_,a.m_nodeA.prev=null,a.m_nodeA.next=p.m_contactList,p.m_contactList!=null&&(p.m_contactList.prev=a.m_nodeA),p.m_contactList=a.m_nodeA,a.m_nodeB.contact=a,a.m_nodeB.other=p,a.m_nodeB.prev=null,a.m_nodeB.next=_.m_contactList,_.m_contactList!=null&&(_.m_contactList.prev=a.m_nodeB),_.m_contactList=a.m_nodeB,t.isSensor()==!1&&s.isSensor()==!1&&(p.setAwake(!0),_.setAwake(!0)),a},i.destroy=function(t,e){var s=t.m_fixtureA,r=t.m_fixtureB;if(!(s===null||r===null)){var n=s.m_body,o=r.m_body;n===null||o===null||(t.isTouching()&&e.endContact(t),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==o.m_contactList&&(o.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!s.m_isSensor&&!r.m_isSensor&&(n.setAwake(!0),o.setAwake(!0)),So.release(t))}},i})(),hh={gravity:c.zero(),allowSleep:!0,warmStarting:!0,continuousPhysics:!0,subStepping:!1,blockSolve:!0,velocityIterations:8,positionIterations:3},Ts=(function(){function i(t){if(!(this instanceof i))return new i(t);this.s_step=new Bn,t?c.isValid(t)&&(t={gravity:t}):t={},t=Xt(t,hh),this.m_solver=new yc(this),this.m_broadPhase=new Rl,this.m_contactList=null,this.m_contactCount=0,this.m_bodyList=null,this.m_bodyCount=0,this.m_jointList=null,this.m_jointCount=0,this.m_stepComplete=!0,this.m_allowSleep=t.allowSleep,this.m_gravity=c.clone(t.gravity),this.m_clearForces=!0,this.m_newFixture=!1,this.m_locked=!1,this.m_warmStarting=t.warmStarting,this.m_continuousPhysics=t.continuousPhysics,this.m_subStepping=t.subStepping,this.m_blockSolve=t.blockSolve,this.m_velocityIterations=t.velocityIterations,this.m_positionIterations=t.positionIterations,this.m_t=0,this.m_step_callback=[]}return i.prototype._serialize=function(){for(var t=[],e=[],s=this.getBodyList();s;s=s.getNext())t.push(s);for(var r=this.getJointList();r;r=r.getNext())typeof r._serialize=="function"&&e.push(r);return{gravity:this.m_gravity,bodies:t,joints:e}},i._deserialize=function(t,e,s){if(!t)return new i;var r=new i(t.gravity);if(t.bodies)for(var n=t.bodies.length-1;n>=0;n-=1)r._addBody(s(Q,t.bodies[n],r));if(t.joints)for(var n=t.joints.length-1;n>=0;n--)r.createJoint(s(kt,t.joints[n],r));return r},i.prototype.getBodyList=function(){return this.m_bodyList},i.prototype.getJointList=function(){return this.m_jointList},i.prototype.getContactList=function(){return this.m_contactList},i.prototype.getBodyCount=function(){return this.m_bodyCount},i.prototype.getJointCount=function(){return this.m_jointCount},i.prototype.getContactCount=function(){return this.m_contactCount},i.prototype.setGravity=function(t){this.m_gravity.set(t)},i.prototype.getGravity=function(){return this.m_gravity},i.prototype.isLocked=function(){return this.m_locked},i.prototype.setAllowSleeping=function(t){if(t!=this.m_allowSleep&&(this.m_allowSleep=t,this.m_allowSleep==!1))for(var e=this.m_bodyList;e;e=e.m_next)e.setAwake(!0)},i.prototype.getAllowSleeping=function(){return this.m_allowSleep},i.prototype.setWarmStarting=function(t){this.m_warmStarting=t},i.prototype.getWarmStarting=function(){return this.m_warmStarting},i.prototype.setContinuousPhysics=function(t){this.m_continuousPhysics=t},i.prototype.getContinuousPhysics=function(){return this.m_continuousPhysics},i.prototype.setSubStepping=function(t){this.m_subStepping=t},i.prototype.getSubStepping=function(){return this.m_subStepping},i.prototype.setAutoClearForces=function(t){this.m_clearForces=t},i.prototype.getAutoClearForces=function(){return this.m_clearForces},i.prototype.clearForces=function(){for(var t=this.m_bodyList;t;t=t.getNext())t.m_force.setZero(),t.m_torque=0},i.prototype.queryAABB=function(t,e){var s=this.m_broadPhase;this.m_broadPhase.query(t,function(r){var n=s.getUserData(r);return e(n.fixture)})},i.prototype.rayCast=function(t,e,s){var r=this.m_broadPhase;this.m_broadPhase.rayCast({maxFraction:1,p1:t,p2:e},function(n,o){var a=r.getUserData(o),l=a.fixture,p=a.childIndex,_={},y=l.rayCast(_,n,p);if(y){var h=_.fraction,m=c.add(c.mulNumVec2(1-h,n.p1),c.mulNumVec2(h,n.p2));return s(l,m,_.normal,h)}return n.maxFraction})},i.prototype.getProxyCount=function(){return this.m_broadPhase.getProxyCount()},i.prototype.getTreeHeight=function(){return this.m_broadPhase.getTreeHeight()},i.prototype.getTreeBalance=function(){return this.m_broadPhase.getTreeBalance()},i.prototype.getTreeQuality=function(){return this.m_broadPhase.getTreeQuality()},i.prototype.shiftOrigin=function(t){if(!this.isLocked()){for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.sub(t),e.m_sweep.c0.sub(t),e.m_sweep.c.sub(t);for(var s=this.m_jointList;s;s=s.m_next)s.shiftOrigin(t);this.m_broadPhase.shiftOrigin(t)}},i.prototype._addBody=function(t){this.isLocked()||(t.m_prev=null,t.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=t),this.m_bodyList=t,++this.m_bodyCount)},i.prototype.createBody=function(t,e){if(this.isLocked())return null;var s={};t&&(c.isValid(t)?s={position:t,angle:e}:typeof t=="object"&&(s=t));var r=new Q(this,s);return this._addBody(r),r},i.prototype.createDynamicBody=function(t,e){var s={};return t&&(c.isValid(t)?s={position:t,angle:e}:typeof t=="object"&&(s=t)),s.type="dynamic",this.createBody(s)},i.prototype.createKinematicBody=function(t,e){var s={};return t&&(c.isValid(t)?s={position:t,angle:e}:typeof t=="object"&&(s=t)),s.type="kinematic",this.createBody(s)},i.prototype.destroyBody=function(t){if(!this.isLocked()){if(t.m_destroyed)return!1;for(var e=t.m_jointList;e;){var s=e;e=e.next,this.publish("remove-joint",s.joint),this.destroyJoint(s.joint),t.m_jointList=e}t.m_jointList=null;for(var r=t.m_contactList;r;){var n=r;r=r.next,this.destroyContact(n.contact),t.m_contactList=r}t.m_contactList=null;for(var o=t.m_fixtureList;o;){var a=o;o=o.m_next,this.publish("remove-fixture",a),a.destroyProxies(this.m_broadPhase),t.m_fixtureList=o}return t.m_fixtureList=null,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),t.m_destroyed=!0,--this.m_bodyCount,this.publish("remove-body",t),!0}},i.prototype.createJoint=function(t){if(this.isLocked())return null;if(t.m_prev=null,t.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=t),this.m_jointList=t,++this.m_jointCount,t.m_edgeA.joint=t,t.m_edgeA.other=t.m_bodyB,t.m_edgeA.prev=null,t.m_edgeA.next=t.m_bodyA.m_jointList,t.m_bodyA.m_jointList&&(t.m_bodyA.m_jointList.prev=t.m_edgeA),t.m_bodyA.m_jointList=t.m_edgeA,t.m_edgeB.joint=t,t.m_edgeB.other=t.m_bodyA,t.m_edgeB.prev=null,t.m_edgeB.next=t.m_bodyB.m_jointList,t.m_bodyB.m_jointList&&(t.m_bodyB.m_jointList.prev=t.m_edgeB),t.m_bodyB.m_jointList=t.m_edgeB,t.m_collideConnected==!1)for(var e=t.m_bodyB.getContactList();e;e=e.next)e.other==t.m_bodyA&&e.contact.flagForFiltering();return t},i.prototype.destroyJoint=function(t){if(!this.isLocked()){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var e=t.m_bodyA,s=t.m_bodyB;if(e.setAwake(!0),s.setAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==s.m_jointList&&(s.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,--this.m_jointCount,t.m_collideConnected==!1)for(var r=s.getContactList();r;)r.other==e&&r.contact.flagForFiltering(),r=r.next;this.publish("remove-joint",t)}},i.prototype.step=function(t,e,s){if(this.publish("pre-step",t),(e|0)!==e&&(e=0),e=e||this.m_velocityIterations,s=s||this.m_positionIterations,this.m_newFixture&&(this.findNewContacts(),this.m_newFixture=!1),this.m_locked=!0,this.s_step.reset(t),this.s_step.velocityIterations=e,this.s_step.positionIterations=s,this.s_step.warmStarting=this.m_warmStarting,this.s_step.blockSolve=this.m_blockSolve,this.updateContacts(),this.m_stepComplete&&t>0){this.m_solver.solveWorld(this.s_step);for(var r=this.m_bodyList;r;r=r.getNext())r.m_islandFlag!=!1&&(r.isStatic()||r.synchronizeFixtures());this.findNewContacts()}this.m_continuousPhysics&&t>0&&this.m_solver.solveWorldTOI(this.s_step),this.m_clearForces&&this.clearForces(),this.m_locked=!1;for(var n;n=this.m_step_callback.shift();)n(this);this.publish("post-step",t)},i.prototype.queueUpdate=function(t){this.isLocked()?this.m_step_callback.push(t):t(this)},i.prototype.findNewContacts=function(){var t=this;this.m_broadPhase.updatePairs(function(e,s){return t.createContact(e,s)})},i.prototype.createContact=function(t,e){var s=t.fixture,r=e.fixture,n=t.childIndex,o=e.childIndex,a=s.getBody(),l=r.getBody();if(a!=l){for(var p=l.getContactList();p;){if(p.other==a){var _=p.contact.getFixtureA(),y=p.contact.getFixtureB(),h=p.contact.getChildIndexA(),m=p.contact.getChildIndexB();if(_==s&&y==r&&h==n&&m==o||_==r&&y==s&&h==o&&m==n)return}p=p.next}if(l.shouldCollide(a)!=!1&&r.shouldCollide(s)!=!1){var u=Ve.create(s,n,r,o);u!=null&&(u.m_prev=null,this.m_contactList!=null&&(u.m_next=this.m_contactList,this.m_contactList.m_prev=u),this.m_contactList=u,++this.m_contactCount)}}},i.prototype.updateContacts=function(){for(var t,e=this.m_contactList;t=e;){e=t.getNext();var s=t.getFixtureA(),r=t.getFixtureB(),n=t.getChildIndexA(),o=t.getChildIndexB(),a=s.getBody(),l=r.getBody();if(t.m_filterFlag){if(l.shouldCollide(a)==!1){this.destroyContact(t);continue}if(r.shouldCollide(s)==!1){this.destroyContact(t);continue}t.m_filterFlag=!1}var p=a.isAwake()&&!a.isStatic(),_=l.isAwake()&&!l.isStatic();if(!(p==!1&&_==!1)){var y=s.m_proxies[n].proxyId,h=r.m_proxies[o].proxyId,m=this.m_broadPhase.testOverlap(y,h);if(m==!1){this.destroyContact(t);continue}t.update(this)}}},i.prototype.destroyContact=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_contactList&&(this.m_contactList=t.m_next),Ve.destroy(t,this),--this.m_contactCount},i.prototype.on=function(t,e){return typeof t!="string"||typeof e!="function"?this:(this._listeners||(this._listeners={}),this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),this)},i.prototype.off=function(t,e){if(typeof t!="string"||typeof e!="function")return this;var s=this._listeners&&this._listeners[t];if(!s||!s.length)return this;var r=s.indexOf(e);return r>=0&&s.splice(r,1),this},i.prototype.publish=function(t,e,s,r){var n=this._listeners&&this._listeners[t];if(!n||!n.length)return 0;for(var o=0;o<n.length;o++)n[o].call(this,e,s,r);return n.length},i.prototype.beginContact=function(t){this.publish("begin-contact",t)},i.prototype.endContact=function(t){this.publish("end-contact",t)},i.prototype.preSolve=function(t,e){this.publish("pre-solve",t,e)},i.prototype.postSolve=function(t,e){this.publish("post-solve",t,e)},i})(),K=(function(){function i(t,e,s){if(!(this instanceof i))return new i(t,e,s);typeof t>"u"?(this.x=0,this.y=0,this.z=0):typeof t=="object"?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t,this.y=e,this.z=s)}return i.prototype._serialize=function(){return{x:this.x,y:this.y,z:this.z}},i._deserialize=function(t){var e=Object.create(i.prototype);return e.x=t.x,e.y=t.y,e.z=t.z,e},i.neo=function(t,e,s){var r=Object.create(i.prototype);return r.x=t,r.y=e,r.z=s,r},i.zero=function(){var t=Object.create(i.prototype);return t.x=0,t.y=0,t.z=0,t},i.clone=function(t){return i.neo(t.x,t.y,t.z)},i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)},i.assert=function(t){},i.prototype.setZero=function(){return this.x=0,this.y=0,this.z=0,this},i.prototype.set=function(t,e,s){return this.x=t,this.y=e,this.z=s,this},i.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},i.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},i.prototype.mul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},i.areEqual=function(t,e){return t===e||typeof t=="object"&&t!==null&&typeof e=="object"&&e!==null&&t.x===e.x&&t.y===e.y&&t.z===e.z},i.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},i.cross=function(t,e){return new i(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)},i.add=function(t,e){return new i(t.x+e.x,t.y+e.y,t.z+e.z)},i.sub=function(t,e){return new i(t.x-e.x,t.y-e.y,t.z-e.z)},i.mul=function(t,e){return new i(e*t.x,e*t.y,e*t.z)},i.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},i.neg=function(t){return new i(-t.x,-t.y,-t.z)},i})(),Io=A(0,0),Eo=A(0,0),si=(function(i){zt(t,i);function t(e,s){var r=this;return r instanceof t?(r=i.call(this)||this,r.m_type=t.TYPE,r.m_radius=I.polygonRadius,r.m_vertex1=e?c.clone(e):c.zero(),r.m_vertex2=s?c.clone(s):c.zero(),r.m_vertex0=c.zero(),r.m_vertex3=c.zero(),r.m_hasVertex0=!1,r.m_hasVertex3=!1,r):new t(e,s)}return t.prototype._serialize=function(){return{type:this.m_type,vertex1:this.m_vertex1,vertex2:this.m_vertex2,vertex0:this.m_vertex0,vertex3:this.m_vertex3,hasVertex0:this.m_hasVertex0,hasVertex3:this.m_hasVertex3}},t._deserialize=function(e){var s=new t(e.vertex1,e.vertex2);return s.m_hasVertex0&&s.setPrevVertex(e.vertex0),s.m_hasVertex3&&s.setNextVertex(e.vertex3),s},t.prototype._reset=function(){},t.prototype.getRadius=function(){return this.m_radius},t.prototype.getType=function(){return this.m_type},t.prototype.setNext=function(e){return this.setNextVertex(e)},t.prototype.setNextVertex=function(e){return e?(this.m_vertex3.setVec2(e),this.m_hasVertex3=!0):(this.m_vertex3.setZero(),this.m_hasVertex3=!1),this},t.prototype.getNextVertex=function(){return this.m_vertex3},t.prototype.setPrev=function(e){return this.setPrevVertex(e)},t.prototype.setPrevVertex=function(e){return e?(this.m_vertex0.setVec2(e),this.m_hasVertex0=!0):(this.m_vertex0.setZero(),this.m_hasVertex0=!1),this},t.prototype.getPrevVertex=function(){return this.m_vertex0},t.prototype._set=function(e,s){return this.m_vertex1.setVec2(e),this.m_vertex2.setVec2(s),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},t.prototype._clone=function(){var e=new t;return e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_vertex1.setVec2(this.m_vertex1),e.m_vertex2.setVec2(this.m_vertex2),e.m_vertex0.setVec2(this.m_vertex0),e.m_vertex3.setVec2(this.m_vertex3),e.m_hasVertex0=this.m_hasVertex0,e.m_hasVertex3=this.m_hasVertex3,e},t.prototype.getChildCount=function(){return 1},t.prototype.testPoint=function(e,s){return!1},t.prototype.rayCast=function(e,s,r,n){var o=B.mulTVec2(r.q,c.sub(s.p1,r.p)),a=B.mulTVec2(r.q,c.sub(s.p2,r.p)),l=c.sub(a,o),p=this.m_vertex1,_=this.m_vertex2,y=c.sub(_,p),h=c.neo(y.y,-y.x);h.normalize();var m=c.dot(h,c.sub(p,o)),u=c.dot(h,l);if(u==0)return!1;var d=m/u;if(d<0||s.maxFraction<d)return!1;var f=c.add(o,c.mulNumVec2(d,l)),v=c.sub(_,p),w=c.dot(v,v);if(w==0)return!1;var g=c.dot(c.sub(f,p),v)/w;return g<0||1<g?!1:(e.fraction=d,m>0?e.normal=B.mulVec2(r.q,h).neg():e.normal=B.mulVec2(r.q,h),!0)},t.prototype.computeAABB=function(e,s,r){D(Io,s,this.m_vertex1),D(Eo,s,this.m_vertex2),Et.combinePoints(e,Io,Eo),Et.extend(e,this.m_radius)},t.prototype.computeMass=function(e,s){e.mass=0,ct(e.center,.5,this.m_vertex1,.5,this.m_vertex2),e.I=0},t.prototype.computeDistanceProxy=function(e){e.m_vertices[0]=this.m_vertex1,e.m_vertices[1]=this.m_vertex2,e.m_vertices.length=2,e.m_count=2,e.m_radius=this.m_radius},t.TYPE="edge",t})(Ti),Vo=A(0,0),ko=A(0,0),fr=(function(i){zt(t,i);function t(e,s){var r=this;return r instanceof t?(r=i.call(this)||this,r.m_type=t.TYPE,r.m_radius=I.polygonRadius,r.m_vertices=[],r.m_count=0,r.m_prevVertex=null,r.m_nextVertex=null,r.m_hasPrevVertex=!1,r.m_hasNextVertex=!1,r.m_isLoop=!!s,e&&e.length&&(s?r._createLoop(e):r._createChain(e)),r):new t(e,s)}return t.prototype._serialize=function(){var e={type:this.m_type,vertices:this.m_isLoop?this.m_vertices.slice(0,this.m_vertices.length-1):this.m_vertices,isLoop:this.m_isLoop,hasPrevVertex:this.m_hasPrevVertex,hasNextVertex:this.m_hasNextVertex,prevVertex:null,nextVertex:null};return this.m_prevVertex&&(e.prevVertex=this.m_prevVertex),this.m_nextVertex&&(e.nextVertex=this.m_nextVertex),e},t._deserialize=function(e,s,r){var n=[];if(e.vertices)for(var o=0;o<e.vertices.length;o++)n.push(r(c,e.vertices[o]));var a=new t(n,e.isLoop);return e.prevVertex&&a.setPrevVertex(e.prevVertex),e.nextVertex&&a.setNextVertex(e.nextVertex),a},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype._createLoop=function(e){if(!(e.length<3)){var s;this.m_vertices=[],this.m_count=e.length+1;for(var s=0;s<e.length;++s)this.m_vertices[s]=c.clone(e[s]);return this.m_vertices[e.length]=c.clone(e[0]),this.m_prevVertex=this.m_vertices[this.m_count-2],this.m_nextVertex=this.m_vertices[1],this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}},t.prototype._createChain=function(e){var s;this.m_vertices=[],this.m_count=e.length;for(var s=0;s<e.length;++s)this.m_vertices[s]=c.clone(e[s]);return this.m_prevVertex=null,this.m_nextVertex=null,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this},t.prototype._reset=function(){this.m_isLoop?this._createLoop(this.m_vertices.slice(0,this.m_vertices.length-1)):this._createChain(this.m_vertices)},t.prototype.setPrevVertex=function(e){this.m_prevVertex=e,this.m_hasPrevVertex=!0},t.prototype.getPrevVertex=function(){return this.m_prevVertex},t.prototype.setNextVertex=function(e){this.m_nextVertex=e,this.m_hasNextVertex=!0},t.prototype.getNextVertex=function(){return this.m_nextVertex},t.prototype._clone=function(){var e=new t;return e._createChain(this.m_vertices),e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_prevVertex=this.m_prevVertex,e.m_nextVertex=this.m_nextVertex,e.m_hasPrevVertex=this.m_hasPrevVertex,e.m_hasNextVertex=this.m_hasNextVertex,e},t.prototype.getChildCount=function(){return this.m_count-1},t.prototype.getChildEdge=function(e,s){e.m_type=si.TYPE,e.m_radius=this.m_radius,e.m_vertex1=this.m_vertices[s],e.m_vertex2=this.m_vertices[s+1],s>0?(e.m_vertex0=this.m_vertices[s-1],e.m_hasVertex0=!0):(e.m_vertex0=this.m_prevVertex,e.m_hasVertex0=this.m_hasPrevVertex),s<this.m_count-2?(e.m_vertex3=this.m_vertices[s+2],e.m_hasVertex3=!0):(e.m_vertex3=this.m_nextVertex,e.m_hasVertex3=this.m_hasNextVertex)},t.prototype.getVertex=function(e){return e<this.m_count?this.m_vertices[e]:this.m_vertices[0]},t.prototype.isLoop=function(){return this.m_isLoop},t.prototype.testPoint=function(e,s){return!1},t.prototype.rayCast=function(e,s,r,n){var o=new si(this.getVertex(n),this.getVertex(n+1));return o.rayCast(e,s,r,0)},t.prototype.computeAABB=function(e,s,r){D(Vo,s,this.getVertex(r)),D(ko,s,this.getVertex(r+1)),Et.combinePoints(e,Vo,ko)},t.prototype.computeMass=function(e,s){e.mass=0,k(e.center),e.I=0},t.prototype.computeDistanceProxy=function(e,s){e.m_vertices[0]=this.getVertex(s),e.m_vertices[1]=this.getVertex(s+1),e.m_count=2,e.m_radius=this.m_radius},t.TYPE="chain",t})(Ti),Lo=Math.max,$r=Math.min,vi=A(0,0),zo=A(0,0),ms=A(0,0),qi=A(0,0),_i=A(0,0),Xe=A(0,0),ri=(function(i){zt(t,i);function t(e){var s=this;return s instanceof t?(s=i.call(this)||this,s.m_type=t.TYPE,s.m_radius=I.polygonRadius,s.m_centroid=c.zero(),s.m_vertices=[],s.m_normals=[],s.m_count=0,e&&e.length&&s._set(e),s):new t(e)}return t.prototype._serialize=function(){return{type:this.m_type,vertices:this.m_vertices}},t._deserialize=function(e,s,r){var n=[];if(e.vertices)for(var o=0;o<e.vertices.length;o++)n.push(r(c,e.vertices[o]));var a=new t(n);return a},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype._clone=function(){var e=new t;e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_count=this.m_count,e.m_centroid.setVec2(this.m_centroid);for(var s=0;s<this.m_count;s++)e.m_vertices.push(this.m_vertices[s].clone());for(var s=0;s<this.m_normals.length;s++)e.m_normals.push(this.m_normals[s].clone());return e},t.prototype.getChildCount=function(){return 1},t.prototype._reset=function(){this._set(this.m_vertices)},t.prototype._set=function(e){if(e.length<3){this._setAsBox(1,1);return}for(var s=$r(e.length,I.maxPolygonVertices),r=[],n=0;n<s;++n){for(var o=e[n],a=!0,l=0;l<r.length;++l)if(c.distanceSquared(o,r[l])<.25*I.linearSlopSquared){a=!1;break}a&&r.push(c.clone(o))}if(s=r.length,s<3){this._setAsBox(1,1);return}for(var p=0,_=r[0].x,n=1;n<s;++n){var y=r[n].x;(y>_||y===_&&r[n].y<r[p].y)&&(p=n,_=y)}for(var h=[],m=0,u=p;;){h[m]=u;for(var d=0,l=1;l<s;++l){if(d===u){d=l;continue}var f=c.sub(r[d],r[h[m]]),o=c.sub(r[l],r[h[m]]),v=c.crossVec2Vec2(f,o);v<0&&(d=l),v===0&&o.lengthSquared()>f.lengthSquared()&&(d=l)}if(++m,u=d,d===p)break}if(m<3){this._setAsBox(1,1);return}this.m_count=m,this.m_vertices=[];for(var n=0;n<m;++n)this.m_vertices[n]=r[h[n]];for(var n=0;n<m;++n){var w=n,g=n+1<m?n+1:0,b=c.sub(this.m_vertices[g],this.m_vertices[w]);this.m_normals[n]=c.crossVec2Num(b,1),this.m_normals[n].normalize()}this.m_centroid=mh(this.m_vertices,m)},t.prototype._setAsBox=function(e,s,r,n){if(this.m_vertices[0]=c.neo(e,-s),this.m_vertices[1]=c.neo(e,s),this.m_vertices[2]=c.neo(-e,s),this.m_vertices[3]=c.neo(-e,-s),this.m_normals[0]=c.neo(1,0),this.m_normals[1]=c.neo(0,1),this.m_normals[2]=c.neo(-1,0),this.m_normals[3]=c.neo(0,-1),this.m_count=4,r&&c.isValid(r)){n=n||0,x(this.m_centroid,r);var o=ge.identity();o.p.setVec2(r),o.q.setAngle(n);for(var a=0;a<this.m_count;++a)this.m_vertices[a]=ge.mulVec2(o,this.m_vertices[a]),this.m_normals[a]=B.mulVec2(o.q,this.m_normals[a])}},t.prototype.testPoint=function(e,s){for(var r=gn(vi,e,s),n=0;n<this.m_count;++n){var o=M(this.m_normals[n],r)-M(this.m_normals[n],this.m_vertices[n]);if(o>0)return!1}return!0},t.prototype.rayCast=function(e,s,r,n){for(var o=B.mulTVec2(r.q,c.sub(s.p1,r.p)),a=B.mulTVec2(r.q,c.sub(s.p2,r.p)),l=c.sub(a,o),p=0,_=s.maxFraction,y=-1,h=0;h<this.m_count;++h){var m=c.dot(this.m_normals[h],c.sub(this.m_vertices[h],o)),u=c.dot(this.m_normals[h],l);if(u==0){if(m<0)return!1}else u<0&&m<p*u?(p=m/u,y=h):u>0&&m<_*u&&(_=m/u);if(_<p)return!1}return y>=0?(e.fraction=p,e.normal=B.mulVec2(r.q,this.m_normals[y]),!0):!1},t.prototype.computeAABB=function(e,s,r){for(var n=1/0,o=1/0,a=-1/0,l=-1/0,p=0;p<this.m_count;++p){var _=D(vi,s,this.m_vertices[p]);n=$r(n,_.x),a=Lo(a,_.x),o=$r(o,_.y),l=Lo(l,_.y)}Tt(e.lowerBound,n-this.m_radius,o-this.m_radius),Tt(e.upperBound,a+this.m_radius,l+this.m_radius)},t.prototype.computeMass=function(e,s){k(_i);var r=0,n=0;k(Xe);for(var o=0;o<this.m_count;++o)ne(Xe,this.m_vertices[o]);L(Xe,1/this.m_count,Xe);for(var a=1/3,o=0;o<this.m_count;++o){R(ms,this.m_vertices[o],Xe),o+1<this.m_count?R(qi,this.m_vertices[o+1],Xe):R(qi,this.m_vertices[0],Xe);var l=$(ms,qi),p=.5*l;r+=p,ct(vi,p*a,ms,p*a,qi),ne(_i,vi);var _=ms.x,y=ms.y,h=qi.x,m=qi.y,u=_*_+h*_+h*h,d=y*y+m*y+m*m;n+=.25*a*l*(u+d)}e.mass=s*r,L(_i,1/r,_i),Nl(e.center,_i,Xe),e.I=s*n,e.I+=e.mass*(M(e.center,e.center)-M(_i,_i))},t.prototype.validate=function(){for(var e=0;e<this.m_count;++e){var s=e,r=e<this.m_count-1?s+1:0,n=this.m_vertices[s];R(zo,this.m_vertices[r],n);for(var o=0;o<this.m_count;++o)if(!(o==s||o==r)){var a=$(zo,R(vi,this.m_vertices[o],n));if(a<0)return!1}}return!0},t.prototype.computeDistanceProxy=function(e){for(var s=0;s<this.m_count;++s)e.m_vertices[s]=this.m_vertices[s];e.m_vertices.length=this.m_count,e.m_count=this.m_count,e.m_radius=this.m_radius},t.TYPE="polygon",t})(Ti);function mh(i,t){for(var e=c.zero(),s=0,r=c.zero(),n,o=1/3,n=0;n<t;++n){var a=r,l=i[n],p=n+1<t?i[n+1]:i[0],_=c.sub(l,a),y=c.sub(p,a),h=c.crossVec2Vec2(_,y),m=.5*h;s+=m,Pe(vi,1,a,1,l,1,p),fe(e,m*o,vi)}return e.mul(1/s),e}var uh=Math.sqrt,_h=Math.PI,Fo=A(0,0),Bi=(function(i){zt(t,i);function t(e,s){var r=this;return r instanceof t?(r=i.call(this)||this,r.m_type=t.TYPE,r.m_p=c.zero(),r.m_radius=1,typeof e=="object"&&c.isValid(e)?(r.m_p.setVec2(e),typeof s=="number"&&(r.m_radius=s)):typeof e=="number"&&(r.m_radius=e),r):new t(e,s)}return t.prototype._serialize=function(){return{type:this.m_type,p:this.m_p,radius:this.m_radius}},t._deserialize=function(e){return new t(e.p,e.radius)},t.prototype._reset=function(){},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype.getCenter=function(){return this.m_p},t.prototype._clone=function(){var e=new t;return e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_p=this.m_p.clone(),e},t.prototype.getChildCount=function(){return 1},t.prototype.testPoint=function(e,s){var r=D(Fo,e,this.m_p);return bi(s,r)<=this.m_radius*this.m_radius},t.prototype.rayCast=function(e,s,r,n){var o=c.add(r.p,B.mulVec2(r.q,this.m_p)),a=c.sub(s.p1,o),l=c.dot(a,a)-this.m_radius*this.m_radius,p=c.sub(s.p2,s.p1),_=c.dot(a,p),y=c.dot(p,p),h=_*_-y*l;if(h<0||y<qt)return!1;var m=-(_+uh(h));return 0<=m&&m<=s.maxFraction*y?(m/=y,e.fraction=m,e.normal=c.add(a,c.mulNumVec2(m,p)),e.normal.normalize(),!0):!1},t.prototype.computeAABB=function(e,s,r){var n=D(Fo,s,this.m_p);Tt(e.lowerBound,n.x-this.m_radius,n.y-this.m_radius),Tt(e.upperBound,n.x+this.m_radius,n.y+this.m_radius)},t.prototype.computeMass=function(e,s){e.mass=s*_h*this.m_radius*this.m_radius,x(e.center,this.m_p),e.I=e.mass*(.5*this.m_radius*this.m_radius+wi(this.m_p))},t.prototype.computeDistanceProxy=function(e){e.m_vertices[0]=this.m_p,e.m_vertices.length=1,e.m_count=1,e.m_radius=this.m_radius},t.TYPE="circle",t})(Ti),ph=Math.abs,dh=Math.PI,yh={frequencyHz:0,dampingRatio:0},Do=(function(i){zt(t,i);function t(e,s,r,n,o){var a=this;if(!(a instanceof t))return new t(e,s,r,n,o);if(r&&n&&"m_type"in n&&"x"in r&&"y"in r){var l=r;r=n,n=l}return e=Xt(e,yh),a=i.call(this,e,s,r)||this,s=a.m_bodyA,r=a.m_bodyB,a.m_type=t.TYPE,a.m_localAnchorA=c.clone(n?s.getLocalPoint(n):e.localAnchorA||c.zero()),a.m_localAnchorB=c.clone(o?r.getLocalPoint(o):e.localAnchorB||c.zero()),a.m_length=Number.isFinite(e.length)?e.length:c.distance(s.getWorldPoint(a.m_localAnchorA),r.getWorldPoint(a.m_localAnchorB)),a.m_frequencyHz=e.frequencyHz,a.m_dampingRatio=e.dampingRatio,a.m_impulse=0,a.m_gamma=0,a.m_bias=0,a}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,length:this.m_length,impulse:this.m_impulse,gamma:this.m_gamma,bias:this.m_bias}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.length>0?this.m_length=+e.length:e.length<0||(e.anchorA||e.anchorA||e.anchorA||e.anchorA)&&(this.m_length=c.distance(this.m_bodyA.getWorldPoint(this.m_localAnchorA),this.m_bodyB.getWorldPoint(this.m_localAnchorB))),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setLength=function(e){this.m_length=e},t.prototype.getLength=function(){return this.m_length},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.mulNumVec2(this.m_impulse,this.m_u).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,l=this.m_bodyB.c_position.a,p=this.m_bodyB.c_velocity.v,_=this.m_bodyB.c_velocity.w,y=B.neo(r),h=B.neo(l);this.m_rA=B.mulVec2(y,c.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(h,c.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_u=c.sub(c.add(a,this.m_rB),c.add(s,this.m_rA));var m=this.m_u.length();m>I.linearSlop?this.m_u.mul(1/m):this.m_u.setNum(0,0);var u=c.crossVec2Vec2(this.m_rA,this.m_u),d=c.crossVec2Vec2(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*u*u+this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=f!=0?1/f:0,this.m_frequencyHz>0){var v=m-this.m_length,w=2*dh*this.m_frequencyHz,g=2*this.m_mass*this.m_dampingRatio*w,b=this.m_mass*w*w,S=e.dt;this.m_gamma=S*(g+S*b),this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0,this.m_bias=v*S*b*this.m_gamma,f+=this.m_gamma,this.m_mass=f!=0?1/f:0}else this.m_gamma=0,this.m_bias=0;if(e.warmStarting){this.m_impulse*=e.dtRatio;var C=c.mulNumVec2(this.m_impulse,this.m_u);n.subMul(this.m_invMassA,C),o-=this.m_invIA*c.crossVec2Vec2(this.m_rA,C),p.addMul(this.m_invMassB,C),_+=this.m_invIB*c.crossVec2Vec2(this.m_rB,C)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(n),this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v.setVec2(p),this.m_bodyB.c_velocity.w=_},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=c.add(s,c.crossNumVec2(r,this.m_rA)),l=c.add(n,c.crossNumVec2(o,this.m_rB)),p=c.dot(this.m_u,l)-c.dot(this.m_u,a),_=-this.m_mass*(p+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=_;var y=c.mulNumVec2(_,this.m_u);s.subMul(this.m_invMassA,y),r-=this.m_invIA*c.crossVec2Vec2(this.m_rA,y),n.addMul(this.m_invMassB,y),o+=this.m_invIB*c.crossVec2Vec2(this.m_rB,y),this.m_bodyA.c_velocity.v.setVec2(s),this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v.setVec2(n),this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){if(this.m_frequencyHz>0)return!0;var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=B.neo(r),l=B.neo(o),p=B.mulSub(a,this.m_localAnchorA,this.m_localCenterA),_=B.mulSub(l,this.m_localAnchorB,this.m_localCenterB),y=c.sub(c.add(n,_),c.add(s,p)),h=y.normalize(),m=Mt(h-this.m_length,-I.maxLinearCorrection,I.maxLinearCorrection),u=-this.m_mass*m,d=c.mulNumVec2(u,y);return s.subMul(this.m_invMassA,d),r-=this.m_invIA*c.crossVec2Vec2(p,d),n.addMul(this.m_invMassB,d),o+=this.m_invIB*c.crossVec2Vec2(_,d),this.m_bodyA.c_position.c.setVec2(s),this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c.setVec2(n),this.m_bodyB.c_position.a=o,ph(m)<I.linearSlop},t.TYPE="distance-joint",t})(kt),fh={maxForce:0,maxTorque:0},Ro=(function(i){zt(t,i);function t(e,s,r,n){var o=this;return o instanceof t?(e=Xt(e,fh),o=i.call(this,e,s,r)||this,s=o.m_bodyA,r=o.m_bodyB,o.m_type=t.TYPE,o.m_localAnchorA=c.clone(n?s.getLocalPoint(n):e.localAnchorA||c.zero()),o.m_localAnchorB=c.clone(n?r.getLocalPoint(n):e.localAnchorB||c.zero()),o.m_linearImpulse=c.zero(),o.m_angularImpulse=0,o.m_maxForce=e.maxForce,o.m_maxTorque=e.maxTorque,o):new t(e,s,r,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.maxTorque)&&(this.m_maxTorque=e.maxTorque)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setMaxTorque=function(e){this.m_maxTorque=e},t.prototype.getMaxTorque=function(){return this.m_maxTorque},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.mulNumVec2(e,this.m_linearImpulse)},t.prototype.getReactionTorque=function(e){return e*this.m_angularImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=B.neo(s),_=B.neo(o);this.m_rA=B.mulVec2(p,c.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(_,c.sub(this.m_localAnchorB,this.m_localCenterB));var y=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,u=this.m_invIB,d=new xe;if(d.ex.x=y+h+m*this.m_rA.y*this.m_rA.y+u*this.m_rB.y*this.m_rB.y,d.ex.y=-m*this.m_rA.x*this.m_rA.y-u*this.m_rB.x*this.m_rB.y,d.ey.x=d.ex.y,d.ey.y=y+h+m*this.m_rA.x*this.m_rA.x+u*this.m_rB.x*this.m_rB.x,this.m_linearMass=d.getInverse(),this.m_angularMass=m+u,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),e.warmStarting){this.m_linearImpulse.mul(e.dtRatio),this.m_angularImpulse*=e.dtRatio;var f=c.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);r.subMul(y,f),n-=m*(c.crossVec2Vec2(this.m_rA,f)+this.m_angularImpulse),a.addMul(h,f),l+=u*(c.crossVec2Vec2(this.m_rB,f)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=r,this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=this.m_invMassA,l=this.m_invMassB,p=this.m_invIA,_=this.m_invIB,y=e.dt;{var h=o-r,m=-this.m_angularMass*h,u=this.m_angularImpulse,d=y*this.m_maxTorque;this.m_angularImpulse=Mt(this.m_angularImpulse+m,-d,d),m=this.m_angularImpulse-u,r-=p*m,o+=_*m}{var h=c.sub(c.add(n,c.crossNumVec2(o,this.m_rB)),c.add(s,c.crossNumVec2(r,this.m_rA))),m=c.neg(xe.mulVec2(this.m_linearMass,h)),u=this.m_linearImpulse;this.m_linearImpulse.add(m);var d=y*this.m_maxForce;this.m_linearImpulse.lengthSquared()>d*d&&(this.m_linearImpulse.normalize(),this.m_linearImpulse.mul(d)),m=c.sub(this.m_linearImpulse,u),s.subMul(a,m),r-=p*c.crossVec2Vec2(this.m_rA,m),n.addMul(l,m),o+=_*c.crossVec2Vec2(this.m_rB,m)}this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="friction-joint",t})(kt),ii=(function(){function i(t,e,s){typeof t=="object"&&t!==null?(this.ex=K.clone(t),this.ey=K.clone(e),this.ez=K.clone(s)):(this.ex=K.zero(),this.ey=K.zero(),this.ez=K.zero())}return i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:K.isValid(t.ex)&&K.isValid(t.ey)&&K.isValid(t.ez)},i.assert=function(t){},i.prototype.setZero=function(){return this.ex.setZero(),this.ey.setZero(),this.ez.setZero(),this},i.prototype.solve33=function(t){var e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,s=this.ey.z*this.ez.x-this.ey.x*this.ez.z,r=this.ey.x*this.ez.y-this.ey.y*this.ez.x,n=this.ex.x*e+this.ex.y*s+this.ex.z*r;n!==0&&(n=1/n);var o=new K;return e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,s=this.ey.z*this.ez.x-this.ey.x*this.ez.z,r=this.ey.x*this.ez.y-this.ey.y*this.ez.x,o.x=n*(t.x*e+t.y*s+t.z*r),e=t.y*this.ez.z-t.z*this.ez.y,s=t.z*this.ez.x-t.x*this.ez.z,r=t.x*this.ez.y-t.y*this.ez.x,o.y=n*(this.ex.x*e+this.ex.y*s+this.ex.z*r),e=this.ey.y*t.z-this.ey.z*t.y,s=this.ey.z*t.x-this.ey.x*t.z,r=this.ey.x*t.y-this.ey.y*t.x,o.z=n*(this.ex.x*e+this.ex.y*s+this.ex.z*r),o},i.prototype.solve22=function(t){var e=this.ex.x,s=this.ey.x,r=this.ex.y,n=this.ey.y,o=e*n-s*r;o!==0&&(o=1/o);var a=c.zero();return a.x=o*(n*t.x-s*t.y),a.y=o*(e*t.y-r*t.x),a},i.prototype.getInverse22=function(t){var e=this.ex.x,s=this.ey.x,r=this.ex.y,n=this.ey.y,o=e*n-s*r;o!==0&&(o=1/o),t.ex.x=o*n,t.ey.x=-o*s,t.ex.z=0,t.ex.y=-o*r,t.ey.y=o*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},i.prototype.getSymInverse33=function(t){var e=K.dot(this.ex,K.cross(this.ey,this.ez));e!==0&&(e=1/e);var s=this.ex.x,r=this.ey.x,n=this.ez.x,o=this.ey.y,a=this.ez.y,l=this.ez.z;t.ex.x=e*(o*l-a*a),t.ex.y=e*(n*a-r*l),t.ex.z=e*(r*a-n*o),t.ey.x=t.ex.y,t.ey.y=e*(s*l-n*n),t.ey.z=e*(n*r-s*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(s*o-r*r)},i.mul=function(t,e){if(e&&"z"in e&&"y"in e&&"x"in e){var s=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,r=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,n=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new K(s,r,n)}else if(e&&"y"in e&&"x"in e){var s=t.ex.x*e.x+t.ey.x*e.y,r=t.ex.y*e.x+t.ey.y*e.y;return c.neo(s,r)}},i.mulVec3=function(t,e){var s=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,r=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,n=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new K(s,r,n)},i.mulVec2=function(t,e){var s=t.ex.x*e.x+t.ey.x*e.y,r=t.ex.y*e.x+t.ey.y*e.y;return c.neo(s,r)},i.add=function(t,e){return new i(K.add(t.ex,e.ex),K.add(t.ey,e.ey),K.add(t.ez,e.ez))},i})(),qo=Math.abs,St;(function(i){i[i.inactiveLimit=0]="inactiveLimit",i[i.atLowerLimit=1]="atLowerLimit",i[i.atUpperLimit=2]="atUpperLimit",i[i.equalLimits=3]="equalLimits"})(St||(St={}));var Ni={lowerAngle:0,upperAngle:0,maxMotorTorque:0,motorSpeed:0,enableLimit:!1,enableMotor:!1},ei=(function(i){zt(t,i);function t(e,s,r,n){var o=this,a,l,p,_,y,h;return o instanceof t?(e=e??{},o=i.call(this,e,s,r)||this,s=o.m_bodyA,r=o.m_bodyB,o.m_mass=new ii,o.m_limitState=St.inactiveLimit,o.m_type=t.TYPE,c.isValid(n)?o.m_localAnchorA=s.getLocalPoint(n):c.isValid(e.localAnchorA)?o.m_localAnchorA=c.clone(e.localAnchorA):o.m_localAnchorA=c.zero(),c.isValid(n)?o.m_localAnchorB=r.getLocalPoint(n):c.isValid(e.localAnchorB)?o.m_localAnchorB=c.clone(e.localAnchorB):o.m_localAnchorB=c.zero(),Number.isFinite(e.referenceAngle)?o.m_referenceAngle=e.referenceAngle:o.m_referenceAngle=r.getAngle()-s.getAngle(),o.m_impulse=new K,o.m_motorImpulse=0,o.m_lowerAngle=(a=e.lowerAngle)!==null&&a!==void 0?a:Ni.lowerAngle,o.m_upperAngle=(l=e.upperAngle)!==null&&l!==void 0?l:Ni.upperAngle,o.m_maxMotorTorque=(p=e.maxMotorTorque)!==null&&p!==void 0?p:Ni.maxMotorTorque,o.m_motorSpeed=(_=e.motorSpeed)!==null&&_!==void 0?_:Ni.motorSpeed,o.m_enableLimit=(y=e.enableLimit)!==null&&y!==void 0?y:Ni.enableLimit,o.m_enableMotor=(h=e.enableMotor)!==null&&h!==void 0?h:Ni.enableMotor,o):new t(e,s,r,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerAngle:this.m_lowerAngle,upperAngle:this.m_upperAngle,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.referenceAngle)&&(this.m_referenceAngle=e.referenceAngle),e.enableLimit!==void 0&&(this.m_enableLimit=e.enableLimit),Number.isFinite(e.lowerAngle)&&(this.m_lowerAngle=e.lowerAngle),Number.isFinite(e.upperAngle)&&(this.m_upperAngle=e.upperAngle),Number.isFinite(e.maxMotorTorque)&&(this.m_maxMotorTorque=e.maxMotorTorque),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed),e.enableMotor!==void 0&&(this.m_enableMotor=e.enableMotor)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.getJointAngle=function(){var e=this.m_bodyA,s=this.m_bodyB;return s.m_sweep.a-e.m_sweep.a-this.m_referenceAngle},t.prototype.getJointSpeed=function(){var e=this.m_bodyA,s=this.m_bodyB;return s.m_angularVelocity-e.m_angularVelocity},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.getMotorTorque=function(e){return e*this.m_motorImpulse},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.setMaxMotorTorque=function(e){e!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=e)},t.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},t.prototype.isLimitEnabled=function(){return this.m_enableLimit},t.prototype.enableLimit=function(e){e!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},t.prototype.getLowerLimit=function(){return this.m_lowerAngle},t.prototype.getUpperLimit=function(){return this.m_upperAngle},t.prototype.setLimits=function(e,s){(e!=this.m_lowerAngle||s!=this.m_upperAngle)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=e,this.m_upperAngle=s)},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.neo(this.m_impulse.x,this.m_impulse.y).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.z},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=B.neo(s),_=B.neo(o);this.m_rA=B.mulVec2(p,c.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(_,c.sub(this.m_localAnchorB,this.m_localCenterB));var y=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,u=this.m_invIB,d=m+u===0;if(this.m_mass.ex.x=y+h+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*u,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*u,this.m_mass.ez.x=-this.m_rA.y*m-this.m_rB.y*u,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=y+h+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*u,this.m_mass.ez.y=this.m_rA.x*m+this.m_rB.x*u,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=m+u,this.m_motorMass=m+u,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),(this.m_enableMotor==!1||d)&&(this.m_motorImpulse=0),this.m_enableLimit&&d==!1){var f=o-s-this.m_referenceAngle;qo(this.m_upperAngle-this.m_lowerAngle)<2*I.angularSlop?this.m_limitState=St.equalLimits:f<=this.m_lowerAngle?(this.m_limitState!=St.atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=St.atLowerLimit):f>=this.m_upperAngle?(this.m_limitState!=St.atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=St.atUpperLimit):(this.m_limitState=St.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=St.inactiveLimit;if(e.warmStarting){this.m_impulse.mul(e.dtRatio),this.m_motorImpulse*=e.dtRatio;var v=c.neo(this.m_impulse.x,this.m_impulse.y);r.subMul(y,v),n-=m*(c.crossVec2Vec2(this.m_rA,v)+this.m_motorImpulse+this.m_impulse.z),a.addMul(h,v),l+=u*(c.crossVec2Vec2(this.m_rB,v)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v=r,this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=this.m_invMassA,l=this.m_invMassB,p=this.m_invIA,_=this.m_invIB,y=p+_===0;if(this.m_enableMotor&&this.m_limitState!=St.equalLimits&&y==!1){var h=o-r-this.m_motorSpeed,m=-this.m_motorMass*h,u=this.m_motorImpulse,d=e.dt*this.m_maxMotorTorque;this.m_motorImpulse=Mt(this.m_motorImpulse+m,-d,d),m=this.m_motorImpulse-u,r-=p*m,o+=_*m}if(this.m_enableLimit&&this.m_limitState!=St.inactiveLimit&&y==!1){var f=c.zero();f.addCombine(1,n,1,c.crossNumVec2(o,this.m_rB)),f.subCombine(1,s,1,c.crossNumVec2(r,this.m_rA));var v=o-r,h=new K(f.x,f.y,v),m=K.neg(this.m_mass.solve33(h));if(this.m_limitState==St.equalLimits)this.m_impulse.add(m);else if(this.m_limitState==St.atLowerLimit){var w=this.m_impulse.z+m.z;if(w<0){var g=c.combine(-1,f,this.m_impulse.z,c.neo(this.m_mass.ez.x,this.m_mass.ez.y)),b=this.m_mass.solve22(g);m.x=b.x,m.y=b.y,m.z=-this.m_impulse.z,this.m_impulse.x+=b.x,this.m_impulse.y+=b.y,this.m_impulse.z=0}else this.m_impulse.add(m)}else if(this.m_limitState==St.atUpperLimit){var w=this.m_impulse.z+m.z;if(w>0){var g=c.combine(-1,f,this.m_impulse.z,c.neo(this.m_mass.ez.x,this.m_mass.ez.y)),b=this.m_mass.solve22(g);m.x=b.x,m.y=b.y,m.z=-this.m_impulse.z,this.m_impulse.x+=b.x,this.m_impulse.y+=b.y,this.m_impulse.z=0}else this.m_impulse.add(m)}var S=c.neo(m.x,m.y);s.subMul(a,S),r-=p*(c.crossVec2Vec2(this.m_rA,S)+m.z),n.addMul(l,S),o+=_*(c.crossVec2Vec2(this.m_rB,S)+m.z)}else{var h=c.zero();h.addCombine(1,n,1,c.crossNumVec2(o,this.m_rB)),h.subCombine(1,s,1,c.crossNumVec2(r,this.m_rA));var m=this.m_mass.solve22(c.neg(h));this.m_impulse.x+=m.x,this.m_impulse.y+=m.y,s.subMul(a,m),r-=p*c.crossVec2Vec2(this.m_rA,m),n.addMul(l,m),o+=_*c.crossVec2Vec2(this.m_rB,m)}this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=B.neo(r),l=B.neo(o),p=0,_=0,y=this.m_invIA+this.m_invIB==0;if(this.m_enableLimit&&this.m_limitState!=St.inactiveLimit&&y==!1){var h=o-r-this.m_referenceAngle,m=0;if(this.m_limitState==St.equalLimits){var u=Mt(h-this.m_lowerAngle,-I.maxAngularCorrection,I.maxAngularCorrection);m=-this.m_motorMass*u,p=qo(u)}else if(this.m_limitState==St.atLowerLimit){var u=h-this.m_lowerAngle;p=-u,u=Mt(u+I.angularSlop,-I.maxAngularCorrection,0),m=-this.m_motorMass*u}else if(this.m_limitState==St.atUpperLimit){var u=h-this.m_upperAngle;p=u,u=Mt(u-I.angularSlop,0,I.maxAngularCorrection),m=-this.m_motorMass*u}r-=this.m_invIA*m,o+=this.m_invIB*m}{a.setAngle(r),l.setAngle(o);var d=B.mulVec2(a,c.sub(this.m_localAnchorA,this.m_localCenterA)),f=B.mulVec2(l,c.sub(this.m_localAnchorB,this.m_localCenterB)),u=c.zero();u.addCombine(1,n,1,f),u.subCombine(1,s,1,d),_=u.length();var v=this.m_invMassA,w=this.m_invMassB,g=this.m_invIA,b=this.m_invIB,S=new xe;S.ex.x=v+w+g*d.y*d.y+b*f.y*f.y,S.ex.y=-g*d.x*d.y-b*f.x*f.y,S.ey.x=S.ex.y,S.ey.y=v+w+g*d.x*d.x+b*f.x*f.x;var C=c.neg(S.solve(u));s.subMul(v,C),r-=g*c.crossVec2Vec2(d,C),n.addMul(w,C),o+=b*c.crossVec2Vec2(f,C)}return this.m_bodyA.c_position.c.setVec2(s),this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c.setVec2(n),this.m_bodyB.c_position.a=o,_<=I.linearSlop&&p<=I.angularSlop},t.TYPE="revolute-joint",t})(kt),us=Math.abs,No=Math.max,vh=Math.min,Ht;(function(i){i[i.inactiveLimit=0]="inactiveLimit",i[i.atLowerLimit=1]="atLowerLimit",i[i.atUpperLimit=2]="atUpperLimit",i[i.equalLimits=3]="equalLimits"})(Ht||(Ht={}));var gh={enableLimit:!1,lowerTranslation:0,upperTranslation:0,enableMotor:!1,maxMotorForce:0,motorSpeed:0},Oo=(function(i){zt(t,i);function t(e,s,r,n,o){var a=this;return a instanceof t?(e=Xt(e,gh),a=i.call(this,e,s,r)||this,s=a.m_bodyA,r=a.m_bodyB,a.m_type=t.TYPE,a.m_localAnchorA=c.clone(n?s.getLocalPoint(n):e.localAnchorA||c.zero()),a.m_localAnchorB=c.clone(n?r.getLocalPoint(n):e.localAnchorB||c.zero()),a.m_localXAxisA=c.clone(o?s.getLocalVector(o):e.localAxisA||c.neo(1,0)),a.m_localXAxisA.normalize(),a.m_localYAxisA=c.crossNumVec2(1,a.m_localXAxisA),a.m_referenceAngle=Number.isFinite(e.referenceAngle)?e.referenceAngle:r.getAngle()-s.getAngle(),a.m_impulse=new K,a.m_motorMass=0,a.m_motorImpulse=0,a.m_lowerTranslation=e.lowerTranslation,a.m_upperTranslation=e.upperTranslation,a.m_maxMotorForce=e.maxMotorForce,a.m_motorSpeed=e.motorSpeed,a.m_enableLimit=e.enableLimit,a.m_enableMotor=e.enableMotor,a.m_limitState=Ht.inactiveLimit,a.m_axis=c.zero(),a.m_perp=c.zero(),a.m_K=new ii,a):new t(e,s,r,n,o)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerTranslation:this.m_lowerTranslation,upperTranslation:this.m_upperTranslation,maxMotorForce:this.m_maxMotorForce,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s),e.localAxisA=c.clone(e.localAxisA);var n=new t(e);return n},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.localAxisA&&(this.m_localXAxisA.setVec2(e.localAxisA),this.m_localYAxisA.setVec2(c.crossNumVec2(1,e.localAxisA))),Number.isFinite(e.referenceAngle)&&(this.m_referenceAngle=e.referenceAngle),typeof e.enableLimit<"u"&&(this.m_enableLimit=!!e.enableLimit),Number.isFinite(e.lowerTranslation)&&(this.m_lowerTranslation=e.lowerTranslation),Number.isFinite(e.upperTranslation)&&(this.m_upperTranslation=e.upperTranslation),typeof e.enableMotor<"u"&&(this.m_enableMotor=!!e.enableMotor),Number.isFinite(e.maxMotorForce)&&(this.m_maxMotorForce=e.maxMotorForce),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getLocalAxisA=function(){return this.m_localXAxisA},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.getJointTranslation=function(){var e=this.m_bodyA.getWorldPoint(this.m_localAnchorA),s=this.m_bodyB.getWorldPoint(this.m_localAnchorB),r=c.sub(s,e),n=this.m_bodyA.getWorldVector(this.m_localXAxisA),o=c.dot(r,n);return o},t.prototype.getJointSpeed=function(){var e=this.m_bodyA,s=this.m_bodyB,r=B.mulVec2(e.m_xf.q,c.sub(this.m_localAnchorA,e.m_sweep.localCenter)),n=B.mulVec2(s.m_xf.q,c.sub(this.m_localAnchorB,s.m_sweep.localCenter)),o=c.add(e.m_sweep.c,r),a=c.add(s.m_sweep.c,n),l=c.sub(a,o),p=B.mulVec2(e.m_xf.q,this.m_localXAxisA),_=e.m_linearVelocity,y=s.m_linearVelocity,h=e.m_angularVelocity,m=s.m_angularVelocity,u=c.dot(l,c.crossNumVec2(h,p))+c.dot(p,c.sub(c.addCrossNumVec2(y,m,n),c.addCrossNumVec2(_,h,r)));return u},t.prototype.isLimitEnabled=function(){return this.m_enableLimit},t.prototype.enableLimit=function(e){e!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},t.prototype.getLowerLimit=function(){return this.m_lowerTranslation},t.prototype.getUpperLimit=function(){return this.m_upperTranslation},t.prototype.setLimits=function(e,s){(e!=this.m_lowerTranslation||s!=this.m_upperTranslation)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_lowerTranslation=e,this.m_upperTranslation=s,this.m_impulse.z=0)},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.setMaxMotorForce=function(e){e!=this.m_maxMotorForce&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorForce=e)},t.prototype.getMaxMotorForce=function(){return this.m_maxMotorForce},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.getMotorForce=function(e){return e*this.m_motorImpulse},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.y},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,l=this.m_bodyB.c_position.a,p=this.m_bodyB.c_velocity.v,_=this.m_bodyB.c_velocity.w,y=B.neo(r),h=B.neo(l),m=B.mulVec2(y,c.sub(this.m_localAnchorA,this.m_localCenterA)),u=B.mulVec2(h,c.sub(this.m_localAnchorB,this.m_localCenterB)),d=c.zero();d.addCombine(1,a,1,u),d.subCombine(1,s,1,m);var f=this.m_invMassA,v=this.m_invMassB,w=this.m_invIA,g=this.m_invIB;this.m_axis=B.mulVec2(y,this.m_localXAxisA),this.m_a1=c.crossVec2Vec2(c.add(d,m),this.m_axis),this.m_a2=c.crossVec2Vec2(u,this.m_axis),this.m_motorMass=f+v+w*this.m_a1*this.m_a1+g*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass);{this.m_perp=B.mulVec2(y,this.m_localYAxisA),this.m_s1=c.crossVec2Vec2(c.add(d,m),this.m_perp),this.m_s2=c.crossVec2Vec2(u,this.m_perp),c.crossVec2Vec2(m,this.m_perp);var b=f+v+w*this.m_s1*this.m_s1+g*this.m_s2*this.m_s2,S=w*this.m_s1+g*this.m_s2,C=w*this.m_s1*this.m_a1+g*this.m_s2*this.m_a2,T=w+g;T==0&&(T=1);var P=w*this.m_a1+g*this.m_a2,E=f+v+w*this.m_a1*this.m_a1+g*this.m_a2*this.m_a2;this.m_K.ex.set(b,S,C),this.m_K.ey.set(S,T,P),this.m_K.ez.set(C,P,E)}if(this.m_enableLimit){var z=c.dot(this.m_axis,d);us(this.m_upperTranslation-this.m_lowerTranslation)<2*I.linearSlop?this.m_limitState=Ht.equalLimits:z<=this.m_lowerTranslation?this.m_limitState!=Ht.atLowerLimit&&(this.m_limitState=Ht.atLowerLimit,this.m_impulse.z=0):z>=this.m_upperTranslation?this.m_limitState!=Ht.atUpperLimit&&(this.m_limitState=Ht.atUpperLimit,this.m_impulse.z=0):(this.m_limitState=Ht.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=Ht.inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor==!1&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.mul(e.dtRatio),this.m_motorImpulse*=e.dtRatio;var H=c.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis),Y=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,W=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;n.subMul(f,H),o-=w*Y,p.addMul(v,H),_+=g*W}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(n),this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v.setVec2(p),this.m_bodyB.c_velocity.w=_},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=this.m_invMassA,l=this.m_invMassB,p=this.m_invIA,_=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!=Ht.equalLimits){var y=c.dot(this.m_axis,c.sub(n,s))+this.m_a2*o-this.m_a1*r,h=this.m_motorMass*(this.m_motorSpeed-y),m=this.m_motorImpulse,u=e.dt*this.m_maxMotorForce;this.m_motorImpulse=Mt(this.m_motorImpulse+h,-u,u),h=this.m_motorImpulse-m;var d=c.mulNumVec2(h,this.m_axis),f=h*this.m_a1,v=h*this.m_a2;s.subMul(a,d),r-=p*f,n.addMul(l,d),o+=_*v}var w=c.zero();if(w.x+=c.dot(this.m_perp,n)+this.m_s2*o,w.x-=c.dot(this.m_perp,s)+this.m_s1*r,w.y=o-r,this.m_enableLimit&&this.m_limitState!=Ht.inactiveLimit){var g=0;g+=c.dot(this.m_axis,n)+this.m_a2*o,g-=c.dot(this.m_axis,s)+this.m_a1*r;var y=new K(w.x,w.y,g),b=K.clone(this.m_impulse),S=this.m_K.solve33(K.neg(y));this.m_impulse.add(S),this.m_limitState==Ht.atLowerLimit?this.m_impulse.z=No(this.m_impulse.z,0):this.m_limitState==Ht.atUpperLimit&&(this.m_impulse.z=vh(this.m_impulse.z,0));var C=c.combine(-1,w,-(this.m_impulse.z-b.z),c.neo(this.m_K.ez.x,this.m_K.ez.y)),T=c.add(this.m_K.solve22(C),c.neo(b.x,b.y));this.m_impulse.x=T.x,this.m_impulse.y=T.y,S=K.sub(this.m_impulse,b);var d=c.combine(S.x,this.m_perp,S.z,this.m_axis),f=S.x*this.m_s1+S.y+S.z*this.m_a1,v=S.x*this.m_s2+S.y+S.z*this.m_a2;s.subMul(a,d),r-=p*f,n.addMul(l,d),o+=_*v}else{var S=this.m_K.solve22(c.neg(w));this.m_impulse.x+=S.x,this.m_impulse.y+=S.y;var d=c.mulNumVec2(S.x,this.m_perp),f=S.x*this.m_s1+S.y,v=S.x*this.m_s2+S.y;s.subMul(a,d),r-=p*f,n.addMul(l,d),o+=_*v}this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=B.neo(r),l=B.neo(o),p=this.m_invMassA,_=this.m_invMassB,y=this.m_invIA,h=this.m_invIB,m=B.mulVec2(a,c.sub(this.m_localAnchorA,this.m_localCenterA)),u=B.mulVec2(l,c.sub(this.m_localAnchorB,this.m_localCenterB)),d=c.sub(c.add(n,u),c.add(s,m)),f=B.mulVec2(a,this.m_localXAxisA),v=c.crossVec2Vec2(c.add(d,m),f),w=c.crossVec2Vec2(u,f),g=B.mulVec2(a,this.m_localYAxisA),b=c.crossVec2Vec2(c.add(d,m),g),S=c.crossVec2Vec2(u,g),C=new K,T=c.zero();T.x=c.dot(g,d),T.y=o-r-this.m_referenceAngle;var P=us(T.x),E=us(T.y),z=I.linearSlop,H=I.maxLinearCorrection,Y=!1,W=0;if(this.m_enableLimit){var j=c.dot(f,d);us(this.m_upperTranslation-this.m_lowerTranslation)<2*z?(W=Mt(j,-H,H),P=No(P,us(j)),Y=!0):j<=this.m_lowerTranslation?(W=Mt(j-this.m_lowerTranslation+z,-H,0),P=Math.max(P,this.m_lowerTranslation-j),Y=!0):j>=this.m_upperTranslation&&(W=Mt(j-this.m_upperTranslation-z,0,H),P=Math.max(P,j-this.m_upperTranslation),Y=!0)}if(Y){var dt=p+_+y*b*b+h*S*S,ot=y*b+h*S,At=y*b*v+h*S*w,lt=y+h;lt==0&&(lt=1);var rt=y*v+h*w,oi=p+_+y*v*v+h*w*w,Pt=new ii;Pt.ex.set(dt,ot,At),Pt.ey.set(ot,lt,rt),Pt.ez.set(At,rt,oi);var Qt=new K;Qt.x=T.x,Qt.y=T.y,Qt.z=W,C=Pt.solve33(K.neg(Qt))}else{var dt=p+_+y*b*b+h*S*S,ot=y*b+h*S,lt=y+h;lt==0&&(lt=1);var Pt=new xe;Pt.ex.setNum(dt,ot),Pt.ey.setNum(ot,lt);var he=Pt.solve(c.neg(T));C.x=he.x,C.y=he.y,C.z=0}var ke=c.combine(C.x,g,C.z,f),Le=C.x*b+C.y+C.z*v,ze=C.x*S+C.y+C.z*w;return s.subMul(p,ke),r-=y*Le,n.addMul(_,ke),o+=h*ze,this.m_bodyA.c_position.c=s,this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c=n,this.m_bodyB.c_position.a=o,P<=I.linearSlop&&E<=I.angularSlop},t.TYPE="prismatic-joint",t})(kt),xh={ratio:1},$o=(function(i){zt(t,i);function t(e,s,r,n,o,a){var l=this;if(!(l instanceof t))return new t(e,s,r,n,o,a);e=Xt(e,xh),l=i.call(this,e,s,r)||this,s=l.m_bodyA,r=l.m_bodyB,l.m_type=t.TYPE,l.m_joint1=n||e.joint1,l.m_joint2=o||e.joint2,l.m_ratio=Number.isFinite(a)?a:e.ratio,l.m_type1=l.m_joint1.getType(),l.m_type2=l.m_joint2.getType();var p,_;l.m_bodyC=l.m_joint1.getBodyA(),l.m_bodyA=l.m_joint1.getBodyB();var y=l.m_bodyA.m_xf,h=l.m_bodyA.m_sweep.a,m=l.m_bodyC.m_xf,u=l.m_bodyC.m_sweep.a;if(l.m_type1===ei.TYPE){var d=l.m_joint1;l.m_localAnchorC=d.m_localAnchorA,l.m_localAnchorA=d.m_localAnchorB,l.m_referenceAngleA=d.m_referenceAngle,l.m_localAxisC=c.zero(),p=h-u-l.m_referenceAngleA}else{var f=l.m_joint1;l.m_localAnchorC=f.m_localAnchorA,l.m_localAnchorA=f.m_localAnchorB,l.m_referenceAngleA=f.m_referenceAngle,l.m_localAxisC=f.m_localXAxisA;var v=l.m_localAnchorC,w=B.mulTVec2(m.q,c.add(B.mulVec2(y.q,l.m_localAnchorA),c.sub(y.p,m.p)));p=c.dot(w,l.m_localAxisC)-c.dot(v,l.m_localAxisC)}l.m_bodyD=l.m_joint2.getBodyA(),l.m_bodyB=l.m_joint2.getBodyB();var g=l.m_bodyB.m_xf,b=l.m_bodyB.m_sweep.a,S=l.m_bodyD.m_xf,C=l.m_bodyD.m_sweep.a;if(l.m_type2===ei.TYPE){var d=l.m_joint2;l.m_localAnchorD=d.m_localAnchorA,l.m_localAnchorB=d.m_localAnchorB,l.m_referenceAngleB=d.m_referenceAngle,l.m_localAxisD=c.zero(),_=b-C-l.m_referenceAngleB}else{var f=l.m_joint2;l.m_localAnchorD=f.m_localAnchorA,l.m_localAnchorB=f.m_localAnchorB,l.m_referenceAngleB=f.m_referenceAngle,l.m_localAxisD=f.m_localXAxisA;var T=l.m_localAnchorD,P=B.mulTVec2(S.q,c.add(B.mulVec2(g.q,l.m_localAnchorB),c.sub(g.p,S.p)));_=c.dot(P,l.m_localAxisD)-c.dot(T,l.m_localAxisD)}return l.m_constant=p+l.m_ratio*_,l.m_impulse=0,l}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,joint1:this.m_joint1,joint2:this.m_joint2,ratio:this.m_ratio}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s),e.joint1=r(kt,e.joint1,s),e.joint2=r(kt,e.joint2,s);var n=new t(e);return n},t.prototype._reset=function(e){Number.isFinite(e.ratio)&&(this.m_ratio=e.ratio)},t.prototype.getJoint1=function(){return this.m_joint1},t.prototype.getJoint2=function(){return this.m_joint2},t.prototype.setRatio=function(e){this.m_ratio=e},t.prototype.getRatio=function(){return this.m_ratio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.mulNumVec2(this.m_impulse,this.m_JvAC).mul(e)},t.prototype.getReactionTorque=function(e){var s=this.m_impulse*this.m_JwA;return e*s},t.prototype.initVelocityConstraints=function(e){this.m_lcA=this.m_bodyA.m_sweep.localCenter,this.m_lcB=this.m_bodyB.m_sweep.localCenter,this.m_lcC=this.m_bodyC.m_sweep.localCenter,this.m_lcD=this.m_bodyD.m_sweep.localCenter,this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=this.m_bodyC.c_position.a,_=this.m_bodyC.c_velocity.v,y=this.m_bodyC.c_velocity.w,h=this.m_bodyD.c_position.a,m=this.m_bodyD.c_velocity.v,u=this.m_bodyD.c_velocity.w,d=B.neo(s),f=B.neo(o),v=B.neo(p),w=B.neo(h);if(this.m_mass=0,this.m_type1==ei.TYPE)this.m_JvAC=c.zero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var g=B.mulVec2(v,this.m_localAxisC),b=B.mulSub(v,this.m_localAnchorC,this.m_lcC),S=B.mulSub(d,this.m_localAnchorA,this.m_lcA);this.m_JvAC=g,this.m_JwC=c.crossVec2Vec2(b,g),this.m_JwA=c.crossVec2Vec2(S,g),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_type2==ei.TYPE)this.m_JvBD=c.zero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var g=B.mulVec2(w,this.m_localAxisD),C=B.mulSub(w,this.m_localAnchorD,this.m_lcD),T=B.mulSub(f,this.m_localAnchorB,this.m_lcB);this.m_JvBD=c.mulNumVec2(this.m_ratio,g),this.m_JwD=this.m_ratio*c.crossVec2Vec2(C,g),this.m_JwB=this.m_ratio*c.crossVec2Vec2(T,g),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.warmStarting?(r.addMul(this.m_mA*this.m_impulse,this.m_JvAC),n+=this.m_iA*this.m_impulse*this.m_JwA,a.addMul(this.m_mB*this.m_impulse,this.m_JvBD),l+=this.m_iB*this.m_impulse*this.m_JwB,_.subMul(this.m_mC*this.m_impulse,this.m_JvAC),y-=this.m_iC*this.m_impulse*this.m_JwC,m.subMul(this.m_mD*this.m_impulse,this.m_JvBD),u-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,this.m_bodyA.c_velocity.v.setVec2(r),this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v.setVec2(a),this.m_bodyB.c_velocity.w=l,this.m_bodyC.c_velocity.v.setVec2(_),this.m_bodyC.c_velocity.w=y,this.m_bodyD.c_velocity.v.setVec2(m),this.m_bodyD.c_velocity.w=u},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=this.m_bodyC.c_velocity.v,l=this.m_bodyC.c_velocity.w,p=this.m_bodyD.c_velocity.v,_=this.m_bodyD.c_velocity.w,y=c.dot(this.m_JvAC,s)-c.dot(this.m_JvAC,a)+c.dot(this.m_JvBD,n)-c.dot(this.m_JvBD,p);y+=this.m_JwA*r-this.m_JwC*l+(this.m_JwB*o-this.m_JwD*_);var h=-this.m_mass*y;this.m_impulse+=h,s.addMul(this.m_mA*h,this.m_JvAC),r+=this.m_iA*h*this.m_JwA,n.addMul(this.m_mB*h,this.m_JvBD),o+=this.m_iB*h*this.m_JwB,a.subMul(this.m_mC*h,this.m_JvAC),l-=this.m_iC*h*this.m_JwC,p.subMul(this.m_mD*h,this.m_JvBD),_-=this.m_iD*h*this.m_JwD,this.m_bodyA.c_velocity.v.setVec2(s),this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v.setVec2(n),this.m_bodyB.c_velocity.w=o,this.m_bodyC.c_velocity.v.setVec2(a),this.m_bodyC.c_velocity.w=l,this.m_bodyD.c_velocity.v.setVec2(p),this.m_bodyD.c_velocity.w=_},t.prototype.solvePositionConstraints=function(e){var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=this.m_bodyC.c_position.c,l=this.m_bodyC.c_position.a,p=this.m_bodyD.c_position.c,_=this.m_bodyD.c_position.a,y=B.neo(r),h=B.neo(o),m=B.neo(l),u=B.neo(_),d=0,f,v,w,g,b,S,C,T,P=0;if(this.m_type1==ei.TYPE)w=c.zero(),b=1,C=1,P+=this.m_iA+this.m_iC,f=r-l-this.m_referenceAngleA;else{var E=B.mulVec2(m,this.m_localAxisC),z=B.mulSub(m,this.m_localAnchorC,this.m_lcC),H=B.mulSub(y,this.m_localAnchorA,this.m_lcA);w=E,C=c.crossVec2Vec2(z,E),b=c.crossVec2Vec2(H,E),P+=this.m_mC+this.m_mA+this.m_iC*C*C+this.m_iA*b*b;var Y=c.sub(this.m_localAnchorC,this.m_lcC),W=B.mulTVec2(m,c.add(H,c.sub(s,a)));f=c.dot(c.sub(W,Y),this.m_localAxisC)}if(this.m_type2==ei.TYPE)g=c.zero(),S=this.m_ratio,T=this.m_ratio,P+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),v=o-_-this.m_referenceAngleB;else{var E=B.mulVec2(u,this.m_localAxisD),j=B.mulSub(u,this.m_localAnchorD,this.m_lcD),dt=B.mulSub(h,this.m_localAnchorB,this.m_lcB);g=c.mulNumVec2(this.m_ratio,E),T=this.m_ratio*c.crossVec2Vec2(j,E),S=this.m_ratio*c.crossVec2Vec2(dt,E),P+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*T*T+this.m_iB*S*S;var ot=c.sub(this.m_localAnchorD,this.m_lcD),At=B.mulTVec2(u,c.add(dt,c.sub(n,p)));v=c.dot(At,this.m_localAxisD)-c.dot(ot,this.m_localAxisD)}var lt=f+this.m_ratio*v-this.m_constant,rt=0;return P>0&&(rt=-lt/P),s.addMul(this.m_mA*rt,w),r+=this.m_iA*rt*b,n.addMul(this.m_mB*rt,g),o+=this.m_iB*rt*S,a.subMul(this.m_mC*rt,w),l-=this.m_iC*rt*C,p.subMul(this.m_mD*rt,g),_-=this.m_iD*rt*T,this.m_bodyA.c_position.c.setVec2(s),this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c.setVec2(n),this.m_bodyB.c_position.a=o,this.m_bodyC.c_position.c.setVec2(a),this.m_bodyC.c_position.a=l,this.m_bodyD.c_position.c.setVec2(p),this.m_bodyD.c_position.a=_,d<I.linearSlop},t.TYPE="gear-joint",t})(kt),wh={maxForce:1,maxTorque:1,correctionFactor:.3},Ho=(function(i){zt(t,i);function t(e,s,r){var n=this;return n instanceof t?(e=Xt(e,wh),n=i.call(this,e,s,r)||this,s=n.m_bodyA,r=n.m_bodyB,n.m_type=t.TYPE,n.m_linearOffset=c.isValid(e.linearOffset)?c.clone(e.linearOffset):s.getLocalPoint(r.getPosition()),n.m_angularOffset=Number.isFinite(e.angularOffset)?e.angularOffset:r.getAngle()-s.getAngle(),n.m_linearImpulse=c.zero(),n.m_angularImpulse=0,n.m_maxForce=e.maxForce,n.m_maxTorque=e.maxTorque,n.m_correctionFactor=e.correctionFactor,n):new t(e,s,r)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,correctionFactor:this.m_correctionFactor,linearOffset:this.m_linearOffset,angularOffset:this.m_angularOffset}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){Number.isFinite(e.angularOffset)&&(this.m_angularOffset=e.angularOffset),Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.maxTorque)&&(this.m_maxTorque=e.maxTorque),Number.isFinite(e.correctionFactor)&&(this.m_correctionFactor=e.correctionFactor),c.isValid(e.linearOffset)&&this.m_linearOffset.set(e.linearOffset)},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setMaxTorque=function(e){this.m_maxTorque=e},t.prototype.getMaxTorque=function(){return this.m_maxTorque},t.prototype.setCorrectionFactor=function(e){this.m_correctionFactor=e},t.prototype.getCorrectionFactor=function(){return this.m_correctionFactor},t.prototype.setLinearOffset=function(e){(e.x!=this.m_linearOffset.x||e.y!=this.m_linearOffset.y)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_linearOffset.set(e))},t.prototype.getLinearOffset=function(){return this.m_linearOffset},t.prototype.setAngularOffset=function(e){e!=this.m_angularOffset&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_angularOffset=e)},t.prototype.getAngularOffset=function(){return this.m_angularOffset},t.prototype.getAnchorA=function(){return this.m_bodyA.getPosition()},t.prototype.getAnchorB=function(){return this.m_bodyB.getPosition()},t.prototype.getReactionForce=function(e){return c.mulNumVec2(e,this.m_linearImpulse)},t.prototype.getReactionTorque=function(e){return e*this.m_angularImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,l=this.m_bodyB.c_position.a,p=this.m_bodyB.c_velocity.v,_=this.m_bodyB.c_velocity.w,y=B.neo(r),h=B.neo(l);this.m_rA=B.mulVec2(y,c.sub(this.m_linearOffset,this.m_localCenterA)),this.m_rB=B.mulVec2(h,c.neg(this.m_localCenterB));var m=this.m_invMassA,u=this.m_invMassB,d=this.m_invIA,f=this.m_invIB,v=new xe;if(v.ex.x=m+u+d*this.m_rA.y*this.m_rA.y+f*this.m_rB.y*this.m_rB.y,v.ex.y=-d*this.m_rA.x*this.m_rA.y-f*this.m_rB.x*this.m_rB.y,v.ey.x=v.ex.y,v.ey.y=m+u+d*this.m_rA.x*this.m_rA.x+f*this.m_rB.x*this.m_rB.x,this.m_linearMass=v.getInverse(),this.m_angularMass=d+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),this.m_linearError=c.zero(),this.m_linearError.addCombine(1,a,1,this.m_rB),this.m_linearError.subCombine(1,s,1,this.m_rA),this.m_angularError=l-r-this.m_angularOffset,e.warmStarting){this.m_linearImpulse.mul(e.dtRatio),this.m_angularImpulse*=e.dtRatio;var w=c.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);n.subMul(m,w),o-=d*(c.crossVec2Vec2(this.m_rA,w)+this.m_angularImpulse),p.addMul(u,w),_+=f*(c.crossVec2Vec2(this.m_rB,w)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=n,this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v=p,this.m_bodyB.c_velocity.w=_},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=this.m_invMassA,l=this.m_invMassB,p=this.m_invIA,_=this.m_invIB,y=e.dt,h=e.inv_dt;{var m=o-r+h*this.m_correctionFactor*this.m_angularError,u=-this.m_angularMass*m,d=this.m_angularImpulse,f=y*this.m_maxTorque;this.m_angularImpulse=Mt(this.m_angularImpulse+u,-f,f),u=this.m_angularImpulse-d,r-=p*u,o+=_*u}{var m=c.zero();m.addCombine(1,n,1,c.crossNumVec2(o,this.m_rB)),m.subCombine(1,s,1,c.crossNumVec2(r,this.m_rA)),m.addMul(h*this.m_correctionFactor,this.m_linearError);var u=c.neg(xe.mulVec2(this.m_linearMass,m)),d=c.clone(this.m_linearImpulse);this.m_linearImpulse.add(u);var f=y*this.m_maxForce;this.m_linearImpulse.clamp(f),u=c.sub(this.m_linearImpulse,d),s.subMul(a,u),r-=p*c.crossVec2Vec2(this.m_rA,u),n.addMul(l,u),o+=_*c.crossVec2Vec2(this.m_rB,u)}this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="motor-joint",t})(kt),bh=Math.PI,Ah={maxForce:0,frequencyHz:5,dampingRatio:.7},Uo=(function(i){zt(t,i);function t(e,s,r,n){var o=this;return o instanceof t?(e=Xt(e,Ah),o=i.call(this,e,s,r)||this,s=o.m_bodyA,r=o.m_bodyB,o.m_type=t.TYPE,c.isValid(n)?o.m_targetA=c.clone(n):c.isValid(e.target)?o.m_targetA=c.clone(e.target):o.m_targetA=c.zero(),o.m_localAnchorB=ge.mulTVec2(r.getTransform(),o.m_targetA),o.m_maxForce=e.maxForce,o.m_impulse=c.zero(),o.m_frequencyHz=e.frequencyHz,o.m_dampingRatio=e.dampingRatio,o.m_beta=0,o.m_gamma=0,o.m_rB=c.zero(),o.m_localCenterB=c.zero(),o.m_invMassB=0,o.m_invIB=0,o.m_mass=new xe,o.m_C=c.zero(),o):new t(e,s,r,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,target:this.m_targetA,maxForce:this.m_maxForce,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,_localAnchorB:this.m_localAnchorB}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s),e.target=c.clone(e.target);var n=new t(e);return e._localAnchorB&&(n.m_localAnchorB=e._localAnchorB),n},t.prototype._reset=function(e){Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.setTarget=function(e){c.areEqual(e,this.m_targetA)||(this.m_bodyB.setAwake(!0),this.m_targetA.set(e))},t.prototype.getTarget=function(){return this.m_targetA},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return c.clone(this.m_targetA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.mulNumVec2(e,this.m_impulse)},t.prototype.getReactionTorque=function(e){return e*0},t.prototype.shiftOrigin=function(e){this.m_targetA.sub(e)},t.prototype.initVelocityConstraints=function(e){this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyB.c_position,r=this.m_bodyB.c_velocity,n=s.c,o=s.a,a=r.v,l=r.w,p=B.neo(o),_=this.m_bodyB.getMass(),y=2*bh*this.m_frequencyHz,h=2*_*this.m_dampingRatio*y,m=_*(y*y),u=e.dt;this.m_gamma=u*(h+u*m),this.m_gamma!=0&&(this.m_gamma=1/this.m_gamma),this.m_beta=u*m*this.m_gamma,this.m_rB=B.mulVec2(p,c.sub(this.m_localAnchorB,this.m_localCenterB));var d=new xe;d.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,d.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,d.ey.x=d.ex.y,d.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,this.m_mass=d.getInverse(),this.m_C.setVec2(n),this.m_C.addCombine(1,this.m_rB,-1,this.m_targetA),this.m_C.mul(this.m_beta),l*=.98,e.warmStarting?(this.m_impulse.mul(e.dtRatio),a.addMul(this.m_invMassB,this.m_impulse),l+=this.m_invIB*c.crossVec2Vec2(this.m_rB,this.m_impulse)):this.m_impulse.setZero(),r.v.setVec2(a),r.w=l},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyB.c_velocity,r=c.clone(s.v),n=s.w,o=c.crossNumVec2(n,this.m_rB);o.add(r),o.addCombine(1,this.m_C,this.m_gamma,this.m_impulse),o.neg();var a=xe.mulVec2(this.m_mass,o),l=c.clone(this.m_impulse);this.m_impulse.add(a);var p=e.dt*this.m_maxForce;this.m_impulse.clamp(p),a=c.sub(this.m_impulse,l),r.addMul(this.m_invMassB,a),n+=this.m_invIB*c.crossVec2Vec2(this.m_rB,a),s.v.setVec2(r),s.w=n},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="mouse-joint",t})(kt),Bh=Math.abs,Sh={collideConnected:!0},Wo=(function(i){zt(t,i);function t(e,s,r,n,o,a,l,p){var _=this;return _ instanceof t?(e=Xt(e,Sh),_=i.call(this,e,s,r)||this,s=_.m_bodyA,r=_.m_bodyB,_.m_type=t.TYPE,_.m_groundAnchorA=c.clone(n||e.groundAnchorA||c.neo(-1,1)),_.m_groundAnchorB=c.clone(o||e.groundAnchorB||c.neo(1,1)),_.m_localAnchorA=c.clone(a?s.getLocalPoint(a):e.localAnchorA||c.neo(-1,0)),_.m_localAnchorB=c.clone(l?r.getLocalPoint(l):e.localAnchorB||c.neo(1,0)),_.m_lengthA=Number.isFinite(e.lengthA)?e.lengthA:c.distance(a,n),_.m_lengthB=Number.isFinite(e.lengthB)?e.lengthB:c.distance(l,o),_.m_ratio=Number.isFinite(p)?p:e.ratio,_.m_constant=_.m_lengthA+_.m_ratio*_.m_lengthB,_.m_impulse=0,_):new t(e,s,r,n,o,a,l,p)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,groundAnchorA:this.m_groundAnchorA,groundAnchorB:this.m_groundAnchorB,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,lengthA:this.m_lengthA,lengthB:this.m_lengthB,ratio:this.m_ratio}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){c.isValid(e.groundAnchorA)&&this.m_groundAnchorA.set(e.groundAnchorA),c.isValid(e.groundAnchorB)&&this.m_groundAnchorB.set(e.groundAnchorB),c.isValid(e.localAnchorA)?this.m_localAnchorA.set(e.localAnchorA):c.isValid(e.anchorA)&&this.m_localAnchorA.set(this.m_bodyA.getLocalPoint(e.anchorA)),c.isValid(e.localAnchorB)?this.m_localAnchorB.set(e.localAnchorB):c.isValid(e.anchorB)&&this.m_localAnchorB.set(this.m_bodyB.getLocalPoint(e.anchorB)),Number.isFinite(e.lengthA)&&(this.m_lengthA=e.lengthA),Number.isFinite(e.lengthB)&&(this.m_lengthB=e.lengthB),Number.isFinite(e.ratio)&&(this.m_ratio=e.ratio)},t.prototype.getGroundAnchorA=function(){return this.m_groundAnchorA},t.prototype.getGroundAnchorB=function(){return this.m_groundAnchorB},t.prototype.getLengthA=function(){return this.m_lengthA},t.prototype.getLengthB=function(){return this.m_lengthB},t.prototype.getRatio=function(){return this.m_ratio},t.prototype.getCurrentLengthA=function(){var e=this.m_bodyA.getWorldPoint(this.m_localAnchorA),s=this.m_groundAnchorA;return c.distance(e,s)},t.prototype.getCurrentLengthB=function(){var e=this.m_bodyB.getWorldPoint(this.m_localAnchorB),s=this.m_groundAnchorB;return c.distance(e,s)},t.prototype.shiftOrigin=function(e){this.m_groundAnchorA.sub(e),this.m_groundAnchorB.sub(e)},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.mulNumVec2(this.m_impulse,this.m_uB).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,l=this.m_bodyB.c_position.a,p=this.m_bodyB.c_velocity.v,_=this.m_bodyB.c_velocity.w,y=B.neo(r),h=B.neo(l);this.m_rA=B.mulVec2(y,c.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(h,c.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_uA=c.sub(c.add(s,this.m_rA),this.m_groundAnchorA),this.m_uB=c.sub(c.add(a,this.m_rB),this.m_groundAnchorB);var m=this.m_uA.length(),u=this.m_uB.length();m>10*I.linearSlop?this.m_uA.mul(1/m):this.m_uA.setZero(),u>10*I.linearSlop?this.m_uB.mul(1/u):this.m_uB.setZero();var d=c.crossVec2Vec2(this.m_rA,this.m_uA),f=c.crossVec2Vec2(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*d*d,w=this.m_invMassB+this.m_invIB*f*f;if(this.m_mass=v+this.m_ratio*this.m_ratio*w,this.m_mass>0&&(this.m_mass=1/this.m_mass),e.warmStarting){this.m_impulse*=e.dtRatio;var g=c.mulNumVec2(-this.m_impulse,this.m_uA),b=c.mulNumVec2(-this.m_ratio*this.m_impulse,this.m_uB);n.addMul(this.m_invMassA,g),o+=this.m_invIA*c.crossVec2Vec2(this.m_rA,g),p.addMul(this.m_invMassB,b),_+=this.m_invIB*c.crossVec2Vec2(this.m_rB,b)}else this.m_impulse=0;this.m_bodyA.c_velocity.v=n,this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v=p,this.m_bodyB.c_velocity.w=_},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=c.add(s,c.crossNumVec2(r,this.m_rA)),l=c.add(n,c.crossNumVec2(o,this.m_rB)),p=-c.dot(this.m_uA,a)-this.m_ratio*c.dot(this.m_uB,l),_=-this.m_mass*p;this.m_impulse+=_;var y=c.mulNumVec2(-_,this.m_uA),h=c.mulNumVec2(-this.m_ratio*_,this.m_uB);s.addMul(this.m_invMassA,y),r+=this.m_invIA*c.crossVec2Vec2(this.m_rA,y),n.addMul(this.m_invMassB,h),o+=this.m_invIB*c.crossVec2Vec2(this.m_rB,h),this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=B.neo(r),l=B.neo(o),p=B.mulVec2(a,c.sub(this.m_localAnchorA,this.m_localCenterA)),_=B.mulVec2(l,c.sub(this.m_localAnchorB,this.m_localCenterB)),y=c.sub(c.add(s,this.m_rA),this.m_groundAnchorA),h=c.sub(c.add(n,this.m_rB),this.m_groundAnchorB),m=y.length(),u=h.length();m>10*I.linearSlop?y.mul(1/m):y.setZero(),u>10*I.linearSlop?h.mul(1/u):h.setZero();var d=c.crossVec2Vec2(p,y),f=c.crossVec2Vec2(_,h),v=this.m_invMassA+this.m_invIA*d*d,w=this.m_invMassB+this.m_invIB*f*f,g=v+this.m_ratio*this.m_ratio*w;g>0&&(g=1/g);var b=this.m_constant-m-this.m_ratio*u,S=Bh(b),C=-g*b,T=c.mulNumVec2(-C,y),P=c.mulNumVec2(-this.m_ratio*C,h);return s.addMul(this.m_invMassA,T),r+=this.m_invIA*c.crossVec2Vec2(p,T),n.addMul(this.m_invMassB,P),o+=this.m_invIB*c.crossVec2Vec2(_,P),this.m_bodyA.c_position.c=s,this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c=n,this.m_bodyB.c_position.a=o,S<I.linearSlop},t.TYPE="pulley-joint",t})(kt),Ch=Math.min,ws;(function(i){i[i.inactiveLimit=0]="inactiveLimit",i[i.atLowerLimit=1]="atLowerLimit",i[i.atUpperLimit=2]="atUpperLimit",i[i.equalLimits=3]="equalLimits"})(ws||(ws={}));var Th={maxLength:0},Yo=(function(i){zt(t,i);function t(e,s,r,n){var o=this;return o instanceof t?(e=Xt(e,Th),o=i.call(this,e,s,r)||this,s=o.m_bodyA,r=o.m_bodyB,o.m_type=t.TYPE,o.m_localAnchorA=c.clone(n?s.getLocalPoint(n):e.localAnchorA||c.neo(-1,0)),o.m_localAnchorB=c.clone(n?r.getLocalPoint(n):e.localAnchorB||c.neo(1,0)),o.m_maxLength=e.maxLength,o.m_mass=0,o.m_impulse=0,o.m_length=0,o.m_state=ws.inactiveLimit,o):new t(e,s,r,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,maxLength:this.m_maxLength}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){Number.isFinite(e.maxLength)&&(this.m_maxLength=e.maxLength)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setMaxLength=function(e){this.m_maxLength=e},t.prototype.getMaxLength=function(){return this.m_maxLength},t.prototype.getLimitState=function(){return this.m_state},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.mulNumVec2(this.m_impulse,this.m_u).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,l=this.m_bodyB.c_position.a,p=this.m_bodyB.c_velocity.v,_=this.m_bodyB.c_velocity.w,y=B.neo(r),h=B.neo(l);this.m_rA=B.mulSub(y,this.m_localAnchorA,this.m_localCenterA),this.m_rB=B.mulSub(h,this.m_localAnchorB,this.m_localCenterB),this.m_u=c.zero(),this.m_u.addCombine(1,a,1,this.m_rB),this.m_u.subCombine(1,s,1,this.m_rA),this.m_length=this.m_u.length();var m=this.m_length-this.m_maxLength;if(m>0?this.m_state=ws.atUpperLimit:this.m_state=ws.inactiveLimit,this.m_length>I.linearSlop)this.m_u.mul(1/this.m_length);else{this.m_u.setZero(),this.m_mass=0,this.m_impulse=0;return}var u=c.crossVec2Vec2(this.m_rA,this.m_u),d=c.crossVec2Vec2(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*u*u+this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=f!=0?1/f:0,e.warmStarting){this.m_impulse*=e.dtRatio;var v=c.mulNumVec2(this.m_impulse,this.m_u);n.subMul(this.m_invMassA,v),o-=this.m_invIA*c.crossVec2Vec2(this.m_rA,v),p.addMul(this.m_invMassB,v),_+=this.m_invIB*c.crossVec2Vec2(this.m_rB,v)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(n),this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v.setVec2(p),this.m_bodyB.c_velocity.w=_},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=c.addCrossNumVec2(s,r,this.m_rA),l=c.addCrossNumVec2(n,o,this.m_rB),p=this.m_length-this.m_maxLength,_=c.dot(this.m_u,c.sub(l,a));p<0&&(_+=e.inv_dt*p);var y=-this.m_mass*_,h=this.m_impulse;this.m_impulse=Ch(0,this.m_impulse+y),y=this.m_impulse-h;var m=c.mulNumVec2(y,this.m_u);s.subMul(this.m_invMassA,m),r-=this.m_invIA*c.crossVec2Vec2(this.m_rA,m),n.addMul(this.m_invMassB,m),o+=this.m_invIB*c.crossVec2Vec2(this.m_rB,m),this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=B.neo(r),l=B.neo(o),p=B.mulSub(a,this.m_localAnchorA,this.m_localCenterA),_=B.mulSub(l,this.m_localAnchorB,this.m_localCenterB),y=c.zero();y.addCombine(1,n,1,_),y.subCombine(1,s,1,p);var h=y.normalize(),m=h-this.m_maxLength;m=Mt(m,0,I.maxLinearCorrection);var u=-this.m_mass*m,d=c.mulNumVec2(u,y);return s.subMul(this.m_invMassA,d),r-=this.m_invIA*c.crossVec2Vec2(p,d),n.addMul(this.m_invMassB,d),o+=this.m_invIB*c.crossVec2Vec2(_,d),this.m_bodyA.c_position.c.setVec2(s),this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c.setVec2(n),this.m_bodyB.c_position.a=o,h-this.m_maxLength<I.linearSlop},t.TYPE="rope-joint",t})(kt),Mh=Math.abs,Ph=Math.PI,Ih={frequencyHz:0,dampingRatio:0},jo=(function(i){zt(t,i);function t(e,s,r,n){var o=this;return o instanceof t?(e=Xt(e,Ih),o=i.call(this,e,s,r)||this,s=o.m_bodyA,r=o.m_bodyB,o.m_type=t.TYPE,o.m_localAnchorA=c.clone(n?s.getLocalPoint(n):e.localAnchorA||c.zero()),o.m_localAnchorB=c.clone(n?r.getLocalPoint(n):e.localAnchorB||c.zero()),o.m_referenceAngle=Number.isFinite(e.referenceAngle)?e.referenceAngle:r.getAngle()-s.getAngle(),o.m_frequencyHz=e.frequencyHz,o.m_dampingRatio=e.dampingRatio,o.m_impulse=new K,o.m_bias=0,o.m_gamma=0,o.m_mass=new ii,o):new t(e,s,r,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.neo(this.m_impulse.x,this.m_impulse.y).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.z},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=B.neo(s),_=B.neo(o);this.m_rA=B.mulVec2(p,c.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(_,c.sub(this.m_localAnchorB,this.m_localCenterB));var y=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,u=this.m_invIB,d=new ii;if(d.ex.x=y+h+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*u,d.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*u,d.ez.x=-this.m_rA.y*m-this.m_rB.y*u,d.ex.y=d.ey.x,d.ey.y=y+h+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*u,d.ez.y=this.m_rA.x*m+this.m_rB.x*u,d.ex.z=d.ez.x,d.ey.z=d.ez.y,d.ez.z=m+u,this.m_frequencyHz>0){d.getInverse22(this.m_mass);var f=m+u,v=f>0?1/f:0,w=o-s-this.m_referenceAngle,g=2*Ph*this.m_frequencyHz,b=2*v*this.m_dampingRatio*g,S=v*g*g,C=e.dt;this.m_gamma=C*(b+C*S),this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0,this.m_bias=w*C*S*this.m_gamma,f+=this.m_gamma,this.m_mass.ez.z=f!=0?1/f:0}else d.ez.z==0?(d.getInverse22(this.m_mass),this.m_gamma=0,this.m_bias=0):(d.getSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0);if(e.warmStarting){this.m_impulse.mul(e.dtRatio);var T=c.neo(this.m_impulse.x,this.m_impulse.y);r.subMul(y,T),n-=m*(c.crossVec2Vec2(this.m_rA,T)+this.m_impulse.z),a.addMul(h,T),l+=u*(c.crossVec2Vec2(this.m_rB,T)+this.m_impulse.z)}else this.m_impulse.setZero();this.m_bodyA.c_velocity.v=r,this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,a=this.m_invMassA,l=this.m_invMassB,p=this.m_invIA,_=this.m_invIB;if(this.m_frequencyHz>0){var y=o-r,h=-this.m_mass.ez.z*(y+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=h,r-=p*h,o+=_*h;var m=c.zero();m.addCombine(1,n,1,c.crossNumVec2(o,this.m_rB)),m.subCombine(1,s,1,c.crossNumVec2(r,this.m_rA));var u=c.neg(ii.mulVec2(this.m_mass,m));this.m_impulse.x+=u.x,this.m_impulse.y+=u.y;var d=c.clone(u);s.subMul(a,d),r-=p*c.crossVec2Vec2(this.m_rA,d),n.addMul(l,d),o+=_*c.crossVec2Vec2(this.m_rB,d)}else{var m=c.zero();m.addCombine(1,n,1,c.crossNumVec2(o,this.m_rB)),m.subCombine(1,s,1,c.crossNumVec2(r,this.m_rA));var y=o-r,f=new K(m.x,m.y,y),v=K.neg(ii.mulVec3(this.m_mass,f));this.m_impulse.add(v);var d=c.neo(v.x,v.y);s.subMul(a,d),r-=p*(c.crossVec2Vec2(this.m_rA,d)+v.z),n.addMul(l,d),o+=_*(c.crossVec2Vec2(this.m_rB,d)+v.z)}this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=o},t.prototype.solvePositionConstraints=function(e){var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=B.neo(r),l=B.neo(o),p=this.m_invMassA,_=this.m_invMassB,y=this.m_invIA,h=this.m_invIB,m=B.mulVec2(a,c.sub(this.m_localAnchorA,this.m_localCenterA)),u=B.mulVec2(l,c.sub(this.m_localAnchorB,this.m_localCenterB)),d,f,v=new ii;if(v.ex.x=p+_+m.y*m.y*y+u.y*u.y*h,v.ey.x=-m.y*m.x*y-u.y*u.x*h,v.ez.x=-m.y*y-u.y*h,v.ex.y=v.ey.x,v.ey.y=p+_+m.x*m.x*y+u.x*u.x*h,v.ez.y=m.x*y+u.x*h,v.ex.z=v.ez.x,v.ey.z=v.ez.y,v.ez.z=y+h,this.m_frequencyHz>0){var w=c.zero();w.addCombine(1,n,1,u),w.subCombine(1,s,1,m),d=w.length(),f=0;var g=c.neg(v.solve22(w));s.subMul(p,g),r-=y*c.crossVec2Vec2(m,g),n.addMul(_,g),o+=h*c.crossVec2Vec2(u,g)}else{var w=c.zero();w.addCombine(1,n,1,u),w.subCombine(1,s,1,m);var b=o-r-this.m_referenceAngle;d=w.length(),f=Mh(b);var S=new K(w.x,w.y,b),C=new K;if(v.ez.z>0)C=K.neg(v.solve33(S));else{var T=c.neg(v.solve22(w));C.set(T.x,T.y,0)}var g=c.neo(C.x,C.y);s.subMul(p,g),r-=y*(c.crossVec2Vec2(m,g)+C.z),n.addMul(_,g),o+=h*(c.crossVec2Vec2(u,g)+C.z)}return this.m_bodyA.c_position.c=s,this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c=n,this.m_bodyB.c_position.a=o,d<=I.linearSlop&&f<=I.angularSlop},t.TYPE="weld-joint",t})(kt),Eh=Math.abs,Vh=Math.PI,kh={enableMotor:!1,maxMotorTorque:0,motorSpeed:0,frequencyHz:2,dampingRatio:.7},Jo=(function(i){zt(t,i);function t(e,s,r,n,o){var a=this;return a instanceof t?(e=Xt(e,kh),a=i.call(this,e,s,r)||this,s=a.m_bodyA,r=a.m_bodyB,a.m_ax=c.zero(),a.m_ay=c.zero(),a.m_type=t.TYPE,a.m_localAnchorA=c.clone(n?s.getLocalPoint(n):e.localAnchorA||c.zero()),a.m_localAnchorB=c.clone(n?r.getLocalPoint(n):e.localAnchorB||c.zero()),c.isValid(o)?a.m_localXAxisA=s.getLocalVector(o):c.isValid(e.localAxisA)?a.m_localXAxisA=c.clone(e.localAxisA):c.isValid(e.localAxis)?a.m_localXAxisA=c.clone(e.localAxis):a.m_localXAxisA=c.neo(1,0),a.m_localYAxisA=c.crossNumVec2(1,a.m_localXAxisA),a.m_mass=0,a.m_impulse=0,a.m_motorMass=0,a.m_motorImpulse=0,a.m_springMass=0,a.m_springImpulse=0,a.m_maxMotorTorque=e.maxMotorTorque,a.m_motorSpeed=e.motorSpeed,a.m_enableMotor=e.enableMotor,a.m_frequencyHz=e.frequencyHz,a.m_dampingRatio=e.dampingRatio,a.m_bias=0,a.m_gamma=0,a):new t(e,s,r,n,o)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,enableMotor:this.m_enableMotor,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA}},t._deserialize=function(e,s,r){e=Lt({},e),e.bodyA=r(Q,e.bodyA,s),e.bodyB=r(Q,e.bodyB,s);var n=new t(e);return n},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.localAxisA&&(this.m_localXAxisA.setVec2(e.localAxisA),this.m_localYAxisA.setVec2(c.crossNumVec2(1,e.localAxisA))),e.enableMotor!==void 0&&(this.m_enableMotor=e.enableMotor),Number.isFinite(e.maxMotorTorque)&&(this.m_maxMotorTorque=e.maxMotorTorque),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getLocalAxisA=function(){return this.m_localXAxisA},t.prototype.getJointTranslation=function(){var e=this.m_bodyA,s=this.m_bodyB,r=e.getWorldPoint(this.m_localAnchorA),n=s.getWorldPoint(this.m_localAnchorB),o=c.sub(n,r),a=e.getWorldVector(this.m_localXAxisA),l=c.dot(o,a);return l},t.prototype.getJointSpeed=function(){var e=this.m_bodyA.m_angularVelocity,s=this.m_bodyB.m_angularVelocity;return s-e},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.setMaxMotorTorque=function(e){e!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=e)},t.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},t.prototype.getMotorTorque=function(e){return e*this.m_motorImpulse},t.prototype.setSpringFrequencyHz=function(e){this.m_frequencyHz=e},t.prototype.getSpringFrequencyHz=function(){return this.m_frequencyHz},t.prototype.setSpringDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getSpringDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return c.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_motorImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var s=this.m_invMassA,r=this.m_invMassB,n=this.m_invIA,o=this.m_invIB,a=this.m_bodyA.c_position.c,l=this.m_bodyA.c_position.a,p=this.m_bodyA.c_velocity.v,_=this.m_bodyA.c_velocity.w,y=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,u=this.m_bodyB.c_velocity.w,d=B.neo(l),f=B.neo(h),v=B.mulVec2(d,c.sub(this.m_localAnchorA,this.m_localCenterA)),w=B.mulVec2(f,c.sub(this.m_localAnchorB,this.m_localCenterB)),g=c.zero();if(g.addCombine(1,y,1,w),g.subCombine(1,a,1,v),this.m_ay=B.mulVec2(d,this.m_localYAxisA),this.m_sAy=c.crossVec2Vec2(c.add(g,v),this.m_ay),this.m_sBy=c.crossVec2Vec2(w,this.m_ay),this.m_mass=s+r+n*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){this.m_ax=B.mulVec2(d,this.m_localXAxisA),this.m_sAx=c.crossVec2Vec2(c.add(g,v),this.m_ax),this.m_sBx=c.crossVec2Vec2(w,this.m_ax);var b=s+r+n*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(b>0){this.m_springMass=1/b;var S=c.dot(g,this.m_ax),C=2*Vh*this.m_frequencyHz,T=2*this.m_springMass*this.m_dampingRatio*C,P=this.m_springMass*C*C,E=e.dt;this.m_gamma=E*(T+E*P),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=S*E*P*this.m_gamma,this.m_springMass=b+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=n+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),e.warmStarting){this.m_impulse*=e.dtRatio,this.m_springImpulse*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var z=c.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax),H=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,Y=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;p.subMul(this.m_invMassA,z),_-=this.m_invIA*H,m.addMul(this.m_invMassB,z),u+=this.m_invIB*Y}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(p),this.m_bodyA.c_velocity.w=_,this.m_bodyB.c_velocity.v.setVec2(m),this.m_bodyB.c_velocity.w=u},t.prototype.solveVelocityConstraints=function(e){var s=this.m_invMassA,r=this.m_invMassB,n=this.m_invIA,o=this.m_invIB,a=this.m_bodyA.c_velocity.v,l=this.m_bodyA.c_velocity.w,p=this.m_bodyB.c_velocity.v,_=this.m_bodyB.c_velocity.w;{var y=c.dot(this.m_ax,p)-c.dot(this.m_ax,a)+this.m_sBx*_-this.m_sAx*l,h=-this.m_springMass*(y+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=h;var m=c.mulNumVec2(h,this.m_ax),u=h*this.m_sAx,d=h*this.m_sBx;a.subMul(s,m),l-=n*u,p.addMul(r,m),_+=o*d}{var y=_-l-this.m_motorSpeed,h=-this.m_motorMass*y,f=this.m_motorImpulse,v=e.dt*this.m_maxMotorTorque;this.m_motorImpulse=Mt(this.m_motorImpulse+h,-v,v),h=this.m_motorImpulse-f,l-=n*h,_+=o*h}{var y=c.dot(this.m_ay,p)-c.dot(this.m_ay,a)+this.m_sBy*_-this.m_sAy*l,h=-this.m_mass*y;this.m_impulse+=h;var m=c.mulNumVec2(h,this.m_ay),u=h*this.m_sAy,d=h*this.m_sBy;a.subMul(s,m),l-=n*u,p.addMul(r,m),_+=o*d}this.m_bodyA.c_velocity.v.setVec2(a),this.m_bodyA.c_velocity.w=l,this.m_bodyB.c_velocity.v.setVec2(p),this.m_bodyB.c_velocity.w=_},t.prototype.solvePositionConstraints=function(e){var s=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,a=B.neo(r),l=B.neo(o),p=B.mulVec2(a,c.sub(this.m_localAnchorA,this.m_localCenterA)),_=B.mulVec2(l,c.sub(this.m_localAnchorB,this.m_localCenterB)),y=c.zero();y.addCombine(1,n,1,_),y.subCombine(1,s,1,p);var h=B.mulVec2(a,this.m_localYAxisA),m=c.crossVec2Vec2(c.add(y,p),h),u=c.crossVec2Vec2(_,h),d=c.dot(y,h),f=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy,v=f!=0?-d/f:0,w=c.mulNumVec2(v,h),g=v*m,b=v*u;return s.subMul(this.m_invMassA,w),r-=this.m_invIA*g,n.addMul(this.m_invMassB,w),o+=this.m_invIB*b,this.m_bodyA.c_position.c.setVec2(s),this.m_bodyA.c_position.a=r,this.m_bodyB.c_position.c.setVec2(n),this.m_bodyB.c_position.a=o,Eh(d)<=I.linearSlop},t.TYPE="wheel-joint",t})(kt),xt,Lh=0,Go={World:Ts,Body:Q,Joint:kt,Fixture:yr,Shape:Ti},Ko={Vec2:c,Vec3:K,World:Ts,Body:Q,Joint:kt,Fixture:yr,Shape:Ti},zh=(xt={},xt[Q.STATIC]=Q,xt[Q.DYNAMIC]=Q,xt[Q.KINEMATIC]=Q,xt[fr.TYPE]=fr,xt[ri.TYPE]=ri,xt[si.TYPE]=si,xt[Bi.TYPE]=Bi,xt[Do.TYPE]=Do,xt[Ro.TYPE]=Ro,xt[$o.TYPE]=$o,xt[Ho.TYPE]=Ho,xt[Uo.TYPE]=Uo,xt[Oo.TYPE]=Oo,xt[Wo.TYPE]=Wo,xt[ei.TYPE]=ei,xt[Yo.TYPE]=Yo,xt[jo.TYPE]=jo,xt[Jo.TYPE]=Jo,xt),Fh={rootClass:Ts,preSerialize:function(i){return i},postSerialize:function(i,t){return i},preDeserialize:function(i){return i},postDeserialize:function(i,t){return i}},Sn=(function(){function i(t){var e=this;this.toJson=function(s){var r=e.options.preSerialize,n=e.options.postSerialize,o=[],a=[s],l={};function p(u,d){if(u.__sid=u.__sid||++Lh,!l[u.__sid]){a.push(u);var f=o.length+a.length,v={refIndex:f,refType:d};l[u.__sid]=v}return l[u.__sid]}function _(u){u=r(u);var d=u._serialize();return d=n(d,u),d}function y(u,d){if(d===void 0&&(d=!1),typeof u!="object"||u===null)return u;if(typeof u._serialize=="function"){if(!d){for(var f in Go)if(u instanceof Go[f])return p(u,f)}u=_(u)}if(Array.isArray(u)){for(var v=[],w=0;w<u.length;w++)v[w]=y(u[w]);u=v}else{var v={};for(var w in u)u.hasOwnProperty(w)&&(v[w]=y(u[w]));u=v}return u}for(;a.length;){var h=a.shift(),m=y(h,!0);o.push(m)}return o},this.fromJson=function(s){var r=e.options.preDeserialize,n=e.options.postDeserialize,o=e.options.rootClass,a={};function l(y,h,m){(!y||!y._deserialize)&&(y=zh[h.type]);var u=y&&y._deserialize;if(u){h=r(h);var d=y._deserialize,f=d(h,m,p);return f=n(f,h),f}}function p(y,h,m){var u=h.refIndex&&h.refType;if(!u)return l(y,h,m);var d=h;Ko[d.refType]&&(y=Ko[d.refType]);var f=d.refIndex;if(!a[f]){var v=s[f],w=l(y,v,m);a[f]=w}return a[f]}var _=l(o,s[0],null);return _},this.options=Lt(Lt({},Fh),t)}return i})(),xc=new Sn({rootClass:Ts});Sn.fromJson=xc.fromJson;Sn.toJson=xc.toJson;(function(){function i(){}return i.mount=function(t){throw new Error("Not implemented")},i.start=function(t){var e=i.mount();return e.start(t),e},i})();var Xo=(function(i){zt(t,i);function t(e,s,r,n){var o=this;return o instanceof t?(o=i.call(this)||this,o._setAsBox(e,s,r,n),o):new t(e,s,r,n)}return t.TYPE="polygon",t})(ri);Ve.addType(Bi.TYPE,Bi.TYPE,Dh);function Dh(i,t,e,s,r,n,o){Rh(i,e.getShape(),t,n.getShape(),r)}var Qo=A(0,0),Zo=A(0,0),Rh=function(i,t,e,s,r){i.pointCount=0,D(Qo,e,t.m_p),D(Zo,r,s.m_p);var n=bi(Zo,Qo),o=t.m_radius,a=s.m_radius,l=o+a;n>l*l||(i.type=mt.e_circles,x(i.localPoint,t.m_p),k(i.localNormal),i.pointCount=1,x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(0,J.e_vertex,0,J.e_vertex))};Ve.addType(si.TYPE,Bi.TYPE,qh);Ve.addType(fr.TYPE,Bi.TYPE,Nh);function qh(i,t,e,s,r,n,o){var a=e.getShape(),l=n.getShape();wc(i,a,t,l,r)}function Nh(i,t,e,s,r,n,o){var a=e.getShape(),l=new si;a.getChildEdge(l,s);var p=l,_=n.getShape();wc(i,p,t,_,r)}var pi=A(0,0),Hr=A(0,0),Ur=A(0,0),He=A(0,0),di=A(0,0),Oi=A(0,0),wc=function(i,t,e,s,r){i.pointCount=0,lc(He,r,e,s.m_p);var n=t.m_vertex1,o=t.m_vertex2;R(pi,o,n);var a=M(pi,o)-M(pi,He),l=M(pi,He)-M(pi,n),p=t.m_radius+s.m_radius;if(l<=0){x(di,n);var _=bi(He,n);if(_>p*p)return;if(t.m_hasVertex0){var y=t.m_vertex0,h=n;R(Hr,h,y);var m=M(Hr,h)-M(Hr,He);if(m>0)return}i.type=mt.e_circles,k(i.localNormal),x(i.localPoint,di),i.pointCount=1,x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(0,J.e_vertex,0,J.e_vertex);return}if(a<=0){x(di,o);var u=bi(He,di);if(u>p*p)return;if(t.m_hasVertex3){var d=t.m_vertex3,f=o;R(Ur,d,f);var v=M(Ur,He)-M(Ur,f);if(v>0)return}i.type=mt.e_circles,k(i.localNormal),x(i.localPoint,di),i.pointCount=1,x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(1,J.e_vertex,0,J.e_vertex);return}var w=wi(pi);ct(di,a/w,n,l/w,o);var g=bi(He,di);g>p*p||(Jt(Oi,1,pi),M(Oi,He)-M(Oi,n)<0&&bs(Oi),ve(Oi),i.type=mt.e_faceA,x(i.localNormal,Oi),x(i.localPoint,n),i.pointCount=1,x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(0,J.e_face,0,J.e_vertex))},Qs=[new Kt,new Kt],Zs=[new Kt,new Kt],yi=[new Kt,new Kt],tr=A(0,0),ta=A(0,0),Wr=A(0,0),Yr=Ci(0,0,0),fi=A(0,0),$i=A(0,0),er=A(0,0),ea=A(0,0),ia=A(0,0),Qe=A(0,0),jr=A(0,0),sa=A(0,0);Ve.addType(ri.TYPE,ri.TYPE,Oh);function Oh(i,t,e,s,r,n,o){Hh(i,e.getShape(),t,n.getShape(),r)}function ra(i,t,e,s,r){var n=i.m_count,o=e.m_count,a=i.m_normals,l=i.m_vertices,p=e.m_vertices;hc(Yr,s,t);for(var _=0,y=-1/0,h=0;h<n;++h){ce(Wr,Yr.q,a[h]),D(ta,Yr,l[h]);for(var m=1/0,u=0;u<o;++u){var d=M(Wr,p[u])-M(Wr,ta);d<m&&(m=d)}m>y&&(y=m,_=h)}r.maxSeparation=y,r.bestIndex=_}function $h(i,t,e,s,r,n){var o=t.m_normals,a=r.m_count,l=r.m_vertices,p=r.m_normals;Hl(sa,n.q,e.q,o[s]);for(var _=0,y=1/0,h=0;h<a;++h){var m=M(sa,p[h]);m<y&&(y=m,_=h)}var u=_,d=u+1<a?u+1:0;D(i[0].v,n,l[u]),i[0].id.setFeatures(s,J.e_face,u,J.e_vertex),D(i[1].v,n,l[d]),i[1].id.setFeatures(s,J.e_face,d,J.e_vertex)}var Hi={maxSeparation:0,bestIndex:0},Hh=function(i,t,e,s,r){i.pointCount=0;var n=t.m_radius+s.m_radius;ra(t,e,s,r,Hi);var o=Hi.bestIndex,a=Hi.maxSeparation;if(!(a>n)){ra(s,r,t,e,Hi);var l=Hi.bestIndex,p=Hi.maxSeparation;if(!(p>n)){var _,y,h,m,u,d,f=.1*I.linearSlop;p>a+f?(_=s,y=t,h=r,m=e,u=l,i.type=mt.e_faceB,d=!0):(_=t,y=s,h=e,m=r,u=o,i.type=mt.e_faceA,d=!1),Qs[0].recycle(),Qs[1].recycle(),$h(Qs,_,h,u,y,m);var v=_.m_count,w=_.m_vertices,g=u,b=u+1<v?u+1:0;x(fi,w[g]),x($i,w[b]),R(er,$i,fi),ve(er),xi(ea,er,1),ct(ia,.5,fi,.5,$i),ce(Qe,h.q,er),xi(jr,Qe,1),D(fi,h,fi),D($i,h,$i);var S=M(jr,fi),C=-M(Qe,fi)+n,T=M(Qe,$i)+n;Zs[0].recycle(),Zs[1].recycle(),yi[0].recycle(),yi[1].recycle(),Tt(tr,-Qe.x,-Qe.y);var P=As(Zs,Qs,tr,C,g);if(!(P<2)){Tt(tr,Qe.x,Qe.y);var E=As(yi,Zs,tr,T,b);if(!(E<2)){x(i.localNormal,ea),x(i.localPoint,ia);for(var z=0,H=0;H<yi.length;++H){var Y=M(jr,yi[H].v)-S;if(Y<=n){var W=i.points[z];gn(W.localPoint,m,yi[H].v),W.id.set(yi[H].id),d&&W.id.swapFeatures(),++z}}i.pointCount=z}}}}};Ve.addType(ri.TYPE,Bi.TYPE,Uh);function Uh(i,t,e,s,r,n,o){Wh(i,e.getShape(),t,n.getShape(),r)}var de=A(0,0),Jr=A(0,0),Wh=function(i,t,e,s,r){i.pointCount=0,lc(de,r,e,s.m_p);for(var n=0,o=-1/0,a=t.m_radius+s.m_radius,l=t.m_count,p=t.m_vertices,_=t.m_normals,y=0;y<l;++y){var h=M(_[y],de)-M(_[y],p[y]);if(h>a)return;h>o&&(o=h,n=y)}var m=n,u=m+1<l?m+1:0,d=p[m],f=p[u];if(o<qt){i.pointCount=1,i.type=mt.e_faceA,x(i.localNormal,_[n]),ct(i.localPoint,.5,d,.5,f),x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(0,J.e_vertex,0,J.e_vertex);return}var v=M(de,f)-M(de,d)-M(d,f)+M(d,d),w=M(de,d)-M(de,f)-M(f,d)+M(f,f);if(v<=0){if(bi(de,d)>a*a)return;i.pointCount=1,i.type=mt.e_faceA,R(i.localNormal,de,d),ve(i.localNormal),x(i.localPoint,d),x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(0,J.e_vertex,0,J.e_vertex)}else if(w<=0){if(bi(de,f)>a*a)return;i.pointCount=1,i.type=mt.e_faceA,R(i.localNormal,de,f),ve(i.localNormal),x(i.localPoint,f),x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(0,J.e_vertex,0,J.e_vertex)}else{ct(Jr,.5,d,.5,f);var g=M(de,_[m])-M(Jr,_[m]);if(g>a)return;i.pointCount=1,i.type=mt.e_faceA,x(i.localNormal,_[m]),x(i.localPoint,Jr),x(i.points[0].localPoint,s.m_p),i.points[0].id.setFeatures(0,J.e_vertex,0,J.e_vertex)}},Yh=Math.min;Ve.addType(si.TYPE,ri.TYPE,jh);Ve.addType(fr.TYPE,ri.TYPE,Jh);function jh(i,t,e,s,r,n,o){Ac(i,e.getShape(),t,n.getShape(),r)}var na=new si;function Jh(i,t,e,s,r,n,o){var a=e.getShape();a.getChildEdge(na,s),Ac(i,na,t,n.getShape(),r)}var re;(function(i){i[i.e_unknown=-1]="e_unknown",i[i.e_edgeA=1]="e_edgeA",i[i.e_edgeB=2]="e_edgeB"})(re||(re={}));var oa;(function(i){i[i.e_isolated=0]="e_isolated",i[i.e_concave=1]="e_concave",i[i.e_convex=2]="e_convex"})(oa||(oa={}));var bc=(function(){function i(){}return i})(),Gh=(function(){function i(){this.vertices=[],this.normals=[],this.count=0;for(var t=0;t<I.maxPolygonVertices;t++)this.vertices.push(A(0,0)),this.normals.push(A(0,0))}return i})(),Kh=(function(){function i(){this.v1=A(0,0),this.v2=A(0,0),this.normal=A(0,0),this.sideNormal1=A(0,0),this.sideNormal2=A(0,0)}return i.prototype.recycle=function(){k(this.v1),k(this.v2),k(this.normal),k(this.sideNormal1),k(this.sideNormal2)},i})(),ir=[new Kt,new Kt],Ze=[new Kt,new Kt],ye=[new Kt,new Kt],Ce=new bc,Ft=new bc,Bt=new Gh,N=new Kh,sr=A(0,0),_s=A(0,0),Ui=A(0,0),ps=A(0,0),ds=Ci(0,0,0),st=A(0,0),Te=A(0,0),F=A(0,0),Me=A(0,0),wt=A(0,0),bt=A(0,0),aa=A(0,0),ti=A(0,0),Ac=function(i,t,e,s,r){hc(ds,e,r),D(sr,ds,s.m_centroid);var n=t.m_vertex0,o=t.m_vertex1,a=t.m_vertex2,l=t.m_vertex3,p=t.m_hasVertex0,_=t.m_hasVertex3;R(Ui,a,o),ve(Ui),Tt(F,Ui.y,-Ui.x);var y=M(F,sr)-M(F,o),h=0,m=0,u=!1,d=!1;k(Te),k(Me),p&&(R(_s,o,n),ve(_s),Tt(Te,_s.y,-_s.x),u=$(_s,Ui)>=0,h=c.dot(Te,sr)-c.dot(Te,n)),_&&(R(ps,l,a),ve(ps),Tt(Me,ps.y,-ps.x),d=c.crossVec2Vec2(Ui,ps)>0,m=c.dot(Me,sr)-c.dot(Me,a));var f;k(st),k(wt),k(bt),p&&_?u&&d?(f=h>=0||y>=0||m>=0,f?(x(st,F),x(wt,Te),x(bt,Me)):(L(st,-1,F),L(wt,-1,F),L(bt,-1,F))):u?(f=h>=0||y>=0&&m>=0,f?(x(st,F),x(wt,Te),x(bt,F)):(L(st,-1,F),L(wt,-1,Me),L(bt,-1,F))):d?(f=m>=0||h>=0&&y>=0,f?(x(st,F),x(wt,F),x(bt,Me)):(L(st,-1,F),L(wt,-1,F),L(bt,-1,Te))):(f=h>=0&&y>=0&&m>=0,f?(x(st,F),x(wt,F),x(bt,F)):(L(st,-1,F),L(wt,-1,Me),L(bt,-1,Te))):p?u?(f=h>=0||y>=0,f?(x(st,F),x(wt,Te),L(bt,-1,F)):(L(st,-1,F),x(wt,F),L(bt,-1,F))):(f=h>=0&&y>=0,f?(x(st,F),x(wt,F),L(bt,-1,F)):(L(st,-1,F),x(wt,F),L(bt,-1,Te))):_?d?(f=y>=0||m>=0,f?(x(st,F),L(wt,-1,F),x(bt,Me)):(L(st,-1,F),L(wt,-1,F),x(bt,F))):(f=y>=0&&m>=0,f?(x(st,F),L(wt,-1,F),x(bt,F)):(L(st,-1,F),L(wt,-1,Me),x(bt,F))):(f=y>=0,f?(x(st,F),L(wt,-1,F),L(bt,-1,F)):(L(st,-1,F),x(wt,F),x(bt,F))),Bt.count=s.m_count;for(var v=0;v<s.m_count;++v)D(Bt.vertices[v],ds,s.m_vertices[v]),ce(Bt.normals[v],ds.q,s.m_normals[v]);var w=s.m_radius+t.m_radius;i.pointCount=0;{Ce.type=re.e_edgeA,Ce.index=f?0:1,Ce.separation=1/0;for(var v=0;v<Bt.count;++v){var g=Bt.vertices[v],b=M(st,g)-M(st,o);b<Ce.separation&&(Ce.separation=b)}}if(Ce.type!=re.e_unknown&&!(Ce.separation>w)){{Ft.type=re.e_unknown,Ft.index=-1,Ft.separation=-1/0,Tt(aa,-st.y,st.x);for(var v=0;v<Bt.count;++v){L(ti,-1,Bt.normals[v]);var S=M(ti,Bt.vertices[v])-M(ti,o),C=M(ti,Bt.vertices[v])-M(ti,a),b=Yh(S,C);if(b>w){Ft.type=re.e_edgeB,Ft.index=v,Ft.separation=b;break}if(M(ti,aa)>=0){if(M(ti,st)-M(bt,st)<-I.angularSlop)continue}else if(M(ti,st)-M(wt,st)<-I.angularSlop)continue;b>Ft.separation&&(Ft.type=re.e_edgeB,Ft.index=v,Ft.separation=b)}}if(!(Ft.type!=re.e_unknown&&Ft.separation>w)){var T=.98,P=.001,E;if(Ft.type==re.e_unknown?E=Ce:Ft.separation>T*Ce.separation+P?E=Ft:E=Ce,ye[0].recycle(),ye[1].recycle(),E.type==re.e_edgeA){i.type=mt.e_faceA;for(var z=0,H=M(st,Bt.normals[0]),v=1;v<Bt.count;++v){var Y=M(st,Bt.normals[v]);Y<H&&(H=Y,z=v)}var W=z,j=W+1<Bt.count?W+1:0;x(ye[0].v,Bt.vertices[W]),ye[0].id.setFeatures(0,J.e_face,W,J.e_vertex),x(ye[1].v,Bt.vertices[j]),ye[1].id.setFeatures(0,J.e_face,j,J.e_vertex),f?(N.i1=0,N.i2=1,x(N.v1,o),x(N.v2,a),x(N.normal,F)):(N.i1=1,N.i2=0,x(N.v1,a),x(N.v2,o),L(N.normal,-1,F))}else i.type=mt.e_faceB,x(ye[0].v,o),ye[0].id.setFeatures(0,J.e_vertex,E.index,J.e_face),x(ye[1].v,a),ye[1].id.setFeatures(0,J.e_vertex,E.index,J.e_face),N.i1=E.index,N.i2=N.i1+1<Bt.count?N.i1+1:0,x(N.v1,Bt.vertices[N.i1]),x(N.v2,Bt.vertices[N.i2]),x(N.normal,Bt.normals[N.i1]);Tt(N.sideNormal1,N.normal.y,-N.normal.x),Tt(N.sideNormal2,-N.sideNormal1.x,-N.sideNormal1.y),N.sideOffset1=M(N.sideNormal1,N.v1),N.sideOffset2=M(N.sideNormal2,N.v2),ir[0].recycle(),ir[1].recycle(),Ze[0].recycle(),Ze[1].recycle();var dt=As(ir,ye,N.sideNormal1,N.sideOffset1,N.i1);if(!(dt<I.maxManifoldPoints)){var ot=As(Ze,ir,N.sideNormal2,N.sideOffset2,N.i2);if(!(ot<I.maxManifoldPoints)){E.type==re.e_edgeA?(x(i.localNormal,N.normal),x(i.localPoint,N.v1)):(x(i.localNormal,s.m_normals[N.i1]),x(i.localPoint,s.m_vertices[N.i1]));for(var At=0,v=0;v<I.maxManifoldPoints;++v){var lt=M(N.normal,Ze[v].v)-M(N.normal,N.v1);if(lt<=w){var rt=i.points[At];E.type==re.e_edgeA?(gn(rt.localPoint,ds,Ze[v].v),rt.id.set(Ze[v].id)):(x(rt.localPoint,Ze[v].v),rt.id.set(Ze[v].id),rt.id.swapFeatures()),++At}}i.pointCount=At}}}}};(function(){function i(t,e){this._refMap={},this._map={},this._xmap={},this._data=[],this._entered=[],this._exited=[],this._key=t,this._listener=e}return i.prototype.update=function(t){if(!Array.isArray(t))throw"Invalid data: "+t;this._entered.length=0,this._exited.length=0,this._data.length=t.length;for(var e=0;e<t.length;e++)if(!(typeof t[e]!="object"||t[e]===null)){var s=t[e],r=this._key(s);this._map[r]?delete this._map[r]:this._entered.push(s),this._data[e]=s,this._xmap[r]=s}for(var r in this._map)this._exited.push(this._map[r]),delete this._map[r];var n=this._map;this._map=this._xmap,this._xmap=n;for(var e=0;e<this._exited.length;e++){var s=this._exited[e],o=this._key(s),a=this._refMap[o];this._listener.exit(s,a),delete this._refMap[o]}for(var e=0;e<this._entered.length;e++){var s=this._entered[e],o=this._key(s),a=this._listener.enter(s);a&&(this._refMap[o]=a)}for(var e=0;e<this._data.length;e++)if(!(typeof t[e]!="object"||t[e]===null)){var s=this._data[e],o=this._key(s),a=this._refMap[o];this._listener.update(s,a)}this._entered.length=0,this._exited.length=0,this._data.length=0},i.prototype.ref=function(t){return this._refMap[this._key(t)]},i})();const yt={scale:100,gravity:1960,fixedTimestep:1e3/60,velocityIterations:8,positionIterations:3,partDensity:1,friction:.3,restitution:.1,linearDamping:.05,angularDamping:.3,playArea:{minX:132,maxX:947,minY:600,maxY:1750},boundaryThickness:50},ca=32768,Xh=255;function Qh(i){return 1<<i-1}class Vt{static instance=null;world;bodies=new Map;nextBodyId=0;accumulator=0;paused=!1;constructor(){const t=yt.gravity/yt.scale;this.world=new Ts({gravity:new c(0,t)}),this.createBoundaryWalls()}static getInstance(){return Vt.instance??=new Vt,Vt.instance}static destroy(){Vt.instance&&(Vt.instance.bodies.clear(),Vt.instance=null)}createBodyForPart(t,e,s,r,n=1){const o=this.calculateBodyDimensions(t,e,s),a=this.createPartBody(o,r);return this.attachPartFixture(a,o,n),this.registerBody(a,t.UID)}calculateBodyDimensions(t,e,s){const r=yt.scale;return{x:t.position.x/r,y:t.position.y/r,halfWidth:e/2/r,halfHeight:s/2/r}}createPartBody(t,e){return this.world.createBody({type:e?"static":"dynamic",position:new c(t.x,t.y),linearDamping:yt.linearDamping,angularDamping:yt.angularDamping})}attachPartFixture(t,e,s){const r=Qh(s);t.createFixture({shape:new Xo(e.halfWidth,e.halfHeight),density:yt.partDensity,friction:yt.friction,restitution:yt.restitution,filterCategoryBits:r,filterMaskBits:r|ca})}registerBody(t,e){const s=this.nextBodyId++;return this.bodies.set(s,t),t.setUserData({entityUid:e,bodyId:s}),s}setBodyDynamic(t){const e=this.bodies.get(t);e&&(e.setType("dynamic"),e.setAwake(!0))}step(t){if(!this.paused)for(this.accumulator+=t;this.accumulator>=yt.fixedTimestep;)this.world.step(yt.fixedTimestep/1e3,yt.velocityIterations,yt.positionIterations),this.accumulator-=yt.fixedTimestep}stepExact(t){this.world.step(t/1e3,yt.velocityIterations,yt.positionIterations)}getBodyPosition(t){const e=this.bodies.get(t);if(!e)return null;const s=e.getPosition();return{x:s.x*yt.scale,y:s.y*yt.scale}}getBodyRotation(t){const e=this.bodies.get(t);return e?e.getAngle():0}isBodySleeping(t){const e=this.bodies.get(t);return e?!e.isAwake():!0}removeBody(t){const e=this.bodies.get(t);e&&(this.world.destroyBody(e),this.bodies.delete(t))}pause(){this.paused=!0}resume(){this.paused=!1}isPaused(){return this.paused}reset(){for(const[,t]of this.bodies)this.world.destroyBody(t);this.bodies.clear(),this.nextBodyId=0,this.accumulator=0,this.paused=!1}getAllBodyIds(){return Array.from(this.bodies.keys())}createBoundaryWalls(){const t=this.calculateBoundaryDimensions();this.createWall(t.minX-t.thickness/2,t.centerY,t.thickness/2,t.height+t.thickness),this.createWall(t.maxX+t.thickness/2,t.centerY,t.thickness/2,t.height+t.thickness)}calculateBoundaryDimensions(){const{playArea:t,boundaryThickness:e,scale:s}=yt,r=e/s,n=t.minX/s,o=t.maxX/s,a=t.minY/s,l=t.maxY/s;return{thickness:r,minX:n,maxX:o,maxY:l,width:(o-n)/2,height:(l-a)/2,centerX:(n+o)/2,centerY:(a+l)/2}}createWall(t,e,s,r){this.world.createBody({type:"static",position:new c(t,e)}).createFixture({shape:new Xo(s,r),friction:yt.friction,filterCategoryBits:ca,filterMaskBits:Xh})}}const vr=new Map;function ni(i){if(vr.has(i.id))throw new Error(`Part "${i.id}" is already registered`);vr.set(i.id,i)}function gr(i){const t=vr.get(i);if(!t)throw new Error(`Part "${i}" not found in registry`);return t}function Zh(i){return vr.has(i)}const tm={id:"simple-plate",name:"Simple Plate",asset:"images/parts/simple-plate.png",collision:{type:"box",width:200,height:100},material:"metal",constraint:{type:"static"},screwMounts:[{id:"top-left",localPosition:{x:20,y:20}},{id:"top-right",localPosition:{x:180,y:20}},{id:"bottom-left",localPosition:{x:20,y:80}},{id:"bottom-right",localPosition:{x:180,y:80}}]};ni(tm);const em={id:"sliding-cover",name:"Sliding Cover",asset:"images/parts/sliding-cover.png",collision:{type:"box",width:150,height:80},material:"metal",constraint:{type:"slider",axis:"x",min:0,max:100},screwMounts:[{id:"left",localPosition:{x:25,y:40}},{id:"center",localPosition:{x:75,y:40}},{id:"right",localPosition:{x:125,y:40}}]};ni(em);const im={id:"board-walnut-square",name:"Walnut Square Board",asset:"images/parts/board-walnut-square.png",collision:{type:"box",width:270,height:260},material:"wood",constraint:{type:"friction",screwThreshold:1},screwMounts:[{id:"top-left",localPosition:{x:30,y:30}},{id:"top-right",localPosition:{x:240,y:30}},{id:"bottom-left",localPosition:{x:30,y:230}},{id:"bottom-right",localPosition:{x:240,y:230}}]};ni(im);const sm={id:"board-oak-horizontal",name:"Oak Horizontal Board",asset:"images/parts/board-oak-horizontal.png",collision:{type:"box",width:755,height:317},material:"wood",constraint:{type:"friction",screwThreshold:1},screwMounts:[{id:"top-left",localPosition:{x:30,y:30}},{id:"top-right",localPosition:{x:725,y:30}},{id:"bottom-left",localPosition:{x:30,y:287}},{id:"bottom-right",localPosition:{x:725,y:287}}]};ni(sm);const rm={id:"board-oak-vertical",name:"Oak Vertical Board",asset:"images/parts/board-oak-vertical.png",collision:{type:"box",width:270,height:417},material:"wood",constraint:{type:"friction",screwThreshold:1},screwMounts:[{id:"top-left",localPosition:{x:30,y:30}},{id:"top-right",localPosition:{x:240,y:30}},{id:"bottom-left",localPosition:{x:30,y:387}},{id:"bottom-right",localPosition:{x:240,y:387}}]};ni(rm);const nm={id:"board-birch-square",name:"Birch Square Board",asset:"images/parts/board-birch-square.png",collision:{type:"box",width:270,height:260},material:"wood",constraint:{type:"friction",screwThreshold:1},screwMounts:[{id:"top-left",localPosition:{x:30,y:30}},{id:"top-right",localPosition:{x:240,y:30}},{id:"bottom-left",localPosition:{x:30,y:230}},{id:"bottom-right",localPosition:{x:240,y:230}}]};ni(nm);const om={id:"board-mahogany-square",name:"Mahogany Square Board",asset:"images/parts/board-mahogany-square.png",collision:{type:"box",width:270,height:260},material:"wood",constraint:{type:"friction",screwThreshold:1},screwMounts:[{id:"top-left",localPosition:{x:30,y:30}},{id:"top-right",localPosition:{x:240,y:30}},{id:"bottom-left",localPosition:{x:30,y:230}},{id:"bottom-right",localPosition:{x:240,y:230}}]};ni(om);const am={id:"board-pine-horizontal",name:"Pine Horizontal Board",asset:"images/parts/board-pine-horizontal.png",collision:{type:"box",width:501,height:317},material:"wood",constraint:{type:"friction",screwThreshold:1},screwMounts:[{id:"top-left",localPosition:{x:30,y:30}},{id:"top-right",localPosition:{x:471,y:30}},{id:"bottom-left",localPosition:{x:30,y:287}},{id:"bottom-right",localPosition:{x:471,y:287}}]};ni(am);const Bc=40;function cm(i,t,e){return i.x-t>=0&&i.x+t<=e.width&&i.y-t>=0&&i.y+t<=e.height}function lm(i,t){let e=!1;const s=t.length;for(let r=0,n=s-1;r<s;n=r++){const o=t[r],a=t[n];o===void 0||a===void 0||o.y>i.y!=a.y>i.y&&i.x<(a.x-o.x)*(i.y-o.y)/(a.y-o.y)+o.x&&(e=!e)}return e}function hm(i,t,e){return[i,{x:i.x-t,y:i.y},{x:i.x+t,y:i.y},{x:i.x,y:i.y-t},{x:i.x,y:i.y+t}].every(r=>lm(r,e))}function mm(i,t,e=Bc){return t.type==="box"?cm(i,e,t):hm(i,e,t.points)}const Ut={centerX:540,centerY:1199,bounds:{minX:-407,maxX:407,minY:-430,maxY:430}};function um(i){return{x:Ut.centerX+i.x,y:Ut.centerY+i.y}}function _m(i,t,e){const s=t/2,r=e/2,n=i.x-s,o=i.x+s,a=i.y-r,l=i.y+r;return n>=Ut.bounds.minX&&o<=Ut.bounds.maxX&&a>=Ut.bounds.minY&&l<=Ut.bounds.maxY}function pm(i,t,e){const s=t/2,r=e/2,n=i.x-s,o=i.x+s,a=i.y-r,l=i.y+r;return{leftEdge:n,rightEdge:o,topEdge:a,bottomEdge:l,exceedsLeft:n<Ut.bounds.minX,exceedsRight:o>Ut.bounds.maxX,exceedsTop:a<Ut.bounds.minY,exceedsBottom:l>Ut.bounds.maxY}}function dm(i,t,e,s){const r=gr(t.partId);if(!mm(i.position,r.collision)){const n=r.collision.type==="box"?`${String(r.collision.width)}x${String(r.collision.height)}`:`${String(r.collision.points.length)}-point polygon`;return{message:`Screw at (${String(i.position.x)}, ${String(i.position.y)}) extends beyond part bounds (${n}). Screw radius is ${String(Bc)}px.`,path:`parts[${String(s)}].screws[${String(e)}].position`}}return null}function ym(i){const t=gr(i);if(t.collision.type==="box")return{width:t.collision.width,height:t.collision.height};const e=t.collision.points,s=e.map(n=>n.x),r=e.map(n=>n.y);return{width:Math.max(...s)-Math.min(...s),height:Math.max(...r)-Math.min(...r)}}function fm(i){const t=[];return i.exceedsLeft&&t.push(`left (${String(i.leftEdge)} < ${String(Ut.bounds.minX)})`),i.exceedsRight&&t.push(`right (${String(i.rightEdge)} > ${String(Ut.bounds.maxX)})`),i.exceedsTop&&t.push(`top (${String(i.topEdge)} < ${String(Ut.bounds.minY)})`),i.exceedsBottom&&t.push(`bottom (${String(i.bottomEdge)} > ${String(Ut.bounds.maxY)})`),t}function vm(i,t){const{width:e,height:s}=ym(i.partId);if(_m(i.position,e,s))return null;const r=pm(i.position,e,s),n=fm(r),o=`(${String(i.position.x)}, ${String(i.position.y)})`,a=`${String(e)}x${String(s)}`;return{message:`Part "${i.partId}" at ${o} with size ${a} exceeds play area bounds. Exceeded: ${n.join(", ")}`,path:`parts[${String(t)}].position`}}function gm(i,t){const e=[],s=[];if(!Zh(i.partId)){const o=`parts[${String(t)}].partId`;return e.push({message:`Unknown part "${i.partId}"`,path:o}),{errors:e,warnings:s}}const r=vm(i,t);r&&e.push(r);const n=new Set;return i.screws.forEach((o,a)=>{const l=dm(o,i,a,t);l&&e.push(l);const p=`${String(o.position.x)},${String(o.position.y)}`;if(n.has(p)){const _=`parts[${String(t)}].screws[${String(a)}].position`,y=`Multiple screws at position (${String(o.position.x)}, ${String(o.position.y)})`;s.push({message:y,path:_})}n.add(p)}),{errors:e,warnings:s}}function xm(i){const t=[];return i.trays.forEach((e,s)=>{(e.capacity<1||e.capacity>4)&&t.push({message:`Tray capacity must be 1-4, got ${String(e.capacity)}`,path:`trays[${String(s)}].capacity`})}),t}function wm(i){const t=[],e=[],s=new Map;i.parts.forEach((r,n)=>{const o=gm(r,n);t.push(...o.errors),e.push(...o.warnings);const a=s.get(r.layer)??0;s.set(r.layer,a+1)});for(const[r,n]of s)n>1&&e.push({message:`${String(n)} parts share layer ${String(r)} - occlusion order may be ambiguous`,path:"parts"});return{errors:t,warnings:e}}function bm(i){const t=[];if(i.win.type==="partsRemoved")for(const e of i.win.partIndices)(e<0||e>=i.parts.length)&&t.push({message:`Invalid part index ${String(e)} in win condition (valid: 0-${String(i.parts.length-1)})`,path:"win.partIndices"});else if(i.win.type==="targetFreed"){const{targetPartIndex:e}=i.win;(e<0||e>=i.parts.length)&&t.push({message:`Invalid target part index ${String(e)} in win condition`,path:"win.targetPartIndex"})}return t}function Am(i){const t=[],e=[];t.push(...xm(i)),i.bufferCapacity!==void 0&&i.bufferCapacity<1&&t.push({message:`Buffer capacity must be at least 1, got ${String(i.bufferCapacity)}`,path:"bufferCapacity"});const s=wm(i);return t.push(...s.errors),e.push(...s.warnings),t.push(...bm(i)),{valid:t.length===0,errors:t,warnings:e}}function Bm(i,t,e,s){for(const r of i.errors)e.push({message:r.message,path:`levels[${String(t)}].${r.path}`});for(const r of i.warnings)s.push({message:r.message,path:`levels[${String(t)}].${r.path}`})}function Sm(i){const t=[],e=[],s=new Set;return i.levels.forEach((r,n)=>{s.has(r.id)&&t.push({message:`Duplicate level ID "${r.id}"`,path:`levels[${String(n)}].id`}),s.add(r.id),Bm(Am(r),n,t,e)}),{errors:t,warnings:e}}function Cm(i){const t=[];i.levels.length!==10&&t.push({message:`Expected 10 levels, got ${String(i.levels.length)}`,path:"levels"});const e=Sm(i);return{valid:e.errors.length===0,errors:e.errors,warnings:[...t,...e.warnings]}}async function Tm(i){const t=await fetch(i);if(!t.ok)throw new Error(`Failed to load region from ${i}: ${String(t.status)}`);const e=await t.json(),s=Cm(e);if(!s.valid){const r=s.errors.map(n=>`  ${n.path}: ${n.message}`).join(`
`);throw new Error(`Region "${e.id}" validation failed:
${r}`)}return e}function Mm(i,t){const e=i.levels[t];if(e===void 0)throw new Error(`Level index ${String(t)} out of bounds (0-${String(i.levels.length-1)})`);return e}var ut=(i=>(i.Red="red",i.Blue="blue",i.Green="green",i.Yellow="yellow",i))(ut||{});function ts(i,t){const e=class{static NAME=i;constructor(){Object.assign(this,structuredClone(t))}init(s){Object.assign(this,s)}reset(){Object.assign(this,structuredClone(t))}};return Object.keys(t).forEach(s=>{Object.defineProperty(e.prototype,s,{value:t[s],writable:!0,enumerable:!0,configurable:!0})}),e}const Pi=ts("screw",{color:ut.Red,partEntityId:"",state:"inBoard",trayEntityId:"",slotIndex:-1,isAnimating:!1}),Sc=ts("part",{partDefinitionId:"",layer:0,screwCount:0,state:"static"}),Cc=ts("physicsBody",{bodyId:-1,bodyType:"static",isSleeping:!0,enabled:!0}),Ar=ts("tray",{color:ut.Red,capacity:3,screwCount:0,displayOrder:0,isAnimating:!1}),Cn=ts("bufferTray",{capacity:5,screwIds:[]}),Tn=ts("gameState",{phase:"playing",totalScrews:0,removedScrews:0,winConditionType:"allScrewsRemoved"}),Pm=Zi(Cs,Pi),Im=Zi(Cs,Sc,Cc),Em=Zi(Cs,Ar),Vm=Zi(Cs,Cn),Ms=new WeakMap;function km(i){return Ms.get(i)}const Lm={[ut.Red]:"short-screw-red",[ut.Yellow]:"short-screw-yellow",[ut.Green]:"short-screw-green",[ut.Blue]:"short-screw-blue"},zm={[ut.Red]:"screw-red",[ut.Yellow]:"screw-yellow",[ut.Green]:"screw-green",[ut.Blue]:"screw-blue"},Fm={[ut.Red]:"tray-red",[ut.Yellow]:"tray-yellow",[ut.Green]:"tray-green",[ut.Blue]:"tray-blue"},Dm={[ut.Red]:"placeholder-red",[ut.Yellow]:"placeholder-yellow",[ut.Green]:"placeholder-green",[ut.Blue]:"placeholder-blue"},Rm=185,la=40,ha=40,qm=75,Tc=new WeakMap;function ma(i){return Tc.get(i)}async function Nm(i){const t=i.state??"inBoard",s=(t==="inBoard"?Lm:zm)[i.color],r=await X.load(s),n=Ss(Pm,{screw:{color:i.color,state:t,partEntityId:i.partEntityId??""}}),o=new ae(r);return o.anchor.set(.5),Ms.set(n,o),n.view.addChild(o),n.position.set(i.position.x,i.position.y),n}async function Om(i){const t=await X.load(i.assetAlias),e=i.dimensions?.width??t.width,s=i.dimensions?.height??t.height,r=i.layer??0,n=$m(i);return Hm(n,t),n.position.set(i.position.x,i.position.y),Um(n,e,s,r),n}function $m(i){return Ss(Im,{part:{partDefinitionId:i.partDefinitionId,layer:i.layer??0,screwCount:0,state:"static"},physicsBody:{bodyId:-1,bodyType:"static",isSleeping:!0,enabled:!0}})}function Hm(i,t){const e=new ae(t);e.anchor.set(.5),e.eventMode="static",Ms.set(i,e),i.view.addChild(e)}function Um(i,t,e,s){const n=Vt.getInstance().createBodyForPart(i,t,e,!0,s);i.c.physicsBody.bodyId=n}async function Wm(i){const t=i.capacity??3,e=i.displayOrder??0,[s,r]=await Ym(i.color),n=jm(i.color,t,e);return Jm(n,s),Gm(n,r,t),n.position.set(i.position.x,i.position.y),n}function Ym(i){return Promise.all([X.load(Fm[i]),X.load(Dm[i])])}function jm(i,t,e){return Ss(Em,{tray:{color:i,capacity:t,screwCount:0,displayOrder:e,isAnimating:!1}})}function Jm(i,t){const e=new ae(t);Ms.set(i,e),i.view.addChild(e)}function Gm(i,t,e){const s=[],r=(e-1)*ha+la,n=(Rm-r)/2+la/2;for(let o=0;o<e;o++){const a=new ae(t);a.anchor.set(.5),a.position.set(n+o*ha,qm),a.alpha=.7,i.view.addChild(a),s.push(a)}Tc.set(i,s)}async function Km(i){const t=await X.load("buffer-tray-frame"),e=Ss(Vm,{bufferTray:{capacity:i.capacity??5,screwIds:[]}}),s=new ae(t);return Ms.set(e,s),e.view.addChild(s),e.position.set(i.position.x,i.position.y),e}const Xm=Zi(Cs,Tn);class Ye{forEachEntity(t,e){const s=this.queries[t];s&&s.forEach(e)}getEntities(t){return this.queries[t]?.entities??[]}getFirstEntity(t){return this.queries[t]?.first}getEntityCount(t){return this.queries[t]?.entities.length??0}getComponents(t,e){return t.c}}const Rt={framePosition:{x:32,y:187},background:{width:990,height:190,offsetX:15,offsetY:10,color:5460819},traySprite:{width:185},placeholder:{width:40},slotOffsets:[{x:25,y:16},{x:220,y:16},{x:419,y:19},{x:614,y:18},{x:808,y:18}]};function Mc(i){const t=Rt.slotOffsets[i];if(!t)throw new Error(`Invalid slot index: ${String(i)}`);return{x:Rt.framePosition.x+t.x,y:Rt.framePosition.y+t.y}}function Gr(i){return Mc(i)}const ln={frame:{x:150,y:438},slotPositions:[{x:257,y:524},{x:409,y:524},{x:540,y:524},{x:676,y:524},{x:821,y:524}]},Br=Rt.slotOffsets.map((i,t)=>Mc(t)),Qm=450,Zm=Rt.framePosition.x+Rt.slotOffsets[4].x,Pc=Rt.traySprite.width,xr=Rt.placeholder.width,wr=40,Ic=75;function tu(i,t,e,s){if(e){const a=ln.slotPositions[t];if(a)return{x:a.x,y:a.y};const l=ln.slotPositions[0];return{x:l.x+t*80,y:l.y}}const n=((s??3)-1)*wr+xr,o=(Pc-n)/2+xr/2;return{x:i.position.x+o+t*wr,y:i.position.y+Ic}}function eu(i,t,e){const s=Br[i];if(!s)throw new Error(`Invalid displayOrder: ${String(i)}`);const r=(e-1)*wr+xr,n=(Pc-r)/2+xr/2;return{x:s.x+n+t*wr,y:s.y+Ic}}class iu{listeners=new Map;on(t,e){let s=this.listeners.get(t);s||(s=new Set,this.listeners.set(t,s)),s.add(e)}off(t,e){const s=this.listeners.get(t);s&&s.delete(e)}emit(t,e){const s=this.listeners.get(t);if(s)for(const r of s)r(e)}clear(t){t?this.listeners.delete(t):this.listeners.clear()}}const V=new iu;let Mn=null,Pn=null;function su(i){Mn=i}function ru(i){Pn=i}function nu(){return Mn}function ou(){return Pn}function au(){Mn=null,Pn=null}const Dt={background:{x:0,y:0},puzzleBase:{x:32,y:676},restartButton:{x:918,y:21},coloredTrayFrame:{x:Rt.framePosition.x,y:Rt.framePosition.y},trayCovers:[Gr(2),Gr(3),Gr(4)],bufferTrayFrame:ln.frame};let Wi=0,rr=!0;const it={get current(){return Wi},update(){Wi++},reset(){Wi=0},setLoggingEnabled(i){rr=i},log(i,t){rr&&console.log(`[T${String(Wi)}] ${i}: ${t}`)},debug(i){rr&&console.log(`[T${String(Wi)}] ${i}`)},warn(i,t){rr&&console.warn(`[T${String(Wi)}] ${i}: ${t}`)}};class In extends Ye{static NAME="trayManagement";static Queries={trays:{components:[Ar]},screws:{components:[Pi]}};transitionQueue=[];isTransitioning=!1;isBusy(){return this.isTransitioning||this.transitionQueue.length>0}init(){V.on("screw:removalComplete",this.handleScrewRemovalComplete),V.on("screw:transferComplete",this.handleScrewTransferComplete),V.on("tray:hideComplete",this.handleAnimationComplete),V.on("tray:shiftComplete",this.handleAnimationComplete),V.on("tray:revealComplete",this.handleRevealComplete)}handleScrewRemovalComplete=t=>{const e=t.screwEntity,s=this.getComponents(e).screw;if(s.state!=="inTray")return;const r=s.trayEntityId,n=this.findTrayByUID(r);if(!n)return;const o=this.getComponents(n).tray;if(o.screwCount>=o.capacity){const a=this.countScrewsInFlightToTray(r);if(a>0){it.log("TRAY",`${o.color} tray full but ${String(a)} screws still in-flight, waiting...`);return}this.queueTransition(n)}};handleScrewTransferComplete=t=>{this.handleScrewRemovalComplete(t)};countScrewsInFlightToTray(t){return this.getEntities("screws").filter(s=>{const r=this.getComponents(s).screw;return r.isAnimating&&r.state==="dragging"&&r.trayEntityId===t}).length}findTrayByUID(t){return this.getEntities("trays").find(s=>String(s.UID)===t)}queueTransition(t){this.transitionQueue.includes(t)||(this.transitionQueue.push(t),this.processNextTransition())}async processNextTransition(){if(this.isTransitioning||this.transitionQueue.length===0)return;this.isTransitioning=!0;const t=this.transitionQueue.shift();if(!t){this.isTransitioning=!1;return}const e=this.getComponents(t).tray;e.isAnimating=!0;const s=this.getSortedTrays(),r=this.findNextHiddenTray(s,t);await this.hideTray(t);const n=this.findTraysToShift(s,e.displayOrder,t);await this.shiftAndRevealTrays(n,r),this.finalizeTransition(e,n,r),this.processNextTransition()}getSortedTrays(){return this.getEntities("trays").sort((e,s)=>{const r=this.getComponents(e).tray.displayOrder,n=this.getComponents(s).tray.displayOrder;return r-n})}findNextHiddenTray(t,e){return t.find(s=>this.getComponents(s).tray.displayOrder>=2&&s!==e)}async hideTray(t){const e=this.getComponents(t).tray;it.log("TRAY",`${e.color} tray hidden (was full)`),V.emit("tray:startHide",{trayEntity:t});const s=await this.waitForEventWithData("tray:hideComplete");for(const r of s.screwsInTray)this.scene.removeChild(r);this.scene.removeChild(t)}findTraysToShift(t,e,s){return t.filter(r=>{const n=this.getComponents(r).tray;return n.displayOrder>e&&n.displayOrder<2&&r!==s})}async shiftAndRevealTrays(t,e){const s=this.emitShiftEvents(t),r=this.emitRevealEvent(e),n=r?[...s,r]:s;n.length>0&&await Promise.all(n)}emitShiftEvents(t){const e=[];for(const s of t){const r=this.getComponents(s).tray,n=r.displayOrder-1;r.displayOrder=n,r.isAnimating=!0,e.push(this.waitForEvent("tray:shiftComplete")),V.emit("tray:startShift",{trayEntity:s,newDisplayOrder:n})}return e}emitRevealEvent(t){if(!t)return null;const e=this.getComponents(t).tray,s=1;e.displayOrder=s,e.isAnimating=!0,it.log("TRAY",`${e.color} tray revealed at position ${String(s)}`);const r=this.waitForEvent("tray:revealComplete");return V.emit("tray:startReveal",{trayEntity:t,displayOrder:s}),r}finalizeTransition(t,e,s){it.log("TRAY_FINALIZE",`queueLen=${String(this.transitionQueue.length)} isTransitioning=${String(this.isTransitioning)}`),t.displayOrder=99,t.isAnimating=!1;for(const r of e){const n=this.getComponents(r).tray;n.isAnimating=!1}if(s){const r=this.getComponents(s).tray;r.isAnimating=!1}this.isTransitioning=!1,it.log("TRAY_FINALIZE"," isTransitioning=false, emitting tray:revealed, then processNextTransition"),s&&V.emit("tray:revealed",{trayEntity:s})}waitForEvent(t){return new Promise(e=>{const s=()=>{V.off(t,s),e()};V.on(t,s)})}waitForEventWithData(t){return new Promise(e=>{const s=r=>{V.off(t,s),e(r)};V.on(t,s)})}handleAnimationComplete=()=>{};handleRevealComplete=()=>{};update(t){}destroy(){V.off("screw:removalComplete",this.handleScrewRemovalComplete),V.off("screw:transferComplete",this.handleScrewTransferComplete),V.off("tray:hideComplete",this.handleAnimationComplete),V.off("tray:shiftComplete",this.handleAnimationComplete),V.off("tray:revealComplete",this.handleRevealComplete),this.transitionQueue=[],this.isTransitioning=!1}}class Sr extends Ye{static NAME="screwPlacement";static Queries={coloredTrays:{components:[Ar]},bufferTrays:{components:[Cn]},screws:{components:[Pi]}};findPlacementTarget(t){const e=this.anyTrayAnimating(),s=this.trayManagementBusy();if(it.log("PLACEMENT",`${t} screw  animating=${String(e)} busy=${String(s)}`),!e&&!s){const n=this.findColoredTrayTarget(t);if(n){const o=this.getComponents(n.tray).tray;if(o.displayOrder===1&&this.willDisplayOrder0Fill())it.log("PLACEMENT",` ${o.color} tray at displayOrder 1 would race, redirecting to buffer`);else return it.log("PLACEMENT",` ${o.color} tray [slot ${String(n.slotIndex)}]`),n}}const r=this.findBufferTrayTarget();return r?it.log("PLACEMENT",` buffer [slot ${String(r.slotIndex)}]`):it.log("PLACEMENT"," NO VALID TARGET"),r}trayManagementBusy(){return this.scene.getSystem(In).isBusy()}anyTrayAnimating(){return this.getEntities("coloredTrays").some(e=>this.getComponents(e).tray.isAnimating)}isBufferFull(){const t=this.getFirstEntity("bufferTrays");if(!t)return!0;const e=this.getComponents(t).bufferTray,s=e.screwIds.length,r=this.countScrewsAnimatingToBuffer();return s+r>=e.capacity}countScrewsAnimatingToBuffer(){const t=this.getFirstEntity("bufferTrays");if(!t)return 0;const e=String(t.UID);return this.getEntities("screws").filter(r=>{const n=this.getComponents(r).screw;return n.isAnimating&&n.state==="dragging"&&n.trayEntityId===e}).length}findColoredTrayTarget(t){const s=this.getEntities("coloredTrays").find(n=>{const o=this.getComponents(n).tray;return o.color===t&&o.displayOrder<2&&!o.isAnimating&&o.screwCount<o.capacity});if(!s)return null;const r=this.getComponents(s).tray;return{type:"colored",tray:s,slotIndex:r.screwCount}}findBufferTrayTarget(){const t=this.getFirstEntity("bufferTrays");if(!t)return null;const e=this.getComponents(t).bufferTray;return e.screwIds.length>=e.capacity?null:{type:"buffer",tray:t,slotIndex:e.screwIds.length}}reserveSlot(t,e){const s=this.getComponents(e).screw;if(t.type==="colored"){const r=this.getComponents(t.tray).tray;r.screwCount++}else this.getComponents(t.tray).bufferTray.screwIds.push(String(e.UID));s.trayEntityId=String(t.tray.UID),s.slotIndex=t.slotIndex}findAvailableColoredTray(t){return this.getEntities("coloredTrays").find(s=>{const r=this.getComponents(s).tray;return r.color===t&&r.displayOrder<2&&!r.isAnimating&&r.screwCount<r.capacity})??null}findScrewByUid(t){return this.getEntities("screws").find(s=>String(s.UID)===t)}hasValidMoves(){return this.getEntities("screws").some(e=>{const s=this.getComponents(e).screw;return s.state!=="inBoard"||s.isAnimating?!1:this.findPlacementTarget(s.color)!==null})}willDisplayOrder0Fill(){const t=this.getEntities("coloredTrays"),e=this.getEntities("screws");for(const s of t){const r=this.getComponents(s).tray;if(r.displayOrder!==0)continue;const n=String(s.UID),o=e.filter(a=>{const l=this.getComponents(a).screw;return l.isAnimating&&l.state==="dragging"&&l.trayEntityId===n}).length;if(r.screwCount+o>=r.capacity)return!0}return!1}update(t){}}class cu extends Ye{static NAME="screwInteraction";static Queries={screws:{components:[Pi]},gameState:{components:[Tn]}};touchInputs=new Map;initialized=!1;initTouchInputs(){this.initialized||(this.initialized=!0,this.forEachEntity("screws",t=>{this.setupTouchInput(t)}))}setupTouchInput(t){if(this.touchInputs.has(t.UID))return;const s=t.view;if(!s)return;s.eventMode="static",s.cursor="pointer";const r=new _n(s);r.onTap=()=>(this.handleScrewTap(t),Promise.resolve()),this.touchInputs.set(t.UID,r)}handleScrewTap(t){const e=this.getComponents(t).screw;if(!this.canInteractWithScrew(e))return;const s=this.scene.getSystem(Sr),r=s.findPlacementTarget(e.color);r&&(this.isInteractionBlocked(s)||(this.logTapAction(t,e.color,r),s.reserveSlot(r,t),e.isAnimating=!0,e.state="dragging",V.emit("screw:startRemoval",{screwEntity:t,targetTray:r.tray,slotIndex:r.slotIndex,isBuffer:r.type==="buffer"})))}isInteractionBlocked(t){const e=t.isBufferFull(),s=t.anyTrayAnimating(),r=t.trayManagementBusy();return e&&(s||r)?(it.log("BLOCKED",`bufferFull=${String(e)} animating=${String(s)} busy=${String(r)}`),!0):!1}logTapAction(t,e,s){const r=t,n=Math.round(r.position.x),o=Math.round(r.position.y),a=s.type==="colored"?this.getComponents(s.tray).tray.color:"buffer";it.log("TAP",`(${String(n)}, ${String(o)})  ${e} screw  ${a} tray [slot ${String(s.slotIndex)}]`)}canInteractWithScrew(t){if(t.state!=="inBoard"||t.isAnimating)return!1;const e=this.getFirstEntity("gameState");return!(e&&this.getComponents(e).gameState.phase!=="playing")}cleanupTouchInput(t){const e=this.touchInputs.get(t.UID);e&&(e.enabled=!1,this.touchInputs.delete(t.UID))}update(t){if(!this.initialized){this.initTouchInputs();return}this.forEachEntity("screws",e=>{this.touchInputs.has(e.UID)||this.setupTouchInput(e)})}destroy(){for(const[t]of this.touchInputs){const e=this.getEntities("screws").find(s=>s.UID===t);e&&this.cleanupTouchInput(e)}this.touchInputs.clear(),this.initialized=!1}}const lu={[ut.Red]:"screw-red",[ut.Yellow]:"screw-yellow",[ut.Green]:"screw-green",[ut.Blue]:"screw-blue"},hn=.5,Ec=.7,hu=20,ua=.8,mu=130,uu=80;function _a(i,t,e,s){const r=1-i;return r*r*t+2*r*i*e+i*i*s}class Vc{ctx;constructor(t){this.ctx=t}setupAnimationTimeline(t){const e=we.timeline();this.ctx.activeTimelines.add(e);const s=this.ctx.getAnimationLayer();return s&&s.addChild(t.view),e}cleanupTimeline(t){this.ctx.activeTimelines.delete(t)}async animateFlight(t,e,s,r,n){const o={t:0},a=()=>{this.updateFlightPosition(o.t,e,s,r)};await t.to(o,{t:1,duration:n,ease:"power2.inOut",onUpdate:a})}updateFlightPosition(t,e,s,r){e.position.x=_a(t,r.startX,r.controlX,r.endX),e.position.y=_a(t,r.startY,r.controlY,r.endY),s.scale.set(r.startScale+(r.endScale-r.startScale)*t)}async animateSettle(t,e,s){await t.to(e.scale,{x:s,y:s,duration:.1,ease:"bounce.out"})}hidePlaceholder(t,e){const r=this.ctx.getTrayPlaceholders(t)?.[e];r&&we.to(r,{alpha:0,duration:.15,ease:"linear"})}}class _u extends Vc{async handle(t){const{screwEntity:e,targetTray:s,slotIndex:r,isBuffer:n}=t,o=e,a=this.ctx.getGameVisual(o);if(o.view.eventMode="none",!a){this.complete(e,n,s,r);return}await this.animateRemoval(o,a,t),this.complete(e,n,s,r)}async animateRemoval(t,e,s){const r=this.setupAnimationTimeline(t);try{await this.executeAnimation(t,e,s,r)}finally{this.cleanupTimeline(r)}}async executeAnimation(t,e,s,r){const{targetTray:n,slotIndex:o,isBuffer:a}=s,l=this.ctx.getComponents(t).screw;await this.swapToLongScrew(e,l.color);const p={x:t.position.x,y:t.position.y},_=a?this.getSlotTargetPosition(n,o,a):this.getColoredTrayTargetPosition(n,o),y=a?Ec:hn,h=this.createFlightParams(p,_,y,mu);await this.animateFlight(r,t,e,h,.45),await this.animateSettle(r,e,y)}async swapToLongScrew(t,e){t.scale.set(ua);const s=await X.load(lu[e]);t.texture=s}createFlightParams(t,e,s,r){const n=t.y-hu;return{startX:t.x,startY:n,controlX:(t.x+e.x)/2,controlY:Math.min(n,e.y)-r,endX:e.x,endY:e.y,startScale:ua,endScale:s}}getColoredTrayTargetPosition(t,e){const s=this.ctx.getComponents(t).tray;return this.ctx.getTraySlotTargetPosition(s.displayOrder,e,s.capacity)}getSlotTargetPosition(t,e,s){const r=s?void 0:this.ctx.getComponents(t).tray.capacity;return this.ctx.getTraySlotPosition(t,e,s,r)}complete(t,e,s,r){const n=this.ctx.getComponents(t).screw;n.state=e?"inBuffer":"inTray",n.isAnimating=!1;const o=t;if(!e){const a=this.ctx.getColoredTrayLayer();a&&a.addChild(o.view),s&&r!==void 0&&(this.checkScrewPosition(o,s,r),this.hidePlaceholder(s,r))}V.emit("screw:removalComplete",{screwEntity:t})}checkScrewPosition(t,e,s){const r=this.ctx.getComponents(t).screw,n=this.ctx.getComponents(e).tray,o=this.ctx.getTraySlotTargetPosition(n.displayOrder,s,n.capacity),a=Math.abs(t.position.x-o.x),l=Math.abs(t.position.y-o.y);(a>.5||l>.5)&&it.warn("POSITION_MISMATCH",`${r.color} screw at (${t.position.x.toFixed(1)}, ${t.position.y.toFixed(1)}) expected (${String(o.x)}, ${String(o.y)}) delta=(${a.toFixed(1)}, ${l.toFixed(1)}) tray.displayOrder=${String(n.displayOrder)} tray.isAnimating=${String(n.isAnimating)}`)}}class pu extends Vc{async handle(t){const{screwEntity:e,targetTray:s,slotIndex:r}=t,n=e,o=this.ctx.getGameVisual(n);if(n.view.eventMode="none",!o){this.complete(e,s,r);return}const a=this.setupAnimationTimeline(n);try{await this.executeAnimation(n,o,t,a)}finally{this.cleanupTimeline(a)}this.complete(e,s,r)}async executeAnimation(t,e,s,r){const{targetTray:n,slotIndex:o}=s,a={x:t.position.x,y:t.position.y},l=this.ctx.getComponents(n).tray,p=this.ctx.getTraySlotTargetPosition(l.displayOrder,o,l.capacity),_=this.createTransferFlightParams(a,p);await this.animateFlight(r,t,e,_,.27),await this.animateSettle(r,e,hn)}createTransferFlightParams(t,e){return{startX:t.x,startY:t.y,controlX:(t.x+e.x)/2,controlY:Math.min(t.y,e.y)-uu,endX:e.x,endY:e.y,startScale:Ec,endScale:hn}}complete(t,e,s){const r=this.ctx.getComponents(t).screw;r.state="inTray",r.trayEntityId=String(e.UID),r.slotIndex=s,r.isAnimating=!1;const n=t,o=this.ctx.getColoredTrayLayer();o&&o.addChild(n.view),this.checkScrewPosition(n,e,s),this.hidePlaceholder(e,s),V.emit("screw:transferComplete",{screwEntity:t})}checkScrewPosition(t,e,s){const r=this.ctx.getComponents(t).screw,n=this.ctx.getComponents(e).tray,o=this.ctx.getTraySlotTargetPosition(n.displayOrder,s,n.capacity),a=Math.abs(t.position.x-o.x),l=Math.abs(t.position.y-o.y);(a>.5||l>.5)&&it.warn("POSITION_MISMATCH",`${r.color} screw at (${t.position.x.toFixed(1)}, ${t.position.y.toFixed(1)}) expected (${String(o.x)}, ${String(o.y)}) delta=(${a.toFixed(1)}, ${l.toFixed(1)}) tray.displayOrder=${String(n.displayOrder)} tray.isAnimating=${String(n.isAnimating)}`)}}class du{ctx;constructor(t){this.ctx=t}async handle(t){const{trayEntity:e}=t,s=e,r=this.ctx.getScrewsInTray(String(e.UID));this.reparentScrewsToTray(r,s),this.setupPivotForCenterScale(s),await this.animateScaleDown(s),V.emit("tray:hideComplete",{trayEntity:e,screwsInTray:r})}setupPivotForCenterScale(t){t.view.pivot.set(92.5,75),t.position.x+=92.5,t.position.y+=75}async animateScaleDown(t){const e=we.timeline();this.ctx.activeTimelines.add(e);try{await e.to(t.scale,{x:0,y:0,duration:.4,ease:"power2.in"})}finally{this.ctx.activeTimelines.delete(e)}}reparentScrewsToTray(t,e){const s=e.view;for(const r of t){const n=r,o=this.ctx.getGameVisual(n);if(!o)continue;const a=n.position.x-e.position.x,l=n.position.y-e.position.y;o.parent&&o.parent.removeChild(o),o.position.set(a,l),s.addChild(o)}}}class yu{ctx;constructor(t){this.ctx=t}async handle(t){const{trayEntity:e,newDisplayOrder:s}=t,r=e,n=Br[s];if(!n){V.emit("tray:shiftComplete",{trayEntity:e});return}const o=this.ctx.getScrewsInTray(String(e.UID)),a=n.x-r.position.x,l=we.timeline();this.ctx.activeTimelines.add(l);try{this.addShiftAnimations(l,r,n.x,o,a),await l}finally{this.ctx.activeTimelines.delete(l)}V.emit("tray:shiftComplete",{trayEntity:e})}addShiftAnimations(t,e,s,r,n){t.to(e.position,{x:s,duration:.3,ease:"power2.inOut"},0);for(const o of r){const a=o;t.to(a.position,{x:a.position.x+n,duration:.3,ease:"power2.inOut"},0)}}}class fu{ctx;constructor(t){this.ctx=t}async handle(t){const{trayEntity:e,displayOrder:s}=t,r=e,n=Br[s];if(!n){V.emit("tray:revealComplete",{trayEntity:e});return}r.position.x=Zm,r.position.y=n.y;const o=we.timeline();this.ctx.activeTimelines.add(o);try{await o.to(r.position,{x:n.x,duration:.3,ease:"power2.out"})}finally{this.ctx.activeTimelines.delete(o)}V.emit("tray:revealComplete",{trayEntity:e})}}class vu extends Ye{static NAME="animation";static Queries={screws:{components:[Pi]}};activeTimelines=new Set;screwRemoval;screwTransfer;trayHide;trayShift;trayReveal;handleRemovalEvent=t=>{this.screwRemoval.handle(t)};handleTransferEvent=t=>{this.screwTransfer.handle(t)};handleTrayHideEvent=t=>{this.trayHide.handle(t)};handleTrayShiftEvent=t=>{this.trayShift.handle(t)};handleTrayRevealEvent=t=>{this.trayReveal.handle(t)};init(){const t=this.createAnimatorContext();this.screwRemoval=new _u(t),this.screwTransfer=new pu(t),this.trayHide=new du(t),this.trayShift=new yu(t),this.trayReveal=new fu(t),V.on("screw:startRemoval",this.handleRemovalEvent),V.on("screw:startTransfer",this.handleTransferEvent),V.on("tray:startHide",this.handleTrayHideEvent),V.on("tray:startShift",this.handleTrayShiftEvent),V.on("tray:startReveal",this.handleTrayRevealEvent)}createAnimatorContext(){return{activeTimelines:this.activeTimelines,getScrewsInTray:t=>this.getScrewsInTray(t),getComponents:t=>this.getComponents(t),getAnimationLayer:()=>nu(),getColoredTrayLayer:()=>ou(),getGameVisual:t=>km(t),getTrayPlaceholders:t=>ma(t)??null,getTraySlotTargetPosition:(t,e,s)=>eu(t,e,s),getTraySlotPosition:(t,e,s,r)=>tu(t,e,s,r)}}getScrewsInTray(t){const e=[];return this.forEachEntity("screws",s=>{const r=this.getComponents(s).screw;r.state==="inTray"&&r.trayEntityId===t&&e.push(s)}),e}hidePlaceholder(t,e){const r=ma(t)?.[e];r&&we.to(r,{alpha:0,duration:.15,ease:"linear"})}update(t){}destroy(){V.off("screw:startRemoval",this.handleRemovalEvent),V.off("screw:startTransfer",this.handleTransferEvent),V.off("tray:startHide",this.handleTrayHideEvent),V.off("tray:startShift",this.handleTrayShiftEvent),V.off("tray:startReveal",this.handleTrayRevealEvent);for(const t of this.activeTimelines)t.kill();this.activeTimelines.clear()}}class gu extends Ye{static NAME="autoTransfer";static Queries={coloredTrays:{components:[Ar]},bufferTrays:{components:[Cn]},screws:{components:[Pi]}};isTransferring=!1;handleRemovalComplete=()=>{queueMicrotask(()=>{this.checkAutoTransfer()})};handleTransferComplete=()=>{queueMicrotask(()=>{this.onTransferComplete()})};handleTrayRevealed=()=>{queueMicrotask(()=>{this.checkAutoTransfer()})};init(){V.on("screw:removalComplete",this.handleRemovalComplete),V.on("screw:transferComplete",this.handleTransferComplete),V.on("tray:revealed",this.handleTrayRevealed)}destroy(){V.off("screw:removalComplete",this.handleRemovalComplete),V.off("screw:transferComplete",this.handleTransferComplete),V.off("tray:revealed",this.handleTrayRevealed),this.isTransferring=!1}onTransferComplete(){this.isTransferring=!1,this.checkAutoTransfer()}checkAutoTransfer(){if(this.shouldSkipTransferCheck())return;const t=this.getFirstEntity("bufferTrays");if(!t)return;const e=this.getComponents(t).bufferTray;if(e.screwIds.length===0){it.log("AUTO_TRANSFER_CHECK"," skipped (buffer empty)");return}this.processBufferScrews(e.screwIds,t)}shouldSkipTransferCheck(){const t=this.isTransferring,e=this.anyTrayAnimating(),s=this.trayManagementBusy();return it.log("AUTO_TRANSFER_CHECK",`transferring=${String(t)} animating=${String(e)} busy=${String(s)}`),t?(it.log("AUTO_TRANSFER_CHECK"," skipped (already transferring)"),!0):e?(it.log("AUTO_TRANSFER_CHECK"," skipped (trays animating)"),!0):s?(it.log("AUTO_TRANSFER_CHECK"," skipped (tray management busy)"),!0):!1}processBufferScrews(t,e){it.log("AUTO_TRANSFER_CHECK",`buffer has ${String(t.length)} screws`);for(const s of t)if(this.tryTransferScrew(s,e))return}tryTransferScrew(t,e){const s=this.scene.getSystem(Sr),r=s.findScrewByUid(t);if(!r)return it.log("AUTO_TRANSFER_CHECK",` screw ${t} not found`),!1;const n=this.getComponents(r).screw;if(n.isAnimating)return it.log("AUTO_TRANSFER_CHECK",` ${n.color} screw still animating`),!1;const o=s.findAvailableColoredTray(n.color);return o?(this.initiateTransfer(r,o,e),!0):(it.log("AUTO_TRANSFER_CHECK",` ${n.color} screw has no matching visible tray`),!1)}anyTrayAnimating(){const t=this.getEntities("coloredTrays");for(const e of t)if(this.getComponents(e).tray.isAnimating)return!0;return!1}trayManagementBusy(){return this.scene.getSystem(In).isBusy()}initiateTransfer(t,e,s){this.isTransferring=!0;const r=this.getComponents(s).bufferTray,n=this.getComponents(e).tray,o=this.getComponents(t).screw,a=String(t.UID),l=r.screwIds.indexOf(a);l>=0&&r.screwIds.splice(l,1);const p=n.screwCount;n.screwCount++,it.log("TRANSFER",`${o.color} screw from buffer  ${n.color} tray [slot ${String(p)}]`),o.isAnimating=!0;const _={screwEntity:t,targetTray:e,slotIndex:p};V.emit("screw:startTransfer",_)}update(t){}}class xu extends Ye{static NAME="winCondition";static Queries={gameState:{components:[Tn]},screws:{components:[Pi]}};handleRemovalComplete=()=>{this.checkConditions()};handleTransferComplete=()=>{this.checkStuckCondition()};init(){V.on("screw:removalComplete",this.handleRemovalComplete),V.on("screw:transferComplete",this.handleTransferComplete)}destroy(){V.off("screw:removalComplete",this.handleRemovalComplete),V.off("screw:transferComplete",this.handleTransferComplete)}checkConditions(){const t=this.getFirstEntity("gameState");if(!t)return;const e=this.getComponents(t).gameState;if(e.phase==="playing"){if(e.removedScrews++,this.checkWinCondition(e.winConditionType)){e.phase="won",V.emit("game:won");return}this.checkStuckCondition()}}checkWinCondition(t){return t==="allScrewsRemoved"?this.checkAllScrewsRemoved():this.checkAllScrewsRemoved()}countInBoardScrews(){return this.getEntities("screws").filter(t=>this.getComponents(t).screw.state==="inBoard").length}checkAllScrewsRemoved(){return this.countInBoardScrews()===0}checkStuckCondition(){const t=this.getFirstEntity("gameState");if(!t)return;const e=this.getComponents(t).gameState;if(e.phase!=="playing")return;this.scene.getSystem(Sr).hasValidMoves()||this.countInBoardScrews()>0&&(e.phase="stuck",V.emit("game:stuck"))}update(t){}}function wu(){window.addEventListener("error",i=>{const t=i.error;window.__gameTest&&window.__gameTest.captureError(t instanceof Error?t:new Error(i.message),`${i.filename}:${String(i.lineno)}:${String(i.colno)}`)}),window.addEventListener("unhandledrejection",i=>{if(window.__gameTest){const t=i.reason;window.__gameTest.captureError(t instanceof Error?t:new Error(String(t)),"unhandledrejection")}})}function En(){const i=new URLSearchParams(window.location.search),t=i.get("seed"),e=i.get("level");return{testMode:i.has("testMode")||i.get("testMode")==="1",seed:t!==null?parseInt(t,10):void 0,scene:i.get("scene")??void 0,muteAudio:i.has("muteAudio")||i.get("muteAudio")==="1",skipIntro:i.has("skipIntro")||i.get("skipIntro")==="1",region:i.get("region")??void 0,level:e!==null?parseInt(e,10):void 0}}function kc(){return En().testMode||!1}const bu=new Set(["constructor","entity","scene","parent","children"]),Au=new Set(["view"]);function Lc(i,t){return typeof t=="function"||i.startsWith("_")||bu.has(i)}function Bu(i,t){if(i==null)return{include:!0,value:i};if(typeof i!="object")return{include:!0,value:i};if(Array.isArray(i)&&(i.length===0||typeof i[0]!="object"))return{include:!0,value:i};if(!Array.isArray(i)){const e=zc(i,t+1);if(e!=="[max depth]")return{include:!0,value:e}}return{include:!1,value:null}}function zc(i,t=0){if(t>3)return"[max depth]";try{return JSON.parse(JSON.stringify(i))}catch{}if(typeof i!="object"||i===null)return i;const e=i,s={};for(const r of Object.keys(e)){if(Lc(r,e[r]))continue;const{include:n,value:o}=Bu(e[r],t);n&&(s[r]=o)}return Object.keys(s).length>0?s:"[complex object]"}function Su(i){if(i&&typeof i=="object"){const t=i,e=t.uid??t.UID;if(typeof e=="string")return e;if(typeof e=="number")return e.toString()}return null}function pa(i){if(i==null)return null;const t={},e=i;for(const s of Object.keys(e)){const r=e[s];if(!Lc(s,r)){if(Au.has(s)){const n=Su(r);n!==null&&(t[`${s}Uid`]=n);continue}r===null||typeof r!="object"||Array.isArray(r)?t[s]=r:t[s]=zc(r)}}return t}function Cu(i){const t={},e=i.c??i.components;if(e instanceof Map)e.forEach((s,r)=>{t[r]=pa(s)});else if(e&&typeof e=="object")for(const[s,r]of Object.entries(e))t[s]=pa(r);return t}function Tu(i){try{if(i.view?.getBounds){const t=i.view.getBounds();return{x:t.x,y:t.y,width:t.width,height:t.height}}}catch{}return null}function Mu(i){const t=i;return{id:t.UID??t.uid??"unknown",type:t.constructor?.name??"Entity",position:{x:t.position?.x??0,y:t.position?.y??0},scale:{x:t.scale?.x??1,y:t.scale?.y??1},rotation:t.rotation??0,visible:t.visible??!0,alpha:t.alpha??1,bounds:Tu(t),components:Cu(t),childCount:t.view?.children?.length??0}}function Pu(i){return i?(i.allEntities?.children??[]).map(s=>Mu(s)):[]}function Iu(i){if(!i)return[];const t=i;return!t.systems||!(t.systems instanceof Map)?[]:Array.from(t.systems.keys())}function Eu(){let i=null;const t=()=>Pu(i),e=s=>t().find(r=>String(r.id)===s)??null;return{getScene:()=>i,getEntities:t,getEntity:e,queryByComponent:s=>t().filter(r=>s in r.components),getEntityCount:()=>t().length,hasEntity:s=>e(s)!==null,getSystems:()=>Iu(i),_setScene:s=>{i=s}}}let Vu=0;function ku(i){let t=5381;for(let e=0;e<i.length;e++){const s=i.charCodeAt(e);t=(t<<5)+t+s,t=t&t}return(t>>>0).toString(16)}function Lu(i){const t=`${i.position.x.toFixed(2)},${i.position.y.toFixed(2)}`,e=`${i.scale.x.toFixed(2)},${i.scale.y.toFixed(2)}`,s=i.rotation.toFixed(4),r=i.visible?"1":"0",n=i.alpha.toFixed(2),a=Object.keys(i.components).sort().map(p=>`${p}:${JSON.stringify(i.components[p])}`).join(";");return`${typeof i.id=="number"?i.id.toString():i.id}|${i.type}|${t}|${e}|${s}|${r}|${n}|${a}`}function zu(i,t,e){return()=>{const s=i(),r=performance.now(),n=Vu++,o=[...s].sort((p,_)=>{const y=typeof p.id=="number"?p.id.toString():p.id,h=typeof _.id=="number"?_.id.toString():_.id;return y.localeCompare(h)}),a=o.map(Lu).join("||"),l=ku(a);return{timestamp:r,frame:n,entityCount:s.length,entities:o,systems:e?.()??[],sceneState:t(),hash:l}}}const da=200;let vs=[];function Fu(i){if(!["pointerDown","pointerUp","pointerMove","keyDown","keyUp"].includes(i.type))return;const e=window.__gameTest?.tick?.current??-1,s={action:i,tick:e,timestamp:performance.now()};vs.push(s),vs.length>da&&(vs=vs.slice(-da))}function Du(){return[...vs]}function Cr(i,t){const s=i.allEntities?.children??[],r=typeof t=="number"?t.toString():t;return s.find(n=>{const o=n,a=o.UID??o.uid;return(typeof a=="number"?a.toString():a)===r})??null}function Ru(i,t){const e=i,s=e.c??e.components;return s?s instanceof Map?s.get(t)??null:s[t]??null:null}function qu(i,t,e,s){if(!i)return{success:!1,error:"Scene not available"};const r=Cr(i,t);if(!r)return{success:!1,error:`Entity ${t} not found`};const n=r;return n.position?.set?(n.position.set(e,s),{success:!0}):{success:!1,error:"Entity has no position property"}}function Nu(i,t,e,s){if(!i)return{success:!1,error:"Scene not available"};const r=Cr(i,t);if(!r)return{success:!1,error:`Entity ${t} not found`};const n=Ru(r,e);return n?(Object.assign(n,s),{success:!0}):{success:!1,error:`Component ${e} not found`}}function Ou(i,t,e){if(!i)return{success:!1,error:"Scene not available"};const s=Cr(i,t);return s?(s.visible=e,{success:!0}):{success:!1,error:`Entity ${t} not found`}}function $u(i,t){if(!i)return{success:!1,error:"Scene not available"};const e=Cr(i,t);if(!e)return{success:!1,error:`Entity ${t} not found`};const s=i;return s.removeChild?(s.removeChild(e),{success:!0}):{success:!1,error:"Scene has no removeChild method"}}function Hu(i){return i?(i.paused=!0,{success:!0}):{success:!1,error:"Scene not available"}}function Uu(i){return i?(i.paused=!1,{success:!0}):{success:!1,error:"Scene not available"}}function Wu(i,t){if(!i)return{success:!1,error:"Scene not available"};const e=i;return e.update?(e.update(t),{success:!0}):{success:!1,error:"Scene has no update method"}}function Kr(i,t,e,s,r){if(!t)return{success:!1,error:"Canvas not available"};const n=t.getBoundingClientRect(),o=n.width/t.width,a=n.height/t.height,l=e*o,p=s*a,_=new PointerEvent(i,{bubbles:!0,cancelable:!0,clientX:n.left+l,clientY:n.top+p,button:r??0,pointerType:"mouse"});return t.dispatchEvent(_),{success:!0}}function ya(i,t,e){const s=new KeyboardEvent(i,{bubbles:!0,cancelable:!0,key:t,code:e});return window.dispatchEvent(s),{success:!0}}function Yu(i,t){switch(i.type){case"setPosition":return qu(t,i.entityId,i.x,i.y);case"setComponent":return Nu(t,i.entityId,i.component,i.data);case"setVisible":return Ou(t,i.entityId,i.visible);case"destroyEntity":return $u(t,i.entityId);case"pause":return Hu(t);case"resume":return Uu(t);case"tick":return Wu(t,i.deltaMs);default:return null}}function ju(i,t){switch(i.type){case"pointerDown":return Kr("pointerdown",t,i.x,i.y,i.button);case"pointerUp":return Kr("pointerup",t,i.x,i.y,i.button);case"pointerMove":return Kr("pointermove",t,i.x,i.y,0);default:return null}}async function Ju(i,t){const e=ju(i,t);if(e)return e;switch(i.type){case"keyDown":return ya("keydown",i.key,i.code);case"keyUp":return ya("keyup",i.key,i.code);case"wait":return await new Promise(s=>setTimeout(s,i.ms)),{success:!0};default:return null}}async function Gu(i,t,e){const s=Yu(i,t());if(s)return s;const r=await Ju(i,e());return r||{success:!1,error:`Unknown action type: ${i.type}`}}function Ku(i,t){return async e=>{try{return Fu(e),await Gu(e,i,t)}catch(s){return{success:!1,error:s instanceof Error?s.message:String(s)}}}}function Xu(){return{pause(){Vt.getInstance().pause()},resume(){Vt.getInstance().resume()},step(i){Vt.getInstance().stepExact(i)},getBodyPosition(i){return Vt.getInstance().getBodyPosition(i)},isBodySleeping(i){return Vt.getInstance().isBodySleeping(i)},reset(){Vt.getInstance().reset()}}}const fa=1e3;let Ji=[],gs=null,va=!1;function Qu(i){try{return typeof i=="object"&&i!==null?JSON.stringify(i,null,2):String(i)}catch{return Object.prototype.toString.call(i)}}function Zu(){return window.__gameTest?.tick?.current??-1}function Xr(i,t){const e={type:i,timestamp:performance.now(),tick:Zu(),args:t.map(Qu)};Ji.push(e),Ji.length>fa&&(Ji=Ji.slice(-fa))}function t_(){va||(gs={log:console.log.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)},console.log=(...i)=>{gs?.log(...i),Xr("log",i)},console.warn=(...i)=>{gs?.warn(...i),Xr("warn",i)},console.error=(...i)=>{gs?.error(...i),Xr("error",i)},va=!0)}function e_(){return[...Ji]}function i_(){Ji=[]}function s_(){return gs}async function r_(){try{const{getApp:i}=await ur(async()=>{const{getApp:r}=await Promise.resolve().then(()=>Oc);return{getApp:r}},void 0),{StagePlugin:t}=await ur(async()=>{const{StagePlugin:r}=await Promise.resolve().then(()=>Za);return{StagePlugin:r}},void 0),e=i();return e?e.get(t).renderer??null:null}catch{return null}}async function Fc(){try{const{getApp:i}=await ur(async()=>{const{getApp:r}=await Promise.resolve().then(()=>Oc);return{getApp:r}},void 0),{StagePlugin:t}=await ur(async()=>{const{StagePlugin:r}=await Promise.resolve().then(()=>Za);return{StagePlugin:r}},void 0),e=i();return e?e.get(t).stage??null:null}catch{return null}}async function n_(){const i=await r_(),t=await Fc();if(i?.extract&&t)try{return await i.extract.base64(t,"image/png")}catch(s){console.warn("[BugReport] Extract failed, falling back to toDataURL:",s)}const e=document.querySelector("canvas");if(!e)throw new Error("Canvas not found");return e.toDataURL("image/png")}function Dc(i,t=0,e=10){if(!i||t>e)return null;const s={type:i.constructor?.name??"Unknown",position:{x:i.x??0,y:i.y??0},scale:{x:i.scale?.x??1,y:i.scale?.y??1},rotation:i.rotation??0,visible:i.visible??!0,alpha:i.alpha??1};i.uid!==void 0&&(s.uid=String(i.uid)),i.label&&(s.label=i.label),i.UID!==void 0&&(s.entityUid=String(i.UID));try{if(typeof i.getBounds=="function"){const r=i.getBounds();r&&typeof r.x=="number"&&(s.bounds={x:r.x,y:r.y,width:r.width,height:r.height})}}catch{}if(i.texture){const r=i.texture;s.texture=r.label??r.uid??"texture"}if(i.children&&i.children.length>0){const r=[];for(const n of i.children){const o=Dc(n,t+1,e);o&&r.push(o)}r.length>0&&(s.children=r)}return s}function Rc(i){let t=1;if(i.children)for(const e of i.children)t+=Rc(e);return t}async function o_(){const i=await Fc();if(!i)return null;const t=Dc(i);if(!t)return null;let e,s="unknown";if(window.__gameTest){const n=window.__gameTest.getRenderSignature();n&&(s=n.sceneState,e=n.entities.map(o=>({id:String(o.id),type:o.type,position:o.position,components:o.components})))}const r={timestamp:performance.now(),displayTree:t,displayObjectCount:Rc(t),sceneState:s};return e&&(r.entities=e),r}async function a_(i){await window.__gameTest?.act({type:"pause"});let t="";try{t=await n_()}catch(o){console.error("[BugReport] Failed to capture screenshot:",o)}const e=await o_(),s=e_(),r=Du();await window.__gameTest?.act({type:"resume"});const n={timestamp:new Date().toISOString(),url:window.location.href,screenshot:t,gameState:e,consoleLogs:s,userActions:r};return i&&(n.description=i),n}async function c_(i){try{return await(await fetch("/__bug-report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json()}catch(t){return{success:!1,error:t instanceof Error?t.message:String(t)}}}let lr=null;function l_(){const i=document.createElement("div");return i.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `,i}function h_(){const i=document.createElement("div");return i.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 20px;
    width: 400px;
    max-width: 90vw;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  `,i}function m_(){const i=document.createElement("h2");return i.textContent="Report Bug",i.style.cssText=`
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 600;
  `,i}function u_(){const i=document.createElement("textarea");return i.placeholder="Describe the bug (optional)...",i.style.cssText=`
    width: 100%;
    height: 100px;
    padding: 10px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #222;
    color: #fff;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
    box-sizing: border-box;
  `,i}function ga(i,t){const e=document.createElement("button");return e.textContent=i,e.style.cssText=`
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
    ${t?"background: #4CAF50; color: white;":"background: #444; color: #ddd;"}
  `,e.onmouseenter=()=>{e.style.background=t?"#45a049":"#555"},e.onmouseleave=()=>{e.style.background=t?"#4CAF50":"#444"},e}function __(){const i=document.createElement("div");return i.style.cssText=`
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 16px;
  `,i}function p_(){const i=document.createElement("div");return i.style.cssText=`
    margin-top: 12px;
    padding: 10px;
    border-radius: 4px;
    font-size: 14px;
    display: none;
  `,i}function Qr(i,t,e){i.textContent=t,i.style.display="block",i.style.background=e?"#5c2020":"#1e3a1e",i.style.color=e?"#ff8080":"#80ff80"}function nr(){lr&&(lr.remove(),lr=null)}function d_(){nr();const i=l_(),t=h_(),e=m_(),s=u_(),r=__(),n=ga("Cancel",!1),o=ga("Submit Report",!0),a=p_();r.appendChild(n),r.appendChild(o),t.appendChild(e),t.appendChild(s),t.appendChild(r),t.appendChild(a),i.appendChild(t),n.onclick=nr,i.onclick=l=>{l.target===i&&nr()},o.onclick=async()=>{o.disabled=!0,n.disabled=!0,o.textContent="Submitting...",o.style.background="#666";try{const l=s.value.trim()||void 0,p=await a_(l),_=await c_(p);_.success?(Qr(a,`Report saved to: ${_.path??"unknown"}`,!1),setTimeout(nr,2e3)):(Qr(a,`Error: ${_.error??"Unknown error"}`,!0),o.disabled=!1,n.disabled=!1,o.textContent="Submit Report",o.style.background="#4CAF50")}catch(l){Qr(a,`Error: ${l instanceof Error?l.message:String(l)}`,!0),o.disabled=!1,n.disabled=!1,o.textContent="Submit Report",o.style.background="#4CAF50"}},document.body.appendChild(i),lr=i,s.focus()}const qc="debugConsole",y_=350,Vn=200,kn=30,f_=36;function v_(){try{const i=localStorage.getItem(qc);if(i)return JSON.parse(i)}catch{}return{x:10,y:window.innerHeight-Vn-10,minimized:!1,visible:!0}}function br(i){try{localStorage.setItem(qc,JSON.stringify(i))}catch{}}function g_(i){const t=document.createElement("div");t.id="debug-console";const e=i.minimized?kn:Vn;return t.style.cssText=`
    position: fixed;
    left: ${String(i.x)}px;
    top: ${String(i.y)}px;
    width: ${String(y_)}px;
    height: ${String(e)}px;
    background: rgba(17, 17, 17, 0.95);
    border: 1px solid #333;
    border-radius: 6px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 11px;
    z-index: 9999;
    display: ${i.visible?"flex":"none"};
    flex-direction: column;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    overflow: hidden;
  `,t}function x_(){const i=document.createElement("div");return i.style.cssText=`
    height: ${String(kn)}px;
    background: #222;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 8px;
    cursor: move;
    user-select: none;
    border-bottom: 1px solid #333;
    flex-shrink: 0;
  `,i}function w_(){const i=document.createElement("span");return i.textContent="Debug Console",i.style.cssText=`
    color: #888;
    font-size: 12px;
    font-weight: 500;
  `,i}function b_(){const i=document.createElement("div");return i.style.cssText=`
    display: flex;
    gap: 6px;
  `,i}function xa(i,t,e){const s=document.createElement("button");return s.textContent=i,s.title=t,s.style.cssText=`
    width: 20px;
    height: 20px;
    background: #333;
    border: none;
    border-radius: 3px;
    color: #888;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  `,s.onmouseenter=()=>{s.style.background="#444",s.style.color="#fff"},s.onmouseleave=()=>{s.style.background="#333",s.style.color="#888"},s.onclick=r=>{r.stopPropagation(),e()},s}function A_(){const i=document.createElement("div");return i.style.cssText=`
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 6px 8px;
    color: #0f0;
  `,i}function B_(){const i=document.createElement("div");return i.style.cssText=`
    height: ${String(f_)}px;
    background: #222;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 8px;
    gap: 8px;
    border-top: 1px solid #333;
    flex-shrink: 0;
  `,i}function Zr(i,t,e){const s=document.createElement("button");return s.textContent=i,s.style.cssText=`
    padding: 4px 10px;
    background: ${t?"#2a5a2a":"#333"};
    border: 1px solid ${t?"#3d7a3d":"#444"};
    border-radius: 4px;
    color: ${t?"#6f6":"#aaa"};
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
  `,s.onmouseenter=()=>{s.style.background=t?"#3d7a3d":"#444",s.style.color=t?"#8f8":"#fff"},s.onmouseleave=()=>{s.style.background=t?"#2a5a2a":"#333",s.style.color=t?"#6f6":"#aaa"},s.onclick=e,s}function S_(i,t){const e=document.createElement("div");e.style.cssText=`
    color: ${i==="error"?"#f66":i==="warn"?"#ff0":"#0f0"};
    word-wrap: break-word;
    white-space: pre-wrap;
    margin-bottom: 2px;
    line-height: 1.4;
  `;const s=i==="error"?"ERR":i==="warn"?"WRN":"LOG";return e.textContent=`[${s}] ${t}`,e}function C_(i,t,e){let s=!1,r=0,n=0;const o=(p,_)=>{s=!0,r=p-e.x,n=_-e.y,document.body.style.userSelect="none"},a=(p,_)=>{if(!s)return;const y=p-r,h=_-n,m=window.innerWidth-i.offsetWidth,u=window.innerHeight-i.offsetHeight;e.x=Math.max(0,Math.min(y,m)),e.y=Math.max(0,Math.min(h,u)),i.style.left=`${String(e.x)}px`,i.style.top=`${String(e.y)}px`},l=()=>{s&&(s=!1,document.body.style.userSelect="",br(e))};t.addEventListener("mousedown",p=>{p.target.tagName!=="BUTTON"&&(p.preventDefault(),o(p.clientX,p.clientY))}),document.addEventListener("mousemove",p=>{a(p.clientX,p.clientY)}),document.addEventListener("mouseup",l),t.addEventListener("touchstart",p=>{if(p.target.tagName==="BUTTON")return;const _=p.touches[0];_&&(p.preventDefault(),o(_.clientX,_.clientY))},{passive:!1}),document.addEventListener("touchmove",p=>{if(!s)return;const _=p.touches[0];_&&(p.preventDefault(),a(_.clientX,_.clientY))},{passive:!1}),document.addEventListener("touchend",l),document.addEventListener("touchcancel",l)}function T_(i,t){document.addEventListener("keydown",e=>{if(e.key==="`"&&!e.ctrlKey&&!e.metaKey&&!e.altKey){const s=e.target;if(s.tagName==="INPUT"||s.tagName==="TEXTAREA")return;t.visible=!t.visible,i.style.display=t.visible?"flex":"none",br(t)}})}function M_(i){const t=[];return{addLog(s,r){const n=S_(s,r);for(i.appendChild(n),t.push(n);t.length>500;)t.shift()?.remove();i.scrollTop=i.scrollHeight},clear(){i.innerHTML="",t.length=0},getLogText(){return t.map(s=>s.textContent??"").join(`
`)}}}function P_(i){t_();const t=s_(),e=console.log,s=console.warn,r=console.error;console.log=(...n)=>{e(...n);const o=n.map(a=>tn(a)).join(" ");i.addLog("log",o)},console.warn=(...n)=>{s(...n);const o=n.map(a=>tn(a)).join(" ");i.addLog("warn",o)},console.error=(...n)=>{r(...n);const o=n.map(a=>tn(a)).join(" ");i.addLog("error",o)},t?.log("[DebugConsole] Initialized - Press ` to toggle")}function tn(i){try{return typeof i=="object"&&i!==null?JSON.stringify(i,null,2):String(i)}catch{return Object.prototype.toString.call(i)}}function I_(){const i=v_(),t=g_(i),e=x_(),s=w_(),r=b_(),n=A_(),o=B_(),a=M_(n),l=xa(i.minimized?"+":"-","Minimize/Expand",()=>{i.minimized=!i.minimized,t.style.height=i.minimized?`${String(kn)}px`:`${String(Vn)}px`,l.textContent=i.minimized?"+":"-",n.style.display=i.minimized?"none":"block",o.style.display=i.minimized?"none":"flex",br(i)}),p=xa("x","Close (` to reopen)",()=>{i.visible=!1,t.style.display="none",br(i)}),_=Zr("Copy",!1,()=>{const m=a.getLogText();navigator.clipboard.writeText(m).then(()=>{const u=_.textContent;_.textContent="Copied!",setTimeout(()=>{_.textContent=u},1e3)})}),y=Zr("Clear",!1,()=>{a.clear(),i_()}),h=Zr("Report Bug",!0,()=>{d_()});return r.appendChild(l),r.appendChild(p),e.appendChild(s),e.appendChild(r),o.appendChild(_),o.appendChild(y),o.appendChild(h),t.appendChild(e),t.appendChild(n),t.appendChild(o),i.minimized&&(n.style.display="none",o.style.display="none"),C_(t,e,i),T_(t,i),P_(a),t}let hr=null;function E_(){return{get current(){return hr?.current??0},reset(){hr?.reset()},setLoggingEnabled(i){hr?.setLoggingEnabled(i)}}}function V_(i){hr=i}function k_(i,t){const e=async s=>(s.type==="pause"?i.sceneState="paused":s.type==="resume"&&(i.sceneState="running"),t(s));return{act:e,async actMany(s){const r=[];for(const n of s)r.push(await e(n));return r}}}function L_(i){return{captureError(t,e){i.errors.push({message:t instanceof Error?t.message:t,stack:t instanceof Error?t.stack:void 0,timestamp:performance.now(),source:e})},snapshot:()=>({ready:i.ready,scene:i.scene,errors:[...i.errors],bootTimeMs:i.bootEndTime?i.bootEndTime-i.bootStartTime:void 0})}}function z_(i,t){return{markReady(e){i.ready=!0,i.scene=e,i.sceneState="running",i.bootEndTime=performance.now()},...L_(i),registerScene(e){t._setScene(e)}}}function F_(i,t){Object.defineProperties(i,{ready:{get:()=>t.ready,enumerable:!0},scene:{get:()=>t.scene,enumerable:!0},bootStartTime:{get:()=>t.bootStartTime,enumerable:!0},bootEndTime:{get:()=>t.bootEndTime,enumerable:!0},errors:{get:()=>t.errors,enumerable:!0}})}function D_(){return{errors:[],ready:!1,scene:"",bootStartTime:performance.now(),bootEndTime:void 0,sceneState:"stopped"}}function R_(){const i=D_(),t=Eu(),e=Ku(()=>t.getScene(),()=>document.querySelector("canvas")),s={...k_(i,e),...z_(i,t),metrics:{},ecs:t,tick:E_(),physics:Xu(),getRenderSignature:zu(()=>t.getEntities(),()=>i.sceneState,()=>t.getSystems()),ready:!1,scene:"",bootStartTime:0,bootEndTime:void 0,errors:[]};return F_(s,i),s}function q_(){if(kc()){console.log("[TestHarness] Initializing test harness..."),window.__gameTest=R_(),wu();const i=En();console.log("[TestHarness] Test params:",i)}}function N_(i){window.__gameTest&&window.__gameTest.markReady(i)}class O_ extends Ye{static NAME="tick";registered=!1;update(t){this.registered||(V_(it),this.registered=!0),it.update()}}const $_=100;class H_ extends Ye{static NAME="partState";static Queries={parts:{components:[Sc]}};boundHandleScrewRemoval;pendingTimeouts=new Set;constructor(){super(),this.boundHandleScrewRemoval=this.handleScrewRemoval.bind(this)}init(){V.on("screw:startRemoval",this.boundHandleScrewRemoval)}destroy(){V.off("screw:startRemoval",this.boundHandleScrewRemoval);for(const t of this.pendingTimeouts)clearTimeout(t);this.pendingTimeouts.clear()}handleScrewRemoval(t){const e=this.findPartEntityForScrew(t.screwEntity);if(!e)return;const s=this.getPartComponent(e);if(s.state!=="free"&&(s.screwCount=Math.max(0,s.screwCount-1),s.screwCount===0)){const r=setTimeout(()=>{this.pendingTimeouts.delete(r),s.state!=="free"&&this.freePart(e,s)},$_);this.pendingTimeouts.add(r)}}findPartEntityForScrew(t){const e=this.getComponents(t).screw;if(!e.partEntityId)return;let s;return this.forEachEntity("parts",r=>{String(r.UID)===e.partEntityId&&(s=r)}),s}getPartComponent(t){return this.getComponents(t).part}freePart(t,e){e.state="free",V.emit("part:freed",{partEntity:t,partId:e.partDefinitionId})}update(t){}}const U_=400,W_=yt.playArea.maxY+200;class Y_ extends Ye{static NAME="physics";static Queries={physicsBodies:{components:[Cc]}};physicsManager;boundHandlePartFreed;fallingParts=new Map;entitiesToDestroy=[];constructor(){super(),this.physicsManager=Vt.getInstance(),this.boundHandlePartFreed=this.handlePartFreed.bind(this)}init(){V.on("part:freed",this.boundHandlePartFreed)}destroy(){V.off("part:freed",this.boundHandlePartFreed)}handlePartFreed(t){const{partEntity:e}=t,s=e,r=this.getComponents(e).physicsBody;r.bodyId<0||(this.physicsManager.setBodyDynamic(r.bodyId),r.bodyType="dynamic",r.isSleeping=!1,this.fallingParts.set(e.UID,s.position.y))}update(t){this.physicsManager.step(t.deltaTime),this.forEachEntity("physicsBodies",e=>{this.syncEntityPhysics(e)}),this.processEntityDestruction()}processEntityDestruction(){for(const t of this.entitiesToDestroy)this.destroyFallingPart(t);this.entitiesToDestroy=[]}destroyFallingPart(t){const e=this.getComponents(t).physicsBody;e.bodyId>=0&&this.physicsManager.removeBody(e.bodyId),this.fallingParts.delete(t.UID),this.scene.removeChild(t)}syncEntityPhysics(t){const e=this.getComponents(t).physicsBody;!e.enabled||e.bodyId<0||e.bodyType==="static"||(this.updateEntityPosition(t,e.bodyId),this.updateEntityRotation(t,e.bodyId),this.fallingParts.has(t.UID)?this.updateFallingPart(t):this.checkSettled(t,e))}updateFallingPart(t){const e=t.position.y,s=yt.playArea.maxY;if(e>W_){this.entitiesToDestroy.push(t);return}if(e>s){const r=Math.min((e-s)/U_,1);t.view.alpha=1-r}}updateEntityPosition(t,e){const s=this.physicsManager.getBodyPosition(e);s&&(t.position.x=s.x,t.position.y=s.y)}updateEntityRotation(t,e){t.view.rotation=this.physicsManager.getBodyRotation(e)}checkSettled(t,e){const s=e.isSleeping,r=this.physicsManager.isBodySleeping(e.bodyId);e.isSleeping=r,!s&&r&&V.emit("part:settled",{partEntity:t})}}class j_{scene;isInitialized=!1;backgroundLayer;uiLayer;puzzleLayer;coloredTrayLayer;animationLayer;restartButton=null;restartInput=null;trayCovers=[];trayEntities=new Map;bufferTrayEntity=null;gameStateEntity=null;partEntities=[];screwEntities=[];currentLevel=null;currentRegionPath=null;currentLevelIndex=0;constructor(t){this.scene=new Tl({stage:t.stage}),this.backgroundLayer=new Ct,this.uiLayer=new Ct,this.puzzleLayer=new Ct,this.coloredTrayLayer=new Ct,this.animationLayer=new Ct,t.stage.addChild(this.backgroundLayer),t.stage.addChild(this.puzzleLayer),t.stage.addChild(this.uiLayer)}async init(){this.isInitialized||(window.__gameTest&&window.__gameTest.registerScene(this.scene),await this.loadAssets(),await this.createBackground(),await this.createTrayArea(),await this.createBufferTray(),await this.createRestartButton(),this.fixLayerOrder(),this.registerSystems(),this.setupGameEvents(),this.isInitialized=!0)}registerSystems(){this.scene.addSystem(O_),this.scene.addSystem(Sr),this.scene.addSystem(vu),this.scene.addSystem(cu),this.scene.addSystem(H_),this.scene.addSystem(Y_),this.scene.addSystem(gu),this.scene.addSystem(xu),this.scene.addSystem(In)}setupGameEvents(){V.on("game:won",()=>{this.handleGameWon()}),V.on("game:stuck",()=>{this.handleGameStuck()})}handleGameWon(){it.log("WIN","Level complete! You won!")}handleGameStuck(){it.log("STUCK","No moves available. Tap restart to try again.")}fixLayerOrder(){const t=this.scene.view2d.stage,e=this.scene.view2d.innerContainer;t.removeChild(this.backgroundLayer),t.removeChild(this.puzzleLayer),t.removeChild(e),t.removeChild(this.uiLayer),t.addChild(this.backgroundLayer),t.addChild(this.puzzleLayer),t.addChild(e),t.addChild(this.uiLayer),t.addChild(this.animationLayer),su(this.animationLayer),ru(this.coloredTrayLayer)}async loadAssets(){this.registerAssetBundles(),await X.loadBundle(["common","ui","trays","screws","placeholders"])}registerAssetBundles(){this.registerCommonBundle(),this.registerUIBundle(),this.registerPlaceholderBundle(),this.registerTrayBundle(),this.registerScrewBundle()}registerCommonBundle(){X.addBundle("common",[{alias:"scene-background",src:"images/backgrounds/scene-background.png"},{alias:"puzzle-base",src:"images/ui/puzzle-base.png"}])}registerUIBundle(){X.addBundle("ui",[{alias:"restart-button",src:"images/ui/restart-button.png"},{alias:"colored-tray-frame",src:"images/ui/colored-tray-frame.png"},{alias:"buffer-tray-frame",src:"images/ui/buffer-tray-frame.png"},{alias:"tray-cover",src:"images/ui/tray-cover.png"}])}registerPlaceholderBundle(){X.addBundle("placeholders",[{alias:"placeholder-red",src:"images/placeholders/placeholder-red.png"},{alias:"placeholder-yellow",src:"images/placeholders/placeholder-yellow.png"},{alias:"placeholder-green",src:"images/placeholders/placeholder-green.png"},{alias:"placeholder-blue",src:"images/placeholders/placeholder-blue.png"}])}registerTrayBundle(){X.addBundle("trays",[{alias:"tray-red",src:"images/trays/tray-red.png"},{alias:"tray-yellow",src:"images/trays/tray-yellow.png"},{alias:"tray-green",src:"images/trays/tray-green.png"},{alias:"tray-blue",src:"images/trays/tray-blue.png"}])}registerScrewBundle(){X.addBundle("screws",[{alias:"short-screw-red",src:"images/screws/short-screw-red.png"},{alias:"short-screw-yellow",src:"images/screws/short-screw-yellow.png"},{alias:"short-screw-green",src:"images/screws/short-screw-green.png"},{alias:"short-screw-blue",src:"images/screws/short-screw-blue.png"},{alias:"screw-red",src:"images/screws/screw-red.png"},{alias:"screw-yellow",src:"images/screws/screw-yellow.png"},{alias:"screw-green",src:"images/screws/screw-green.png"},{alias:"screw-blue",src:"images/screws/screw-blue.png"}])}async createBackground(){const t=await X.load("scene-background"),e=new ae(t);e.position.set(Dt.background.x,Dt.background.y),this.backgroundLayer.addChild(e);const s=await X.load("puzzle-base"),r=new ae(s);r.position.set(Dt.puzzleBase.x,Dt.puzzleBase.y),this.puzzleLayer.addChild(r)}async createTrayArea(){const t=new ba;t.rect(0,0,Rt.background.width,Rt.background.height),t.fill({color:Rt.background.color}),t.position.set(Dt.coloredTrayFrame.x+Rt.background.offsetX,Dt.coloredTrayFrame.y+Rt.background.offsetY),this.uiLayer.addChild(t),this.uiLayer.addChild(this.coloredTrayLayer);const e=await X.load("tray-cover");for(const n of Dt.trayCovers){const o=new ae(e);o.position.set(n.x,n.y),this.uiLayer.addChild(o),this.trayCovers.push(o)}const s=await X.load("colored-tray-frame"),r=new ae(s);r.position.set(Dt.coloredTrayFrame.x,Dt.coloredTrayFrame.y),this.uiLayer.addChild(r)}async createLevelTrays(t){const e=t.trays;for(let s=0;s<e.length;s++){const r=e[s];if(!r)continue;const n=s,o=n<2,a=Br[n],l=o?{x:a?.x??40,y:a?.y??202}:{x:a?.x??40,y:Qm},p=await Wm({color:r.color,position:l,capacity:r.capacity,displayOrder:n});this.scene.addChild(p),this.trayEntities.set(r.color,p),this.coloredTrayLayer.addChild(p.view)}}async createBufferTray(){const t=await X.load("buffer-tray-frame"),e=new ae(t);e.position.set(Dt.bufferTrayFrame.x,Dt.bufferTrayFrame.y),this.uiLayer.addChild(e)}async createRestartButton(){const t=await X.load("restart-button");this.restartButton=new ae(t),this.restartButton.position.set(Dt.restartButton.x,Dt.restartButton.y),this.restartButton.eventMode="static",this.restartButton.cursor="pointer",this.restartInput=new _n(this.restartButton),this.restartInput.onTap=()=>(this.handleRestartClick(),Promise.resolve()),this.uiLayer.addChild(this.restartButton)}handleRestartClick(){this.currentRegionPath&&this.currentLevel&&(it.log("RESTART","Restarting level..."),this.loadLevel(this.currentRegionPath,this.currentLevelIndex))}getTrayByColor(t){return this.trayEntities.get(t)}getAnimationLayer(){return this.animationLayer}getColoredTrayLayer(){return this.coloredTrayLayer}getCurrentLevel(){return this.currentLevel}async loadLevel(t,e){this.clearLevel(),this.currentRegionPath=t,this.currentLevelIndex=e;const s=await Tm(t),r=Mm(s,e);this.currentLevel=r,await this.loadPartAssets(r),await this.createLevelEntities(r)}async createLevelEntities(t){this.createGameStateEntity(t),await this.createLevelTrays(t),await this.createBufferTrayEntity(t),await this.createPartsAndScrews(t)}createGameStateEntity(t){const e=t.parts.reduce((s,r)=>s+r.screws.length,0);this.gameStateEntity=Ss(Xm,{gameState:{phase:"playing",totalScrews:e,removedScrews:0,winConditionType:t.win.type}}),this.scene.addChild(this.gameStateEntity)}async createBufferTrayEntity(t){this.bufferTrayEntity=await Km({position:{x:Dt.bufferTrayFrame.x,y:Dt.bufferTrayFrame.y},capacity:t.bufferCapacity??5}),this.scene.addChild(this.bufferTrayEntity)}async createPartsAndScrews(t){const e=[...t.parts].sort((s,r)=>s.layer-r.layer);for(const s of e){const r=gr(s.partId),n=um(s.position),o=await Om({assetAlias:r.id,partDefinitionId:r.id,position:n,layer:s.layer});this.scene.addChild(o),this.partEntities.push(o),await this.createScrewsForPart(s,r,n,o)}}async createScrewsForPart(t,e,s,r){const n=e.collision.type==="box"?e.collision.width:0,o=e.collision.type==="box"?e.collision.height:0;for(const l of t.screws){const p={x:s.x-n/2+l.position.x,y:s.y-o/2+l.position.y},_=await Nm({color:l.color,position:p,partEntityId:String(r.UID)});this.scene.addChild(_),this.screwEntities.push(_)}const a=r.c.part;a.screwCount=t.screws.length}clearLevel(){it.reset(),Vt.getInstance().reset(),this.gameStateEntity&&(this.scene.removeChild(this.gameStateEntity),this.gameStateEntity=null),this.bufferTrayEntity&&(this.scene.removeChild(this.bufferTrayEntity),this.bufferTrayEntity=null),this.coloredTrayLayer.removeChildren();for(const t of this.trayEntities.values())this.scene.removeChild(t);this.trayEntities.clear();for(const t of this.partEntities)this.scene.removeChild(t);for(const t of this.screwEntities)this.scene.removeChild(t);this.animationLayer.removeChildren(),this.partEntities=[],this.screwEntities=[],this.currentLevel=null}loadedPartBundles=new Set;async loadPartAssets(t){const e=new Set(t.parts.map(r=>r.partId)),s=[];for(const r of e){if(this.loadedPartBundles.has(r))continue;const n=gr(r);n.asset&&(s.push({alias:n.id,src:n.asset}),this.loadedPartBundles.add(r))}if(s.length>0){const r=`level-parts-${String(Date.now())}`;X.addBundle(r,s),await X.loadBundle(r)}}start(){this.scene.start()}pause(){this.scene.paused=!0}resume(){this.scene.paused=!1}update(t){}destroy(){this.restartInput&&(this.restartInput.enabled=!1,this.restartInput=null),this.restartButton=null,this.trayEntities.clear(),this.backgroundLayer.removeChildren(),this.uiLayer.removeChildren(),this.puzzleLayer.removeChildren(),this.animationLayer.removeChildren(),au(),this.scene.reset()}}class J_ extends dl{gameScene=null;async onPrepare(){this.gameScene=new j_({stage:this.view}),await this.gameScene.init();const t=En(),s=`regions/region-${t.region??"test"}.json`,r=t.level??0;await this.gameScene.loadLevel(s,r)}onShow(){this.gameScene?.start()}onUpdate(t){this.gameScene?.update(t)}onHide(){this.gameScene?.pause()}onHidden(){this.gameScene?.destroy(),this.gameScene=null}onPause(){this.gameScene?.pause()}onResume(){this.gameScene?.resume()}}const or={width:1080,height:1920,backgroundColor:1710638,antialias:!0};let We=null;async function Nc(){return We!==null||(We=new Pa,G_(We),await We.init(),K_(We),await X_(We)),We}function G_(i){i.add(Ee,{backgroundColor:or.backgroundColor,antialias:or.antialias,autoAddToDocument:!1}),i.add(pn,{resizeFunction:Qa(or.width,or.height,!0)}),i.add(Oa),i.add($a),i.add(dn,{main:{loadBeforeTransition:!0},overlay:{loadBeforeTransition:!0}})}function K_(i){const t=i.get(Ee),e=document.getElementById("app");if(e===null)throw new Error("App container element not found");e.appendChild(t.view)}async function X_(i){const t=i.get(dn);t.main.add(J_,void 0,"game"),await t.main.show("game"),N_("game")}function Q_(){return We}const Oc=Object.freeze(Object.defineProperty({__proto__:null,bootstrap:Nc,getApp:Q_},Symbol.toStringTag,{value:"Module"}));q_();if(kc()){const i=I_();document.body.appendChild(i)}async function Z_(){try{console.log("Starting application..."),await Nc(),console.log("Application started successfully")}catch(i){console.error("Failed to initialize application:",i),window.__gameTest&&window.__gameTest.captureError(i instanceof Error?i:new Error(String(i)),"main");const t=document.getElementById("app");t&&(t.innerHTML=`<pre style="color: red; padding: 20px;">${String(i)}

${i instanceof Error?i.stack??"":""}</pre>`)}}Z_();
//# sourceMappingURL=index-DioiMUIk.js.map
