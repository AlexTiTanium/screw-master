# Bug Fixing Workflow for AI Agents

This document describes how to use bug reports generated by the game's automated bug report system to investigate and fix issues.

## Bug Report System Overview

The game includes an automated bug report system that captures:
- **Screenshot** - Visual state of the game canvas
- **Game State** - Complete ECS entity and component data
- **Console Logs** - All console output with timestamps and tick numbers
- **User Actions** - Recorded pointer/keyboard events leading up to the bug

## Bug Report Structure

Each bug report is saved in `bug-reports/{timestamp}/` with:

```
bug-reports/2024-01-15T10-30-45-123Z/
├── screenshot.png     # Visual state when bug was reported
├── render-graph.json  # PixiJS display object tree (visual hierarchy)
├── game-state.json    # ECS entities and components
├── console-log.txt    # All console logs with tick numbers
└── report.json        # Metadata (URL, description, user actions)
```

## Step-by-Step Bug Fixing Process

### 1. Read Bug Report Files

Start by examining the bug report contents:

#### report.json
Contains metadata and user actions:
```json
{
  "timestamp": "2024-01-15T10:30:45.123Z",
  "url": "http://localhost:3000/?testMode=1&region=test&level=0",
  "description": "Red screw went to blue tray instead of red tray",
  "userActions": [
    { "action": { "type": "pointerDown", "x": 595, "y": 1434 }, "tick": 120, "timestamp": 2500.5 },
    { "action": { "type": "pointerUp", "x": 595, "y": 1434 }, "tick": 122, "timestamp": 2550.3 }
  ]
}
```

#### render-graph.json
Contains the PixiJS display object tree with UIDs for correlation:
```json
{
  "type": "Container",
  "uid": "1",
  "position": { "x": 0, "y": 0 },
  "visible": true,
  "children": [
    {
      "type": "ScrewEntity",
      "uid": "456",
      "entityUid": "123",
      "position": { "x": 595, "y": 1434 },
      "texture": "screw-red",
      "visible": true
    }
  ]
}
```

**Correlation keys:**
- `uid` - PixiJS internal uid, matches `view2d.viewUid` in game-state.json
- `entityUid` - ODIE entity UID, matches `entities[].id` in game-state.json

#### game-state.json
Contains ECS entities with their components:
```json
{
  "timestamp": 2600.123,
  "displayObjectCount": 80,
  "entities": [
    {
      "id": "123",
      "type": "ScrewEntity",
      "position": { "x": 595, "y": 1434 },
      "components": {
        "screw": { "color": "red", "state": "placed", "slotIndex": 0 },
        "view2d": { "name": "view2d", "viewUid": "456", "layer": "default" }
      }
    },
    {
      "id": "789",
      "type": "TrayEntity",
      "position": { "x": 48, "y": 175 },
      "components": {
        "tray": { "color": "red", "screwCount": 2, "capacity": 4 }
      }
    }
  ],
  "systems": ["TickSystem", "ScrewPlacementSystem", "AnimationSystem"],
  "sceneState": "running"
}
```

**Correlation keys:**
- `entities[].id` matches `entityUid` in render-graph.json
- `view2d.viewUid` references the display object's internal uid

#### console-log.txt
Formatted log entries:
```
[   1234ms] [T120] [LOG  ] TAP: (595, 1434) → red screw
[   1250ms] [T121] [LOG  ] TRANSFER: red screw → buffer
[   1280ms] [T122] [LOG  ] AUTO_TRANSFER: buffer → blue tray (ERROR: wrong color!)
```

#### screenshot.png
Visual reference showing the game state at bug report time.

### 2. Create E2E Test from User Actions

Transform the `userActions` array into a Playwright test:

```typescript
// e2e/specs/bug-2024-01-15T10-30-45-123Z.spec.ts
import { test, expect } from '@playwright/test';
import { createHarnessClient } from '../helpers/harness';

test.describe('Bug: Red screw went to wrong tray', () => {
  test('reproduce from user action log', async ({ page }) => {
    // Use URL from report.json
    await page.goto('/?testMode=1&region=test&level=0');

    const harness = createHarnessClient(page);
    await harness.waitForReady(15000);

    // Wait for initial render to settle
    await page.waitForTimeout(500);

    // Replay user actions from report.json
    // Action 1: pointerDown at (595, 1434) - tick 120
    await harness.act({ type: 'pointerDown', x: 595, y: 1434 });
    await page.waitForTimeout(50);

    // Action 2: pointerUp at (595, 1434) - tick 122
    await harness.act({ type: 'pointerUp', x: 595, y: 1434 });

    // Wait for animations to complete
    await page.waitForTimeout(1000);

    // Add assertions based on bug description
    // The red screw should be in a red tray, not blue
    const screws = await harness.queryByComponent('screw');
    const redScrew = screws.find(s =>
      (s.components.screw as { color: string }).color === 'red' &&
      (s.components.screw as { state: string }).state === 'placed'
    );

    // Get the tray containing this screw
    const trays = await harness.queryByComponent('tray');
    const targetTray = trays.find(t => {
      const tray = t.components.tray as { color: string };
      // Check if screw is positioned within this tray
      return Math.abs(t.position.x - redScrew!.position.x) < 100;
    });

    // Assert: red screw should be in red tray
    expect((targetTray?.components.tray as { color: string }).color).toBe('red');
  });
});
```

### 3. Verify Bug Reproduction

Run the test to confirm the bug reproduces:

```bash
npm run test:e2e -- --grep "Red screw went to wrong tray"
```

Expected: Test should **fail** with the bug present, confirming reproduction.

### 4. Investigate Root Cause

Use the console logs and game state to identify the issue:

1. **Look for error patterns** in console-log.txt
2. **Trace the entity state** changes in game-state.json
3. **Identify the tick/timestamp** where behavior diverges from expected
4. **Search the codebase** for related systems/functions

Common investigation queries:
```bash
# Find screw transfer logic
grep -r "AUTO_TRANSFER\|transfer" src/scenes/game/systems/

# Find tray color matching logic
grep -r "color.*match\|matchColor" src/scenes/game/

# Find the system mentioned in logs
grep -r "ScrewSystem\|TraySystem" src/scenes/game/systems/
```

### 5. Fix the Bug

Make the necessary code changes to fix the issue. Common bug patterns:

#### Timing/Race Conditions
- Actions with very short delays between them
- State changes during animations
- Async operations completing out of order

#### Position Mismatches
- Coordinate system conversions (Figma CSS vs PixiJS center)
- Scaling issues between game space and screen space

#### Component State Inconsistencies
- Entity state not matching actual position
- Component data not updated after operations

### 6. Verify the Fix

Run the test again to confirm the fix works:

```bash
npm run test:e2e -- --grep "Red screw went to wrong tray"
```

Expected: Test should **pass** with the fix applied.

### 7. Run Full Test Suite

Ensure no regressions were introduced:

```bash
npm run validate
npm run test:e2e
```

## Quick Reference: Test Template

```typescript
import { test, expect } from '@playwright/test';
import { createHarnessClient } from '../helpers/harness';

test.describe('Bug: {description from report.json}', () => {
  test('reproduce from bug report', async ({ page }) => {
    // 1. Navigate using URL from report.json
    await page.goto('{url from report.json}');

    const harness = createHarnessClient(page);
    await harness.waitForReady(15000);
    await page.waitForTimeout(500);

    // 2. Replay actions from userActions array
    for (const { action } of userActions) {
      await harness.act(action);
      await page.waitForTimeout(50);
    }

    // 3. Wait for game to settle
    await page.waitForTimeout(1000);

    // 4. Add assertions based on expected behavior
    const entities = await harness.getEntities();
    // ... verify correct state
  });
});
```

## Key Files Reference

| File | Purpose |
|------|---------|
| `src/shared/debug/bugReport.ts` | Bug report client (capture & submit) |
| `src/shared/debug/consoleCapture.ts` | Console log capture system |
| `src/shared/debug/harness/actionDsl.ts` | Action recording and execution |
| `src/shared/debug/harness/ecsAccess.ts` | ECS entity serialization |
| `src/shared/debug/types.ts` | Type definitions (RenderSignature, EntitySnapshot) |
| `e2e/helpers/harness.ts` | Playwright test harness client |
| `vite/plugins/bugReportPlugin.ts` | Vite plugin for saving reports |

## Understanding Entity Correlation

Bug reports provide two views of game objects that can be correlated:

### render-graph.json → game-state.json
Display objects with `entityUid` link to ECS entities:
```
render-graph.json:  { "type": "ScrewEntity", "uid": "456", "entityUid": "123", ... }
                                                                ↓
game-state.json:    { "id": "123", "type": "ScrewEntity", "components": {...} }
```

### game-state.json → render-graph.json
ECS entities with `view2d.viewUid` link back to display objects:
```
game-state.json:    { "components": { "view2d": { "viewUid": "456" } } }
                                                       ↓
render-graph.json:  { "type": "ScrewEntity", "uid": "456", ... }
```

### When to use which file
- **render-graph.json** - Visual hierarchy, z-ordering, what's visible on screen
- **game-state.json** - Game logic state, component data, entity relationships

## Tips for Effective Bug Fixing

1. **Read the description first** - User descriptions often point directly to the issue
2. **Check the timestamp progression** - Logs are ordered by time, follow the sequence
3. **Compare expected vs actual state** - game-state.json shows what happened
4. **Use tick numbers for correlation** - Match log entries to game frames
5. **Keep the test** - Converted bug report tests prevent regressions
